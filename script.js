const GLOBAL_LOGO = 'data:image/png;base64,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';

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { 
    getFirestore, collection, doc, onSnapshot, 
    addDoc, setDoc, deleteDoc, getDocs, query, updateDoc, getDoc, where, deleteField,
    enableIndexedDbPersistence, writeBatch, orderBy, limit
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

import {
    getStorage, ref, uploadBytes, getDownloadURL
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

import { OdooConnector } from "./odoo-connector.js";

// --- Firebase Config (placeholders will be populated by environment) ---
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-cmms-app';

console.log("游 CORINFAR CMMS - Versi칩n Odoo Integration 2.0 cargada.");
// --- Firebase Initialization ---
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

// Export for verification
window.state = null;
const auth = getAuth(app);

// Enable Offline Persistence
enableIndexedDbPersistence(db).catch((err) => {
    if (err.code == 'failed-precondition') {
        console.warn("La persistencia fall칩: M칰ltiples pesta침as abiertas.");
    } else if (err.code == 'unimplemented') {
        console.warn("La persistencia no es compatible con este navegador.");
    }
});

// --- App State ---
const state = {
    odoo: null, // Instancia del conector de Odoo
    storage: storage,
    currentUser: null,
    currentExecution: null,
    currentTab: 'dashboard',
    machines: [],
    parts: [],
    proveedores: [],
    technicians: [],
    workOrders: [],
    solicitudes: [],
    workPlans: [],
    activeWorkPlanTab: 'machine',
    workPlanExecutions: [],
    evaluationCriteria: [],
    technicianEvaluations: [],
    calendarDate: new Date(),
    machineMaintFilter: null,
    partStockFilter: null,
    monitoringLocationFilter: 'all',
    activeTimers: {},
    collections: {
        parts: collection(db, `/artifacts/${appId}/public/data/parts`),
        machines: collection(db, `/artifacts/${appId}/public/data/machines`),
        proveedores: collection(db, `/artifacts/${appId}/public/data/proveedores`),
        technicians: collection(db, `/artifacts/${appId}/public/data/technicians`),
        workOrders: collection(db, `/artifacts/${appId}/public/data/workOrders`),
        solicitudes: collection(db, `/artifacts/${appId}/public/data/solicitudes`),
        workPlans: collection(db, `/artifacts/${appId}/public/data/workPlans`),
        workPlanExecutions: collection(db, `/artifacts/${appId}/public/data/workPlanExecutions`),
        evaluationCriteria: collection(db, `/artifacts/${appId}/public/data/evaluationCriteria`),
        technicianEvaluations: collection(db, `/artifacts/${appId}/public/data/technicianEvaluations`),
        partMovements: collection(db, `/artifacts/${appId}/public/data/partMovements`),
        partRequests: collection(db, `/artifacts/${appId}/public/data/partRequests`),
        settings: collection(db, `/artifacts/${appId}/public/data/settings`),
        auditLogs: collection(db, `/artifacts/${appId}/public/data/auditLogs`),
        monitoringConfigs: collection(db, `/artifacts/${appId}/public/data/monitoringConfigs`),
    },
    monitoringConfigs: [],
    currentMonitoringConfig: null,
    activeMonitoringVar: null,
    partMovements: [],
    partRequests: [],
        auditLogs: [],
    modals: {},
    charts: {},
    searchTimeouts: {},
    signaturePad: null,
    currentTheme: 'light'
};
window.state = state;
let currentPartDocs = [];

const FICHA_MAESTRA_TEMPLATE = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { primary: '#1e3b8a' },
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        /* Fallback basics in case Tailwind CDN is slow or fails in iframe */
        .flex { display: flex !important; }
        .grid { display: grid !important; }
        .flex-col { flex-direction: column !important; }
        .justify-between { justify-content: space-between !important; }
        .justify-end { justify-content: flex-end !important; }
        .items-start { align-items: flex-start !important; }
        .items-center { align-items: center !important; }
        .gap-2 { gap: 0.5rem !important; }
        .gap-4 { gap: 1rem !important; }
        .gap-6 { gap: 1.5rem !important; }
        .grid-cols-12 { grid-template-columns: repeat(12, minmax(0, 1fr)) !important; }
        .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)) !important; }
        .col-span-7 { grid-column: span 7 / span 7 !important; }
        .col-span-5 { grid-column: span 5 / span 5 !important; }
        .col-span-12 { grid-column: span 12 / span 12 !important; }
        .border-b-2 { border-bottom-width: 2px !important; }
        .text-right { text-align: right !important; }
        .text-center { text-align: center !important; }
        .w-full { width: 100% !important; }

        @page {
            size: A4;
            margin: 0;
        }

        body { background: white; font-family: 'Inter', sans-serif; -webkit-print-color-adjust: exact; margin: 0; padding: 0; }
        .pdf-page {
            width: 210mm;
            height: 297mm;
            padding: 10mm;
            margin: 0;
            background: white;
            position: relative;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .table-header {
            background-color: #f8fafc !important;
            color: #64748b !important;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.7rem;
            letter-spacing: 0.05em;
        }
        img { max-width: 100%; height: auto; }
    </style>
</head>
<body class="text-slate-800">
    <main class="pdf-page">
        <!-- Header -->
        <header class="border-b-2 border-primary pb-3 mb-4 flex justify-between items-start">
            <div class="flex gap-4 items-center">
                <div class="bg-primary p-2 rounded-lg">
                    <img id="print-logo" src="" class="w-12 h-auto" alt="Logo">
                </div>
                <div>
                    <h2 class="text-xs font-bold text-slate-500 uppercase tracking-widest">CORINFAR</h2>
                    <h1 class="text-2xl font-extrabold text-primary">FICHA MAESTRA DE ACTIVO</h1>
                    <p class="text-[10px] text-slate-400">Doc ID: CMMS-FA-001 | Versi칩n 2.0</p>
                </div>
            </div>
            <div class="text-right space-y-1">
                <div class="flex items-center justify-end gap-2">
                    <span class="text-xs font-medium text-slate-500">Asset ID:</span>
                    <span id="print-asset-id" class="text-lg font-bold text-slate-900 tracking-tight"></span>
                </div>
                <div class="flex items-center justify-end gap-2">
                    <span class="text-xs font-medium text-slate-500">Criticidad:</span>
                    <span id="print-criticidad" class="px-2 py-0.5 text-white text-[10px] font-bold rounded-full"></span>
                </div>
                <div class="text-[10px] text-slate-500 italic mt-1">
                    Ubicaci칩n: <span id="print-location"></span>
                </div>
            </div>
        </header>

        <!-- Asset Summary & Image -->
        <section class="grid grid-cols-12 gap-6 mb-4">
            <div class="col-span-7">
                <div class="bg-slate-50 border border-slate-100 p-4 rounded-lg">
                    <h3 class="flex items-center gap-2 text-primary font-bold text-xs uppercase mb-3 pb-2 border-b border-slate-200">
                        Informaci칩n General
                    </h3>
                    <dl class="grid grid-cols-2 gap-y-2 gap-x-4 text-xs">
                        <div>
                            <dt class="text-slate-500">Marca</dt>
                            <dd id="print-brand" class="font-semibold"></dd>
                        </div>
                        <div>
                            <dt class="text-slate-500">Estado Actual</dt>
                            <dd id="print-status-badge"></dd>
                        </div>
                        <div>
                            <dt class="text-slate-500">Modelo</dt>
                            <dd id="print-model" class="font-semibold"></dd>
                        </div>
                        <div>
                            <dt class="text-slate-500">Num. de Serie</dt>
                            <dd id="print-serial" class="font-semibold"></dd>
                        </div>
                        <div>
                            <dt class="text-slate-500">Fecha de Compra</dt>
                            <dd id="print-purchase-date" class="font-semibold"></dd>
                        </div>
                        <div>
                            <dt class="text-slate-500">Puesta en Marcha</dt>
                            <dd id="print-commissioning-date" class="font-semibold text-primary"></dd>
                        </div>
                        <div>
                            <dt class="text-slate-500">Impacto en Calidad</dt>
                            <dd id="print-risk" class="font-semibold text-orange-700"></dd>
                        </div>
                        <div>
                            <dt class="text-slate-500">Tipo</dt>
                            <dd id="print-type" class="font-semibold"></dd>
                        </div>
                    </dl>
                </div>
                <div class="mt-4 flex gap-4 text-center">
                    <div class="flex-1 bg-slate-50 p-2 rounded-lg border border-slate-100">
                        <div class="text-[9px] text-slate-500 uppercase font-bold">Total Mant.</div>
                        <div id="print-total-mant" class="text-lg font-bold text-slate-800"></div>
                    </div>
                    <div class="flex-1 bg-slate-50 p-2 rounded-lg border border-slate-100">
                        <div class="text-[9px] text-slate-500 uppercase font-bold">MTBF</div>
                        <div id="print-mtbf" class="text-lg font-bold text-slate-800"></div>
                    </div>
                    <div class="flex-1 bg-slate-50 p-2 rounded-lg border border-slate-100">
                        <div class="text-[9px] text-slate-500 uppercase font-bold">Disponibilidad</div>
                        <div id="print-availability" class="text-lg font-bold text-green-600"></div>
                    </div>
                </div>
            </div>
            <div class="col-span-5">
                <div class="border-2 border-slate-100 rounded-lg p-1 bg-white h-[180px] flex items-center justify-center overflow-hidden">
                    <img id="print-asset-image" alt="Vista del Activo" class="max-w-full max-h-full object-contain rounded-sm" src="">
                </div>
            </div>
        </section>

        <!-- Qualifications -->
        <section class="mb-4">
            <h3 class="flex items-center gap-2 text-primary font-bold text-xs uppercase mb-3">
                Calificaci칩n del Equipo (IQ / OQ / PQ)
            </h3>
            <div class="overflow-hidden border border-slate-200 rounded-lg">
                <table class="w-full text-left text-xs">
                    <thead>
                        <tr class="table-header">
                            <th class="px-4 py-2 border-b">Etapa</th>
                            <th class="px-4 py-2 border-b">Estado</th>
                            <th class="px-4 py-2 border-b">Fecha Aprobaci칩n</th>
                            <th class="px-4 py-2 border-b">Vencimiento</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">
                        <tr>
                            <td class="px-4 py-2 font-bold text-primary">IQ  Instalaci칩n</td>
                            <td class="px-4 py-2"><span id="print-iq-status" class="font-semibold uppercase text-[9px]"></span></td>
                            <td id="print-iq-date" class="px-4 py-2"></td>
                            <td class="px-4 py-2 text-slate-400 italic">N/A</td>
                        </tr>
                        <tr>
                            <td class="px-4 py-2 font-bold text-primary">OQ  Operaci칩n</td>
                            <td class="px-4 py-2"><span id="print-oq-status" class="font-semibold uppercase text-[9px]"></span></td>
                            <td id="print-oq-date" class="px-4 py-2"></td>
                            <td class="px-4 py-2 text-slate-400 italic">N/A</td>
                        </tr>
                        <tr id="print-pq-row">
                            <td class="px-4 py-2 font-bold text-primary">PQ  Desempe침o</td>
                            <td class="px-4 py-2"><span id="print-pq-status" class="font-semibold uppercase text-[9px]"></span></td>
                            <td id="print-pq-date" class="px-4 py-2"></td>
                            <td id="print-pq-next" class="px-4 py-2 font-bold"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Maintenance and Spares -->
        <div class="grid grid-cols-2 gap-6 mb-4">
            <section>
                <h3 class="flex items-center gap-2 text-primary font-bold text-xs uppercase mb-3">
                    Mantenimientos Programados
                </h3>
                <div class="border border-slate-200 rounded-lg overflow-hidden">
                    <table class="w-full text-left text-[10px]">
                        <thead class="table-header">
                            <tr>
                                <th class="px-3 py-1.5 border-b">ID</th>
                                <th class="px-3 py-1.5 border-b">Fecha</th>
                                <th class="px-3 py-1.5 border-b">Tipo</th>
                            </tr>
                        </thead>
                        <tbody id="print-history-table-body" class="divide-y divide-slate-100">
                        </tbody>
                    </table>
                </div>
            </section>
            <section>
                <h3 class="flex items-center gap-2 text-primary font-bold text-xs uppercase mb-3">
                    Repuestos Vinculados
                </h3>
                <div class="border border-slate-200 rounded-lg overflow-hidden">
                    <table class="w-full text-left text-[10px]">
                        <thead class="table-header">
                            <tr>
                                <th class="px-3 py-1.5 border-b">Repuesto</th>
                                <th class="px-3 py-1.5 border-b">Estado</th>
                            </tr>
                        </thead>
                        <tbody id="print-parts-table-body" class="divide-y divide-slate-100">
                        </tbody>
                    </table>
                </div>
            </section>
        </div>

        <!-- Documentation -->
        <section class="grid grid-cols-2 gap-6 bg-slate-50 p-3 rounded-lg border border-slate-100 mb-4">
            <div>
                <h4 class="text-xs font-bold text-slate-700 uppercase mb-2">Documentaci칩n</h4>
                <ul id="print-docs-list" class="text-[10px] space-y-1 text-slate-600">
                </ul>
            </div>
            <div>
                <h4 class="text-xs font-bold text-slate-700 uppercase mb-2">Biblioteca Digital</h4>
                <p class="text-[9px] text-slate-500 mb-2 italic">Acceso restringido para personal autorizado.</p>
                <div class="flex gap-4">
                    <span class="text-[9px] px-2 py-1 bg-white border border-slate-200 rounded text-slate-400">Manual Usuario 游</span>
                    <span class="text-[9px] px-2 py-1 bg-white border border-slate-200 rounded text-slate-400">Ficha T칠cnica 游</span>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="mt-auto border-t border-slate-200 pt-4 flex justify-between items-end">
            <div class="space-y-1">
                <p class="text-[9px] text-slate-400 font-medium">Documento generado autom치ticamente por sistema CORINFAR CMMS</p>
                <p class="text-[9px] text-slate-400">Usuario: <span id="print-user" class="text-slate-600"></span>  Fecha: <span id="print-date"></span></p>
                <div class="flex gap-4 mt-2">
                    <div class="text-[10px] bg-slate-100 px-3 py-1 rounded font-bold text-slate-500">REF: CMMS-FA-001</div>
                    <div id="print-ref-id" class="text-[10px] bg-slate-100 px-3 py-1 rounded font-bold text-slate-500"></div>
                </div>
            </div>
            <div class="flex flex-col items-center gap-1">
                <div class="w-16 h-16 bg-slate-100 p-1 border border-slate-200 rounded shadow-sm flex items-center justify-center">
                    QR
                </div>
                <span class="text-[8px] text-slate-400 font-bold tracking-widest">VALIDACI칍N QR</span>
            </div>
        </footer>
    </main>
</body>
</html>
`;

// --- Utility Functions ---
async function hashPassword(password) {
    if (!password) return null;
    const encoder = new TextEncoder();
    const data = encoder.encode(password + "CORINFAR-SALT-2025");
    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}

async function recordAuditLog(collectionName, docId, action, oldData, newData, detailedAction = null) {
    // Evitar registrar contrase침as en el log de auditor칤a
    const sanitize = (data) => {
        if (!data) return null;
        const sanitized = { ...data };
        if (sanitized.password) sanitized.password = '********';
        return sanitized;
    };

    try {
        const logData = {
            collectionName,
            docId,
            action, // 'CREATE', 'UPDATE', 'DELETE'
            detailedAction,
            oldData: sanitize(oldData),
            newData: sanitize(newData),
            userId: state.currentUser ? (state.currentUser.fb_id || state.currentUser.id || 'unknown') : 'system',
            username: state.currentUser ? state.currentUser.username : 'Sistema',
            timestamp: new Date().toISOString(),
            userAgent: navigator.userAgent
        };
        await addDoc(state.collections.auditLogs, logData);
    } catch (error) {
        console.error("Error recording audit log:", error);
    }
}

function showToast(message, type = 'info') {
    const toastContainer = document.querySelector('.toast-container');
    const toastId = 'toast-' + Date.now();
    
    const toast = document.createElement('div');
    toast.className = `toast align-items-center toast-${type}`;
    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');
    toast.id = toastId;
    
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                ${message}
            </div>
            <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    `;
    
    toastContainer.appendChild(toast);
    
    const bsToast = new bootstrap.Toast(toast, {
        autohide: true,
        delay: 5000
    });
    
    bsToast.show();
    
    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}

function showLoading(show = true) {
    const loadingOverlay = document.getElementById('global-loading');
    if (show) {
        loadingOverlay.classList.remove('d-none');
    } else {
        loadingOverlay.classList.add('d-none');
    }
}

function formatCurrency(value) {
    const number = parseFloat(value);
    if (isNaN(number)) {
        return 'N/A';
    }
    return `Lps ${number.toFixed(2)}`;
}

function debounce(func, wait) {
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(state.searchTimeouts[func.name]);
            func(...args);
        };
        clearTimeout(state.searchTimeouts[func.name]);
        state.searchTimeouts[func.name] = setTimeout(later, wait);
    };
}

// --- Initialization ---
document.addEventListener('DOMContentLoaded', async () => {
    if (!firebaseConfig.apiKey) {
        document.body.innerHTML = `<div class="alert alert-danger m-5"><strong>Error de Configuraci칩n:</strong> La configuraci칩n de Firebase no se ha cargado correctamente. La aplicaci칩n no puede iniciarse. Aseg칰rese de que las variables del entorno est칠n disponibles.</div>`;
        throw new Error("Firebase config is missing or invalid.");
    }

    // Init Bootstrap Modals
    state.modals.machine = new bootstrap.Modal(document.getElementById('machine-modal'));
    state.modals.part = new bootstrap.Modal(document.getElementById('part-modal'));
    state.modals.proveedor = new bootstrap.Modal(document.getElementById('proveedor-modal'));
    state.modals.technician = new bootstrap.Modal(document.getElementById('technician-modal'));
    state.modals.confirm = new bootstrap.Modal(document.getElementById('confirm-modal'));
    state.modals.workOrder = new bootstrap.Modal(document.getElementById('work-order-modal'));
    state.modals.partHistory = new bootstrap.Modal(document.getElementById('part-history-modal'));
    state.modals.manageParts = new bootstrap.Modal(document.getElementById('manage-parts-modal'));
    state.modals.solicitud = new bootstrap.Modal(document.getElementById('solicitud-modal'));
    state.modals.workPlan = new bootstrap.Modal(document.getElementById('work-plan-modal'));
    state.modals.criteria = new bootstrap.Modal(document.getElementById('criteria-modal'));
    state.modals.evaluation = new bootstrap.Modal(document.getElementById('evaluation-modal'));
    state.modals.technicianProfile = new bootstrap.Modal(document.getElementById('technician-profile-modal'));
    state.modals.machineHistory = new bootstrap.Modal(document.getElementById('machine-history-modal'));
    state.modals.machineDetail = new bootstrap.Modal(document.getElementById('machine-detail-modal'));
    state.modals.auditDetail = new bootstrap.Modal(document.getElementById('auditDetailModal'));
    state.modals.passwordConfirm = new bootstrap.Modal(document.getElementById('passwordConfirmModal'));
    state.modals.variableName = new bootstrap.Modal(document.getElementById('variable-name-modal'));
    state.modals.partDetail = new bootstrap.Modal(document.getElementById('part-detail-modal'));
    state.modals.measurementHistory = new bootstrap.Modal(document.getElementById('measurement-history-modal'));
    
    setupEventListeners();
    updateCurrentDate();
    populateDateSelectors();
    initCharts();
    handlePeriodChange(); // Set initial state for period selectors
    
    // Call auto-closure/cancellation for old work orders on startup
    handleExpiredWorkOrders();

    // Load Odoo Settings
    await loadOdooSettings();

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            await initializeSampleData();
            setupRealtimeListeners();
        } else {
             try {
                 if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                     await signInWithCustomToken(auth, __initial_auth_token);
                 } else {
                     await signInAnonymously(auth);
                 }
            } catch (error) {
                 console.error("Error during sign-in:", error);
                 showToast('Error al conectar con el servidor', 'error');
            }
        }
    });
});

// --- Sample Data Initialization (Runs once if DB is empty) ---
async function initializeSampleData() {
    showLoading(true);
    try {
        const techniciansSnapshot = await getDocs(state.collections.technicians);
        if (techniciansSnapshot.empty) {
            
            const adminUser = { 
                username: 'admin', 
                password: 'admin', 
                role: 'Admin', 
                permissions: ['all'], 
                salario: 30000
            };

            await addDoc(state.collections.technicians, adminUser);
            
            showToast('Cuenta de administrador creada. 춰Bienvenido!', 'success');
        }
    } catch (error) {
        console.error("Error initializing administrator account:", error);
        showToast('Error al crear la cuenta de administrador', 'error');
    } finally {
        showLoading(false);
    }
}

// --- Realtime Listeners ---
function setupRealtimeListeners() {
    // OPTIMIZED: Use docChanges for efficient DOM updates on simple list views
    onSnapshot(query(state.collections.machines), snapshot => {
        let requiresKpiUpdate = false;
        let dataChanged = false;
        snapshot.docChanges().forEach(change => {
            dataChanged = true;
            const machineData = { fb_id: change.doc.id, ...change.doc.data() };
            const index = state.machines.findIndex(m => m.fb_id === change.doc.id);
            requiresKpiUpdate = true;

            if (change.type === "added") {
                if (index === -1) state.machines.push(machineData);
            }
            if (change.type === "modified") {
                if (index > -1) state.machines[index] = machineData;
            }
            if (change.type === "removed") {
                if (index > -1) state.machines.splice(index, 1);
            }
        });

        if (dataChanged) {
            renderMachines();
            populateDynamicSelectors();
            
            updateMachineCriticidadChart();
            
            if (requiresKpiUpdate) updateDashboardData();
        }
    });
    
    onSnapshot(query(state.collections.parts), snapshot => {
        let requiresCostUpdate = false;
        let dataChanged = false;
         snapshot.docChanges().forEach(change => {
            dataChanged = true;
            const partData = { fb_id: change.doc.id, ...change.doc.data() };
            const index = state.parts.findIndex(p => p.fb_id === change.doc.id);
            if (change.type !== "removed") {
                const oldPart = state.parts[index];
                if (!oldPart || oldPart.cost !== partData.cost) requiresCostUpdate = true;
            } else {
                requiresCostUpdate = true;
            }

            if (change.type === "added") {
                if (index === -1) state.parts.push(partData);
            }
            if (change.type === "modified") {
                if (index > -1) state.parts[index] = partData;
            }
            if (change.type === "removed") {
                if (index > -1) state.parts.splice(index, 1);
            }
        });

        if (dataChanged) {
            renderParts();
            if (requiresCostUpdate) updateDashboardData();
        }
    });

     onSnapshot(query(state.collections.proveedores), snapshot => {
        let dataChanged = false;
         snapshot.docChanges().forEach(change => {
            dataChanged = true;
            const provData = { fb_id: change.doc.id, ...change.doc.data() };
            const index = state.proveedores.findIndex(p => p.fb_id === change.doc.id);

            if (change.type === "added") {
                if (index === -1) state.proveedores.push(provData);
            }
            if (change.type === "modified") {
                if (index > -1) state.proveedores[index] = provData;
            }
            if (change.type === "removed") {
                if (index > -1) state.proveedores.splice(index, 1);
            }
        });

        if (dataChanged) {
            renderProveedores();
            populateSupplierSelectors();
        }
    });
    
    onSnapshot(query(state.collections.technicians), snapshot => {
        const wasEmpty = state.technicians.length === 0;
         snapshot.docChanges().forEach(change => {
            const techData = { fb_id: change.doc.id, ...change.doc.data() };
            const index = state.technicians.findIndex(p => p.fb_id === change.doc.id);

            if (change.type === "added") {
                if (index === -1) state.technicians.push(techData);
            } else if (change.type === "modified") {
                if (index > -1) state.technicians[index] = techData;
            } else if (change.type === "removed") {
                if (index > -1) state.technicians.splice(index, 1);
            }
        });

        renderTechnicians(); // Full re-render is fine for this small/infrequent table

        if (wasEmpty && state.technicians.length > 0) {
            document.getElementById('login-status-text').textContent = 'Ingrese sus credenciales';
            document.getElementById('username').disabled = false;
            document.getElementById('password').disabled = false;
            document.querySelector('#login-form button[type="submit"]').disabled = false;
        }
    });
    
    // For complex views like dashboard, calendar, kanban, a full re-render on data change is more robust and acceptable.
    let firstWoLoad = true;
    onSnapshot(query(state.collections.workOrders), snapshot => {
        state.workOrders = snapshot.docs.map(doc => ({ fb_id: doc.id, ...doc.data() }));

        if (firstWoLoad && state.workOrders.length > 0) {
            handleExpiredWorkOrders();
            firstWoLoad = false;
        }

        populateWorkOrderSelectors();
        renderCalendar();
        if (state.currentTab === 'maquinaria') renderMachines();
        if (state.currentTab === 'monitoreo-inteligente') renderSmartMonitoring();
        if (state.currentTab === 'trabajo-activo') renderActiveWorkView();
        if (state.currentTab === 'ordenes-asignadas') renderAssignedOrders();
        if (state.currentTab === 'solicitudes') renderSolicitudes(); // Re-render solicitudes as WO status affects them
        updateDashboardData();
    });

    onSnapshot(query(state.collections.workPlans), snapshot => {
        state.workPlans = snapshot.docs.map(doc => ({ fb_id: doc.id, ...doc.data() }));
        if (state.currentTab === 'maquinaria') renderMachines();
        if (state.currentTab === 'planes-trabajo') {
            renderWorkPlans();
        }
        populateExecutionReportSelector();
        updatePlanNotifications();
    });

    onSnapshot(query(state.collections.workPlanExecutions), snapshot => {
        state.workPlanExecutions = snapshot.docs.map(doc => ({ fb_id: doc.id, ...doc.data() }));
        if (state.currentTab === 'monitoreo-inteligente') renderSmartMonitoring();
        updateDashboardData();
        populateExecutionReportSelector();
    });

    onSnapshot(query(state.collections.monitoringConfigs), snapshot => {
        state.monitoringConfigs = snapshot.docs.map(doc => ({ fb_id: doc.id, ...doc.data() }));
        if (state.currentTab === 'monitoreo-inteligente') renderSmartMonitoring();
    });

    if (state.currentUser) {
        const solicitudesQuery = query(state.collections.solicitudes);

        onSnapshot(solicitudesQuery, snapshot => {
            state.solicitudes = snapshot.docs.map(doc => ({ fb_id: doc.id, ...doc.data() }));
            if (state.currentTab === 'solicitudes') renderSolicitudes();
            if (state.currentTab === 'trabajo-activo') renderActiveWorkView();
            updateDashboardData(); // Update pending requests stat
        });
    }

    onSnapshot(query(state.collections.evaluationCriteria), snapshot => {
        state.evaluationCriteria = snapshot.docs.map(doc => ({ fb_id: doc.id, ...doc.data() }));
        if (state.currentTab === 'evaluation-criteria') {
            renderCriteria();
        }
    });

    onSnapshot(query(state.collections.technicianEvaluations), snapshot => {
        state.technicianEvaluations = snapshot.docs.map(doc => ({ fb_id: doc.id, ...doc.data() }));
    });


    onSnapshot(query(state.collections.partRequests), snapshot => {
        state.partRequests = snapshot.docs.map(doc => ({ fb_id: doc.id, ...doc.data() }));
        renderPartRequests();
    });

}


// --- Report Search Handlers ---
function handleReportMachineSearch(e) {
    populateDynamicSelectors(e.target.value, 'report-machine-select');
}
function handleReportMachinePartsSearch(e) {
    populateDynamicSelectors(e.target.value, 'report-machine-parts-select');
}
function handleReportWoSearch(e) {
    populateWorkOrderSelectors(e.target.value);
}
function handleReportExecutionSearch(e) {
    populateExecutionReportSelector(e.target.value);
}

// --- Event Listeners Setup ---
function setupEventListeners() {
    document.getElementById('login-form').addEventListener('submit', handleLogin);
    document.getElementById('theme-toggle-btn').addEventListener('click', toggleTheme);
    document.getElementById('password-toggle').addEventListener('click', togglePasswordVisibility);
    document.getElementById('solicitud-type').addEventListener('change', (e) => {
        const type = e.target.value;
        const isInsumos = type === 'insumos';
        document.getElementById('solicitud-extra-fields').classList.toggle('d-none', !isInsumos);
        document.getElementById('solicitud-machine').required = !isInsumos;
        document.getElementById('solicitud-machine-label').innerHTML = isInsumos ? 'M치quina (Opcional)' : 'M치quina';
        document.getElementById('solicitud-description-label').innerHTML = isInsumos ? 'Descripci칩n de lo solicitado' : 'Descripci칩n del Problema';
    });
    
    document.getElementById('logout-btn').addEventListener('click', handleLogout);
    document.getElementById('btn-filter-audit').addEventListener('click', renderAuditLogs);
    document.getElementById('generate-audit-report-btn').addEventListener('click', generateAuditReport);
    
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.addEventListener('click', (e) => {
            e.preventDefault();
            switchTab(tab.dataset.tab);
            if(window.innerWidth < 992) {
                toggleSidebar(false);
            }
        });
    });

    document.getElementById('sidebar-toggle').addEventListener('click', () => toggleSidebar());
    document.getElementById('sidebar-overlay').addEventListener('click', () => toggleSidebar(false));
    
    // Machine Listeners
    document.getElementById('add-machine-btn').addEventListener('click', () => showMachineModal());
    document.getElementById('sync-all-machines-odoo-btn').addEventListener('click', () => syncAllMachinesToOdoo());
    document.getElementById('machine-form').addEventListener('submit', handleMachineSubmit);
    document.getElementById('search-machine-input').addEventListener('input', debounce(renderMachines, 300));

    // Filtros de resumen de maquinaria
    document.querySelectorAll('.machine-summary-header .summary-pill').forEach(pill => {
        pill.addEventListener('click', () => {
            const filter = pill.querySelector('.label').textContent.trim();
            state.machineMaintFilter = (state.machineMaintFilter === filter) ? null : filter;
            renderMachines();
        });
    });

    document.getElementById('disable-schedule-check').addEventListener('change', e => {
        document.getElementById('schedule-wrapper').style.display = e.target.checked ? 'none' : 'block';
    });

    // Part Listeners
    document.getElementById('add-part-btn').addEventListener('click', () => showPartModal());
    document.getElementById('sync-all-parts-odoo-btn').addEventListener('click', () => syncAllPartsToOdoo());
    document.getElementById('view-all-part-history-btn').addEventListener('click', () => showPartHistoryModal(null));

    const addPartMobile = document.getElementById('btn-add-part-mobile');
    if (addPartMobile) addPartMobile.addEventListener('click', () => showPartModal());

    const syncPartsMobile = document.getElementById('btn-part-sync-mobile');
    if (syncPartsMobile) syncPartsMobile.addEventListener('click', () => syncAllPartsToOdoo());

    const historyPartsMobile = document.getElementById('btn-part-history-mobile');
    if (historyPartsMobile) historyPartsMobile.addEventListener('click', () => showPartHistoryModal(null));
    document.getElementById('part-form').addEventListener('submit', handlePartSubmit);

    document.getElementById('add-part-doc-btn').addEventListener('click', () => {
        document.getElementById('part-doc-file').click();
    });

    document.getElementById('part-doc-file').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            currentPartDocs.push({ name: file.name, file: file });
            renderPartDocsList();
            e.target.value = '';
        }
    });

    document.getElementById('part-image-file').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (event) => {
                const preview = document.getElementById('part-image-preview');
                preview.src = event.target.result;
                preview.classList.remove('d-none');
                document.querySelector('#part-modal .upload-placeholder').classList.add('d-none');
            };
            reader.readAsDataURL(file);
        }
    });
    document.getElementById('search-part-input').addEventListener('input', debounce(renderParts, 300));

    // Filtros de resumen de repuestos
    document.querySelectorAll('.inventory-summary .summary-pill').forEach(pill => {
        pill.addEventListener('click', () => {
            let filter = '';
            if (pill.classList.contains('critical')) filter = 'critical';
            else if (pill.classList.contains('attention')) filter = 'attention';
            else if (pill.classList.contains('operative')) filter = 'operative';

            state.partStockFilter = (state.partStockFilter === filter) ? null : filter;
            renderParts();
        });
    });

    // Proveedor Listeners
    document.getElementById('add-proveedor-btn').addEventListener('click', () => showProveedorModal());
    document.getElementById('proveedor-form').addEventListener('submit', handleProveedorSubmit);
    document.getElementById('search-proveedor-input').addEventListener('input', debounce(renderProveedores, 300));

    // Technician/User Listeners
    document.getElementById('add-technician-btn').addEventListener('click', () => showTechnicianModal());
    document.getElementById('technician-form').addEventListener('submit', handleTechnicianSubmit);
    document.getElementById('technician-role').addEventListener('change', (e) => {
        updateTechnicianModalUIForRole(e.target.value);
    });

    // Signature Listeners
    document.getElementById('toggle-draw-sig').addEventListener('click', () => {
        document.getElementById('signature-draw-container').style.display = 'block';
        document.getElementById('signature-upload-container').style.display = 'none';
        initSignaturePad();
    });
    document.getElementById('toggle-upload-sig').addEventListener('click', () => {
        document.getElementById('signature-draw-container').style.display = 'none';
        document.getElementById('signature-upload-container').style.display = 'block';
    });
    document.getElementById('clear-signature').addEventListener('click', () => {
        if (state.signaturePad) state.signaturePad.clear();
    });

    document.getElementById('signature-upload').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (event) => {
                const preview = document.getElementById('signature-preview');
                const previewContainer = document.getElementById('signature-preview-container');
                preview.src = event.target.result;
                previewContainer.classList.remove('d-none');
            };
            reader.readAsDataURL(file);
        }
    });
    
    // Solicitud Listeners
    document.getElementById('add-solicitud-btn').addEventListener('click', showSolicitudModal);
    document.getElementById('solicitud-form').addEventListener('submit', handleSolicitudSubmit);

    // Work Plan Listeners
    document.getElementById('add-work-plan-btn').addEventListener('click', () => showWorkPlanModal());
    document.getElementById('save-work-plan-btn').addEventListener('click', handleWorkPlanSubmit);
    document.getElementById('work-plan-search-input').addEventListener('input', debounce(renderWorkPlans, 300));
    document.querySelectorAll('#work-plan-group-tabs .nav-link').forEach(tab => {
        tab.addEventListener('click', (e) => {
            state.activeWorkPlanTab = e.target.dataset.group;
            document.querySelectorAll('#work-plan-group-tabs .nav-link').forEach(el => el.classList.remove('active'));
            e.target.classList.add('active');
            renderWorkPlans();
        });
    });
    document.getElementById('add-task-group-btn').addEventListener('click', () => addTaskGroup());

    // Criteria Listeners
    document.getElementById('add-criteria-btn').addEventListener('click', () => showCriteriaModal());
    document.getElementById('criteria-form').addEventListener('submit', handleCriteriaSubmit);

    // Evaluation Listeners
    document.getElementById('evaluation-form').addEventListener('submit', handleEvaluationSubmit);


    // Planner Listeners
    document.getElementById('prev-month-btn').addEventListener('click', () => changeMonth(-1));
    document.getElementById('next-month-btn').addEventListener('click', () => changeMonth(1));
    document.getElementById('planner-search-input').addEventListener('input', debounce(renderCalendar, 300));
    document.getElementById('add-preventive-task-btn').addEventListener('click', () => showWorkOrderModal(null, 'Preventivo'));
    document.getElementById('add-corrective-task-btn-planner').addEventListener('click', () => showWorkOrderModal(null, 'Correctivo'));

    // Work Order Listeners
    document.getElementById('wo-machine-search').addEventListener('input', (e) => populateWorkOrderMachineSelector(e.target.value));
    document.getElementById('wo-type').addEventListener('change', handleWorkOrderTypeChange);
    document.getElementById('wo-save-btn').addEventListener('click', () => saveWorkOrder());
    document.getElementById('wo-start-btn').addEventListener('click', () => saveWorkOrder({ status: 'En Proceso' }));
    document.getElementById('wo-pause-btn').addEventListener('click', () => saveWorkOrder({ status: 'Pausado' }));
    document.getElementById('wo-resume-btn').addEventListener('click', () => saveWorkOrder({ status: 'En Proceso' }));
    document.getElementById('wo-complete-btn').addEventListener('click', () => saveWorkOrder({ status: 'Pendiente de Evaluaci칩n' }));
    document.getElementById('wo-validate-btn').addEventListener('click', async () => {
        const fbId = document.getElementById('wo-fb-id-hidden').value;
        const now = new Date().toISOString();
        await saveWorkOrder({
            status: 'Pendiente de Evaluaci칩n',
            validatedBy: state.currentUser.username
        });
        await completeLinkedPlanExecution(fbId, now, 'Pendiente de Evaluaci칩n', state.currentUser.username);
    });
    document.getElementById('wo-reject-btn').addEventListener('click', async () => {
        const fbId = document.getElementById('wo-fb-id-hidden').value;
        await saveWorkOrder({
            status: 'Pausado',
            fechaFinalizacionReal: null,
            totalWorkDurationMs: null,
            technicianFinished: false,
            validatedBy: null
        });
        showToast('Orden rechazada y devuelta a estado Pausado.', 'info');
    });
    document.getElementById('wo-add-part-btn').addEventListener('click', () => addPartToWorkOrder());
    document.getElementById('wo-submit-request-btn').addEventListener('click', handlePartRequestSubmit);
    document.getElementById('part-request-status-filter').addEventListener('change', renderPartRequests);
    document.getElementById('wo-add-support-technician-btn').addEventListener('click', handleAddSupportTechnicianClick);
    document.getElementById('wo-lead-technician-select').addEventListener('change', handleLeadTechnicianChange);

    // Manage Parts Modal Listeners
    document.getElementById('add-update-part-btn').addEventListener('click', handleAddOrUpdatePartInModal);
    document.getElementById('save-managed-parts-btn').addEventListener('click', handleSaveManagedParts);

    // Criteria Listeners
    document.getElementById('add-criteria-btn').addEventListener('click', () => showCriteriaModal());
    document.getElementById('criteria-form').addEventListener('submit', handleCriteriaSubmit);

    // Evaluation Listeners
    document.getElementById('evaluation-form').addEventListener('submit', handleEvaluationSubmit);

    // Report Listeners
    document.getElementById('report-machine-search').addEventListener('input', debounce(handleReportMachineSearch, 300));
    document.getElementById('report-machine-parts-search').addEventListener('input', debounce(handleReportMachinePartsSearch, 300));
    document.getElementById('report-wo-search').addEventListener('input', debounce(handleReportWoSearch, 300));
    document.getElementById('report-execution-search').addEventListener('input', debounce(handleReportExecutionSearch, 300));

    document.getElementById('generate-general-report-btn').addEventListener('click', generateGeneralReport);
    document.getElementById('generate-wo-report-btn').addEventListener('click', generateWorkOrderReport);
    document.getElementById('generate-machine-report-btn').addEventListener('click', generateMachineReport);
    document.getElementById('generate-machine-parts-report-btn').addEventListener('click', generateMachinePartsReport);
    document.getElementById('generate-single-wo-report-btn').addEventListener('click', generateSingleWorkOrderReport);
    document.getElementById('generate-global-report-btn').addEventListener('click', generateGlobalReport);
    document.getElementById('generate-execution-report-btn').addEventListener('click', generateExecutionReportPDF);
    document.getElementById('generate-technician-performance-report-btn').addEventListener('click', generateTechnicianPerformanceReport);
    document.getElementById('backup-db-btn').addEventListener('click', downloadBackup);
    document.getElementById('refresh-monitoring-btn').addEventListener('click', () => {
        renderSmartMonitoring();
        document.getElementById('last-update-text').textContent = 'Actualizado hace un momento';
    });

    // Monitoring Config Listeners
    document.getElementById('m-config-cancel-btn').addEventListener('click', hideMonitoringConfig);
    document.getElementById('m-config-save-btn').addEventListener('click', handleSaveMonitoringConfig);
    document.getElementById('m-config-add-var-btn').addEventListener('click', () => {
        document.getElementById('new-variable-name').value = '';
        state.modals.variableName.show();
    });

    document.getElementById('save-variable-name-btn').addEventListener('click', handleAddMonitoringVariable);
    document.getElementById('new-variable-name').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleAddMonitoringVariable();
    });

    // Threshold Inputs Listeners
    ['normal', 'warning', 'critical'].forEach(type => {
        document.getElementById(`m-threshold-${type}-min`).addEventListener('input', updateActiveVarThresholds);
        document.getElementById(`m-threshold-${type}-max`).addEventListener('input', updateActiveVarThresholds);
    });

    document.getElementById('technician-list').addEventListener('click', (e) => {
        const viewButton = e.target.closest('.view-profile-btn');
        const editButton = e.target.closest('.edit-tech');
        const deleteButton = e.target.closest('.delete-tech:not([disabled])');
        const reportButton = e.target.closest('.generate-single-tech-report-btn');

        if (viewButton) {
            showTechnicianProfileModal(viewButton.dataset.id);
        } else if (editButton) {
            showTechnicianModal(editButton.dataset.id);
        } else if (deleteButton) {
            deleteTechnician(deleteButton.dataset.id);
        } else if (reportButton) {
            generateTechnicianPerformanceReport(reportButton.dataset.username);
        }
    });


    // Dashboard Filters
    document.getElementById('dashboardDate').addEventListener('change', updateDashboardData);
    document.getElementById('dashboardWeek').addEventListener('change', updateDashboardData);
    document.getElementById('dashboard-period-select').addEventListener('change', handlePeriodChange);
    document.getElementById('dashboardMonth').addEventListener('change', () => {
        if (document.getElementById('dashboard-period-select').value === 'week') {
            populateWeekSelector();
        }
        updateDashboardData();
    });
    document.getElementById('dashboardYear').addEventListener('change', () => {
        if (document.getElementById('dashboard-period-select').value === 'week') {
            populateWeekSelector();
        }
        updateDashboardData();
    });
    document.getElementById('kpi-machine-select').addEventListener('change', updateDashboardData);

    const kanbanMonthFilter = document.getElementById('kanban-month-filter');
    if (kanbanMonthFilter) {
        kanbanMonthFilter.addEventListener('change', renderActiveWorkView);
    }

    const assignedMonthFilter = document.getElementById('assigned-month-filter');
    if (assignedMonthFilter) {
        assignedMonthFilter.addEventListener('change', renderAssignedOrders);
    }

    const solicitudesMonthFilter = document.getElementById('solicitudes-month-filter');
    if (solicitudesMonthFilter) {
        solicitudesMonthFilter.addEventListener('change', renderSolicitudes);
    }
    
    const statusIndicator = document.getElementById('connection-status-indicator');
    window.addEventListener('online', () => updateConnectionStatus(true));
    window.addEventListener('offline', () => updateConnectionStatus(false));
    updateConnectionStatus(navigator.onLine);

    // Plan Execution View Listeners
    const finishBtn = document.getElementById('execution-view-finish-btn');
    if (finishBtn) finishBtn.addEventListener('click', handleFinishPlanExecution);

    const pauseBtn = document.getElementById('execution-view-pause-btn');
    if (pauseBtn) pauseBtn.addEventListener('click', () => {
        const { execution } = state.currentExecution || {};
        if (execution && execution.status === 'Pausado') {
            handleResumePlanExecution();
        } else {
            handlePausePlanExecution();
        }
    });

    const closeBtn = document.getElementById('execution-view-close-btn');
    if (closeBtn) closeBtn.addEventListener('click', handleClosePlanExecution);

    // Odoo Config Listeners
    const odooForm = document.getElementById('odoo-config-form');
    if (odooForm) odooForm.addEventListener('submit', handleOdooConfigSubmit);

    const testOdooBtn = document.getElementById('test-odoo-btn');
    if (testOdooBtn) testOdooBtn.addEventListener('click', testOdooConnection);
}

// --- Odoo Configuration Functions ---
async function loadOdooSettings() {
    try {
        const querySnapshot = await getDocs(state.collections.settings);
        const odooDoc = querySnapshot.docs.find(d => d.id === 'odoo_config');

        if (odooDoc) {
            const data = odooDoc.data();
            document.getElementById('odoo-url').value = data.url || '';
            document.getElementById('odoo-db').value = data.db || '';
            document.getElementById('odoo-username').value = data.username || '';
            document.getElementById('odoo-apikey').value = data.apiKey || '';
            document.getElementById('odoo-proxy').value = data.proxyUrl || '';

            state.odoo = new OdooConnector(data.url, data.db, data.username, data.apiKey, data.proxyUrl);
            updateOdooStatus('Configurado', 'success');
            console.log("[Odoo Sync] Configuraci칩n de Odoo cargada correctamente.");

            // Intentar detectar la versi칩n de Odoo en segundo plano
            state.odoo.version().then(v => {
                if (v && v.server_version) {
                    state.odooVersion = parseInt(v.server_version);
                    console.log(`[Odoo Sync] Versi칩n de servidor detectada: ${v.server_version} (Major: ${state.odooVersion})`);
                }
            }).catch(err => console.warn("[Odoo Sync] No se pudo obtener la versi칩n de Odoo:", err));
        } else {
            console.log("[Odoo Sync] No hay configuraci칩n de Odoo guardada.");
        }
    } catch (error) {
        console.error("Error loading Odoo settings:", error);
    }
}

async function handleOdooConfigSubmit(e) {
    e.preventDefault();
    showLoading(true);

    const configData = {
        url: document.getElementById('odoo-url').value.trim(),
        db: document.getElementById('odoo-db').value.trim(),
        username: document.getElementById('odoo-username').value.trim(),
        apiKey: document.getElementById('odoo-apikey').value.trim(),
        proxyUrl: document.getElementById('odoo-proxy').value.trim()
    };

    try {
        await setDoc(doc(state.collections.settings, 'odoo_config'), configData);
        state.odoo = new OdooConnector(configData.url, configData.db, configData.username, configData.apiKey, configData.proxyUrl);
        updateOdooStatus('Guardado correctamente', 'success');
        showToast('Configuraci칩n de Odoo guardada', 'success');
    } catch (error) {
        console.error("Error saving Odoo config:", error);
        showToast('Error al guardar la configuraci칩n', 'error');
    } finally {
        showLoading(false);
    }
}

async function testOdooConnection() {
    const url = document.getElementById('odoo-url').value.trim();
    const db = document.getElementById('odoo-db').value.trim();
    const username = document.getElementById('odoo-username').value.trim();
    const apiKey = document.getElementById('odoo-apikey').value.trim();
    const proxyUrl = document.getElementById('odoo-proxy').value.trim();

    if (!url || !db || !username || !apiKey) {
        showToast('Complete todos los campos para probar la conexi칩n', 'warning');
        return;
    }

    // Validaci칩n de ayuda para el usuario
    if (db.includes('.odoo.com') || db.includes('http')) {
        showToast('Atenci칩n: El campo "Base de Datos" suele ser solo el nombre (ej: "miempresa"), no la URL completa.', 'warning');
    }

    showLoading(true);
    updateOdooStatus('Probando conexi칩n...', 'info');

    const tempConnector = new OdooConnector(url, db, username, apiKey, proxyUrl);

    try {
        const uid = await tempConnector.authenticate();
        if (uid) {
            // Detectar versi칩n
            const v = await tempConnector.version();
            if (v && v.server_version) {
                state.odooVersion = parseInt(v.server_version);
                console.log(`[Odoo Sync Test] Versi칩n detectada: ${v.server_version}`);
            }

            // Prueba adicional: verificar permisos de mantenimiento
            try {
                await tempConnector.searchRead('maintenance.equipment', [], ['id']);
                const verSuffix = state.odooVersion ? ` (Odoo ${state.odooVersion})` : '';
                updateOdooStatus(`Conexi칩n OK${verSuffix}`, 'success');
                showToast(`춰Conexi칩n exitosa${verSuffix} y permisos de Mantenimiento verificados!`, 'success');
            } catch (permError) {
                updateOdooStatus('Conexi칩n OK (Sin Permisos Mantenimiento)', 'warning');
                showToast('Conexi칩n exitosa, pero el usuario no tiene permisos para el m칩dulo de Mantenimiento.', 'warning');
                console.warn("Error de permisos Odoo:", permError);
            }
        } else {
             throw new Error("No se recibi칩 un UID v치lido.");
        }
    } catch (error) {
        console.error("Test Odoo error:", error);
        updateOdooStatus('Fallo en la conexi칩n: ' + error.message, 'danger');
        showToast('Fallo al conectar con Odoo: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}

function updateOdooStatus(message, type) {
    const indicator = document.getElementById('odoo-status-indicator');
    if (indicator) {
        indicator.textContent = message;
        indicator.className = `small text-${type}`;

        const icon = document.createElement('i');
        icon.className = `fas fa-circle me-1`;
        indicator.prepend(icon);
    }
}

// --- Auth & Permissions Functions ---
async function handleLogin(e) {
    e.preventDefault();
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    
    document.getElementById('login-text').classList.add('d-none');
    document.getElementById('login-spinner').classList.remove('d-none');
    document.getElementById('login-container').classList.add('loading');
    
    const hashedPassword = await hashPassword(password);
    const user = state.technicians.find(t => {
        if (t.username !== username) return false;
        if (t.passwordIsHashed) {
            return t.password === hashedPassword;
        } else {
            return t.password === password;
        }
    });
    
    if (user) {
        state.currentUser = user;

        // Aplicar preferencia de tema
        if (user.theme === 'dark') {
            document.body.classList.add('dark-mode');
            state.currentTheme = 'dark';
        } else {
            document.body.classList.remove('dark-mode');
            state.currentTheme = 'light';
        }
        updateChartsTheme();

        document.getElementById('login-overlay').classList.add('d-none');
        document.getElementById('app-wrapper').classList.remove('d-none');
        
        document.getElementById('user-display').textContent = user.username;
        document.getElementById('user-role').textContent = user.role;
        document.getElementById('user-avatar').src = `https://ui-avatars.com/api/?name=${user.username}&background=0D8ABC&color=fff`;
        
        document.getElementById('login-error').classList.add('d-none');
        
        showToast(`Bienvenido, ${user.username}`, 'success');
        
        setupRealtimeListeners(); // Re-setup listeners with correct user role
        applyUserPermissions();
    } else {
        document.getElementById('login-error').classList.remove('d-none');
        showToast('Usuario o contrase침a incorrectos', 'error');
    }
    
    document.getElementById('login-text').classList.remove('d-none');
    document.getElementById('login-spinner').classList.add('d-none');
    document.getElementById('login-container').classList.remove('loading');
}

function handleLogout(force = false) {
    if (force === true) {
        window.location.reload();
    } else {
        showConfirmation('Cerrar sesi칩n', '쮼st치 seguro de que desea cerrar la sesi칩n?', () => {
            window.location.reload();
        });
    }
}

let sessionTimeout;
function resetSessionTimeout() {
    if (sessionTimeout) clearTimeout(sessionTimeout);
    if (state.currentUser) {
        sessionTimeout = setTimeout(() => {
            handleLogout(true);
        }, 15 * 60 * 1000); // 15 minutos de inactividad
    }
}
['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart'].forEach(name => {
    document.addEventListener(name, resetSessionTimeout, true);
});

function applyUserPermissions() {
    if (!state.currentUser) return;

    const { role, permissions = [] } = state.currentUser;
    const allTabs = document.querySelectorAll('.nav-tab');

    allTabs.forEach(tab => {
         tab.style.display = 'none';
    });
     document.querySelector('.nav-tab[data-tab="dashboard"]').style.display = 'flex';


    let visibleTabs = [];

    switch (role) {
        case 'Admin':
            visibleTabs = ['monitoreo-inteligente', 'maquinaria', 'repuestos', 'proveedores', 'tecnicos', 'trabajo-activo', 'planificador', 'planes-trabajo', 'reportes', 'auditoria', 'solicitudes', 'evaluation-criteria', 'solicitudes-repuestos', 'configuracion'];
            break;
        case 'Planificador':
            visibleTabs = ['monitoreo-inteligente', 'maquinaria', 'repuestos', 'proveedores', 'trabajo-activo', 'planificador', 'planes-trabajo', 'reportes', 'solicitudes', 'ordenes-asignadas', 'solicitudes-repuestos'];
            break;
        case 'Jefe de Area':
            visibleTabs = ['monitoreo-inteligente', ...(permissions || [])];
            break;
        case 'Invitado':
            visibleTabs = ['monitoreo-inteligente', 'maquinaria', 'repuestos', 'proveedores', 'tecnicos', 'trabajo-activo', 'planificador', 'reportes'];
            break;
        case 'T칠cnico':
            visibleTabs = permissions.includes('all')
                ? ['monitoreo-inteligente', 'maquinaria', 'repuestos', 'proveedores', 'planificador', 'ordenes-asignadas', 'reportes']
                : ['monitoreo-inteligente', ...permissions];
            if(permissions.includes('ordenes-asignadas')) {
                 visibleTabs.push('trabajo-activo');
            }
            visibleTabs.push('solicitudes-repuestos');
            break;
        case 'Operario':
            visibleTabs = ['solicitudes', 'trabajo-activo', 'planificador', 'solicitudes-repuestos'];
            break;
    }

    visibleTabs.forEach(tabName => {
        const tab = document.querySelector(`.nav-tab[data-tab="${tabName}"]`);
        if (tab) tab.style.display = 'flex';
    });

    document.querySelectorAll('.admin-only').forEach(el => {
        el.style.display = (role === 'Admin') ? 'flex' : 'none';
    });

     const isAdmin = role === 'Admin';
     const isPlanner = role === 'Planificador';
     const canManageResources = isAdmin || isPlanner;
     const canManageUsers = isAdmin;
     const canPlan = isAdmin || isPlanner;

     document.getElementById('add-machine-btn').style.display = canManageResources ? 'inline-block' : 'none';
     document.getElementById('sync-all-machines-odoo-btn').style.display = (canManageResources && state.odoo) ? 'inline-block' : 'none';
     document.getElementById('add-part-btn').style.display = canManageResources ? 'inline-block' : 'none';
     document.getElementById('sync-all-parts-odoo-btn').style.display = (canManageResources && state.odoo) ? 'inline-block' : 'none';
     document.getElementById('add-proveedor-btn').style.display = canManageResources ? 'inline-block' : 'none';
     document.getElementById('add-technician-btn').style.display = canManageUsers ? 'inline-block' : 'none';
     document.getElementById('add-preventive-task-btn').style.display = canPlan ? 'inline-block' : 'none';
     document.getElementById('add-corrective-task-btn-planner').style.display = canPlan ? 'inline-block' : 'none';

    // Filter report options for Technicians
    const isTecnico = role === 'T칠cnico';
    const generalReportItem = document.getElementById('generate-general-report-btn')?.closest('.list-group-item');
    const woHistoryReportItem = document.getElementById('generate-wo-report-btn')?.closest('.list-group-item');
    const globalReportItem = document.getElementById('generate-global-report-btn')?.closest('.list-group-item');

    if (generalReportItem) generalReportItem.classList.toggle('d-none', isTecnico);
    if (woHistoryReportItem) woHistoryReportItem.classList.toggle('d-none', isTecnico);
    if (globalReportItem) globalReportItem.classList.toggle('d-none', isTecnico);

    updateMachineCriticidadChart();
    renderMachines();
    renderParts();
    renderProveedores();
    renderTechnicians();
}


// --- UI Functions ---
async function switchTab(tabName) {
    document.querySelectorAll('.main-content > .tab-content').forEach(tab => tab.classList.add('d-none'));
    document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
    
    document.getElementById(tabName).classList.remove('d-none');
    const activeTab = document.querySelector(`[data-tab="${tabName}"]`);
    activeTab.classList.add('active');
    
    document.getElementById('page-title').textContent = activeTab.innerText.trim();
    state.currentTab = tabName;

    document.getElementById('dashboard-date-filter').classList.toggle('d-none', tabName !== 'dashboard');


    if (tabName === 'maquinaria') renderMachines();
    if (tabName === 'monitoreo-inteligente') renderSmartMonitoring();
    if (tabName === 'solicitudes-repuestos') renderPartRequests();
    if (tabName === 'trabajo-activo') {
        const monthFilter = document.getElementById('kanban-month-filter');
        if (monthFilter && !monthFilter.value) {
            const now = new Date();
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            monthFilter.value = `${year}-${month}`;
        }
        renderActiveWorkView();
    }
    if (tabName === 'ordenes-asignadas') {
        const monthFilter = document.getElementById('assigned-month-filter');
        if (monthFilter && !monthFilter.value) {
            const now = new Date();
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            monthFilter.value = `${year}-${month}`;
        }
        renderAssignedOrders();
    }
    if (tabName === 'planificador') renderCalendar();
    if (tabName === 'evaluation-criteria') renderCriteria();
    if (tabName === 'auditoria') loadAuditLogs();
    if (tabName === 'solicitudes') {
        const monthFilter = document.getElementById('solicitudes-month-filter');
        if (monthFilter && !monthFilter.value) {
            const now = new Date();
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            monthFilter.value = `${year}-${month}`;
        }
        renderSolicitudes();
    }
    if (tabName === 'planes-trabajo') renderWorkPlans();
    if (tabName === 'configuracion') await loadOdooSettings();
}

function togglePasswordVisibility() {
    const passwordInput = document.getElementById('password');
    const icon = document.getElementById('password-toggle').querySelector('i');
    
    if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        icon.classList.replace('fa-eye', 'fa-eye-slash');
    } else {
        passwordInput.type = 'password';
        icon.classList.replace('fa-eye-slash', 'fa-eye');
    }
}

function toggleSidebar(forceState) {
    const sidebar = document.querySelector('.sidebar');
    const overlay = document.getElementById('sidebar-overlay');
    const mainContent = document.querySelector('.main-content');
    
    const show = forceState !== undefined ? forceState : !sidebar.classList.contains('show');

    if (show) {
        sidebar.classList.add('show');
        overlay.style.display = 'block';
        if(window.innerWidth < 992) {
           mainContent.style.marginLeft = '260px'; 
        }
    } else {
        sidebar.classList.remove('show');
        overlay.style.display = 'none';
        mainContent.style.marginLeft = '0';
    }
}

function showConfirmation(title, message, onConfirm) {
    document.getElementById('confirm-modal-title').textContent = title;
    document.getElementById('confirm-modal-body').textContent = message;
    
    const confirmBtn = document.getElementById('confirm-modal-btn');
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    
    const modalInstance = new bootstrap.Modal(document.getElementById('confirm-modal'));

    newConfirmBtn.addEventListener('click', () => {
        onConfirm();
        modalInstance.hide();
    });
    
    modalInstance.show();
}

function updateConnectionStatus(online) {
    const statusIndicator = document.getElementById('connection-status-indicator');
    state.isOnline = online;
    
    if (online) {
        statusIndicator.classList.remove('offline');
        statusIndicator.classList.remove('syncing');
        statusIndicator.title = 'Conectado';
        if (state.currentUser) showToast('Conexi칩n restablecida', 'success');
    } else {
        statusIndicator.classList.remove('syncing');
        statusIndicator.classList.add('offline');
        statusIndicator.title = 'Sin conexi칩n';
        if (state.currentUser) showToast('Se perdi칩 la conexi칩n. Algunas funciones pueden no estar disponibles.', 'warning');
    }
}

function updateCurrentDate() {
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    const currentDate = new Date().toLocaleDateString('es-ES', options);
    document.getElementById('current-date').textContent = currentDate.charAt(0).toUpperCase() + currentDate.slice(1);
}

function populateDateSelectors() {
    const monthSelect = document.getElementById('dashboardMonth');
    const yearSelect = document.getElementById('dashboardYear');
    const globalMonthSelect = document.getElementById('report-global-month');
    const globalYearSelect = document.getElementById('report-global-year');
    // REMOVED: const techMonthSelect = document.getElementById('report-technician-month');
    // REMOVED: const techYearSelect = document.getElementById('report-technician-year');
    const dateSelect = document.getElementById('dashboardDate');
    const now = new Date();
    const currentMonth = now.getMonth();
    const currentYear = now.getFullYear();

    const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

    if (monthSelect) {
        monthSelect.innerHTML = '';
        months.forEach((month, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = month;
            if (index === currentMonth) {
                option.selected = true;
            }
            monthSelect.appendChild(option);
        });
    }


    if (yearSelect) {
        yearSelect.innerHTML = '';
        for (let i = currentYear + 1; i >= currentYear - 5; i--) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = i;
            if (i === currentYear) {
                option.selected = true;
            }
            yearSelect.appendChild(option);
        }
    }

    if (globalYearSelect) {
        globalYearSelect.innerHTML = '';
        for (let i = currentYear + 1; i >= currentYear - 5; i--) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = i;
            if (i === currentYear) {
                option.selected = true;
            }
            globalYearSelect.appendChild(option);
        }
    }



    if (globalMonthSelect) {
        globalMonthSelect.innerHTML = '';
        months.forEach((month, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = month;
            if (index === currentMonth) {
                option.selected = true;
            }
            globalMonthSelect.appendChild(option);
        });
    }

    if (dateSelect) {
        dateSelect.value = now.toISOString().split('T')[0];
    }
}

function populateWeekSelector() {
    const weekSelect = document.getElementById('dashboardWeek');
    const month = parseInt(document.getElementById('dashboardMonth').value);
    const year = parseInt(document.getElementById('dashboardYear').value);
    weekSelect.innerHTML = '';

    const firstOfMonth = new Date(year, month, 1);
    const lastOfMonth = new Date(year, month + 1, 0);

    let weekStart = new Date(firstOfMonth);
    weekStart.setDate(weekStart.getDate() - weekStart.getDay()); // Start from Sunday of the first week

    let weekCounter = 1;
    while (weekStart <= lastOfMonth) {
        const weekEnd = new Date(weekStart);
        weekEnd.setDate(weekEnd.getDate() + 6);

        const option = document.createElement('option');
        option.value = `${weekStart.toISOString().split('T')[0]}|${weekEnd.toISOString().split('T')[0]}`;
        option.textContent = `Semana ${weekCounter}: ${weekStart.toLocaleDateString('es-ES')} - ${weekEnd.toLocaleDateString('es-ES')}`;
        weekSelect.appendChild(option);

        weekStart.setDate(weekStart.getDate() + 7);
        weekCounter++;
    }
}

function initCharts() {
    const chartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'top',
            },
        }
    };

    state.charts.maintenance = new Chart(document.getElementById('maintenanceChart').getContext('2d'), {
        type: 'doughnut',
        data: {
            labels: ['Preventivo', 'Correctivo'],
            datasets: [{
                label: 'Tipos de Mantenimiento',
                data: [0, 0],
                backgroundColor: ['#3498db', '#e74c3c'],
            }]
        },
        options: { ...chartOptions, plugins: { ...chartOptions.plugins, title: { display: true, text: 'Tipos de Mantenimiento' }}}
    });

    state.charts.machineCriticidad = new Chart(document.getElementById('machineCriticidadChart').getContext('2d'), {
        type: 'doughnut',
        data: {
            labels: ['Baja', 'Media', 'Alta'],
            datasets: [{
                data: [0, 0, 0],
                backgroundColor: ['#2ecc71', '#f39c12', '#e74c3c'],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '75%',
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
    
    state.charts.failureType = new Chart(document.getElementById('failureTypeChart').getContext('2d'), {
        type: 'bar',
        data: {
            labels: ['Mec치nica', 'El칠ctrica', 'Electr칩nica', 'Operaci칩n'],
            datasets: [{
                label: 'Tipos de Falla',
                data: [0, 0, 0, 0],
                backgroundColor: '#8e44ad',
            }]
        },
        options: { ...chartOptions, indexAxis: 'y', scales: { y: { beginAtZero: true }}, plugins: { ...chartOptions.plugins, title: { display: true, text: 'An치lisis de Fallas Correctivas' }}}
    });

    state.charts.taskStatus = new Chart(document.getElementById('taskStatusChart').getContext('2d'), {
        type: 'pie',
        data: {
            labels: ['Pendiente', 'En Proceso', 'Pausado', 'Pendiente de Evaluaci칩n', 'Completado', 'Cancelado'],
            datasets: [{
                label: 'Estado de Tareas',
                data: [0, 0, 0, 0, 0, 0],
                backgroundColor: ['#f39c12', '#3498db', '#6c757d', '#17a2b8', '#28a745', '#dc3545'],
            }]
        },
        options: { ...chartOptions, plugins: { ...chartOptions.plugins, title: { display: true, text: 'Estado de 칍rdenes de Trabajo' }}}
    });

    state.charts.correctiveTrends = new Chart(document.getElementById('correctiveTrendsChart').getContext('2d'), {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                {
                    label: 'Preventivos',
                    data: [],
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    fill: true,
                    tension: 0.3
                },
                {
                    label: 'Correctivos',
                    data: [],
                    borderColor: '#e74c3c',
                    backgroundColor: 'rgba(231, 76, 60, 0.1)',
                    fill: true,
                    tension: 0.3
                }
            ]
        },
        options: { ...chartOptions, plugins: { ...chartOptions.plugins, title: { display: true, text: 'Tendencia Mensual (칔ltimos 12 Meses)' }}}
    });
}

// --- HTML creation helpers for table rows ---
function createPartRowHTML(part, status) {
    let actionsHTML = '';
    const userRole = state.currentUser?.role;
    if(userRole === 'Admin' || userRole === 'Planificador') {
        actionsHTML = `
            <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-info view-part-detail" data-id="${part.id}" title="Ver Detalle">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-outline-secondary view-part-history" data-id="${part.id}" title="Ver Historial">
                    <i class="fas fa-history"></i>
                </button>
                <button class="btn btn-outline-primary edit-part" data-id="${part.id}" title="Editar">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-outline-danger delete-part" data-id="${part.id}" title="Eliminar">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
    } else {
        actionsHTML = `
            <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-info view-part-detail" data-id="${part.id}" title="Ver Detalle">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-outline-secondary view-part-history" data-id="${part.id}" title="Ver Historial">
                    <i class="fas fa-history"></i>
                </button>
            </div>
            <span class="text-muted fst-italic ms-1">Solo lectura</span>
        `;
    }

    const statusIcons = {
        critical: '<i class="fas fa-times-circle text-danger" title="Sin existencia"></i>',
        attention: '<i class="fas fa-exclamation-triangle text-warning" title="M칤nimo"></i>',
        operative: '<i class="fas fa-check-circle text-success" title="Operativo"></i>'
    };

    const statusDotClass = `bg-${status}`;
    const classificationMap = {
        insumo: { label: 'Insumo', class: 'bg-info text-dark' },
        mecanico: { label: 'Mec치nico', class: 'bg-secondary' },
        electrico: { label: 'El칠ctrico', class: 'bg-warning text-dark' },
        neumatico: { label: 'Neum치tico', class: 'bg-primary text-white' },
        repuesto: { label: 'Repuesto', class: 'bg-secondary' }
    };
    const classInfo = classificationMap[part.classification] || classificationMap['repuesto'];
    const classificationBadge = classInfo.class;
    const classificationText = classInfo.label;

    // L칩gica para m치quinas vinculadas
    let machineNames = 'N/A';
    const machineIds = part.machineIds || (part.machineId ? [part.machineId] : []);
    if (machineIds.length > 0) {
        if (machineIds.length === 1) {
            const machine = state.machines.find(m => m.id === machineIds[0]);
            machineNames = machine ? machine.name : machineIds[0];
        } else {
            machineNames = `<span class="badge bg-secondary">${machineIds.length} M치quinas</span>`;
        }
    }

    return `
        <td class="text-center">
            <div class="d-flex flex-column align-items-center gap-1">
                ${statusIcons[status]}
            </div>
        </td>
        <td><span class="part-id-badge">${part.id || 'N/A'}</span></td>
        <td>
            <div class="fw-bold text-wrap" style="max-width: 250px;">${part.description}</div>
            <div class="d-flex gap-2 mt-1">
                <span class="badge ${classificationBadge} x-small" style="font-size: 0.65rem;">${classificationText}</span>
            </div>
        </td>
        <td>
            <div class="small text-muted"><i class="fas fa-truck me-1"></i>${state.proveedores.find(s => s.id === part.supplierId)?.nombre || 'N/A'}</div>
        </td>
        <td>
            <div class="small text-muted"><i class="fas fa-cogs me-1"></i>${machineNames}</div>
        </td>
        <td>
            <div class="small text-muted"><i class="fas fa-map-marker-alt me-1"></i>${part.location || 'N/A'}</div>
        </td>
        <td class="text-center">
            <span class="badge ${status === 'critical' ? 'bg-danger' : (status === 'attention' ? 'bg-warning text-dark' : 'bg-success')} rounded-pill stock-badge-large">
                ${part.stock}
            </span>
        </td>
        <td class="text-center">
            <div class="small text-muted mb-1">M칤nimo</div>
            <span class="fw-bold">${part.minStock}</span>
        </td>
        <td class="text-center">
            ${actionsHTML}
        </td>
    `;
}

function createProveedorRowHTML(proveedor) {
    let actionsHTML = 'Sin permisos';
    const userRole = state.currentUser?.role;
    if(userRole === 'Admin' || userRole === 'Planificador') {
        actionsHTML = `
            <button class="btn btn-sm btn-outline-primary edit-proveedor" data-id="${proveedor.id}"><i class="fas fa-edit"></i></button> 
            <button class="btn btn-sm btn-outline-danger delete-proveedor" data-id="${proveedor.id}"><i class="fas fa-trash"></i></button>
        `;
    } else {
        actionsHTML = `<span class="text-muted fst-italic">Solo lectura</span>`;
    }
    return `
        <td>${proveedor.id}</td><td>${proveedor.nombre}</td><td>${proveedor.rtn || 'N/A'}</td>
        <td>${proveedor.telefono || 'N/A'}</td><td>${proveedor.direccion || 'N/A'}</td>
        <td>${proveedor.email || 'N/A'}</td><td class="text-center">${actionsHTML}</td>
    `;
}

// --- CRUD Machine Functions ---
function renderMachines() {
    const container = document.getElementById('machine-distribution-container');
    if (!container) return;
    const searchTerm = document.getElementById('search-machine-input').value.toLowerCase();
    container.innerHTML = '';

    // 1. Filter machines based on permissions and search term
    let machinesToRender = state.machines;
    if (state.currentUser?.role === 'Jefe de Area' && Array.isArray(state.currentUser.managedMachineIds)) {
        const managedIds = new Set(state.currentUser.managedMachineIds);
        machinesToRender = state.machines.filter(m => managedIds.has(m.id));
    } else if (state.currentUser?.role === 'T칠cnico' && Array.isArray(state.currentUser.equipoAsignado)) {
        const assignedIds = new Set(state.currentUser.equipoAsignado);
        machinesToRender = state.machines.filter(m => assignedIds.has(m.id));
    }

    const filteredMachines = machinesToRender.filter(m =>
        m.id.toLowerCase().includes(searchTerm) ||
        m.name.toLowerCase().includes(searchTerm) ||
        (m.location && m.location.toLowerCase().includes(searchTerm))
    );

    // 2. Summary stats for header pills
    let maintAltaCount = 0;
    let maintMediaCount = 0;
    let maintBajaCount = 0;

    const getMachineStatus = (machineId) => {
        const activeOrders = state.workOrders.filter(wo =>
            wo.machineId === machineId &&
            ['En Proceso', 'Pausado'].includes(wo.status)
        );
        const hasCorrective = activeOrders.some(wo => wo.type === 'Correctivo');
        const hasPreventive = activeOrders.some(wo => wo.type === 'Preventivo');

        if (hasCorrective) return 'parada';
        if (hasPreventive) return 'mantenimiento';
        return 'operando';
    };

    filteredMachines.forEach(m => {
        const status = getMachineStatus(m.id);
        if (status !== 'operando') {
            if (m.criticidad === 'Alta') maintAltaCount++;
            else if (m.criticidad === 'Media') maintMediaCount++;
            else if (m.criticidad === 'Baja') maintBajaCount++;
        }
    });

    const countAltaEl = document.getElementById('count-maint-alta');
    const countMediaEl = document.getElementById('count-maint-media');
    const countBajaEl = document.getElementById('count-maint-baja');

    if (countAltaEl) countAltaEl.textContent = maintAltaCount;
    if (countMediaEl) countMediaEl.textContent = maintMediaCount;
    if (countBajaEl) countBajaEl.textContent = maintBajaCount;

    // Actualizar resaltado de filtros activos
    document.querySelectorAll('.machine-summary-header .summary-pill').forEach(pill => {
        const label = pill.querySelector('.label').textContent;
        pill.classList.toggle('active-filter', state.machineMaintFilter === label);
    });

    // Aplicar filtro de mantenimiento si existe
    let machinesToShow = filteredMachines;
    if (state.machineMaintFilter) {
        machinesToShow = filteredMachines.filter(m => {
            const status = getMachineStatus(m.id);
            return status !== 'operando' && m.criticidad === state.machineMaintFilter;
        });
    }

    if (machinesToShow.length === 0) {
        container.innerHTML = '<div class="alert alert-light text-center">No se encontraron m치quinas con los criterios seleccionados.</div>';
        return;
    }

    // 3. Helper functions for card details
    const getNextMaint = (machineId) => {
        const plans = state.workPlans.filter(p => p.machineId === machineId);
        if (plans.length === 0) return 'N/A';
        const dates = plans.map(p => new Date(p.nextDueDate + 'T12:00:00')).filter(d => !isNaN(d.getTime()));
        if (dates.length === 0) return 'N/A';
        const nearest = new Date(Math.min(...dates));
        return nearest.toLocaleDateString('es-ES');
    };

    const getWorkStats = (machineId) => {
        // Solo contar 칩rdenes que no hayan sido canceladas o rechazadas
        const machineOrders = state.workOrders.filter(wo => wo.machineId === machineId && !['Cancelado', 'Rechazado'].includes(wo.status));
        return {
            correctivos: machineOrders.filter(wo => wo.type === 'Correctivo').length,
            preventivos: machineOrders.filter(wo => wo.type === 'Preventivo').length
        };
    };

    // 4. Group machines by location
    const machinesByLocation = machinesToShow.reduce((acc, machine) => {
        const location = machine.location || 'Sin Ubicaci칩n';
        if (!acc[location]) acc[location] = [];
        acc[location].push(machine);
        return acc;
    }, {});

    const criticalityOrder = { 'Alta': 0, 'Media': 1, 'Baja': 2 };

    // 5. Render groups and cards
    Object.entries(machinesByLocation).forEach(([location, machines], index) => {
        // Sort machines by criticality (Higher first)
        machines.sort((a, b) => (criticalityOrder[a.criticidad || 'Baja'] || 2) - (criticalityOrder[b.criticidad || 'Baja'] || 2));

        const groupAlta = machines.filter(m => m.criticidad === 'Alta').length;
        const groupMedia = machines.filter(m => m.criticidad === 'Media').length;
        const groupBaja = machines.filter(m => m.criticidad === 'Baja').length;

        const collapseId = `collapse-machine-loc-${index}`;
        const groupEl = document.createElement('div');
        groupEl.className = 'machine-zone mb-4';

        let cardsHTML = machines.map(m => {
            const status = getMachineStatus(m.id);
            const statusLabels = { 'parada': 'Parada (Correctivo)', 'mantenimiento': 'En Mantenimiento', 'operando': 'Operando' };
            const nextMaint = getNextMaint(m.id);
            const stats = getWorkStats(m.id);
            const critClass = (m.criticidad || 'Baja').toLowerCase();
            const typeText = m.type === 'instalacion' ? 'Instalaci칩n' : 'M치quina';

            let actionsHTML = '';
            const userRole = state.currentUser?.role;
            const canEdit = (userRole === 'Admin' || userRole === 'Planificador');
            actionsHTML = `
                <div class="dropdown card-dist-actions">
                    <button class="btn btn-link dropdown-toggle no-caret" type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item view-machine-detail" href="#" data-id="${m.id}"><i class="fas fa-eye me-2"></i>Ver Detalle</a></li>
                        ${canEdit ? `
                            <li><a class="dropdown-item edit-machine" href="#" data-id="${m.id}"><i class="fas fa-edit me-2"></i>Editar</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item delete-machine text-danger" href="#" data-id="${m.id}"><i class="fas fa-trash me-2"></i>Eliminar</a></li>
                        ` : ''}
                    </ul>
                </div>
            `;

            return `
                <div class="machine-card-dist border-${critClass}">
                    <div class="card-dist-header">
                        <span class="card-dist-id">${m.id}</span>
                        ${actionsHTML}
                    </div>
                    <h5 class="card-dist-title clickable-detail" data-id="${m.id}" style="cursor: pointer;">${m.name}</h5>
                    <div class="card-dist-type">${typeText}</div>

                    <div class="card-dist-status">
                        <div class="status-indicator-dot ${status}"></div>
                        <span>${statusLabels[status]}</span>
                    </div>

                    <div class="card-dist-info-row">
                        <span class="card-dist-info-label">Criticidad:</span>
                        <span class="card-dist-info-value">${m.criticidad || 'Baja'}</span>
                    </div>
                    <div class="card-dist-info-row">
                        <span class="card-dist-info-label">Pr칩ximo Maint.:</span>
                        <span class="card-dist-info-value">${nextMaint}</span>
                    </div>

                    <div class="card-dist-stats">
                        <div class="stat-pill correctivos show-history" data-machine-id="${m.id}" data-type="Correctivo" style="cursor: pointer;" title="Ver historial de correctivos">
                            <span class="stat-count">${stats.correctivos}</span>
                            <span>Correctivos</span>
                        </div>
                        <div class="stat-pill preventivos show-history" data-machine-id="${m.id}" data-type="Preventivo" style="cursor: pointer;" title="Ver historial de preventivos">
                            <span class="stat-count">${stats.preventivos}</span>
                            <span>Preventivos</span>
                        </div>
                    </div>
                </div>
            `;
        }).join('');

        groupEl.innerHTML = `
            <div class="zone-header collapsed" data-bs-toggle="collapse" data-bs-target="#${collapseId}" aria-expanded="false" role="button">
                <div class="d-flex align-items-center gap-3">
                    <span><i class="fas fa-map-marker-alt me-2"></i>${location.toUpperCase()}</span>
                    <span class="badge bg-primary text-white rounded-pill shadow-sm">${machines.length}</span>
                </div>
                <div class="header-stats d-none d-md-flex gap-2 ms-4">
                    ${groupAlta > 0 ? `<span class="badge rounded-pill bg-danger" style="font-size: 0.7rem;">${groupAlta} Alta</span>` : ''}
                    ${groupMedia > 0 ? `<span class="badge rounded-pill bg-warning text-dark" style="font-size: 0.7rem;">${groupMedia} Media</span>` : ''}
                    ${groupBaja > 0 ? `<span class="badge rounded-pill bg-success" style="font-size: 0.7rem;">${groupBaja} Baja</span>` : ''}
                </div>
                <i class="fas fa-chevron-down transition-icon ms-auto"></i>
            </div>
            <div id="${collapseId}" class="collapse">
                <div class="border-start border-end border-bottom rounded-bottom shadow-sm" style="background-color: var(--card-bg);">
                    <div class="cards-grid">
                        ${cardsHTML}
                    </div>
                </div>
            </div>
        `;
        container.appendChild(groupEl);
    });

    // 6. Re-attach listeners
    container.querySelectorAll('.view-machine-detail, .clickable-detail').forEach(btn => btn.addEventListener('click', (e) => {
        e.preventDefault();
        showMachineDetail(btn.dataset.id);
    }));
    container.querySelectorAll('.edit-machine').forEach(btn => btn.addEventListener('click', (e) => {
        e.preventDefault();
        showMachineModal(btn.dataset.id);
    }));
    container.querySelectorAll('.delete-machine').forEach(btn => btn.addEventListener('click', (e) => {
        e.preventDefault();
        deleteMachine(btn.dataset.id);
    }));

    container.querySelectorAll('.show-history').forEach(pill => pill.addEventListener('click', () => {
        showMachineHistory(pill.dataset.machineId, pill.dataset.type);
    }));
}

function showMachineDetail(machineId) {
    const machine = state.machines.find(m => m.id === machineId);
    if (!machine) return;

    const container = document.getElementById('machine-detail-view-container');
    const actionsTop = document.getElementById('machine-detail-actions-top');

    // Status Logic
    const activeOrders = state.workOrders.filter(wo => wo.machineId === machineId && ['En Proceso', 'Pausado'].includes(wo.status));
    const hasCorrective = activeOrders.some(wo => wo.type === 'Correctivo');
    const hasPreventive = activeOrders.some(wo => wo.type === 'Preventivo');

    let statusLabel = 'Operativo / Calificado';
    let statusClass = 'success';
    let statusBg = '#10b981';
    if (hasCorrective) {
        statusLabel = 'Parado / Falla Cr칤tica';
        statusClass = 'danger';
        statusBg = '#ef4444';
    } else if (hasPreventive) {
        statusLabel = 'En Mantenimiento';
        statusClass = 'warning';
        statusBg = '#f59e0b';
    }

    // IQ/OQ/PQ Logic for styling
    const iqVal = machine.iqStatus ? 'Validado' : 'Pendiente';
    const oqVal = machine.oqStatus ? 'Validado' : 'Pendiente';
    const pqVal = machine.pqStatus ? 'Vigente' : 'Vencido/Pendiente';

    // History and Parts
    const orders = state.workOrders
        .filter(wo => wo.machineId === machineId && wo.type === 'Preventivo')
        .sort((a, b) => new Date((b.date || '1970-01-01') + 'T12:00:00Z') - new Date((a.date || '1970-01-01') + 'T12:00:00Z'))
        .slice(0, 5);

    const criticalityOrder = { 'Cr칤tico': 4, 'Alto': 3, 'Medio': 2, 'Bajo': 1 };
    const linkedParts = state.parts
        .filter(p => p.machineIds && p.machineIds.includes(machineId))
        .sort((a, b) => {
            const critA = criticalityOrder[a.criticality || 'Bajo'] || 0;
            const critB = criticalityOrder[b.criticality || 'Bajo'] || 0;
            if (critA !== critB) return critB - critA;
            return (a.stock || 0) - (b.stock || 0);
        })
        .slice(0, 5);

    // Top Actions
    actionsTop.innerHTML = `
        <button class="btn btn-sm btn-outline-secondary me-2 edit-machine-from-detail" data-id="${machine.id}"><i class="fas fa-edit me-1"></i>Editar</button>
        <button class="btn btn-sm btn-outline-secondary me-2 print-machine-label"><i class="fas fa-print me-1"></i>Imprimir</button>
    `;

    // Main Content
    container.innerHTML = `
        <div class="px-4 py-4">
            <div class="mb-4 d-flex justify-content-between align-items-start flex-wrap gap-3">
                <div>
                    <div class="d-flex align-items-center gap-3 mb-1">
                        <h2 class="h3 fw-bold mb-0">${machine.name}</h2>
                        <span class="status-tag">
                            <span class="rounded-circle" style="width: 8px; height: 8px; background-color: ${statusBg};"></span>
                            ${statusLabel}
                        </span>
                    </div>
                    <p class="text-muted mb-0">ID del Activo: <span class="text-primary-custom fw-bold">${machine.id}</span></p>
                </div>
            </div>

            <div class="row g-4">
                <aside class="col-lg-4">
                    <section class="section-card overflow-hidden">
                        <div class="p-3 bg-light border-bottom">
                            <h6 class="fw-bold mb-0">Imagen del Equipo</h6>
                        </div>
                        <div class="p-4 text-center d-flex align-items-center justify-content-center" style="min-height: 200px;">
                            ${machine.imageUrl ?
                                `<img src="${machine.imageUrl}" alt="${machine.name}" class="img-fluid rounded shadow-sm border" style="max-height: 250px; object-fit: contain;">` :
                                `<div class="text-muted"><i class="fas fa-image fa-4x mb-2 d-block"></i>Sin Imagen</div>`
                            }
                        </div>
                    </section>

                    <section class="section-card">
                        <div class="p-3 bg-light border-bottom">
                            <h6 class="fw-bold mb-0">Acceso R치pido</h6>
                        </div>
                        <div class="p-4 text-center">
                            <div class="d-inline-block p-3 border rounded-3 mb-3 shadow-sm">
                                <i class="fas fa-qrcode fa-5x"></i>
                            </div>
                            <p class="small text-muted text-uppercase fw-bold mb-0" style="font-size: 0.65rem; letter-spacing: 1px;">Escanee para historial r치pido</p>
                        </div>
                    </section>
                </aside>

                <div class="col-lg-8">
                    <section class="section-card p-4">
                        <h5 class="fw-bold mb-4 text-primary-custom d-flex align-items-center gap-2">
                            <i class="fas fa-file-contract"></i> Clasificaci칩n T칠cnica y Regulatoria del Activo
                        </h5>
                        <div class="row g-4">
                            <div class="col-md-4">
                                <p class="label-text">Marca</p>
                                <p class="value-text">${machine.brand || 'N/A'}</p>
                            </div>
                            <div class="col-md-4">
                                <p class="label-text">Modelo</p>
                                <p class="value-text">${machine.model || 'N/A'}</p>
                            </div>
                            <div class="col-md-4">
                                <p class="label-text">N칰mero de Serie</p>
                                <p class="value-text font-mono">${machine.serialNumber || 'N/A'}</p>
                            </div>
                            <div class="col-md-4">
                                <p class="label-text">Impacto en Calidad del Producto</p>
                                <p class="value-text">${['Directo', 'Indirecto'].includes(machine.riskClassification) ? machine.riskClassification : 'N/A'}</p>
                            </div>
                            <div class="col-md-4">
                                <p class="label-text">Ubicaci칩n</p>
                                <p class="value-text">${machine.location || 'N/A'}</p>
                            </div>
                            <div class="col-md-4">
                                <p class="label-text">Fecha de Compra</p>
                                <p class="value-text">${machine.purchaseDate || 'N/A'}</p>
                            </div>
                            <div class="col-md-4">
                                <p class="label-text">Puesta en Marcha</p>
                                <p class="value-text">${machine.commissioningDate || 'N/A'}</p>
                            </div>
                        </div>
                    </section>

                    <section class="section-card p-4">
                        <h5 class="fw-bold mb-4 text-primary-custom d-flex align-items-center gap-2">
                            <i class="fas fa-certificate"></i> Estado de Calificaci칩n (IQ/OQ/PQ)
                        </h5>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="p-3 border rounded ${machine.iqStatus ? 'bg-success bg-opacity-10 border-success' : 'bg-light'}">
                                    <p class="small fw-bold text-muted text-uppercase mb-1" style="font-size: 0.65rem;">IQ - Instalaci칩n</p>
                                    <p class="fw-bold mb-0 ${machine.iqStatus ? 'text-success' : 'text-secondary'}">${iqVal}</p>
                                    <p class="small text-muted mb-0" style="font-size: 0.7rem;">Fecha: ${machine.iqDate || 'N/A'}</p>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="p-3 border rounded ${machine.oqStatus ? 'bg-success bg-opacity-10 border-success' : 'bg-light'}">
                                    <p class="small fw-bold text-muted text-uppercase mb-1" style="font-size: 0.65rem;">OQ - Operaci칩n</p>
                                    <p class="fw-bold mb-0 ${machine.oqStatus ? 'text-success' : 'text-secondary'}">${oqVal}</p>
                                    <p class="small text-muted mb-0" style="font-size: 0.7rem;">Fecha: ${machine.oqDate || 'N/A'}</p>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="p-3 border rounded ${machine.pqStatus ? 'bg-primary bg-opacity-10 border-primary' : 'bg-light'}">
                                    <p class="small fw-bold text-muted text-uppercase mb-1" style="font-size: 0.65rem;">PQ - Desempe침o</p>
                                    <p class="fw-bold mb-0 ${machine.pqStatus ? 'text-primary' : 'text-secondary'}">${pqVal}</p>
                                    <p class="small text-muted mb-0" style="font-size: 0.7rem;">Vencimiento: ${machine.pqNextDate || 'N/A'}</p>
                                </div>
                            </div>
                        </div>
                    </section>

                    <section class="section-card overflow-hidden">
                        <div class="p-4">
                            <h5 class="fw-bold mb-4 text-primary-custom d-flex align-items-center gap-2">
                                <i class="fas fa-calendar-check"></i> Mantenimientos Programados
                            </h5>
                            <div class="table-responsive p-0 shadow-none border-0">
                                <table class="table table-hover mb-0">
                                    <thead class="bg-light">
                                        <tr>
                                            <th class="small fw-bold text-muted text-uppercase" style="font-size: 0.65rem;">ID</th>
                                            <th class="small fw-bold text-muted text-uppercase" style="font-size: 0.65rem;">Fecha</th>
                                            <th class="small fw-bold text-muted text-uppercase" style="font-size: 0.65rem;">Tipo</th>
                                            <th class="small fw-bold text-muted text-uppercase" style="font-size: 0.65rem;">T칠cnico</th>
                                            <th class="small fw-bold text-muted text-uppercase" style="font-size: 0.65rem;">Estado</th>
                                            <th class="small fw-bold text-muted text-uppercase" style="font-size: 0.65rem;">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${orders.length > 0 ? orders.map(o => {
                                            let statusClass = 'bg-light text-dark';
                                            if (['En Proceso', 'Pausado'].includes(o.status)) statusClass = 'bg-info text-dark';
                                            if (o.status === 'Completado') statusClass = 'bg-success';
                                            if (o.status === 'Cancelado') statusClass = 'bg-danger';
                                            if (o.status === 'Pendiente de Evaluaci칩n' || o.status === 'Pendiente de Aprobaci칩n') statusClass = 'bg-warning text-dark';

                                            return `
                                                <tr>
                                                    <td class="small fw-bold">${o.id}</td>
                                                    <td class="small">${o.date || 'N/A'}</td>
                                                    <td><span class="badge ${o.type === 'Preventivo' ? 'bg-info' : 'bg-danger'}" style="font-size: 0.6rem;">${o.type}</span></td>
                                                    <td class="small">${o.leadTechnician || (o.technicians && o.technicians[0]) || 'N/A'}</td>
                                                    <td><span class="badge ${statusClass}" style="font-size: 0.6rem;">${o.status}</span></td>
                                                    <td>
                                                        <button class="btn btn-sm btn-outline-primary view-wo-from-detail-history" data-id="${o.fb_id || o.id}">
                                                            <i class="fas fa-eye"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            `;
                                        }).join('') : '<tr><td colspan="6" class="text-center text-muted py-3">No hay registros</td></tr>'}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </section>

                    <section class="section-card overflow-hidden">
                        <div class="p-4">
                            <h5 class="fw-bold mb-4 text-primary-custom d-flex align-items-center gap-2">
                                <i class="fas fa-box-open"></i> Repuestos Vinculados
                            </h5>
                            <div class="table-responsive p-0 shadow-none border-0">
                                <table class="table table-hover mb-0">
                                    <thead class="bg-light">
                                        <tr>
                                            <th class="small fw-bold text-muted text-uppercase" style="font-size: 0.65rem;">Repuesto</th>
                                            <th class="small fw-bold text-muted text-uppercase" style="font-size: 0.65rem;">ID</th>
                                            <th class="small fw-bold text-muted text-uppercase" style="font-size: 0.65rem;">Stock</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${linkedParts.length > 0 ? linkedParts.map(p => `
                                            <tr>
                                                <td class="small">
                                                    <div class="d-flex align-items-center gap-2">
                                                        ${p.imageUrl ? `<img src="${p.imageUrl}" class="rounded border" style="width: 32px; height: 32px; object-fit: cover;">` : '<div class="rounded border bg-light d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;"><i class="fas fa-box text-muted" style="font-size: 0.7rem;"></i></div>'}
                                                        <span class="fw-bold text-wrap" style="max-width: 200px;">${p.description}</span>
                                                    </div>
                                                </td>
                                                <td class="small font-mono">${p.id}</td>
                                                <td class="small fw-bold ${p.stock <= p.minStock ? 'text-danger' : ''}">${p.stock}</td>
                                            </tr>
                                        `).join('') : '<tr><td colspan="3" class="text-center text-muted py-3">No hay repuestos vinculados</td></tr>'}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </section>

                    <section class="section-card p-4">
                        <h5 class="fw-bold mb-4 text-primary-custom d-flex align-items-center gap-2">
                            <i class="fas fa-book"></i> Centro de Documentaci칩n
                        </h5>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="d-flex align-items-center p-2 border rounded ${machine.userManualUrl ? 'hover-bg-light cursor-pointer download-user-manual' : 'opacity-50'}">
                                    <div class="bg-danger bg-opacity-10 text-danger p-2 rounded me-3">
                                        <i class="fas fa-file-pdf"></i>
                                    </div>
                                    <div>
                                        <p class="small fw-bold mb-0">Manual de Usuario</p>
                                        <p class="text-muted mb-0" style="font-size: 0.7rem;">${machine.userManualUrl ? 'Manual del fabricante' : 'No disponible'}</p>
                                    </div>
                                    <i class="fas fa-download ms-auto text-muted"></i>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex align-items-center p-2 border rounded ${machine.techManualUrl ? 'hover-bg-light cursor-pointer download-tech-manual' : 'opacity-50'}">
                                    <div class="bg-primary bg-opacity-10 text-primary p-2 rounded me-3">
                                        <i class="fas fa-file-pdf"></i>
                                    </div>
                                    <div>
                                        <p class="small fw-bold mb-0">Manual T칠cnico</p>
                                        <p class="text-muted mb-0" style="font-size: 0.7rem;">${machine.techManualUrl ? 'Diagramas y esquemas' : 'No disponible'}</p>
                                    </div>
                                    <i class="fas fa-download ms-auto text-muted"></i>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
            </div>
        </div>
    `;

    // Re-attach listeners for buttons inside the modal
    actionsTop.querySelector('.edit-machine-from-detail')?.addEventListener('click', () => {
        state.modals.machineDetail.hide();
        showMachineModal(machine.id);
    });

    container.querySelector('.download-user-manual')?.addEventListener('click', () => {
        if (machine.userManualUrl) window.open(machine.userManualUrl, '_blank');
    });

    container.querySelector('.download-tech-manual')?.addEventListener('click', () => {
        if (machine.techManualUrl) window.open(machine.techManualUrl, '_blank');
    });

    container.querySelectorAll('.view-wo-from-detail-history').forEach(btn => {
        btn.addEventListener('click', () => {
            state.modals.machineDetail.hide();
            showWorkOrderModal(btn.dataset.id);
        });
    });

    // Add listeners for Print button
    actionsTop.querySelector('.print-machine-label')?.addEventListener('click', () => {
        showLoading(true);
        generateFichaMaestra(machine.id);
    });

    state.modals.machineDetail.show();
}

async function showPartDetail(partId) {
    const part = state.parts.find(p => p.id === partId);
    if (!part) {
        showToast('Repuesto no encontrado', 'error');
        return;
    }

    const contentContainer = document.getElementById('part-detail-content');
    contentContainer.innerHTML = `
        <div class="p-5 text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-2">Cargando detalles...</p>
        </div>
    `;

    state.modals.partDetail.show();

    // Fetch last 5 movements
    let movements = [];
    try {
        const q = query(state.collections.partMovements, where('partId', '==', partId), orderBy('date', 'desc'), limit(5));
        const querySnapshot = await getDocs(q);
        querySnapshot.forEach(docSnap => {
            movements.push({ fb_id: docSnap.id, ...docSnap.data() });
        });
    } catch (error) {
        console.error("Error fetching movements for detail:", error);
    }

    renderPartDetailHTML(part, movements);
}

function renderPartDetailHTML(part, movements) {
    const contentContainer = document.getElementById('part-detail-content');

    const classificationMap = {
        insumo: { label: 'Insumo', class: 'bg-info text-dark' },
        mecanico: { label: 'Mec치nico', class: 'bg-secondary' },
        electrico: { label: 'El칠ctrico', class: 'bg-warning text-dark' },
        neumatico: { label: 'Neum치tico', class: 'bg-primary text-white' },
        repuesto: { label: 'Repuesto', class: 'bg-secondary' }
    };
    const classInfo = classificationMap[part.classification] || classificationMap['repuesto'];

    // Movements table rows
    let movementsHTML = '';
    if (movements.length === 0) {
        movementsHTML = '<tr><td colspan="4" class="text-center text-muted py-4">No hay movimientos registrados</td></tr>';
    } else {
        movements.forEach(m => {
            const qtyClass = m.quantity > 0 ? 'text-success' : 'text-danger';
            const qtyPrefix = m.quantity > 0 ? '+' : '';
            const actionDotColor = m.quantity > 0 ? '#10b981' : '#ef4444';

            movementsHTML += `
                <tr class="hover-bg-light transition-colors">
                    <td class="px-3 py-3 text-muted small">${new Date(m.date).toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: 'numeric' })}</td>
                    <td class="px-3 py-3">
                        <div class="d-flex align-items-center gap-2">
                            <span class="rounded-circle" style="width: 8px; height: 8px; background-color: ${actionDotColor};"></span>
                            <span class="small fw-medium">${m.type}</span>
                        </div>
                    </td>
                    <td class="px-3 py-3 fw-bold ${qtyClass}">${qtyPrefix}${m.quantity}</td>
                    <td class="px-3 py-3">
                        <span class="badge bg-light text-dark border font-monospace small" style="font-size: 0.75rem;">${m.details?.details || '-'}</span>
                    </td>
                </tr>
            `;
        });
    }

    contentContainer.innerHTML = `
        <!-- Header -->
        <div class="sticky-top border-bottom px-4 py-3 d-flex align-items-center justify-content-between" style="z-index: 1020; background-color: var(--modal-bg);">
            <div class="d-flex align-items-center gap-3">
                <button class="btn btn-link p-0 d-flex align-items-center justify-content-center" data-bs-dismiss="modal" style="width: 32px; height: 32px; border-radius: 50%; color: inherit;">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h5 class="fw-bold mb-0">Ficha de Repuesto</h5>
            </div>
            <button class="btn btn-link text-primary-custom fw-bold text-decoration-none" onclick="state.modals.partDetail.hide(); showPartModal('${part.id}')">
                Editar
            </button>
        </div>

        <div class="modal-body p-4 scrollable-content" style="background-color: var(--content-bg);">
            <!-- Top Section: Image & Basic Info -->
            <section class="row g-4 mb-4 bg-white p-4 rounded-3 border mx-0 shadow-sm">
                <div class="col-md-4">
                    <div class="ratio ratio-1x1 rounded-3 overflow-hidden bg-light border d-flex align-items-center justify-content-center shadow-sm">
                        ${part.imageUrl ?
                            `<img src="${part.imageUrl}" alt="${part.description}" class="img-fluid object-fit-cover">` :
                            `<div class="text-muted text-center"><i class="fas fa-box-open fa-3x mb-2 d-block"></i>Sin Imagen</div>`
                        }
                    </div>
                </div>
                <div class="col-md-8 d-flex flex-column justify-content-between">
                    <div>
                        <div class="d-flex align-items-center gap-2 mb-2">
                            <span class="badge ${classInfo.class} text-uppercase px-2 py-1" style="font-size: 0.7rem; letter-spacing: 0.05em;">${classInfo.label}</span>
                            <span class="text-muted small">ID: ${part.id}</span>
                        </div>
                        <h2 class="h3 fw-bold mb-2">${part.description}</h2>
                        <p class="text-muted small mb-4">${part.location ? `Ubicado en ${part.location}. ` : ''}Clasificado como ${classInfo.label}.</p>
                    </div>

                    <!-- Stock Badge -->
                    <div class="d-inline-flex align-items-center gap-3 p-3 rounded-3 border" style="background-color: rgba(236, 91, 19, 0.05); border-color: rgba(236, 91, 19, 0.2) !important; width: fit-content;">
                        <div class="rounded-circle d-flex align-items-center justify-content-center text-white shadow-sm" style="width: 48px; height: 48px; background-color: #ec5b13;">
                            <i class="fas fa-boxes-stacked"></i>
                        </div>
                        <div>
                            <p class="text-uppercase fw-bold text-primary-custom mb-0" style="font-size: 0.65rem; letter-spacing: 0.1em;">Stock Disponible</p>
                            <p class="h2 fw-bold mb-0">${part.stock} <span class="h5 fw-medium opacity-50 mb-0">unidades</span></p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Info Grid -->
            <section class="row g-3 mb-4">
                <div class="col-sm-4">
                    <div class="bg-white p-3 rounded-3 border d-flex gap-3 h-100 shadow-sm">
                        <i class="fas fa-store text-primary-custom mt-1"></i>
                        <div>
                            <p class="text-uppercase fw-bold text-muted mb-1" style="font-size: 0.65rem;">Proveedor</p>
                            <p class="fw-bold mb-0 small">${part.supplier || 'N/A'}</p>
                        </div>
                    </div>
                </div>
                <div class="col-sm-4">
                    <div class="bg-white p-3 rounded-3 border d-flex gap-3 h-100 shadow-sm">
                        <i class="fas fa-location-dot text-primary-custom mt-1"></i>
                        <div>
                            <p class="text-uppercase fw-bold text-muted mb-1" style="font-size: 0.65rem;">Ubicaci칩n</p>
                            <p class="fw-bold mb-0 small">${part.location || 'N/A'}</p>
                        </div>
                    </div>
                </div>
                <div class="col-sm-4">
                    <div class="bg-white p-3 rounded-3 border d-flex gap-3 h-100 shadow-sm">
                        <i class="fas fa-tag text-primary-custom mt-1"></i>
                        <div>
                            <p class="text-uppercase fw-bold text-muted mb-1" style="font-size: 0.65rem;">Clasificaci칩n</p>
                            <p class="fw-bold mb-0 small">${classInfo.label}</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- History Table -->
            <section class="bg-white rounded-3 border shadow-sm overflow-hidden">
                <div class="p-3 border-bottom d-flex justify-content-between align-items-center bg-light">
                    <h6 class="fw-bold mb-0 d-flex align-items-center gap-2">
                        <i class="fas fa-history text-muted"></i>
                        칔ltimos 5 Movimientos
                    </h6>
                    <button class="btn btn-link btn-sm text-muted text-decoration-none fw-bold" onclick="state.modals.partDetail.hide(); showPartHistoryModal('${part.id}')">Ver todos</button>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0" style="font-size: 0.85rem;">
                        <thead class="bg-light text-muted text-uppercase" style="font-size: 0.65rem; letter-spacing: 0.05em;">
                            <tr>
                                <th class="px-3 py-2 border-0">Fecha</th>
                                <th class="px-3 py-2 border-0">Acci칩n</th>
                                <th class="px-3 py-2 border-0">Cantidad</th>
                                <th class="px-3 py-2 border-0">Referencia / OT</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y">
                            ${movementsHTML}
                        </tbody>
                    </table>
                </div>
            </section>
        </div>
    `;
}

async function generateFichaMaestra(machineId) {
    const machine = state.machines.find(m => m.id === machineId);
    if (!machine) {
        showLoading(false);
        return;
    }

    // Create a hidden but layout-active iframe
    const iframe = document.createElement('iframe');
    iframe.style.position = 'fixed';
    iframe.style.top = '0';
    iframe.style.left = '0';
    iframe.style.width = '210mm';
    iframe.style.height = '297mm';
    iframe.style.opacity = '0';
    iframe.style.pointerEvents = 'none';
    iframe.style.zIndex = '-1';
    document.body.appendChild(iframe);

    const doc = iframe.contentWindow.document;
    doc.open();
    doc.write(FICHA_MAESTRA_TEMPLATE);
    doc.close();

    // Wait for Tailwind to load and be ready
    await new Promise(resolve => {
        const timeout = setTimeout(resolve, 3000);
        const check = () => {
            if (iframe.contentWindow.tailwind) {
                clearTimeout(timeout);
                resolve();
            } else {
                setTimeout(check, 100);
            }
        };
        check();
    });

    // Populate the iframe data
    const t = (id) => doc.getElementById(id);
    const historyBody = t('print-history-table-body');
    const partsBody = t('print-parts-table-body');
    const docsList = t('print-docs-list');

    // Basic Info
    t('print-logo').src = GLOBAL_LOGO;
    t('print-asset-id').textContent = machine.id;
    t('print-ref-id').textContent = `EQ: ${machine.id}`;
    t('print-criticidad').textContent = (machine.criticidad || 'BAJA').toUpperCase();

    const crit = (machine.criticidad || 'Baja').toLowerCase();
    const critBg = crit === 'alta' ? '#dc2626' : (crit === 'media' ? '#d97706' : '#16a34a');
    t('print-criticidad').style.backgroundColor = critBg;

    t('print-location').textContent = machine.location || 'N/A';
    t('print-brand').textContent = machine.brand || 'N/A';
    t('print-model').textContent = machine.model || 'N/A';
    t('print-serial').textContent = machine.serialNumber || 'N/A';
    t('print-purchase-date').textContent = machine.purchaseDate || 'N/A';
    t('print-commissioning-date').textContent = machine.commissioningDate || 'N/A';
    t('print-risk').textContent = machine.riskClassification || 'N/A';
    t('print-type').textContent = machine.type === 'instalacion' ? 'Instalaci칩n' : 'M치quina';

    // Status Badge
    const activeOrders = state.workOrders.filter(wo => wo.machineId === machineId && ['En Proceso', 'Pausado'].includes(wo.status));
    const hasCorrective = activeOrders.some(wo => wo.type === 'Correctivo');
    const hasPreventive = activeOrders.some(wo => wo.type === 'Preventivo');

    let statusText = '餃 Operativo';
    let statusColorClass = 'bg-green-100 text-green-800';
    if (hasCorrective) {
        statusText = '餃 Parada Cr칤tica';
        statusColorClass = 'bg-red-100 text-red-800';
    } else if (hasPreventive) {
        statusText = '餃 En Mantenimiento';
        statusColorClass = 'bg-yellow-100 text-yellow-800';
    }
    t('print-status-badge').innerHTML = `<span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-medium ${statusColorClass}">${statusText}</span>`;

    // Image
    t('print-asset-image').src = machine.imageUrl || 'https://via.placeholder.com/400x300?text=Sin+Imagen';

    // Monthly KPIs Logic
    const now = new Date();
    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
    const machineWorkOrders = state.workOrders.filter(o =>
        o.machineId === machineId &&
        new Date(o.date || o.createdAt) >= startOfMonth
    );
    const correctiveOrders = machineWorkOrders.filter(o => o.type === 'Correctivo');

    let mtbf = 'N/A';
    let calcStartDate = startOfMonth;
    if (machine.createdAt && new Date(machine.createdAt) > startOfMonth) {
        calcStartDate = new Date(machine.createdAt);
    }

    if (calcStartDate < now) {
        const totalTimeMs = now - calcStartDate;
        const mtbfMs = totalTimeMs / (correctiveOrders.length + 1);
        mtbf = `${(mtbfMs / (1000 * 60 * 60)).toFixed(0)} h`;
    }

    let availability = '100%';
    const completedCorrectives = correctiveOrders.filter(o => o.status === 'Completado');
    if (calcStartDate < now) {
        const scheduledUptimeMs = calculateScheduledUptimeMs([machine], calcStartDate, now);
        const totalDowntimeMs = completedCorrectives.reduce((sum, o) => sum + getTotalWorkDurationMs(o), 0);
        if (scheduledUptimeMs > 0) {
            const avail = ((scheduledUptimeMs - totalDowntimeMs) / scheduledUptimeMs) * 100;
            availability = `${Math.max(0, avail).toFixed(1)}%`;
        }
    }

    t('print-total-mant').textContent = machineWorkOrders.length;
    t('print-mtbf').textContent = mtbf;
    t('print-availability').textContent = availability;

    // Qualifications
    t('print-iq-status').textContent = machine.iqStatus ? 'VALIDADO' : 'PENDIENTE';
    t('print-iq-status').className = `font-semibold uppercase text-[9px] ${machine.iqStatus ? 'text-green-600' : 'text-slate-400'}`;
    t('print-iq-date').textContent = machine.iqDate || 'N/A';

    t('print-oq-status').textContent = machine.oqStatus ? 'VALIDADO' : 'PENDIENTE';
    t('print-oq-status').className = `font-semibold uppercase text-[9px] ${machine.oqStatus ? 'text-green-600' : 'text-slate-400'}`;
    t('print-oq-date').textContent = machine.oqDate || 'N/A';

    t('print-pq-status').textContent = machine.pqStatus ? 'VIGENTE' : 'VENCIDO/PENDIENTE';
    t('print-pq-status').className = `font-semibold uppercase text-[9px] ${machine.pqStatus ? 'text-blue-600' : 'text-red-600'}`;
    t('print-pq-date').textContent = machine.pqDate || 'N/A';
    t('print-pq-next').textContent = machine.pqNextDate || 'N/A';

    // Highlight PQ near expiration
    if (machine.pqNextDate) {
        const next = new Date(machine.pqNextDate + 'T12:00:00');
        const diffDays = Math.ceil((next - new Date()) / (1000 * 60 * 60 * 24));
        if (diffDays > 0 && diffDays < 30) {
            t('print-pq-row').style.backgroundColor = '#fffbeb';
            t('print-pq-next').style.color = '#b45309';
            t('print-pq-next').innerHTML = `丘멆잺 Vence en ${diffDays} d칤as`;
        }
    }

    // History Table
    const recentOrders = [...machineWorkOrders]
        .filter(o => o.type === 'Preventivo')
        .sort((a, b) => new Date(b.date || '1970-01-01') - new Date(a.date || '1970-01-01'))
        .slice(0, 5);

    historyBody.innerHTML = recentOrders.map(o => `
        <tr>
            <td class="px-3 py-1.5 font-medium border-b border-slate-100">${o.id}</td>
            <td class="px-3 py-1.5 border-b border-slate-100">${new Date(o.date + 'T12:00:00Z').toLocaleDateString('es-ES')}</td>
            <td class="px-3 py-1.5 border-b border-slate-100 ${o.type === 'Preventivo' ? 'text-green-600' : 'text-red-600'} font-medium italic">${o.type}</td>
        </tr>
    `).join('') || '<tr><td colspan="3" class="px-3 py-1.5 text-center text-slate-400">Sin historial registrado</td></tr>';

    // Parts Table
    const criticalityOrder = { 'Cr칤tico': 4, 'Alto': 3, 'Medio': 2, 'Bajo': 1 };
    const sortedParts = state.parts
        .filter(p => p.machineIds && p.machineIds.includes(machineId))
        .sort((a, b) => {
            const critA = criticalityOrder[a.criticality || 'Bajo'] || 0;
            const critB = criticalityOrder[b.criticality || 'Bajo'] || 0;
            if (critA !== critB) return critB - critA;
            return (a.stock || 0) - (b.stock || 0);
        })
        .slice(0, 5);

    partsBody.innerHTML = sortedParts.map(p => {
        let stockStatus = 'OK';
        let stockClass = 'bg-green-100 text-green-800';
        if (p.stock <= 0) {
            stockStatus = 'SIN STOCK';
            stockClass = 'bg-red-100 text-red-800';
        } else if (p.stock <= p.minStock) {
            stockStatus = 'BAJO STOCK';
            stockClass = 'bg-yellow-100 text-yellow-800';
        }
        return `
            <tr>
                <td class="px-3 py-1.5 font-medium border-b border-slate-100">${p.description}</td>
                <td class="px-3 py-1.5 border-b border-slate-100"><span class="${stockClass} px-1 rounded text-[8px] font-bold">${stockStatus}</span></td>
            </tr>
        `;
    }).join('') || '<tr><td colspan="2" class="px-3 py-1.5 text-center text-slate-400">No hay repuestos vinculados</td></tr>';

    // Documentation List
    let docsHTML = '';
    if (!machine.userManualUrl) docsHTML += `<li class="flex items-center gap-2"><span class="w-1 h-1 bg-red-400 rounded-full"></span> Manual de Usuario NO DISPONIBLE</li>`;
    if (!machine.techManualUrl) docsHTML += `<li class="flex items-center gap-2"><span class="w-1 h-1 bg-red-400 rounded-full"></span> Manual T칠cnico NO DISPONIBLE</li>`;
    if (machine.userManualUrl) docsHTML += `<li class="flex items-center gap-2"><span class="w-1 h-1 bg-green-400 rounded-full"></span> Manual de Usuario: DISPONIBLE 九</li>`;
    if (machine.techManualUrl) docsHTML += `<li class="flex items-center gap-2"><span class="w-1 h-1 bg-green-400 rounded-full"></span> Manual T칠cnico: DISPONIBLE 九</li>`;
    docsList.innerHTML = docsHTML;

    // Footer Info
    t('print-user').textContent = state.currentUser?.username || 'Sistema';
    t('print-date').textContent = new Date().toLocaleString('es-ES');

    // Force Tailwind to re-process the document after content injection
    if (iframe.contentWindow.tailwind) {
        try {
            // Some versions of Tailwind CDN auto-detect, but we can try to nudge it
            // by adding a dummy class to body
            doc.body.classList.add('tailwind-applied');
        } catch(e) {}
    }

    // Give extra delay for images and Tailwind JIT to process the new content
    await new Promise(r => setTimeout(r, 2000));

    iframe.contentWindow.print();
    setTimeout(() => {
        if (document.body.contains(iframe)) document.body.removeChild(iframe);
        showLoading(false);
    }, 1000);
}

function showMachineHistory(machineId, type) {
    const historyList = document.getElementById('machine-history-list');
    const title = document.getElementById('machine-history-modal-title');
    const machine = state.machines.find(m => m.id === machineId) || { name: machineId };

    title.textContent = `Historial: ${machine.name} (${type})`;
    historyList.innerHTML = '';

    const orders = state.workOrders
        .filter(wo => wo.machineId === machineId && wo.type === type)
        .sort((a, b) => new Date((b.date || '1970-01-01') + 'T12:00:00Z') - new Date((a.date || '1970-01-01') + 'T12:00:00Z'));

    if (orders.length === 0) {
        historyList.innerHTML = '<tr><td colspan="5" class="text-center">No hay registros para este tipo.</td></tr>';
    } else {
        orders.forEach(order => {
            const tr = document.createElement('tr');

            let statusClass = 'bg-light text-dark';
            if (['En Proceso', 'Pausado'].includes(order.status)) statusClass = 'bg-info text-dark';
            if (order.status === 'Completado') statusClass = 'bg-success';
            if (order.status === 'Cancelado') statusClass = 'bg-danger';
            if (order.status === 'Pendiente de Evaluaci칩n' || order.status === 'Pendiente de Aprobaci칩n') statusClass = 'bg-warning text-dark';

            tr.innerHTML = `
                <td><strong>${order.id}</strong></td>
                <td>${order.date || 'N/A'}</td>
                <td>${order.type}</td>
                <td><span class="badge ${statusClass}">${order.status}</span></td>
                <td>
                    <button class="btn btn-sm btn-outline-primary view-wo-from-history" data-id="${order.fb_id || order.id}">
                        <i class="fas fa-eye"></i>
                    </button>
                </td>
            `;
            historyList.appendChild(tr);

            tr.querySelector('.view-wo-from-history').addEventListener('click', () => {
                state.modals.machineHistory.hide();
                showWorkOrderModal(order.fb_id || order.id);
            });
        });
    }

    state.modals.machineHistory.show();
}

async function uploadMachineFile(machineId, file, type) {
    if (!file) return null;

    // Validar tama침o (10MB)
    const MAX_SIZE = 10 * 1024 * 1024;
    if (file.size > MAX_SIZE) {
        throw new Error(`El archivo ${file.name} excede el l칤mite de 10MB.`);
    }

    const fileName = `${type}_${Date.now()}_${file.name}`;
    const storageRef = ref(state.storage, `maquinas/${machineId}/${fileName}`);

    try {
        const snapshot = await uploadBytes(storageRef, file);
        const downloadURL = await getDownloadURL(snapshot.ref);
        return downloadURL;
    } catch (error) {
        console.error(`Error uploading ${type}:`, error);
        throw new Error(`Fallo al subir el archivo ${file.name}`);
    }
}

function showMachineModal(machineId = null) {
    const form = document.getElementById('machine-form');
    form.reset();
    const idInput = document.getElementById('machine-id');
    const scheduleWrapper = document.getElementById('schedule-wrapper');
    const disableScheduleCheck = document.getElementById('disable-schedule-check');
    
    document.querySelectorAll('.day-check').forEach(c => c.checked = false);
    document.getElementById('machine-start-time-weekday').value = '';
    document.getElementById('machine-end-time-weekday').value = '';
    document.getElementById('machine-start-time-saturday').value = '';
    document.getElementById('machine-end-time-saturday').value = '';
    document.getElementById('machine-start-time-sunday').value = '';
    document.getElementById('machine-end-time-sunday').value = '';

    // Limpiar estados de archivos
    document.getElementById('machine-image-status').innerHTML = '';
    document.getElementById('machine-user-manual-status').innerHTML = '';
    document.getElementById('machine-tech-manual-status').innerHTML = '';
    document.getElementById('machine-image-file').value = '';
    document.getElementById('machine-user-manual-file').value = '';
    document.getElementById('machine-tech-manual-file').value = '';

    if (machineId) {
        document.getElementById('machine-modal-title').textContent = 'Editar M치quina';
        const machine = state.machines.find(m => m.id === machineId);
        if (machine) {
            document.getElementById('machine-id-hidden').value = machine.id;
            idInput.value = machine.id;
            document.getElementById('machine-name').value = machine.name;
            document.getElementById('machine-type').value = machine.type || 'maquina';
            document.getElementById('machine-location').value = machine.location;
            document.getElementById('machine-criticidad').value = machine.criticidad || 'Baja';
            document.getElementById('machine-monitoring-enabled').checked = machine.monitoringEnabled !== false;
            idInput.setAttribute('readonly', true);

            // New fields
            document.getElementById('machine-brand').value = machine.brand || '';
            document.getElementById('machine-model').value = machine.model || '';
            document.getElementById('machine-serial').value = machine.serialNumber || '';
            document.getElementById('machine-risk').value = machine.riskClassification || '';

            // Mostrar estado de archivos actuales
            if (machine.imageUrl) {
                document.getElementById('machine-image-status').innerHTML = `<img src="${machine.imageUrl}" class="img-thumbnail" style="max-height: 100px;"><p class="small text-muted mb-0">Imagen actual</p>`;
            }
            if (machine.userManualUrl) {
                document.getElementById('machine-user-manual-status').innerHTML = `<a href="${machine.userManualUrl}" target="_blank" class="btn btn-sm btn-outline-info mt-1"><i class="fas fa-file-pdf me-1"></i>Ver Manual Actual</a>`;
            }
            if (machine.techManualUrl) {
                document.getElementById('machine-tech-manual-status').innerHTML = `<a href="${machine.techManualUrl}" target="_blank" class="btn btn-sm btn-outline-info mt-1"><i class="fas fa-file-pdf me-1"></i>Ver Manual Actual</a>`;
            }

            document.getElementById('machine-purchase-date').value = machine.purchaseDate || '';
            document.getElementById('machine-commissioning-date').value = machine.commissioningDate || '';
            document.getElementById('machine-iq-status').checked = machine.iqStatus || false;
            document.getElementById('machine-iq-date').value = machine.iqDate || '';
            document.getElementById('machine-oq-status').checked = machine.oqStatus || false;
            document.getElementById('machine-oq-date').value = machine.oqDate || '';
            document.getElementById('machine-pq-status').checked = machine.pqStatus || false;
            document.getElementById('machine-pq-next-date').value = machine.pqNextDate || '';

            const scheduleDisabled = machine.scheduleDisabled || false;
            disableScheduleCheck.checked = scheduleDisabled;
            scheduleWrapper.style.display = scheduleDisabled ? 'none' : 'block';

            if (machine.schedule) {
                if (machine.schedule.weekday || machine.schedule.saturday || machine.schedule.sunday) {
                    if (machine.schedule.weekday) {
                        machine.schedule.weekday.activeDays?.forEach(day => {
                            const checkbox = document.querySelector(`.day-check[value="${day}"]`);
                            if (checkbox) checkbox.checked = true;
                        });
                        document.getElementById('machine-start-time-weekday').value = machine.schedule.weekday.startTime || '';
                        document.getElementById('machine-end-time-weekday').value = machine.schedule.weekday.endTime || '';
                    }
                    if (machine.schedule.saturday?.active) {
                        document.getElementById('day-sat').checked = true;
                        document.getElementById('machine-start-time-saturday').value = machine.schedule.saturday.startTime || '';
                        document.getElementById('machine-end-time-saturday').value = machine.schedule.saturday.endTime || '';
                    }
                    if (machine.schedule.sunday?.active) {
                        document.getElementById('day-sun').checked = true;
                        document.getElementById('machine-start-time-sunday').value = machine.schedule.sunday.startTime || '';
                        document.getElementById('machine-end-time-sunday').value = machine.schedule.sunday.endTime || '';
                    }
                }
            }
        }
    } else {
        document.getElementById('machine-modal-title').textContent = 'A침adir M치quina';
        document.getElementById('machine-id-hidden').value = '';
        disableScheduleCheck.checked = false;
        scheduleWrapper.style.display = 'block';
        document.getElementById('machine-type').value = 'maquina';
        idInput.removeAttribute('readonly');
    }
    state.modals.machine.show();
}

async function handleMachineSubmit(e) {
    e.preventDefault();
    const originalId = document.getElementById('machine-id-hidden').value;
    const machineId = document.getElementById('machine-id').value.trim();

    if(!machineId) {
        showToast('El ID de la m치quina no puede estar vac칤o.', 'error');
        return;
    }

    const imageFile = document.getElementById('machine-image-file').files[0];
    const userManualFile = document.getElementById('machine-user-manual-file').files[0];
    const techManualFile = document.getElementById('machine-tech-manual-file').files[0];

    showLoading(true);

    const weekdayActiveDays = [];
    document.querySelectorAll('#machine-form .day-check:checked').forEach(c => {
        const day = parseInt(c.value);
        if (day >= 1 && day <= 5) {
            weekdayActiveDays.push(c.value);
        }
    });

    const schedule = {
        weekday: {
            activeDays: weekdayActiveDays,
            startTime: document.getElementById('machine-start-time-weekday').value,
            endTime: document.getElementById('machine-end-time-weekday').value,
        },
        saturday: {
            active: document.getElementById('day-sat').checked,
            startTime: document.getElementById('machine-start-time-saturday').value,
            endTime: document.getElementById('machine-end-time-saturday').value,
        },
        sunday: {
            active: document.getElementById('day-sun').checked,
            startTime: document.getElementById('machine-start-time-sunday').value,
            endTime: document.getElementById('machine-end-time-sunday').value,
        }
    };

    const machineData = {
        id: document.getElementById('machine-id').value.trim(),
        name: document.getElementById('machine-name').value,
        type: document.getElementById('machine-type').value,
        location: document.getElementById('machine-location').value,
        criticidad: document.getElementById('machine-criticidad').value,
        monitoringEnabled: document.getElementById('machine-monitoring-enabled').checked,
        scheduleDisabled: document.getElementById('disable-schedule-check').checked,
        schedule: schedule,
        brand: document.getElementById('machine-brand')?.value || '',
        model: document.getElementById('machine-model')?.value || '',
        serialNumber: document.getElementById('machine-serial')?.value || '',
        riskClassification: document.getElementById('machine-risk')?.value || '',
        purchaseDate: document.getElementById('machine-purchase-date')?.value || '',
        commissioningDate: document.getElementById('machine-commissioning-date')?.value || '',
        iqStatus: document.getElementById('machine-iq-status')?.checked || false,
        iqDate: document.getElementById('machine-iq-date')?.value || '',
        oqStatus: document.getElementById('machine-oq-status')?.checked || false,
        oqDate: document.getElementById('machine-oq-date')?.value || '',
        pqStatus: document.getElementById('machine-pq-status')?.checked || false,
        pqNextDate: document.getElementById('machine-pq-next-date')?.value || '',
    };

    const existingMachine = state.machines.find(m => m.fb_id === machineId) || (originalId ? state.machines.find(m => m.fb_id === originalId) : null);

    try {
        // --- Procesar Subida de Archivos ---
        let imageUrl = existingMachine?.imageUrl || '';
        let userManualUrl = existingMachine?.userManualUrl || '';
        let techManualUrl = existingMachine?.techManualUrl || '';

        if (imageFile) imageUrl = await uploadMachineFile(machineId, imageFile, 'img');
        if (userManualFile) userManualUrl = await uploadMachineFile(machineId, userManualFile, 'manual_user');
        if (techManualFile) techManualUrl = await uploadMachineFile(machineId, techManualFile, 'manual_tech');

        machineData.imageUrl = imageUrl;
        machineData.userManualUrl = userManualUrl;
        machineData.techManualUrl = techManualUrl;
        if (existingMachine && existingMachine.createdAt) {
            machineData.createdAt = existingMachine.createdAt;
        } else if (!originalId) {
            machineData.createdAt = new Date().toISOString();
        }

        const docRef = doc(state.collections.machines, machineData.id);
        await setDoc(docRef, machineData, { merge: true });

        if (originalId && originalId !== machineData.id) {
             await deleteDoc(doc(state.collections.machines, originalId));
             await recordAuditLog('machines', machineData.id, 'CREATE', null, machineData, 'Cambio ID M치quina');
             await recordAuditLog('machines', originalId, 'DELETE', existingMachine, null, 'Eliminaci칩n por cambio ID');
        } else if (!originalId) {
             await recordAuditLog('machines', machineData.id, 'CREATE', null, machineData, 'Creaci칩n M치quina');
        } else {
             await recordAuditLog('machines', machineData.id, 'UPDATE', existingMachine, machineData, 'Modificaci칩n M치quina');
        }

        // --- Sincronizaci칩n con Odoo (Segundo Plano) ---
        if (state.odoo) {
            syncMachineToOdoo(machineData).catch(err => {
                console.warn("[Odoo Background Sync] Error:", err);
            });
        }

        showToast('M치quina guardada correctamente', 'success');
        state.modals.machine.hide();
    } catch (error) { 
        console.error("Error saving machine: ", error);
        showToast('Error al guardar la m치quina: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}

function deleteMachine(machineId) {
     showConfirmation('Eliminar M치quina', `쮼st치 seguro de que desea eliminar la m치quina ${machineId}?`, async () => {
        try { 
            const existingMachine = state.machines.find(m => m.fb_id === machineId);
            await deleteDoc(doc(state.collections.machines, machineId)); 
            await recordAuditLog('machines', machineId, 'DELETE', existingMachine, null, 'Eliminaci칩n M치quina');
            showToast('M치quina eliminada correctamente', 'success');
        } catch (error) { 
            console.error("Error deleting machine: ", error);
            showToast('Error al eliminar la m치quina', 'error');
        }
    });
}

// --- CRUD Part Functions ---
function renderParts() {
    const criticalList = document.getElementById('parts-list-critical');
    const attentionList = document.getElementById('parts-list-attention');
    const operativeList = document.getElementById('parts-list-operative');

    if (!criticalList || !attentionList || !operativeList) return;

    const searchTerm = document.getElementById('search-part-input').value.toLowerCase();

    criticalList.innerHTML = '';
    attentionList.innerHTML = '';
    operativeList.innerHTML = '';

    let countCritical = 0;
    let countAttention = 0;
    let countOperative = 0;

    let partsToRender = state.parts;
    const userRole = state.currentUser?.role;
    const managedMachineIds = state.currentUser?.managedMachineIds;
    const equipoAsignado = state.currentUser?.equipoAsignado;

    if ((userRole === 'Jefe de Area' && Array.isArray(managedMachineIds)) || (userRole === 'T칠cnico' && Array.isArray(equipoAsignado))) {
        const relevantMachineIds = new Set(userRole === 'Jefe de Area' ? managedMachineIds : equipoAsignado);
        partsToRender = state.parts.filter(p => {
            const machineIds = p.machineIds || (p.machineId ? [p.machineId] : []);
            if (!machineIds || machineIds.length === 0) return false;
            return machineIds.some(machineId => relevantMachineIds.has(machineId));
        });
    }

    const filteredParts = partsToRender.filter(p =>
        (p.id || '').toLowerCase().includes(searchTerm) ||
        (p.description || '').toLowerCase().includes(searchTerm)
    );

    filteredParts.forEach(part => {
        const currentStock = Number(part.stock) || 0;
        const minStock = Number(part.minStock) || 0;

        let status = 'operative';
        if (currentStock === 0) {
            status = 'critical';
            countCritical++;
        } else if (currentStock <= minStock) {
            status = 'attention';
            countAttention++;
        } else {
            countOperative++;
        }

        // Aplicar filtro si existe
        if (state.partStockFilter && state.partStockFilter !== status) return;

        let targetList = (status === 'critical') ? criticalList : (status === 'attention' ? attentionList : operativeList);
        const tr = document.createElement('tr');
        tr.id = `part-row-${part.fb_id}`;
        tr.innerHTML = createPartRowHTML(part, status);
        targetList.appendChild(tr);
    });

    // Re-vincular event listeners para cada tabla
    [criticalList, attentionList, operativeList].forEach(list => {
        list.querySelectorAll('.view-part-detail').forEach(btn => btn.addEventListener('click', () => showPartDetail(btn.dataset.id)));
        list.querySelectorAll('.view-part-history').forEach(btn => btn.addEventListener('click', () => showPartHistoryModal(btn.dataset.id)));
        list.querySelectorAll('.edit-part').forEach(btn => btn.addEventListener('click', () => showPartModal(btn.dataset.id)));
        list.querySelectorAll('.delete-part').forEach(btn => btn.addEventListener('click', () => deletePart(btn.dataset.id)));
    });

    // Actualizar contadores
    document.getElementById('count-critical').textContent = countCritical;
    document.getElementById('count-attention').textContent = countAttention;
    document.getElementById('count-operative').textContent = countOperative;

    // Actualizar resaltado de filtros activos
    document.querySelectorAll('.inventory-summary .summary-pill').forEach(pill => {
        let pillStatus = '';
        if (pill.classList.contains('critical')) pillStatus = 'critical';
        else if (pill.classList.contains('attention')) pillStatus = 'attention';
        else if (pill.classList.contains('operative')) pillStatus = 'operative';
        pill.classList.toggle('active-filter', state.partStockFilter === pillStatus);
    });

    // Mostrar/ocultar y expandir zonas seg칰n filtros y contenido
    const zones = {
        critical: document.getElementById('zone-critical'),
        attention: document.getElementById('zone-attention'),
        operative: document.getElementById('zone-operative')
    };

    Object.keys(zones).forEach(key => {
        const zone = zones[key];
        const count = key === 'critical' ? countCritical : (key === 'attention' ? countAttention : countOperative);

        // Si hay un filtro activo, solo mostramos la zona filtrada
        if (state.partStockFilter) {
            zone.style.display = (state.partStockFilter === key && count > 0) ? 'block' : 'none';
            // Expandir autom치ticamente si est치 filtrado
            if (state.partStockFilter === key) {
                const collapseEl = document.getElementById(`collapse-${key}`);
                if (collapseEl) collapseEl.classList.add('show');
                const headerEl = zone.querySelector('.zone-header');
                if (headerEl) headerEl.classList.remove('collapsed');
            }
        } else {
            zone.style.display = count > 0 ? 'block' : 'none';
        }
    });

    // Manejar estado vac칤o global
    if (filteredParts.length === 0) {
        operativeList.innerHTML = '<tr><td colspan="10" class="text-center text-muted py-4">No se encontraron repuestos o insumos</td></tr>';
        document.getElementById('zone-operative').style.display = 'block';
    }

    // Mostrar alerta de error de sincronizaci칩n Odoo si existe
    const existingPill = document.getElementById('odoo-sync-error-pill');
    if (existingPill) existingPill.remove();

    if (state.odooSyncError) {
        const errorPill = document.createElement('div');
        errorPill.id = 'odoo-sync-error-pill';
        errorPill.className = 'alert alert-danger d-flex align-items-center mb-4 w-100';
        errorPill.style.cursor = 'pointer';
        errorPill.innerHTML = `
            <i class="fas fa-exclamation-triangle me-2"></i>
            <div class="flex-grow-1">
                <strong>Error de Sincronizaci칩n Odoo:</strong> ${state.odooSyncError.length > 100 ? state.odooSyncError.substring(0, 100) + '...' : state.odooSyncError}
                <br><small>Haga clic para limpiar este aviso.</small>
            </div>
            <button type="button" class="btn-close" aria-label="Close"></button>
        `;
        errorPill.onclick = () => {
            state.odooSyncError = null;
            errorPill.remove();
        };
        const partsTab = document.getElementById('repuestos');
        if (partsTab) partsTab.prepend(errorPill);
    }
}

function addOrUpdatePartInTable(part) {
    // En la nueva arquitectura de 3 zonas, reconstruimos las listas para asegurar la correcta categorizaci칩n
    renderParts();
}

async function recordPartMovement(partId, quantity, type, details = {}) {
    try {
        const part = state.parts.find(p => p.id === partId);
        const movementData = {
            date: new Date().toISOString(),
            partId: partId,
            partDescription: part ? part.description : 'Desconocido',
            quantity: quantity,
            type: type, // e.g., 'Salida OT', 'Entrada Compra', 'Ajuste Manual'
            orderId: details.orderId || null,
            orderHumanId: details.orderHumanId || null,
            user: state.currentUser?.username || 'Sistema',
            ...details
        };
        const docRef = await addDoc(state.collections.partMovements, movementData);
        await recordAuditLog('partMovements', movementData.partId, 'CREATE', null, movementData, `Movimiento Inventario: ${movementData.type}`);
    } catch (error) {
        console.error("Error recording part movement:", error);
    }
}

async function showPartHistoryModal(partId = null) {
    state.currentPartIdForHistory = partId;
    if (partId) {
        const part = state.parts.find(p => p.id === partId);
        document.getElementById('part-history-modal-title').textContent = `Historial de: ${part ? part.description : partId}`;
    } else {
        document.getElementById('part-history-modal-title').textContent = `Historial General de Movimientos`;
    }
    state.modals.partHistory.show();
    await loadPartMovements(partId);
}

async function handlePartRequestSubmit() {
    const description = document.getElementById('wo-request-description').value.trim();
    const quantity = parseInt(document.getElementById('wo-request-quantity').value);
    const urgency = document.getElementById('wo-request-urgency').value;
    const woFbId = document.getElementById('wo-fb-id-hidden').value;
    const woId = document.getElementById('wo-id').value;
    const machineId = document.getElementById('wo-machine').value;

    if (!description || isNaN(quantity) || quantity < 1) {
        showToast('Complete la descripci칩n y cantidad v치lida.', 'warning');
        return;
    }

    if (!woFbId) {
        showToast('Debe guardar la orden de trabajo primero para poder solicitar repuestos.', 'warning');
        return;
    }

    showLoading(true);
    try {
        const requestData = {
            date: new Date().toISOString(),
            workOrderFbId: woFbId,
            workOrderId: woId,
            machineId: machineId,
            requester: state.currentUser?.username || 'Desconocido',
            description: description,
            quantity: quantity,
            urgency: urgency,
            status: 'Pendiente'
        };
        const docRef = await addDoc(state.collections.partRequests, requestData);
        await recordAuditLog('partRequests', woId || docRef.id, 'CREATE', null, requestData, 'Creaci칩n Solicitud Repuesto');

        document.getElementById('wo-request-description').value = '';
        document.getElementById('wo-request-quantity').value = 1;
        showToast('Solicitud de repuesto enviada.', 'success');
        renderWoPendingRequests();
    } catch (error) {
        console.error("Error submitting part request:", error);
        showToast('Error al enviar la solicitud.', 'error');
    } finally {
        showLoading(false);
    }
}

function renderWoPendingRequests() {
    const list = document.getElementById('wo-pending-requests-list');
    if (!list) return;
    const woFbId = document.getElementById('wo-fb-id-hidden').value;
    if (!woFbId) {
        list.innerHTML = '';
        return;
    }

    const requests = state.partRequests.filter(r => r.workOrderFbId === woFbId);
    if (requests.length === 0) {
        list.innerHTML = '';
        return;
    }

    list.innerHTML = '<h6 class="mt-2 small fw-bold">Solicitudes Enviadas para esta OT:</h6>';
    const table = document.createElement('table');
    table.className = 'table table-sm table-bordered x-small mb-0';
    table.innerHTML = `
        <thead class="table-light">
            <tr>
                <th>Descripci칩n</th>
                <th>Cant.</th>
                <th>Estado</th>
            </tr>
        </thead>
        <tbody></tbody>
    `;
    const tbody = table.querySelector('tbody');
    requests.forEach(r => {
        const tr = document.createElement('tr');
        let statusClass = 'bg-secondary';
        if (r.status === 'Pedido') statusClass = 'bg-warning text-dark';
        if (r.status === 'Recibido') statusClass = 'bg-success';
        if (r.status === 'Rechazado') statusClass = 'bg-danger';

        tr.innerHTML = `
            <td>${r.description}</td>
            <td>${r.quantity}</td>
            <td><span class="badge ${statusClass}">${r.status}</span></td>
        `;
        tbody.appendChild(tr);
    });
    list.appendChild(table);
}

function renderPartRequests() {
    const list = document.getElementById('part-request-list');
    if (!list) return;
    const statusFilter = document.getElementById('part-request-status-filter').value;

    list.innerHTML = '';
    const user = state.currentUser;
    let filtered = state.partRequests.filter(r => statusFilter === 'all' || r.status === statusFilter);

    // Filtrar por solicitante para Operarios y Jefes de 츼rea
    if (user && user.role !== 'Admin' && user.role !== 'Planificador') {
        filtered = filtered.filter(r => r.requester === user.username);
    }

    filtered.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(r => {
        const tr = document.createElement('tr');
        const date = new Date(r.date);

        let statusClass = 'bg-secondary';
        let statusLabel = r.status;

        if (r.status === 'Pendiente') {
            statusLabel = 'Solicitado';
        }
        if (r.status === 'Pedido') {
            statusClass = 'bg-warning text-dark';
            statusLabel = 'Aprobado';
        }
        if (r.status === 'Recibido') {
            statusClass = 'bg-success';
            statusLabel = 'Entregado';
        }
        if (r.status === 'Rechazado') {
            statusClass = 'bg-danger';
            statusLabel = 'Rechazado';
        }

        let urgencyClass = 'text-muted';
        if (r.urgency === 'Alta') urgencyClass = 'text-danger fw-bold';
        if (r.urgency === 'Media') urgencyClass = 'text-warning fw-bold';

        let actions = '';
        const userRole = state.currentUser?.role;
        const canManage = ['Admin', 'Planificador'].includes(userRole);

        if (canManage && r.status !== 'Recibido' && r.status !== 'Rechazado') {
            if (r.status === 'Pendiente') {
                actions += `<button class="btn btn-xs btn-outline-warning me-1" onclick="updatePartRequestStatus('${r.fb_id}', 'Pedido')">Aprobar</button>`;
            }
            if (r.status === 'Pedido' || r.status === 'Pendiente') {
                actions += `<button class="btn btn-xs btn-outline-success me-1" onclick="updatePartRequestStatus('${r.fb_id}', 'Recibido')">Entregar</button>`;
            }
            actions += `<button class="btn btn-xs btn-outline-danger" onclick="updatePartRequestStatus('${r.fb_id}', 'Rechazado')">Rechazar</button>`;
        }

        tr.innerHTML = `
            <td>${date.toLocaleDateString()}</td>
            <td>${r.workOrderId || 'N/A'}</td>
            <td>${r.description}</td>
            <td>${r.quantity}</td>
            <td class="${urgencyClass}">${r.urgency}</td>
            <td>${r.requester}</td>
            <td><span class="badge ${statusClass}">${statusLabel}</span></td>
            <td class="text-center">${actions}</td>
        `;
        list.appendChild(tr);
    });
}

window.updatePartRequestStatus = async function(fbId, newStatus) {
    const request = state.partRequests.find(r => r.fb_id === fbId);
    if (!request) return;

    showLoading(true);
    try {
        const docRef = doc(state.collections.partRequests, fbId);
        const oldRequest = JSON.parse(JSON.stringify(request));
        const updates = {
            status: newStatus,
            processedBy: state.currentUser?.username,
            processedDate: new Date().toISOString()
        };
        await updateDoc(docRef, updates);
        const detailedAction = updates.status ? `Solicitud Repuesto: ${updates.status}` : 'Actualizaci칩n Solicitud Repuesto';
        await recordAuditLog('partRequests', request.workOrderId || fbId, 'UPDATE', oldRequest, { ...request, ...updates }, detailedAction);

        if (newStatus === 'Recibido') {
            await handlePartRequestReceived(request);
        }

        let displayStatus = newStatus;
        if (newStatus === 'Pedido') displayStatus = 'Aprobada';
        if (newStatus === 'Recibido') displayStatus = 'Entregada';
        showToast(`Solicitud marcada como ${displayStatus}.`, 'success');
    } catch (error) {
        console.error("Error updating part request:", error);
        showToast('Error al actualizar el estado.', 'error');
    } finally {
        showLoading(false);
    }
};

async function handlePartRequestReceived(request) {
    let part = state.parts.find(p => p.description.toLowerCase() === request.description.toLowerCase());

    if (part) {
        const partRef = doc(state.collections.parts, part.id);
        const newStock = (part.stock || 0) + request.quantity;
        await updateDoc(partRef, { stock: newStock });
        await recordPartMovement(part.id, request.quantity, 'Entrada Solicitud', { details: `Solicitud OT: ${request.workOrderId}` });

        if (state.odoo) {
            syncPartStockToOdoo(part.id, { ...part, stock: newStock }).catch(err =>
                console.warn("[Odoo Sync] Error actualizando stock desde solicitud:", err)
            );
        }
    } else {
        const newId = 'REQ-' + Math.random().toString(36).substr(2, 5).toUpperCase();
        const newPart = {
            id: newId,
            description: request.description,
            classification: 'repuesto',
            stock: request.quantity,
            minStock: 1,
            cost: 0,
            machineIds: request.machineId ? [request.machineId] : [],
            location: 'Recibido por Solicitud'
        };
        await setDoc(doc(state.collections.parts, newId), newPart);
        await recordPartMovement(newId, request.quantity, 'Entrada Solicitud (Nuevo)', { details: `Solicitud OT: ${request.workOrderId}` });

        if (state.odoo) {
            syncPartStockToOdoo(newId, newPart).catch(err =>
                console.warn("[Odoo Sync] Error sincronizando nuevo repuesto desde solicitud:", err)
            );
        }
    }
}

async function loadPartMovements(partId = null) {
    const list = document.getElementById('part-history-list');
    if (list) {
        list.innerHTML = '<tr><td colspan="5" class="text-center text-muted"><i class="fas fa-spinner fa-spin"></i> Cargando movimientos...</td></tr>';
    }

    try {
        let q;
        if (partId) {
            // Using partId as stored in movements (the human-readable ID)
            q = query(state.collections.partMovements, where("partId", "==", partId), orderBy("date", "desc"), limit(200));
        } else {
            q = query(state.collections.partMovements, orderBy("date", "desc"), limit(200));
        }
        const snapshot = await getDocs(q);
        state.partMovements = snapshot.docs.map(doc => ({ fb_id: doc.id, ...doc.data() }));
        renderPartHistory();
    } catch (error) {
        console.error("Error loading part movements:", error);
        // Fallback if index is missing (common in Firestore when adding orderby + where)
        try {
             let q2;
             if (partId) {
                q2 = query(state.collections.partMovements, where("partId", "==", partId), limit(200));
             } else {
                q2 = query(state.collections.partMovements, limit(200));
             }
             const snapshot = await getDocs(q2);
             state.partMovements = snapshot.docs.map(doc => ({ fb_id: doc.id, ...doc.data() }));
             renderPartHistory();
        } catch (e2) {
            showToast("Error al cargar historial de movimientos", "error");
        }
    }
}

function renderPartHistory() {
    const list = document.getElementById('part-history-list');
    if (!list) return;
    list.innerHTML = '';

    const partId = state.currentPartIdForHistory;
    const movements = state.partMovements
        .filter(m => !partId || m.partId === partId)
        .sort((a, b) => new Date(b.date) - new Date(a.date));

    movements.forEach(m => {
        const tr = document.createElement('tr');
        const date = new Date(m.date);
        tr.innerHTML = `
            <td>${date.toLocaleDateString()} ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</td>
            <td>${m.orderHumanId || 'N/A'}</td>
            <td>${partId ? m.type : (m.partDescription + ' (' + m.partId + ')')}</td>
            <td class="${m.quantity < 0 ? 'text-danger' : 'text-success'} fw-bold">${m.quantity > 0 ? '+' : ''}${m.quantity}</td>
            <td>${m.type}</td>
            <td>${m.user}</td>
        `;
        list.appendChild(tr);
    });
}

function renderPartDocsList() {
    const list = document.getElementById('part-docs-list');
    list.innerHTML = '';
    currentPartDocs.forEach((doc, index) => {
        const item = document.createElement('div');
        item.className = 'tech-doc-item d-flex align-items-center justify-content-between p-2 rounded-3 bg-white shadow-sm';
        item.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="fas fa-file-pdf text-danger me-3"></i>
                <span class="small fw-medium text-truncate" style="max-width: 200px;">${doc.name}</span>
            </div>
            <button type="button" class="btn btn-sm text-danger remove-doc-btn" data-index="${index}">
                <i class="fas fa-trash-alt"></i>
            </button>
        `;
        list.appendChild(item);
    });

    list.querySelectorAll('.remove-doc-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            currentPartDocs.splice(btn.dataset.index, 1);
            renderPartDocsList();
        });
    });
}

function showPartModal(partId = null) {
    const form = document.getElementById('part-form');
    form.reset();
    populateSupplierSelectors();
    const idInput = document.getElementById('part-id');

    // Reset image and docs
    const preview = document.getElementById('part-image-preview');
    preview.src = '';
    preview.classList.add('d-none');
    document.querySelector('#part-modal .upload-placeholder').classList.remove('d-none');
    document.getElementById('part-image-url').value = '';
    document.getElementById('part-image-file').value = '';
    currentPartDocs = [];
    renderPartDocsList();

    const machinesListContainer = document.getElementById('part-machines-list');
    machinesListContainer.innerHTML = '';
    if (state.machines.length > 0) {
        state.machines.forEach(machine => {
            const div = document.createElement('div');
            div.className = 'form-check';
            div.innerHTML = `
                <input class="form-check-input part-machine-check" type="checkbox" value="${machine.id}" id="part-machine-check-${machine.id}">
                <label class="form-check-label small" for="part-machine-check-${machine.id}">
                    ${machine.name} (${machine.id})
                </label>
            `;
            machinesListContainer.appendChild(div);
        });
    } else {
        machinesListContainer.innerHTML = '<p class="text-muted small">No hay m치quinas registradas.</p>';
    }
    
    if (partId) {
        document.getElementById('part-modal-title').textContent = 'Editar Repuesto';
        const part = state.parts.find(p => p.id === partId);
        if (part) {
            document.getElementById('part-id-hidden').value = part.id;
            idInput.value = part.id;
            document.getElementById('part-description').value = part.description;
            document.getElementById('part-classification').value = part.classification || 'insumo';
            document.getElementById('part-supplier').value = part.supplierId || '';
            
            const machineIdsToSelect = part.machineIds || (part.machineId ? [part.machineId] : []);
            machineIdsToSelect.forEach(machineId => {
                const checkbox = document.getElementById(`part-machine-check-${machineId}`);
                if (checkbox) checkbox.checked = true;
            });

            document.getElementById('part-cost').value = part.cost;
            document.getElementById('part-stock').value = part.stock;
            document.getElementById('part-criticidad').value = part.criticality || 'Bajo';
            document.getElementById('part-minStock').value = part.minStock;
            document.getElementById('part-location').value = part.location || '';

            document.getElementById('part-image-url').value = part.imageUrl || '';
            if (part.imageUrl) {
                preview.src = part.imageUrl;
                preview.classList.remove('d-none');
                document.querySelector('#part-modal .upload-placeholder').classList.add('d-none');
            }

            currentPartDocs = part.technicalDocs ? [...part.technicalDocs] : [];
            renderPartDocsList();

            idInput.setAttribute('readonly', true);
        }
    } else {
        document.getElementById('part-modal-title').textContent = 'A침adir Repuesto';
        document.getElementById('part-id-hidden').value = '';
        idInput.removeAttribute('readonly');
        document.getElementById('part-classification').value = 'insumo';
    }
    state.modals.part.show();
}

async function handlePartSubmit(e) {
    e.preventDefault();
    const originalId = document.getElementById('part-id-hidden').value;
    const partId = document.getElementById('part-id').value.trim();

    if(!partId) {
        showToast('El ID del repuesto no puede estar vac칤o.', 'error');
        return;
    }

    const selectedMachineIds = [];
    document.querySelectorAll('#part-machines-list .part-machine-check:checked').forEach(checkbox => {
        selectedMachineIds.push(checkbox.value);
    });

    const imageFile = document.getElementById('part-image-file').files[0];
    let imageUrl = document.getElementById('part-image-url').value;

    try {
        showLoading(true, 'Guardando repuesto...');

        if (imageFile) {
            imageUrl = await uploadPartFile(partId, imageFile, 'img');
        }

        // Subir nuevas fichas t칠cnicas
        const updatedDocs = [];
        for (const doc of currentPartDocs) {
            if (doc.file) {
                const url = await uploadPartFile(partId, doc.file, 'doc');
                updatedDocs.push({ name: doc.name, url: url });
            } else {
                updatedDocs.push(doc);
            }
        }

        const partData = {
            id: partId,
            description: document.getElementById('part-description').value,
            classification: document.getElementById('part-classification').value,
            supplierId: document.getElementById('part-supplier').value,
            machineIds: selectedMachineIds,
            cost: parseFloat(document.getElementById('part-cost').value) || 0,
            stock: parseInt(document.getElementById('part-stock').value) || 0,
            criticality: document.getElementById('part-criticidad').value,
            minStock: parseInt(document.getElementById('part-minStock').value) || 0,
            location: document.getElementById('part-location').value,
            imageUrl: imageUrl,
            technicalDocs: updatedDocs
        };

        const docRef = doc(state.collections.parts, partData.id);
        const oldPart = state.parts.find(p => p.fb_id === partData.id) || (originalId ? state.parts.find(p => p.fb_id === originalId) : null);
        const oldStock = oldPart ? oldPart.stock : 0;
        const stockDelta = partData.stock - oldStock;

        await setDoc(docRef, partData, { merge: true });

        if (stockDelta !== 0) {
            await recordPartMovement(partData.id, stockDelta, 'Ajuste Manual');
        }

        if (originalId && originalId !== partData.id) {
             await deleteDoc(doc(state.collections.parts, originalId));
             await recordAuditLog('parts', partData.id, 'CREATE', null, partData, 'Cambio ID Repuesto');
             await recordAuditLog('parts', originalId, 'DELETE', oldPart, null, 'Eliminaci칩n por cambio ID');
        } else if (!originalId) {
             await recordAuditLog('parts', partData.id, 'CREATE', null, partData, 'Creaci칩n Repuesto');
        } else {
             await recordAuditLog('parts', partData.id, 'UPDATE', oldPart, partData, 'Modificaci칩n Repuesto');
        }

        if (state.odoo) {
            syncPartStockToOdoo(partData.id, partData).catch(err => {
                console.warn("[Odoo Background Sync] Error:", err);
            });
        }

        showToast('Repuesto guardado correctamente', 'success');
        state.modals.part.hide();
    } catch (error) { 
        console.error("Error saving part: ", error);
        showToast('Error al guardar el repuesto: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}

function deletePart(partId) {
    showConfirmation('Eliminar Repuesto', `쮼st치 seguro de que desea eliminar el repuesto ${partId}?`, async () => {
        try { 
            const existingPart = state.parts.find(p => p.fb_id === partId);
            await deleteDoc(doc(state.collections.parts, partId)); 
            await recordAuditLog('parts', partId, 'DELETE', existingPart, null, 'Eliminaci칩n Repuesto');
            showToast('Repuesto eliminado correctamente', 'success');
        } catch (error) { 
            console.error("Error deleting part: ", error);
            showToast('Error al eliminar el repuesto', 'error');
        }
    });
}

// --- CRUD Proveedor Functions ---
function renderProveedores() {
    const tbody = document.getElementById('proveedor-list');
    const searchTerm = document.getElementById('search-proveedor-input').value.toLowerCase();
    tbody.innerHTML = '';
    
    let proveedoresToRender = state.proveedores;
    const userRole = state.currentUser?.role;
    const managedMachineIds = state.currentUser?.managedMachineIds;
    const equipoAsignado = state.currentUser?.equipoAsignado;

    if ((userRole === 'Jefe de Area' && Array.isArray(managedMachineIds)) || (userRole === 'T칠cnico' && Array.isArray(equipoAsignado))) {
        const relevantMachineIds = new Set(userRole === 'Jefe de Area' ? managedMachineIds : equipoAsignado);

        // Find all parts associated with the managed machines
        const relevantParts = state.parts.filter(p => {
            const machineIds = p.machineIds || [];
            return machineIds.some(mId => relevantMachineIds.has(mId));
        });

        // Get the unique supplier IDs from those parts
        const relevantSupplierIds = new Set(relevantParts.map(p => p.supplierId).filter(Boolean));

        // Filter the suppliers list
        proveedoresToRender = state.proveedores.filter(prov => relevantSupplierIds.has(prov.id));
    }

    const filtered = proveedoresToRender.filter(p => p.id.toLowerCase().includes(searchTerm) || p.nombre.toLowerCase().includes(searchTerm));
    
    if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center">No se encontraron proveedores.</td></tr>';
        return;
    }

    const fragment = document.createDocumentFragment();
    filtered.forEach(p => {
        const tr = document.createElement('tr');
        tr.id = `proveedor-row-${p.fb_id}`;
        tr.innerHTML = createProveedorRowHTML(p);
        fragment.appendChild(tr);
    });
    tbody.appendChild(fragment);

    tbody.querySelectorAll('.edit-proveedor').forEach(btn => btn.addEventListener('click', () => showProveedorModal(btn.dataset.id)));
    tbody.querySelectorAll('.delete-proveedor').forEach(btn => btn.addEventListener('click', () => deleteProveedor(btn.dataset.id)));
}

function addOrUpdateProveedorInTable(proveedor) {
    const tbody = document.getElementById('proveedor-list');
    let tr = document.getElementById(`proveedor-row-${proveedor.fb_id}`);

    if (tr) { // Update
        tr.innerHTML = createProveedorRowHTML(proveedor);
    } else { // Add
        const placeholder = tbody.querySelector('td[colspan="7"]');
        if (placeholder) placeholder.parentElement.remove();
        tr = document.createElement('tr');
        tr.id = `proveedor-row-${proveedor.fb_id}`;
        tr.innerHTML = createProveedorRowHTML(proveedor);
        tbody.appendChild(tr);
    }
    tr.querySelector('.edit-proveedor')?.addEventListener('click', () => showProveedorModal(tr.querySelector('.edit-proveedor').dataset.id));
    tr.querySelector('.delete-proveedor')?.addEventListener('click', () => deleteProveedor(tr.querySelector('.delete-proveedor').dataset.id));
}

function showProveedorModal(proveedorId = null) {
    const form = document.getElementById('proveedor-form');
    form.reset();
    const idInput = document.getElementById('proveedor-id');

    if (proveedorId) {
        document.getElementById('proveedor-modal-title').textContent = 'Editar Proveedor';
        const proveedor = state.proveedores.find(p => p.id === proveedorId);
        if (proveedor) {
            document.getElementById('proveedor-id-hidden').value = proveedor.id;
            idInput.value = proveedor.id;
            document.getElementById('proveedor-nombre').value = proveedor.nombre;
            document.getElementById('proveedor-rtn').value = proveedor.rtn || '';
            document.getElementById('proveedor-telefono').value = proveedor.telefono || '';
            document.getElementById('proveedor-email').value = proveedor.email || '';
            document.getElementById('proveedor-direccion').value = proveedor.direccion || '';
            idInput.setAttribute('readonly', true);
        }
    } else {
        document.getElementById('proveedor-modal-title').textContent = 'A침adir Proveedor';
        document.getElementById('proveedor-id-hidden').value = '';
        idInput.removeAttribute('readonly');
    }
    state.modals.proveedor.show();
}

async function handleProveedorSubmit(e) {
    e.preventDefault();
    const originalId = document.getElementById('proveedor-id-hidden').value;

    const proveedorData = {
        id: document.getElementById('proveedor-id').value.trim(),
        nombre: document.getElementById('proveedor-nombre').value,
        rtn: document.getElementById('proveedor-rtn').value,
        telefono: document.getElementById('proveedor-telefono').value,
        email: document.getElementById('proveedor-email').value,
        direccion: document.getElementById('proveedor-direccion').value,
    };

    if (!proveedorData.id) {
        showToast('El C칩digo del proveedor no puede estar vac칤o.', 'error');
        return;
    }

    try {
        const oldProv = state.proveedores.find(p => p.fb_id === proveedorData.id) || (originalId ? state.proveedores.find(p => p.fb_id === originalId) : null);
        const docRef = doc(state.collections.proveedores, proveedorData.id);
        await setDoc(docRef, proveedorData, { merge: true });

        if (originalId && originalId !== proveedorData.id) {
             await deleteDoc(doc(state.collections.proveedores, originalId));
             await recordAuditLog('proveedores', proveedorData.id, 'CREATE', null, proveedorData);
             await recordAuditLog('proveedores', originalId, 'DELETE', oldProv, null);
        } else if (!originalId) {
             await recordAuditLog('proveedores', proveedorData.id, 'CREATE', null, proveedorData);
        } else {
             await recordAuditLog('proveedores', proveedorData.id, 'UPDATE', oldProv, proveedorData);
        }
        showToast('Proveedor guardado correctamente', 'success');
    } catch (error) {
        console.error("Error saving proveedor: ", error);
        showToast('Error al guardar el proveedor', 'error');
    }
    state.modals.proveedor.hide();
}

function deleteProveedor(proveedorId) {
    showConfirmation('Eliminar Proveedor', `쮼st치 seguro de que desea eliminar el proveedor ${proveedorId}?`, async () => {
        try {
            const oldProv = state.proveedores.find(p => p.fb_id === proveedorId);
            await deleteDoc(doc(state.collections.proveedores, proveedorId));
            await recordAuditLog('proveedores', proveedorId, 'DELETE', oldProv, null);
            showToast('Proveedor eliminado correctamente', 'success');
        } catch (error) {
            console.error("Error deleting proveedor: ", error);
            showToast('Error al eliminar el proveedor', 'error');
        }
    });
}

// --- NEW: Centralized function to update the user modal UI based on role ---
function updateTechnicianModalUIForRole(role) {
    const salaryWrapper = document.getElementById('technician-salary-wrapper');
    const salaryInput = document.getElementById('technician-salary');
    const permissionsWrapper = document.getElementById('technician-permissions-wrapper');
    const jefeMaquinasWrapper = document.getElementById('jefe-maquinas-wrapper');
    const jefePermissionsWrapper = document.getElementById('jefe-permissions-wrapper');
    const tecnicoMaquinasWrapper = document.getElementById('tecnico-maquinas-wrapper');

    // Visibilidad de permisos por rol
    permissionsWrapper.style.display = role === 'T칠cnico' ? 'block' : 'none';
    jefePermissionsWrapper.classList.toggle('d-none', role !== 'Jefe de Area');

    // Visibilidad de asignaci칩n de m치quinas por rol
    const showTecnicoMaquinas = role === 'T칠cnico' || role === 'Operario';
    tecnicoMaquinasWrapper.classList.toggle('d-none', !showTecnicoMaquinas);

    // Visibilidad espec칤fica para Jefe de Area
    jefeMaquinasWrapper.classList.toggle('d-none', role !== 'Jefe de Area');


    if (role === 'Operario') {
        salaryWrapper.style.display = 'none';
        salaryInput.removeAttribute('required');
    } else {
        salaryWrapper.style.display = 'block';
        salaryInput.setAttribute('required', true);
    }
}

// --- CRUD Technician/User Functions ---
function renderTechnicians() {
    const tbody = document.getElementById('technician-list');
    tbody.innerHTML = '';
    if (state.technicians.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center">No se encontraron usuarios.</td></tr>';
        return;
    }

    state.technicians.forEach(tech => {
        const tr = document.createElement('tr');
        const isCurrentUser = state.currentUser && state.currentUser.username === tech.username;

        let actionsHTML = '';
        if (state.currentUser?.role === 'Admin') {
            actionsHTML += `<button class="btn btn-sm btn-outline-primary edit-tech" data-id="${tech.fb_id}"><i class="fas fa-edit"></i></button> `;
            actionsHTML += `<button class="btn btn-sm btn-outline-danger delete-tech" data-id="${tech.fb_id}" ${isCurrentUser ? 'disabled' : ''}><i class="fas fa-trash"></i></button> `;
        }

        if (tech.role === 'T칠cnico') {
            actionsHTML += `<button class="btn btn-sm btn-outline-info view-profile-btn" data-id="${tech.fb_id}"><i class="fas fa-user-chart"></i></button> `;
            actionsHTML += `<button class="btn btn-sm btn-outline-danger generate-single-tech-report-btn" data-username="${tech.username}"><i class="fas fa-file-pdf"></i></button>`;
        }

        tr.innerHTML = `
            <td>${tech.username}</td>
            <td>${tech.role}</td>
            <td>${tech.salario ? new Intl.NumberFormat('es-HN', { style: 'currency', currency: 'HNL' }).format(tech.salario) : 'N/A'}</td>
            <td class="text-center">${actionsHTML || '<span class="text-muted fst-italic">Sin acciones</span>'}</td>
        `;
        tbody.appendChild(tr);
    });

    // Delegated event listeners are used for edit/delete/profile, set up in setupEventListeners
}

async function handleStartLinkedPlan(workOrder, plan) {
    if (workOrder && workOrder.isExpired) {
        showToast('Esta orden ha expirado y no puede ser modificada.', 'error');
        return;
    }
    if (!workOrder || !plan) {
        showToast('Error: Faltan datos de la orden o del plan.', 'error');
        return;
    }

    // First, check if an execution already exists for this work order.
    let execution = state.workPlanExecutions.find(e => e.workOrderFbId === workOrder.fb_id);

    if (execution) {
        // If it exists, just start the view.
        startWorkPlanExecution(execution, plan);
        state.modals.workOrder.hide();
    } else {
        // If it does not exist, create it.
        showLoading(true);
        try {
            const nowDate = new Date();
            const now = nowDate.toISOString();
            const executionTaskGroups = (plan.taskGroups || []).map(group => ({
                ...group,
                tasks: group.tasks.map(task => ({ ...task, status: 'Pendiente' }))
            }));

            const executionData = {
                planId: plan.fb_id,
                workOrderFbId: workOrder.fb_id,
                executedAt: now,
                executedBy: state.currentUser.username,
                taskGroups: executionTaskGroups,
                status: 'En Proceso',
                workIntervals: [{ start: now, end: null }]
            };

            const executionDocRef = await addDoc(state.collections.workPlanExecutions, executionData);

            // Update the work order to link to the new execution ID, update ID prefix and status if needed
            const woUpdates = {
                executionId: executionDocRef.id,
            };

            // Only update status and start time if the order is not already in process
            if (workOrder.status !== 'En Proceso') {
                woUpdates.status = 'En Proceso';
                if (!workOrder.fechaInicioReal) {
                    woUpdates.fechaInicioReal = now;
                }
                woUpdates.date = `${nowDate.getFullYear()}-${String(nowDate.getMonth() + 1).padStart(2, '0')}-${String(nowDate.getDate()).padStart(2, '0')}`;

                let workIntervals = workOrder.workIntervals ? JSON.parse(JSON.stringify(workOrder.workIntervals)) : [];
                workIntervals.push({ start: now, end: null });
                woUpdates.workIntervals = workIntervals;
            }

            if (workOrder.id && workOrder.id.startsWith('MP')) {
                woUpdates.id = generateNextId('MA');
            }

            await updateDoc(doc(state.collections.workOrders, workOrder.fb_id), woUpdates);

            // The snapshot listener will update the local state. We can find the new execution there.
            // But to be faster, we can create a temporary object for the UI.
            const newExecutionForUI = { ...executionData, fb_id: executionDocRef.id };

            showToast('Checklist de plan iniciado. La orden ahora est치 En Proceso.', 'success');
            startWorkPlanExecution(newExecutionForUI, plan);
            state.modals.workOrder.hide();

        } catch (error) {
            console.error("Error creating plan execution from linked plan:", error);
            showToast('Error al iniciar el plan de trabajo.', 'error');
        } finally {
            showLoading(false);
        }
    }
}

function initSignaturePad() {
    const canvas = document.getElementById('signature-pad');
    if (!canvas) return;

    if (!state.signaturePad) {
        state.signaturePad = new SignaturePad(canvas, {
            backgroundColor: 'rgba(255, 255, 255, 0)',
            penColor: 'rgb(0, 0, 0)'
        });

        // Handle resizing
        const resizeCanvas = () => {
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            canvas.getContext("2d").scale(ratio, ratio);
            state.signaturePad.clear();
        };

        window.addEventListener("resize", resizeCanvas);
        resizeCanvas();
    }
}

function showTechnicianModal(techId = null) {
    const form = document.getElementById('technician-form');
    form.reset();
    const userInput = document.getElementById('technician-username');
    const passInput = document.getElementById('technician-password');
    const salaryInput = document.getElementById('technician-salary');
    const roleSelect = document.getElementById('technician-role');
    const jefeMaquinasList = document.getElementById('jefe-maquinas-list');
    const tecnicoMaquinasList = document.getElementById('tecnico-maquinas-list');
    document.querySelectorAll('.permission-check, .jefe-permission-check').forEach(cb => cb.checked = false);
    jefeMaquinasList.innerHTML = ''; // Clear previous list
    tecnicoMaquinasList.innerHTML = ''; // Clear previous list

    // Reset signature UI
    document.getElementById('signature-draw-container').style.display = 'none';
    document.getElementById('signature-upload-container').style.display = 'none';
    document.getElementById('signature-preview-container').classList.add('d-none');
    document.getElementById('signature-preview').src = '';
    if (state.signaturePad) state.signaturePad.clear();

    // Populate the machine lists for Jefe de Area and Tecnico
    if (state.machines.length > 0) {
        state.machines.forEach(machine => {
            const div = document.createElement('div');
            div.className = 'form-check';
            div.innerHTML = `
                <input class="form-check-input machine-check" type="checkbox" value="${machine.id}" id="jefe-machine-check-${machine.id}">
                <label class="form-check-label" for="jefe-machine-check-${machine.id}">
                    ${machine.name} (${machine.id})
                </label>
            `;
            jefeMaquinasList.appendChild(div);

            const divTecnico = document.createElement('div');
            divTecnico.className = 'form-check';
            divTecnico.innerHTML = `
                <input class="form-check-input tecnico-machine-check" type="checkbox" value="${machine.id}" id="tecnico-machine-check-${machine.id}">
                <label class="form-check-label" for="tecnico-machine-check-${machine.id}">
                    ${machine.name} (${machine.id})
                </label>
            `;
            tecnicoMaquinasList.appendChild(divTecnico);
        });
    } else {
        const noMachinesText = '<p class="text-muted small">No hay m치quinas registradas para asignar.</p>';
        jefeMaquinasList.innerHTML = noMachinesText;
        tecnicoMaquinasList.innerHTML = noMachinesText;
    }

    if (techId) {
        document.getElementById('technician-modal-title').textContent = 'Editar Usuario';
        const tech = state.technicians.find(t => t.fb_id === techId);
        if (tech) {
            document.getElementById('technician-id-hidden').value = tech.fb_id;
            userInput.value = tech.username;
            salaryInput.value = tech.salario || '';
            roleSelect.value = tech.role;
            userInput.setAttribute('readonly', true);
            passInput.removeAttribute('required');
            passInput.placeholder = "Dejar en blanco para no cambiar";
            if (tech.role === 'T칠cnico') {
                if (tech.permissions) {
                    tech.permissions.forEach(perm => {
                        const cb = document.getElementById(`perm-${perm}`);
                        if(cb) cb.checked = true;
                    });
                }
                if (Array.isArray(tech.equipoAsignado)) {
                    tech.equipoAsignado.forEach(machineId => {
                        const checkbox = document.getElementById(`tecnico-machine-check-${machineId}`);
                        if (checkbox) checkbox.checked = true;
                    });
                }
            }
            if (tech.role === 'Jefe de Area') {
                if (Array.isArray(tech.managedMachineIds)) {
                    tech.managedMachineIds.forEach(machineId => {
                        const checkbox = document.getElementById(`jefe-machine-check-${machineId}`);
                        if (checkbox) {
                            checkbox.checked = true;
                        }
                    });
                }
                if (Array.isArray(tech.permissions)) {
                    tech.permissions.forEach(perm => {
                        const cb = document.getElementById(`jefe-perm-${perm}`);
                        if(cb) cb.checked = true;
                    });
                }
            }

            if (tech.signature) {
                document.getElementById('signature-preview').src = tech.signature;
                document.getElementById('signature-preview-container').classList.remove('d-none');
            }
        }
    } else {
        document.getElementById('technician-modal-title').textContent = 'A침adir Usuario';
        document.getElementById('technician-id-hidden').value = '';
        userInput.removeAttribute('readonly');
        passInput.setAttribute('required', true);
        passInput.placeholder = "";
    }

    // Centralized call to update UI based on the selected role
    updateTechnicianModalUIForRole(roleSelect.value);
    
    state.modals.technician.show();
}

async function handleTechnicianSubmit(e) {
    e.preventDefault();
    const techId = document.getElementById('technician-id-hidden').value;
    const password = document.getElementById('technician-password').value;
    const role = document.getElementById('technician-role').value;

    const techData = {
        username: document.getElementById('technician-username').value,
        salario: role === 'Operario' ? 0 : (parseFloat(document.getElementById('technician-salary').value) || 0),
        role: role,
        permissions: [],
        managedMachineIds: [],
    };

    if (role === 'Admin') {
        techData.permissions = ['all'];
    } else if (role === 'Planificador') {
        techData.permissions = ['maquinaria', 'repuestos', 'proveedores', 'trabajo-activo', 'planificador', 'planes-trabajo', 'reportes', 'solicitudes', 'ordenes-asignadas'];
    } else if (role === 'Jefe de Area') {
        document.querySelectorAll('#jefe-permissions .jefe-permission-check:checked').forEach(cb => {
            techData.permissions.push(cb.value);
        });
        document.querySelectorAll('#jefe-maquinas-list .machine-check:checked').forEach(cb => {
            techData.managedMachineIds.push(cb.value);
        });
    } else if (role === 'Invitado') {
        techData.permissions = ['read-only'];
    } else if (role === 'Operario') {
        techData.permissions = ['solicitudes', 'trabajo-activo', 'planificador'];
        techData.equipoAsignado = [];
        document.querySelectorAll('#tecnico-maquinas-list .tecnico-machine-check:checked').forEach(cb => {
            techData.equipoAsignado.push(cb.value);
        });
    } else if (role === 'T칠cnico') {
        techData.equipoAsignado = []; // Se inicializa el array para este rol
        document.querySelectorAll('.permission-check:checked').forEach(cb => {
            techData.permissions.push(cb.value);
        });
        document.querySelectorAll('#tecnico-maquinas-list .tecnico-machine-check:checked').forEach(cb => {
            techData.equipoAsignado.push(cb.value);
        });
    }

    // Para las actualizaciones de roles que no son 'T칠cnico', nos aseguramos de
    // eliminar el campo `equipoAsignado` en caso de que el usuario fuera previamente un t칠cnico.
    if (techId && role !== 'T칠cnico' && role !== 'Operario') {
        techData.equipoAsignado = deleteField();
    }


    if (password) {
        techData.password = await hashPassword(password);
        techData.passwordIsHashed = true;
    }

    // Capture Signature
    const signatureDrawContainer = document.getElementById('signature-draw-container');
    const signaturePreview = document.getElementById('signature-preview');
    const signaturePreviewContainer = document.getElementById('signature-preview-container');

    if (signatureDrawContainer.style.display === 'block' && state.signaturePad && !state.signaturePad.isEmpty()) {
        techData.signature = state.signaturePad.toDataURL();
    } else if (!signaturePreviewContainer.classList.contains('d-none') && signaturePreview.src) {
        techData.signature = signaturePreview.src;
    }
    
    try {
        let currentFbId = techId;
        const oldTech = techId ? state.technicians.find(t => t.fb_id === techId) : null;
        if (techId) {
            await setDoc(doc(state.collections.technicians, techId), techData, { merge: true });
            await recordAuditLog('technicians', techId, 'UPDATE', oldTech, techData);
            showToast('Usuario actualizado correctamente', 'success');
        } else {
            const docRef = await addDoc(state.collections.technicians, techData);
            currentFbId = docRef.id;
            await recordAuditLog('technicians', currentFbId, 'CREATE', null, techData);
            showToast('Usuario creado correctamente', 'success');
        }

        // --- Sincronizaci칩n con Odoo (Segundo Plano) ---
        if (state.odoo) {
            syncTechnicianToOdoo(techData, currentFbId).catch(err => {
                console.warn("[Odoo Background Sync] Error:", err);
            });
        }
    } catch (error) { 
        console.error("Error saving technician: ", error);
        showToast('Error al guardar el usuario', 'error');
    }
    state.modals.technician.hide();
}

function deleteTechnician(techId) {
     const tech = state.technicians.find(t => t.fb_id === techId);
     if (tech && state.currentUser && tech.username === state.currentUser.username) {
          showToast('No puede eliminar el usuario con el que ha iniciado sesi칩n.', 'error');
          return;
     }
     showConfirmation('Eliminar Usuario', `쮼st치 seguro de que desea eliminar a ${tech.username}?`, async () => {
        try { 
            const oldTech = state.technicians.find(t => t.fb_id === techId);
            await deleteDoc(doc(state.collections.technicians, techId)); 
            await recordAuditLog('technicians', techId, 'DELETE', oldTech, null);
            showToast('Usuario eliminado correctamente', 'success');
        } catch (error) { 
            console.error("Error deleting technician: ", error);
            showToast('Error al eliminar el usuario', 'error');
        }
    });
}

// --- Solicitud (Request) Functions ---
function renderSolicitudes() {
    const tbody = document.getElementById('solicitud-list');
    tbody.innerHTML = '';
    
    let userSolicitudes = state.solicitudes; 
    const userRole = state.currentUser?.role;
    const managedMachineIds = state.currentUser?.managedMachineIds;
    const equipoAsignado = state.currentUser?.equipoAsignado;

    if ((userRole === 'Jefe de Area' && Array.isArray(managedMachineIds)) || (userRole === 'T칠cnico' && Array.isArray(equipoAsignado)) || (userRole === 'Operario' && Array.isArray(equipoAsignado))) {
        const relevantMachineIds = new Set(userRole === 'Jefe de Area' ? managedMachineIds : equipoAsignado);
        userSolicitudes = state.solicitudes.filter(s => relevantMachineIds.has(s.machineId));
    }

    const monthFilter = document.getElementById('solicitudes-month-filter');
    const selectedMonth = monthFilter ? monthFilter.value : null;

    if (selectedMonth) {
        userSolicitudes = userSolicitudes.filter(s => {
            if (!s.createdAt) return false;
            let localMonthStr = "";
            if (/^\d{4}-\d{2}-\d{2}/.test(s.createdAt)) {
                localMonthStr = s.createdAt.substring(0, 7);
            } else {
                const d = new Date(s.createdAt);
                if (isNaN(d.getTime())) return false;
                localMonthStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
            }
            return localMonthStr === selectedMonth;
        });
    }

    if (userSolicitudes.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">No se encontraron solicitudes para este periodo.</td></tr>';
        return;
    }

    userSolicitudes.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

    userSolicitudes.forEach(solicitud => {
        const machine = state.machines.find(m => m.id === solicitud.machineId) || { name: 'N/A' };
        const tr = document.createElement('tr');
        
        let statusText = solicitud.status;
        let statusBadgeClass = '';
        let linkedWorkOrder = null;

        if (solicitud.workOrderFbId) {
            linkedWorkOrder = state.workOrders.find(wo => wo.fb_id === solicitud.workOrderFbId);
        } else if (solicitud.workOrderId) {
            linkedWorkOrder = state.workOrders.find(wo => wo.id === solicitud.workOrderId);
        }

        // B칰squeda de respaldo si los v칤nculos directos fallan o est치n desactualizados (ej. cambio de ID de MP a MA)
        if (!linkedWorkOrder) {
            linkedWorkOrder = state.workOrders.find(wo =>
                wo.sourceSolicitudId === solicitud.fb_id ||
                (wo.solicitudId === solicitud.id && solicitud.id)
            );
        }

        if (linkedWorkOrder) {
            statusText = (linkedWorkOrder.status === 'Pendiente') ? 'En Planificaci칩n' : linkedWorkOrder.status;
        } else if (solicitud.status === 'Aprobado') {
             statusText = 'En Planificaci칩n';
        }
        
        switch(statusText) {
            case 'Pendiente': 
                statusBadgeClass = 'bg-warning text-dark'; 
                break;
            case 'Aprobado':
            case 'En Planificaci칩n':
                statusBadgeClass = 'bg-primary'; 
                statusText = 'En Planificaci칩n';
                break;
            case 'En Proceso': 
                statusBadgeClass = 'bg-info text-dark'; 
                break;
            case 'Pausado': 
                statusBadgeClass = 'bg-secondary'; 
                break;
            case 'Completado': 
                statusBadgeClass = 'bg-success'; 
                break;
            case 'Rechazado': 
                statusBadgeClass = 'bg-danger'; 
                break;
            case 'Cancelado':
                statusBadgeClass = 'bg-danger'; 
                break;
            default: 
                statusBadgeClass = 'bg-light text-dark';
        }

        const canManage = ['Admin', 'Planificador', 'T칠cnico'].includes(userRole);
        let vinculadaContent = '';

        if (linkedWorkOrder) {
            vinculadaContent = `
                <button class="btn btn-sm btn-outline-primary view-linked-wo" data-wo-id="${linkedWorkOrder.fb_id || linkedWorkOrder.id}">
                    <i class="fas fa-external-link-alt me-1"></i>${linkedWorkOrder.id}
                </button>`;
        } else if (solicitud.status === 'Pendiente' && canManage) {
            vinculadaContent = `
                <button class="btn btn-sm btn-success create-wo-btn">
                    <i class="fas fa-plus me-1"></i>Crear OT
                </button>`;
        } else {
            vinculadaContent = '<span class="text-muted small">Sin vincular</span>';
        }

        tr.innerHTML = `
            <td class="col-id">${solicitud.id}</td>
            <td>${machine.name}</td>
            <td class="col-desc" title="${solicitud.description}">${solicitud.description}</td>
            <td>${new Date(solicitud.createdAt).toLocaleDateString('es-ES')}</td>
            <td><span class="badge ${statusBadgeClass}">${statusText}</span></td>
            <td>${vinculadaContent}</td>
        `;

        tbody.appendChild(tr);

        if (linkedWorkOrder) {
            tr.querySelector('.view-linked-wo').addEventListener('click', (e) => {
                e.preventDefault();
                showWorkOrderModal(linkedWorkOrder.fb_id || linkedWorkOrder.id);
            });
        } else if (solicitud.status === 'Pendiente' && canManage) {
            tr.querySelector('.create-wo-btn').addEventListener('click', (e) => {
                e.preventDefault();
                showWorkOrderModal(null, 'Correctivo', solicitud);
            });
        }
    });
}
function showSolicitudModal(prefillData = null) {
    document.getElementById('solicitud-form').reset();
    document.getElementById('solicitud-extra-fields').classList.add('d-none');
    document.getElementById('solicitud-machine').required = true;
    document.getElementById('solicitud-machine-label').innerHTML = 'M치quina';
    document.getElementById('solicitud-description-label').innerHTML = 'Descripci칩n del Problema';

    const machineSelect = document.getElementById('solicitud-machine');
    const descriptionText = document.getElementById('solicitud-description');
    machineSelect.innerHTML = '<option value="">Seleccione una m치quina...</option>';

    let machinesToDisplay = state.machines;
    const user = state.currentUser;

    if (user) {
        if (user.role === 'Jefe de Area' && Array.isArray(user.managedMachineIds)) {
            const managedIds = new Set(user.managedMachineIds);
            machinesToDisplay = state.machines.filter(m => managedIds.has(m.id));
        } else if ((user.role === 'T칠cnico' || user.role === 'Operario') && Array.isArray(user.equipoAsignado)) {
            const assignedIds = new Set(user.equipoAsignado);
            machinesToDisplay = state.machines.filter(m => assignedIds.has(m.id));
        }
    }

    machinesToDisplay.forEach(m => machineSelect.innerHTML += `<option value="${m.id}">${m.name}</option>`);

    if (prefillData) {
        if (prefillData.machineId) {
            machineSelect.value = prefillData.machineId;
        }
        if (prefillData.description) {
            descriptionText.value = prefillData.description;
        }
    }

    state.modals.solicitud.show();
}

async function handleSolicitudSubmit(e) {
    e.preventDefault();
    showLoading(true);
    
    const type = document.getElementById('solicitud-type').value;
    const machineId = document.getElementById('solicitud-machine').value;
    const description = document.getElementById('solicitud-description').value;

    if (type === 'insumos') {
        const quantity = parseInt(document.getElementById('solicitud-quantity').value);
        const urgency = document.getElementById('solicitud-urgency').value;

        if (!description || isNaN(quantity) || quantity < 1) {
            showToast('Descripci칩n y cantidad son obligatorias.', 'warning');
            showLoading(false);
            return;
        }

        try {
            const requestData = {
                date: new Date().toISOString(),
                workOrderFbId: '',
                workOrderId: '',
                machineId: machineId || 'General',
                requester: state.currentUser?.username || 'Desconocido',
                description: description,
                quantity: quantity,
                urgency: urgency,
                status: 'Pendiente',
                isDirectRequest: true // Para distinguir de las de OT
            };
            const docRef = await addDoc(state.collections.partRequests, requestData);
            await recordAuditLog('partRequests', docRef.id, 'CREATE', null, requestData, 'Creaci칩n Solicitud Insumos');
            showToast('Solicitud de insumos enviada correctamente', 'success');
            state.modals.solicitud.hide();
        } catch (error) {
            console.error("Error submitting supply request:", error);
            showToast('Error al enviar la solicitud.', 'error');
        } finally {
            showLoading(false);
        }
        return;
    }

    // Caso Mantenimiento (Existente)
    const solicitudesCount = (await getDocs(query(state.collections.solicitudes))).size;
    const nextId = `SOL-${(solicitudesCount + 1).toString().padStart(4, '0')}`;

    const solicitudData = {
        id: nextId,
        machineId: machineId,
        description: description,
        requester: state.currentUser.username,
        status: 'Pendiente',
        createdAt: new Date().toISOString()
    };

    if (!solicitudData.machineId || !solicitudData.description) {
        showToast('Todos los campos son obligatorios.', 'error');
        showLoading(false);
        return;
    }

    try {
        const docRef = await addDoc(state.collections.solicitudes, solicitudData);
        await recordAuditLog('solicitudes', solicitudData.id, 'CREATE', null, solicitudData, 'Creaci칩n Solicitud Mantenimiento');
        showToast('Solicitud enviada correctamente', 'success');
        state.modals.solicitud.hide();

        // --- Sincronizaci칩n con Odoo (Segundo Plano) ---
        if (state.odoo) {
            syncSolicitudToOdoo(solicitudData, docRef.id, nextId).catch(err => {
                console.warn("[Odoo Background Sync] Error:", err);
            });
        }
    } catch(error) {
        console.error("Error submitting solicitud:", error);
        showToast('Error al enviar la solicitud.', 'error');
    } finally {
        showLoading(false);
    }
}

// --- Evaluation Criteria Functions ---

function renderCriteria() {
    const tbodyOperario = document.getElementById('criteria-list-operario');
    const tbodyJefe = document.getElementById('criteria-list-jefe');

    tbodyOperario.innerHTML = '';
    tbodyJefe.innerHTML = '';

    const operarioCriteria = state.evaluationCriteria.filter(c => c.role === 'Operario' || !c.role);
    const jefeCriteria = state.evaluationCriteria.filter(c => c.role === 'Jefe de Area');

    if (operarioCriteria.length === 0) {
        tbodyOperario.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No hay criterios de operario.</td></tr>';
    }
    if (jefeCriteria.length === 0) {
        tbodyJefe.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No hay criterios de jefe de 치rea.</td></tr>';
    }

    state.evaluationCriteria.forEach(criteria => {
        const tr = document.createElement('tr');
        if (criteria.status === 'inactivo') tr.classList.add('table-secondary', 'opacity-50');

        const pairedCriteria = criteria.pairId ? state.evaluationCriteria.find(c => c.fb_id === criteria.pairId) : null;
        const pairText = pairedCriteria ? pairedCriteria.description : '<span class="text-muted small">Sin vincular</span>';

        tr.innerHTML = `
            <td>${criteria.description}</td>
            <td>${pairText}</td>
            <td class="text-center">
                <div class="btn-group">
                    <button class="btn btn-xs btn-outline-primary edit-criteria-btn" data-id="${criteria.fb_id}" title="Editar"><i class="fas fa-edit"></i></button>
                    <button class="btn btn-xs btn-outline-danger delete-criteria-btn" data-id="${criteria.fb_id}" title="Eliminar"><i class="fas fa-trash"></i></button>
                </div>
            </td>
        `;

        if (criteria.role === 'Jefe de Area') {
            tbodyJefe.appendChild(tr);
        } else {
            tbodyOperario.appendChild(tr);
        }
    });

    document.querySelectorAll('.edit-criteria-btn').forEach(btn => {
        btn.addEventListener('click', () => showCriteriaModal(btn.dataset.id));
    });
    document.querySelectorAll('.delete-criteria-btn').forEach(btn => {
        btn.addEventListener('click', () => deleteCriteria(btn.dataset.id));
    });
}

function showCriteriaModal(criteriaId = null) {
    const form = document.getElementById('criteria-form');
    form.reset();
    document.getElementById('criteria-id-hidden').value = '';

    const roleSelect = document.getElementById('criteria-role');
    const pairSelect = document.getElementById('criteria-pair');

    const updatePairs = () => {
        const selectedRole = roleSelect.value;
        const currentId = document.getElementById('criteria-id-hidden').value;
        pairSelect.innerHTML = '<option value="">Ninguno (Criterio independiente)</option>';

        state.evaluationCriteria.forEach(c => {
            // Solo mostrar criterios del rol OPUESTO y que no sean el actual
            if (c.role !== selectedRole && c.fb_id !== currentId) {
                const opt = document.createElement('option');
                opt.value = c.fb_id;
                opt.textContent = c.description;
                pairSelect.appendChild(opt);
            }
        });
    };

    roleSelect.onchange = updatePairs;

    if (criteriaId) {
        const criteria = state.evaluationCriteria.find(c => c.fb_id === criteriaId);
        if (criteria) {
            document.getElementById('criteria-modal-title').textContent = 'Editar Criterio';
            document.getElementById('criteria-id-hidden').value = criteria.fb_id;
            document.getElementById('criteria-description').value = criteria.description;
            roleSelect.value = criteria.role || 'Operario';
            updatePairs();
            pairSelect.value = criteria.pairId || '';
            document.getElementById('criteria-status').value = criteria.status;
        }
    } else {
        document.getElementById('criteria-modal-title').textContent = 'A침adir Criterio';
        updatePairs();
    }
    state.modals.criteria.show();
}

async function handleCriteriaSubmit(e) {
    e.preventDefault();
    const criteriaId = document.getElementById('criteria-id-hidden').value;
    const pairId = document.getElementById('criteria-pair').value;
    const criteriaData = {
        description: document.getElementById('criteria-description').value,
        role: document.getElementById('criteria-role').value,
        pairId: pairId || null,
        status: document.getElementById('criteria-status').value
    };

    if (!criteriaData.description) {
        showToast('La descripci칩n es obligatoria.', 'error');
        return;
    }

    showLoading(true);
    try {
        let finalId = criteriaId;
        if (criteriaId) {
            // Si estamos editando y ten칤a una pareja anterior, quitar el link de esa pareja
            const oldCriteria = state.evaluationCriteria.find(c => c.fb_id === criteriaId);
            if (oldCriteria && oldCriteria.pairId && oldCriteria.pairId !== pairId) {
                await updateDoc(doc(state.collections.evaluationCriteria, oldCriteria.pairId), { pairId: null });
            }
            await setDoc(doc(state.collections.evaluationCriteria, criteriaId), criteriaData, { merge: true });
            await recordAuditLog('evaluationCriteria', criteriaId, 'UPDATE', oldCriteria, criteriaData);
            showToast('Criterio actualizado.', 'success');
        } else {
            const docRef = await addDoc(state.collections.evaluationCriteria, criteriaData);
            finalId = docRef.id;
            await recordAuditLog('evaluationCriteria', finalId, 'CREATE', null, criteriaData);
            showToast('Criterio a침adido.', 'success');
        }

        // Si se seleccion칩 una pareja, actualizarla tambi칠n para que apunte a este criterio (v칤nculo bidireccional)
        if (pairId) {
            await updateDoc(doc(state.collections.evaluationCriteria, pairId), { pairId: finalId });
        }

        state.modals.criteria.hide();
    } catch (error) {
        console.error("Error saving criteria:", error);
        showToast('Error al guardar el criterio.', 'error');
    } finally {
        showLoading(false);
    }
}

function deleteCriteria(criteriaId) {
    showConfirmation('Eliminar Criterio', '쮼st치 seguro de eliminar este criterio?', async () => {
        showLoading(true);
        try {
            // Si tiene pareja, quitar el v칤nculo en la pareja antes de borrar
            const criteria = state.evaluationCriteria.find(c => c.fb_id === criteriaId);
            if (criteria && criteria.pairId) {
                await updateDoc(doc(state.collections.evaluationCriteria, criteria.pairId), { pairId: null });
            }
            await deleteDoc(doc(state.collections.evaluationCriteria, criteriaId));
            await recordAuditLog('evaluationCriteria', criteriaId, 'DELETE', criteria, null);
            showToast('Criterio eliminado.', 'success');
        } catch (error) {
            console.error("Error deleting criteria:", error);
            showToast('Error al eliminar el criterio.', 'error');
        } finally {
            showLoading(false);
        }
    });
}

// --- Evaluation & Profile Functions ---

function showEvaluationDetailsModal(workOrderId) {
    const order = state.workOrders.find(o => o.fb_id === workOrderId);
    if (!order) return;

    const evs = state.technicianEvaluations.filter(ev => ev.workOrderFbId === workOrderId);
    const container = document.getElementById('evaluation-details-content');

    let html = `
        <div class="mb-4">
            <h6 class="fw-bold"><i class="fas fa-info-circle me-2"></i>Informaci칩n de la Orden</h6>
            <div class="row">
                <div class="col-md-6"><p class="mb-1"><strong>ID:</strong> ${order.id}</p></div>
                <div class="col-md-6"><p class="mb-1"><strong>M치quina:</strong> ${order.machineId}</p></div>
                <div class="col-12"><p class="mb-1"><strong>Descripci칩n:</strong> ${order.description}</p></div>
            </div>
        </div>
        <hr>
    `;

    if (evs.length === 0) {
        html += '<p class="text-center text-muted">No hay evaluaciones registradas para esta orden.</p>';
    } else {
        evs.forEach(ev => {
            const dateStr = ev.evaluationDate ? new Date(ev.evaluationDate).toLocaleString() : 'N/A';
            const avgRating = ev.maxScore > 0 ? (ev.score / ev.maxScore) * 5 : 0;
            const evaluatorDisplayName = ev.evaluatorName || ev.evaluatorId || 'N/A';

            html += `
                <div class="card mb-3 shadow-sm border-0 bg-light">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0 text-primary"><i class="fas fa-user-tag me-2"></i>${ev.evaluatorRole}: ${evaluatorDisplayName}</h6>
                            <span class="badge bg-secondary">${dateStr}</span>
                        </div>
                        <div class="mb-2">
                            <strong>Calificaci칩n: </strong>
                            <span class="text-warning">
                                ${Array.from({length: 5}, (_, i) => `<i class="${i < Math.round(avgRating) ? 'fas' : 'far'} fa-star"></i>`).join('')}
                            </span>
                            <span class="ms-2 fw-bold" style="font-size: 1.1rem;">${avgRating.toFixed(1)}</span>
                        </div>
                        <div class="mb-2">
                            <p class="mb-1"><strong>Comentarios:</strong></p>
                            <p class="mb-0 italic text-muted">"${ev.comments || 'Sin comentarios'}"</p>
                        </div>
                        <div class="mt-2">
                            <p class="mb-1 small"><strong>Criterios:</strong></p>
                            <ul class="list-inline mb-0">
                                ${(ev.results || []).map(res => {
                                    return `<li class="list-inline-item small me-3"><span class="text-muted">${res.description}:</span> <strong>${res.score ? 'S칤' : 'No'}</strong></li>`;
                                }).join('')}
                            </ul>
                        </div>
                    </div>
                </div>
            `;
        });
    }

    container.innerHTML = html;
    const modal = new bootstrap.Modal(document.getElementById('evaluation-details-modal'));
    modal.show();
}

function showEvaluationModal(workOrderId) {
    const workOrder = state.workOrders.find(wo => wo.id === workOrderId || wo.fb_id === workOrderId);
    if (!workOrder) {
        showToast('Orden de trabajo no encontrada.', 'error');
        return;
    }

    // Bloquear evaluaci칩n si es de plan o de solicitud y no ha sido validada por el planificador
    const isPlanOrder = workOrder.type === 'Preventivo' || workOrder.linkedPlanId;
    const hasRequest = workOrder.solicitudId || workOrder.sourceSolicitudId;
    if ((isPlanOrder || hasRequest) && !workOrder.validatedBy) {
        showToast('Esta orden debe ser validada por el Planificador antes de proceder a la evaluaci칩n.', 'warning');
        return;
    }

    document.getElementById('evaluation-form').reset();
    document.getElementById('evaluation-wo-id-hidden').value = workOrder.fb_id;

    // Determinar qu칠 rol est치 evaluando el usuario actual
    const userRole = state.currentUser?.role;
    const existingEvaluations = state.technicianEvaluations.filter(ev => ev.workOrderFbId === workOrder.fb_id);
    const originalSolicitud = (workOrder.solicitudId || workOrder.sourceSolicitudId) ? state.solicitudes.find(s => s.id === (workOrder.solicitudId || workOrder.sourceSolicitudId) || s.fb_id === (workOrder.solicitudId || workOrder.sourceSolicitudId)) : null;
    const isRequester = originalSolicitud && originalSolicitud.requester === state.currentUser?.username;
    const hasOpEval = existingEvaluations.some(ev => ev.evaluatorRole === 'Operario');
    const hasJfEval = existingEvaluations.some(ev => ev.evaluatorRole === 'Jefe de Area');

    let evaluatingRole = '';
    if (userRole === 'Admin') {
        if (!hasOpEval) evaluatingRole = 'Operario';
        else if (!hasJfEval) evaluatingRole = 'Jefe de Area';
        else evaluatingRole = 'Jefe de Area'; // Por defecto vista de Jefe
    } else {
        const isJefeCandidate = (userRole === 'Jefe de Area' || (userRole === 'Planificador' && workOrder.type === 'Preventivo'));
        const isOperarioCandidate = (userRole === 'Operario' || isRequester);

        if (isJefeCandidate && isOperarioCandidate) {
            if (!hasOpEval) evaluatingRole = 'Operario';
            else evaluatingRole = 'Jefe de Area';
        } else if (isJefeCandidate) {
            evaluatingRole = 'Jefe de Area';
        } else if (isOperarioCandidate) {
            evaluatingRole = 'Operario';
        }
    }

    const existingEval = existingEvaluations.find(ev => ev.evaluatorRole === evaluatingRole);
    const isReadOnly = !!existingEval;

    document.getElementById('evaluation-modal-title').textContent = isReadOnly
        ? `Evaluaci칩n de ${evaluatingRole}: ${workOrder.id}`
        : `Evaluar como ${evaluatingRole}: ${workOrder.id}`;

    // Configurar UI de solo lectura
    const badge = document.getElementById('evaluation-read-only-badge');
    const saveBtn = document.getElementById('evaluation-save-btn');
    const commentsField = document.getElementById('evaluation-comments');

    if (isReadOnly) {
        badge.classList.remove('d-none');
        document.getElementById('evaluation-evaluator-name').textContent = existingEval.evaluatorId || 'N/A';
        saveBtn.classList.add('d-none');
        commentsField.value = existingEval.comments || '';
        commentsField.disabled = true;
    } else {
        badge.classList.add('d-none');
        saveBtn.classList.remove('d-none');
        commentsField.disabled = false;
    }

    // Guardar el rol evaluador en un dataset para el submit
    document.getElementById('evaluation-form').dataset.evaluatingRole = evaluatingRole;

    const criteriaContainer = document.getElementById('evaluation-criteria-container');
    criteriaContainer.innerHTML = '';

    if (isReadOnly) {
        // Renderizar los resultados de la evaluaci칩n existente
        if (!existingEval.results || existingEval.results.length === 0) {
            criteriaContainer.innerHTML = `<p class="text-muted">No se encontraron detalles de criterios para esta evaluaci칩n.</p>`;
        } else {
            existingEval.results.forEach(res => {
                const div = document.createElement('div');
                div.className = 'form-check mb-2';
                div.innerHTML = `
                    <input class="form-check-input" type="checkbox" ${res.score ? 'checked' : ''} disabled>
                    <label class="form-check-label">
                        ${res.description}
                    </label>
                `;
                criteriaContainer.appendChild(div);
            });
        }
    } else {
        // Renderizar criterios activos para nueva evaluaci칩n
        const activeCriteria = state.evaluationCriteria.filter(c => c.status === 'activo' && (c.role === evaluatingRole || (!c.role && evaluatingRole === 'Operario')));

        if (activeCriteria.length === 0) {
            criteriaContainer.innerHTML = `<p class="text-muted">No hay criterios de evaluaci칩n activos para el rol ${evaluatingRole}.</p>`;
        } else {
            activeCriteria.forEach(criteria => {
                const div = document.createElement('div');
                div.className = 'form-check mb-2';
                div.innerHTML = `
                    <input class="form-check-input evaluation-checkbox" type="checkbox" value="${criteria.fb_id}" id="eval-${criteria.fb_id}">
                    <label class="form-check-label" for="eval-${criteria.fb_id}">
                        ${criteria.description}
                    </label>
                `;
                criteriaContainer.appendChild(div);
            });
        }
    }
    state.modals.evaluation.show();
}


async function handleEvaluationSubmit(e) {
    e.preventDefault();
    const workOrderFbId = document.getElementById('evaluation-wo-id-hidden').value;
    const workOrder = state.workOrders.find(wo => wo.fb_id === workOrderFbId);
    const evaluatingRole = e.target.dataset.evaluatingRole;

    if (!workOrder) {
        showToast('Error: Orden de trabajo no encontrada.', 'error');
        return;
    }

    const evaluationResults = [];
    document.querySelectorAll('.evaluation-checkbox').forEach(checkbox => {
        evaluationResults.push({
            criteriaId: checkbox.value,
            description: checkbox.nextElementSibling.textContent.trim(),
            score: checkbox.checked ? 1 : 0
        });
    });

    const evaluationData = {
        workOrderId: workOrder.id,
        workOrderFbId: workOrder.fb_id,
        technicianId: workOrder.leadTechnician,
        evaluatorId: state.currentUser.username,
        evaluatorName: state.currentUser.username,
        evaluatorRole: evaluatingRole, // Guardamos el rol que evalu칩
        evaluationDate: new Date().toISOString(),
        comments: document.getElementById('evaluation-comments').value,
        results: evaluationResults,
        score: evaluationResults.reduce((acc, item) => acc + item.score, 0),
        maxScore: evaluationResults.length
    };

    const confirmed = await new Promise(resolve => {
        requestSignature(() => resolve(true), () => resolve(false));
    });
    if (!confirmed) return;

    showLoading(true);
    try {
        const now = new Date().toISOString();

        // 1. Guardar la evaluaci칩n actual
        const docRef = await addDoc(state.collections.technicianEvaluations, evaluationData);
        await recordAuditLog('technicianEvaluations', evaluationData.workOrderId || docRef.id, 'CREATE', null, evaluationData, 'Evaluaci칩n T칠cnica (Firmada)');

        // 2. Verificar si ya est치n las dos evaluaciones (Operario y Jefe de Area)
        const allEvaluations = state.technicianEvaluations.filter(ev => ev.workOrderFbId === workOrderFbId);
        // A침adimos la actual ya que el snapshot puede tardar un poco
        allEvaluations.push(evaluationData);

        const hasOperario = allEvaluations.some(ev => ev.evaluatorRole === 'Operario');
        const hasJefe = allEvaluations.some(ev => ev.evaluatorRole === 'Jefe de Area');

        if (hasOperario && hasJefe) {
            // Solo si est치n ambas, pasamos a Completado
            await updateDoc(doc(state.collections.workOrders, workOrderFbId), { status: 'Completado' });
            await completeLinkedPlanExecution(workOrderFbId, now, 'Completado');
            showToast('Evaluaci칩n guardada. Orden de trabajo completada al recibir ambas evaluaciones.', 'success');
        } else {
            showToast(`Evaluaci칩n de ${evaluatingRole} guardada. Pendiente de la otra evaluaci칩n para completar la OT.`, 'info');
        }

        state.modals.evaluation.hide();
    } catch (error) {
        console.error("Error saving evaluation:", error);
        showToast('Error al guardar la evaluaci칩n.', 'error');
    } finally {
        showLoading(false);
    }
}

async function showTechnicianProfileModal(technicianId) {
    const technician = state.technicians.find(t => t.fb_id === technicianId);
    if (!technician) return;

    // Set basic info
    document.getElementById('technician-profile-modal-title').textContent = `Perfil de ${technician.username}`;
    document.getElementById('technician-profile-avatar').src = `https://ui-avatars.com/api/?name=${technician.username}&background=0D8ABC&color=fff`;
    document.getElementById('technician-profile-name').textContent = technician.username;
    document.getElementById('technician-profile-role').textContent = technician.role;

    // Calculate and set metrics
    const assignedOrders = state.workOrders.filter(wo => wo.technicians.includes(technician.username));
    const completedOrders = assignedOrders.filter(wo => wo.status === 'Completado' || wo.status === 'Pendiente de Evaluaci칩n');
    document.getElementById('technician-profile-assigned').textContent = assignedOrders.length;
    document.getElementById('technician-profile-completed').textContent = completedOrders.length;

    // Fetch and display evaluations
    const evaluationsContainer = document.getElementById('technician-profile-evaluations');
    evaluationsContainer.innerHTML = '<div class="spinner-border spinner-border-sm"></div>';

    const technicianEvaluations = state.technicianEvaluations.filter(e => e.technicianId === technician.username);

    if (technicianEvaluations.length === 0) {
        evaluationsContainer.innerHTML = '<p class="text-muted">Este t칠cnico a칰n no tiene evaluaciones.</p>';
    } else {
        const totalScore = technicianEvaluations.reduce((sum, e) => sum + e.score, 0);
        const totalMaxScore = technicianEvaluations.reduce((sum, e) => sum + e.maxScore, 0);
        const averageScorePercentage = totalMaxScore > 0 ? (totalScore / totalMaxScore) * 100 : 0;

        evaluationsContainer.innerHTML = `
            <div class="mb-3">
                <h5>Puntuaci칩n Promedio</h5>
                <div class="progress" style="height: 25px;">
                    <div class="progress-bar" role="progressbar" style="width: ${averageScorePercentage.toFixed(2)}%;" aria-valuenow="${averageScorePercentage.toFixed(2)}" aria-valuemin="0" aria-valuemax="100">
                        ${averageScorePercentage.toFixed(1)}%
                    </div>
                </div>
            </div>
            <h6>Desglose por Criterio (칔ltimas 10 evaluaciones)</h6>
            <ul class="list-group text-start">
                ${renderCriteriaBreakdown(technicianEvaluations.slice(-10), false)}
            </ul>
        `;
    }


    state.modals.technicianProfile.show();
}

function renderCriteriaBreakdown(evaluations, forPdf = false) {
    const criteriaStats = {}; // { description: { positive: 10, total: 15 } }

    evaluations.forEach(evaluation => {
        evaluation.results.forEach(result => {
            if (!criteriaStats[result.description]) {
                criteriaStats[result.description] = { positive: 0, total: 0 };
            }
            criteriaStats[result.description].total++;
            if (result.score === 1) {
                criteriaStats[result.description].positive++;
            }
        });
    });

    const breakdown = Object.entries(criteriaStats).map(([description, stats]) => {
        const percentage = stats.total > 0 ? (stats.positive / stats.total) * 100 : 0;
        return { description, percentage };
    });

    if (forPdf) {
        return breakdown;
    }

    return breakdown.map(item => `
        <li class="list-group-item d-flex justify-content-between align-items-center">
            ${item.description}
            <span class="badge bg-primary rounded-pill">${item.percentage.toFixed(0)}%</span>
        </li>
    `).join('');
}


// --- Work Plan Functions ---

function renderWorkPlans() {
    const container = document.getElementById('work-plans-list-container');
    const searchTerm = document.getElementById('work-plan-search-input').value.toLowerCase();
    container.innerHTML = '';

    let plansToRender = state.workPlans;
    if (state.currentUser?.role === 'Jefe de Area' && Array.isArray(state.currentUser.managedMachineIds)) {
        const managedIds = new Set(state.currentUser.managedMachineIds);
        plansToRender = state.workPlans.filter(p => managedIds.has(p.machineId));
    } else if ((state.currentUser?.role === 'T칠cnico' || state.currentUser?.role === 'Operario') && Array.isArray(state.currentUser.equipoAsignado)) {
        const assignedIds = new Set(state.currentUser.equipoAsignado);
        plansToRender = state.workPlans.filter(p => assignedIds.has(p.machineId));
    }

    const filteredPlans = plansToRender.filter(p => p.name.toLowerCase().includes(searchTerm));
    if (filteredPlans.length === 0) {
        container.innerHTML = '<div class="alert alert-light text-center">No se encontraron planes.</div>';
        return;
    }

    const createWorkPlanListItem = (plan) => {
        const machine = state.machines.find(m => m.id === plan.machineId);
        const item = document.createElement('a');
        item.href = '#';
        item.className = 'list-group-item list-group-item-action border-0 py-2 px-3';
        item.dataset.id = plan.fb_id;
        item.setAttribute('data-plan-id', plan.fb_id);
        const frequencyMap = { 'h': 'Hora(s)', 'd': 'D칤a(s)', 'w': 'Semana(s)', 'm': 'Mes(es)', 'y': 'A침o(s)'};
        const frequencyText = `Cada ${plan.frequencyValue || 1} ${frequencyMap[plan.frequencyUnit] || 'Mes(es)'}`;
        item.innerHTML = `
            <div class="d-flex w-100 justify-content-between align-items-center">
                <h6 class="mb-0 small fw-bold text-primary">${plan.name}</h6>
                <small class="text-muted" style="font-size: 0.7rem;">${frequencyText}</small>
            </div>
            ${state.activeWorkPlanTab !== 'machine' ? `<p class="mb-0 small text-muted mt-1" style="font-size: 0.75rem;">${machine?.name || 'M치quina no encontrada'}</p>` : ''}
        `;
        item.addEventListener('click', (e) => {
            e.preventDefault();
            document.querySelectorAll('#work-plans-list-container .list-group-item').forEach(el => el.classList.remove('active'));
            item.classList.add('active');
            renderWorkPlanDetails(plan.fb_id);
        });
        return item;
    };

    if (state.activeWorkPlanTab === 'all') {
        const listGroup = document.createElement('div');
        listGroup.className = 'list-group';
        filteredPlans.forEach(plan => {
            listGroup.appendChild(createWorkPlanListItem(plan));
        });
        container.appendChild(listGroup);
    } else {
        // Grouped view
        let grouped = {};
        if (state.activeWorkPlanTab === 'machine') {
            filteredPlans.forEach(plan => {
                const machine = state.machines.find(m => m.id === plan.machineId);
                const groupName = machine?.name || 'Sin M치quina';
                if (!grouped[groupName]) grouped[groupName] = [];
                grouped[groupName].push(plan);
            });
        } else if (state.activeWorkPlanTab === 'frequency') {
            const frequencyMap = { 'd': 'Diario', 'w': 'Semanal', 'm': 'Mensual', 'y': 'Anual'};
            filteredPlans.forEach(plan => {
                const freqLabel = frequencyMap[plan.frequencyUnit] || 'Otros';
                const groupName = `${freqLabel} (Cada ${plan.frequencyValue || 1})`;
                if (!grouped[groupName]) grouped[groupName] = [];
                grouped[groupName].push(plan);
            });
        }

        const accordion = document.createElement('div');
        accordion.className = 'accordion accordion-flush';
        accordion.id = 'workPlansAccordion';

        Object.keys(grouped).sort().forEach((groupName, index) => {
            const plans = grouped[groupName];
            const accordionItem = document.createElement('div');
            accordionItem.className = 'accordion-item border-bottom';

            const headerId = `headingWP${index}`;
            const collapseId = `collapseWP${index}`;

            const isExpanded = searchTerm.length > 0 || index === 0;

            accordionItem.innerHTML = `
                <h2 class="accordion-header" id="${headerId}">
                    <button class="accordion-button ${isExpanded ? '' : 'collapsed'} py-2" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}" aria-expanded="${isExpanded}" aria-controls="${collapseId}">
                        <div class="d-flex justify-content-between w-100 align-items-center pe-3">
                            <span class="fw-bold small">${groupName}</span>
                            <span class="badge bg-secondary rounded-pill small">${plans.length}</span>
                        </div>
                    </button>
                </h2>
                <div id="${collapseId}" class="accordion-collapse collapse ${isExpanded ? 'show' : ''}" aria-labelledby="${headerId}" ${searchTerm.length === 0 ? 'data-bs-parent="#workPlansAccordion"' : ''}>
                    <div class="accordion-body p-0">
                        <div class="list-group list-group-flush">
                        </div>
                    </div>
                </div>
            `;

            const listGroup = accordionItem.querySelector('.list-group');
            plans.forEach(plan => {
                listGroup.appendChild(createWorkPlanListItem(plan));
            });

            accordion.appendChild(accordionItem);
        });
        container.appendChild(accordion);
    }
}

function renderWorkPlanDetails(planId) {
    const detailsContainer = document.getElementById('work-plan-details-container');
    const placeholder = document.getElementById('work-plan-placeholder');
    const plan = state.workPlans.find(p => p.fb_id === planId);

    if (!plan) {
        detailsContainer.classList.add('d-none');
        placeholder.classList.remove('d-none');
        return;
    }

    const machine = state.machines.find(m => m.id === plan.machineId);
    const technician = state.technicians.find(t => t.username === plan.responsibleTechnician);
    const lastExecution = state.workPlanExecutions.filter(e => e.planId === plan.fb_id).sort((a,b) => new Date(b.executedAt) - new Date(a.executedAt))[0];

    const userRole = state.currentUser?.role;
    const canEdit = userRole !== 'Operario' && userRole !== 'Invitado';
    const activeExecution = state.workPlanExecutions.find(ex => ex.planId === planId && (ex.status === 'En Proceso' || ex.status === 'Pausado'));

    detailsContainer.innerHTML = `
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">${plan.name}</h5>
                <div>
                    <button class="btn btn-sm ${activeExecution ? 'btn-warning' : 'btn-info'} me-1" id="view-plan-btn" title="${activeExecution ? 'Ver Ejecuci칩n Activa' : 'Ver Tareas del Plan'}">
                        <i class="fas ${activeExecution ? 'fa-external-link-alt' : 'fa-eye'}"></i> ${activeExecution ? 'Ver Ejecuci칩n' : 'Ver Plan'}
                    </button>
                    ${canEdit ? `
                        <button class="btn btn-sm btn-outline-primary" id="edit-plan-btn" title="Editar Plan"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-outline-danger" id="delete-plan-btn" title="Eliminar Plan"><i class="fas fa-trash"></i></button>
                    ` : ''}
                </div>
            </div>
            <div class="card-body">
                <p><strong>M치quina:</strong> ${machine?.name || 'N/A'}</p>
                <p><strong>T칠cnico Responsable:</strong> ${technician?.username || 'N/A'}</p>
                <p><strong>Frecuencia:</strong> Cada ${plan.frequencyValue || 1} ${ {'h': 'Hora(s)', 'd': 'D칤a(s)', 'w': 'Semana(s)', 'm': 'Mes(es)', 'y': 'A침o(s)'}[plan.frequencyUnit] || 'Mes(es)'}</p>
                 <p><strong>Pr칩xima Ejecuci칩n Programada:</strong> ${plan.nextDueDate ? new Date(plan.nextDueDate + 'T00:00:00').toLocaleDateString('es-ES') : 'N/A'}</p>
                 <p><strong>칔ltima Ejecuci칩n:</strong> ${plan.lastExecutedAt ? new Date(plan.lastExecutedAt).toLocaleString('es-ES') : 'Nunca'}</p>
                <hr>
                <h6>Tareas a Realizar</h6>
                ${(plan.taskGroups || []).map(group => `
                    <div class="mb-3">
                        <div class="d-flex align-items-center gap-2 mb-1">
                            <span class="badge bg-secondary x-small">${group.layout === 'cards' ? 'Vista Tarjetas' : 'Vista Tabla'}</span>
                            <strong>${group.name}</strong>
                        </div>
                        <ul class="list-unstyled ms-3 x-small">
                            ${group.tasks.map(task => `
                                <li>
                                    <i class="fas fa-check-circle text-secondary me-2"></i>
                                    <strong>${task.description}</strong>
                                    ${task.helperText ? `<span class="text-muted"> - ${task.helperText}</span>` : ''}
                                    <span class="badge bg-light text-dark border ms-1">${task.type}</span>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                `).join('')}
            </div>
        </div>
    `;

    detailsContainer.querySelector('#view-plan-btn').addEventListener('click', () => {
        if (activeExecution) {
            startWorkPlanExecution(activeExecution, plan);
        } else {
            // Visualization-only mode from the plans tab
            executeWorkPlan(planId, true);
        }
    });

    if (canEdit) {
        detailsContainer.querySelector('#edit-plan-btn').addEventListener('click', () => showWorkPlanModal(planId));
        detailsContainer.querySelector('#delete-plan-btn').addEventListener('click', () => deleteWorkPlan(planId));
    }


    placeholder.classList.add('d-none');
    detailsContainer.classList.remove('d-none');
}

function showWorkPlanModal(planId = null) {
    const form = document.getElementById('work-plan-form');
    form.reset();
    document.getElementById('task-groups-container').innerHTML = '';

    const machineSelect = document.getElementById('work-plan-machine');
    machineSelect.innerHTML = '<option value="">Seleccione una m치quina...</option>';
    state.machines.forEach(m => machineSelect.innerHTML += `<option value="${m.id}">${m.name}</option>`);

    const techSelect = document.getElementById('work-plan-responsible');
    techSelect.innerHTML = '<option value="">Seleccione un t칠cnico...</option>';
    state.technicians.filter(t => t.role === 'T칠cnico').forEach(t => techSelect.innerHTML += `<option value="${t.username}">${t.username}</option>`);

    if (planId) {
        document.getElementById('work-plan-modal-title').textContent = 'Editar Plan de Trabajo';
        const plan = state.workPlans.find(p => p.fb_id === planId);
        if (plan) {
            document.getElementById('work-plan-id-hidden').value = plan.fb_id;
            document.getElementById('work-plan-name').value = plan.name;
            document.getElementById('work-plan-machine').value = plan.machineId;
            document.getElementById('work-plan-description').value = plan.description;
            document.getElementById('work-plan-responsible').value = plan.responsibleTechnician;
            document.getElementById('work-plan-frequency-value').value = plan.frequencyValue || 1;
            document.getElementById('work-plan-frequency-unit').value = plan.frequencyUnit || 'm';
            document.getElementById('work-plan-start-date').value = plan.nextDueDate;

            (plan.taskGroups || []).forEach(group => {
                addTaskGroup(group.name, group.layout || 'table', group.tasks);
            });
        }
    } else {
        document.getElementById('work-plan-modal-title').textContent = 'Nuevo Plan de Trabajo';
        document.getElementById('work-plan-id-hidden').value = '';
    }

    state.modals.workPlan.show();
}

async function handleWorkPlanSubmit() {
    const planId = document.getElementById('work-plan-id-hidden').value;
    const taskGroups = [];
    document.querySelectorAll('#task-groups-container .task-group').forEach(groupEl => {
        const groupName = groupEl.querySelector('.task-group-name-input').value;
        const groupLayout = groupEl.querySelector('.task-group-layout-select').value;
        const tasks = [];
        groupEl.querySelectorAll('.task-item').forEach(taskEl => {
            const description = taskEl.querySelector('.task-description-input').value;
            if (description) {
                const type = taskEl.querySelector('.task-type-select').value;
                const fieldsInput = taskEl.querySelector('.task-multi-fields-input').value;
                tasks.push({
                    description: description,
                    helperText: taskEl.querySelector('.task-helper-input').value,
                    type: type,
                    unit: taskEl.querySelector('.task-unit-input').value,
                    requirePhoto: taskEl.querySelector('.task-photo-check').checked,
                    allowAlerta: taskEl.querySelector('.task-alerta-check').checked,
                    fields: fieldsInput ? fieldsInput.split(',').map(s => s.trim()).filter(s => s) : null
                });
            }
        });
        if (groupName && tasks.length > 0) {
            taskGroups.push({ name: groupName, layout: groupLayout, tasks: tasks });
        }
    });

    const planData = {
        name: document.getElementById('work-plan-name').value,
        machineId: document.getElementById('work-plan-machine').value,
        description: document.getElementById('work-plan-description').value,
        responsibleTechnician: document.getElementById('work-plan-responsible').value,
        frequencyValue: parseInt(document.getElementById('work-plan-frequency-value').value),
        frequencyUnit: document.getElementById('work-plan-frequency-unit').value,
        nextDueDate: document.getElementById('work-plan-start-date').value,
        taskGroups: taskGroups,
        isActive: true,
    };

    if (!planData.name || !planData.machineId || !planData.responsibleTechnician || !planData.nextDueDate) {
        showToast('Por favor, complete todos los campos obligatorios.', 'error');
        return;
    }

    showLoading(true);
    try {
        const oldPlan = planId ? state.workPlans.find(p => p.fb_id === planId) : null;
        if (planId) {
            await setDoc(doc(state.collections.workPlans, planId), planData, { merge: true });
            await recordAuditLog('workPlans', planId, 'UPDATE', oldPlan, planData);
            showToast('Plan de trabajo actualizado.', 'success');
        } else {
            const docRef = await addDoc(state.collections.workPlans, planData);
            await recordAuditLog('workPlans', docRef.id, 'CREATE', null, planData);
            showToast('Plan de trabajo creado.', 'success');
        }
        state.modals.workPlan.hide();
        renderWorkPlans();
    } catch (error) {
        console.error("Error saving work plan:", error);
        showToast('Error al guardar el plan de trabajo.', 'error');
    } finally {
        showLoading(false);
    }
}

function deleteWorkPlan(planId) {
    showConfirmation('Eliminar Plan de Trabajo', '쮼st치 seguro de que desea eliminar este plan? Esta acci칩n no se puede deshacer.', async () => {
        showLoading(true);
        try {
            const oldPlan = state.workPlans.find(p => p.fb_id === planId);
            await deleteDoc(doc(state.collections.workPlans, planId));
            await recordAuditLog('workPlans', planId, 'DELETE', oldPlan, null);
            showToast('Plan de trabajo eliminado.', 'success');
            document.getElementById('work-plan-details-container').classList.add('d-none');
            document.getElementById('work-plan-placeholder').classList.remove('d-none');
        } catch (error) {
            console.error("Error deleting work plan:", error);
            showToast('Error al eliminar el plan.', 'error');
        } finally {
            showLoading(false);
        }
    });
}

function addTaskGroup(name = '', layout = 'table', tasks = []) {
    const container = document.getElementById('task-groups-container');
    const groupEl = document.createElement('div');
    groupEl.className = 'card mb-3 task-group';
    groupEl.innerHTML = `
        <div class="card-header p-2 bg-light d-flex align-items-center gap-2">
            <input type="text" class="form-control form-control-sm task-group-name-input" placeholder="Nombre de la Secci칩n (ej: Reductor)" value="${name}">
            <select class="form-select form-select-sm task-group-layout-select" style="width: auto;">
                <option value="table" ${layout === 'table' ? 'selected' : ''}>Vista Tabla</option>
                <option value="cards" ${layout === 'cards' ? 'selected' : ''}>Vista Tarjetas</option>
            </select>
            <button class="btn btn-outline-danger btn-sm" type="button" onclick="this.closest('.task-group').remove()"><i class="fas fa-trash"></i></button>
        </div>
        <div class="card-body p-2">
            <div class="tasks-list"></div>
            <div class="mt-2 text-center">
                <button type="button" class="btn btn-outline-primary btn-sm add-task-btn"><i class="fas fa-plus me-1"></i>A침adir Item de Formulario</button>
            </div>
        </div>
    `;

    const tasksList = groupEl.querySelector('.tasks-list');

    const addTaskItem = (task = null) => {
        const taskEl = document.createElement('div');
        taskEl.className = 'border rounded p-2 mb-2 bg-white shadow-sm task-item';
        taskEl.innerHTML = `
            <div class="d-flex justify-content-between align-items-start mb-2">
                <div class="flex-grow-1 me-2">
                    <input type="text" class="form-control form-control-sm fw-bold task-description-input mb-1" placeholder="T칤tulo de la tarea (ej: Nivel de aceite)" value="${task?.description || ''}">
                    <input type="text" class="form-control form-control-sm task-helper-input" placeholder="Instrucci칩n corta (ej: Verificar visor frontal)" value="${task?.helperText || ''}">
                </div>
                <button class="btn btn-link text-danger p-0" type="button" onclick="this.closest('.task-item').remove()"><i class="fas fa-trash"></i></button>
            </div>
            <div class="row g-2 align-items-center">
                <div class="col-md-4">
                    <label class="x-small fw-bold mb-1 d-block">Tipo de Campo</label>
                    <select class="form-select form-select-sm task-type-select">
                        <option value="status_detail" ${task?.type === 'status_detail' ? 'selected' : ''}>Estado (OK/FALLO) + Detalle</option>
                        <option value="numeric" ${task?.type === 'numeric' ? 'selected' : ''}>Medici칩n Num칠rica</option>
                        <option value="multi_numeric" ${task?.type === 'multi_numeric' ? 'selected' : ''}>M칰ltiples Mediciones</option>
                        <option value="text" ${task?.type === 'text' ? 'selected' : ''}>Solo Texto/Observaci칩n</option>
                    </select>
                </div>
                <div class="col-md-3 unit-container ${['numeric', 'multi_numeric'].includes(task?.type) ? '' : 'd-none'}">
                    <label class="x-small fw-bold mb-1 d-block">Unidad</label>
                    <input type="text" class="form-control form-control-sm task-unit-input" placeholder="ej: 춿C, A, PSI" value="${task?.unit || ''}">
                </div>
                <div class="col-md-5 d-flex align-items-end gap-3 pb-1">
                    <div class="form-check">
                        <input class="form-check-input task-photo-check" type="checkbox" ${task?.requirePhoto ? 'checked' : ''}>
                        <label class="form-check-label x-small">Foto Oblig.</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input task-alerta-check" type="checkbox" ${task?.allowAlerta !== false ? 'checked' : ''}>
                        <label class="form-check-label x-small">Permitir ALERTA</label>
                    </div>
                </div>
            </div>
            <div class="multi-fields-container mt-2 ${task?.type === 'multi_numeric' ? '' : 'd-none'}">
                <label class="x-small fw-bold mb-1 d-block">Sub-campos (ej: Fase L1, Fase L2)</label>
                <input type="text" class="form-control form-control-sm task-multi-fields-input" placeholder="Separados por coma" value="${task?.fields ? task.fields.join(', ') : ''}">
            </div>
        `;

        const typeSelect = taskEl.querySelector('.task-type-select');
        typeSelect.addEventListener('change', (e) => {
            const val = e.target.value;
            taskEl.querySelector('.unit-container').classList.toggle('d-none', !['numeric', 'multi_numeric'].includes(val));
            taskEl.querySelector('.multi-fields-container').classList.toggle('d-none', val !== 'multi_numeric');
        });

        tasksList.appendChild(taskEl);
    };

    if (tasks && tasks.length > 0) {
        tasks.forEach(task => addTaskItem(task));
    } else {
        addTaskItem();
    }

    groupEl.querySelector('.add-task-btn').addEventListener('click', () => addTaskItem());

    container.appendChild(groupEl);
}

async function executeWorkPlan(planId, isReadOnly = false) {
    const plan = state.workPlans.find(p => p.fb_id === planId);
    if (!plan) return;

    // Visualization mode: we don't create anything in Firestore until Pause or Finish is clicked.
    const executionTaskGroups = (plan.taskGroups || []).map(group => ({
        ...group,
        tasks: group.tasks.map(task => ({ ...task, status: 'Pendiente' }))
    }));

    const executionData = {
        planId: planId,
        executedAt: new Date().toISOString(),
        executedBy: state.currentUser.username,
        taskGroups: executionTaskGroups,
        status: 'En Proceso',
        isLocal: true, // flag to indicate it's not yet in Firestore
        isReadOnly: isReadOnly
    };

    startWorkPlanExecution(executionData, plan);
}

// --- Plan Execution View Functions ---
window.updateTaskValue = (groupIndex, taskIndex, value) => {
    if (state.currentExecution && state.currentExecution.execution) {
        state.currentExecution.execution.taskGroups[groupIndex].tasks[taskIndex].value = value;
    }
};

window.updateTaskDetail = (groupIndex, taskIndex, detail) => {
    if (state.currentExecution && state.currentExecution.execution) {
        state.currentExecution.execution.taskGroups[groupIndex].tasks[taskIndex].detail = detail;
    }
};

window.updateTaskMultiValue = (groupIndex, taskIndex, fieldIndex, value) => {
    if (state.currentExecution && state.currentExecution.execution) {
        const task = state.currentExecution.execution.taskGroups[groupIndex].tasks[taskIndex];
        if (!task.multiValues) task.multiValues = [];
        task.multiValues[fieldIndex] = value;
    }
};

function startWorkPlanExecution(execution, plan) {
    if (!execution || !plan) {
        showToast('Faltan datos para iniciar la ejecuci칩n del plan.', 'error');
        return;
    }
    // Deep copy execution for session-only changes unless explicitly saved (Pause/Finish)
    state.currentExecution = {
        execution: JSON.parse(JSON.stringify(execution)),
        plan
    };

    document.getElementById('app-wrapper').classList.add('d-none');
    document.getElementById('plan-execution-view').classList.remove('d-none');

    const subtitle = document.getElementById('execution-view-subtitle');
    if (subtitle) {
        subtitle.textContent = `M치quina: ${plan.machineId} | Responsable: ${execution.executedBy || state.currentUser.username}`;
    }

    renderWorkPlanExecution(state.currentExecution.execution, plan);
}

async function uploadExecutionFile(executionId, file) {
    if (file.size > 10 * 1024 * 1024) {
        showToast('El archivo es demasiado grande (M치ximo 10MB)', 'error');
        return null;
    }
    const timestamp = Date.now();
    const cleanName = file.name.replace(/[^a-z0-9.]/gi, '_').toLowerCase();
    const fileName = `evidence_${timestamp}_${cleanName}`;
    const storageRef = ref(state.storage, `ejecuciones/${executionId}/${fileName}`);
    const snapshot = await uploadBytes(storageRef, file);
    return await getDownloadURL(snapshot.ref);
}

function renderWorkPlanExecution(execution, plan) {
    const container = document.getElementById('execution-view-body');
    container.innerHTML = '';
    document.getElementById('execution-view-title').textContent = execution.isReadOnly ? `Visualizando Plan: ${plan.name}` : `Ejecuci칩n: ${plan.name}`;

    const pauseBtn = document.getElementById('execution-view-pause-btn');
    const finishBtn = document.getElementById('execution-view-finish-btn');

    if (execution.isReadOnly) {
        if (pauseBtn) pauseBtn.classList.add('d-none');
        if (finishBtn) finishBtn.classList.add('d-none');
    } else {
        if (pauseBtn) {
            pauseBtn.classList.remove('d-none');
            pauseBtn.innerHTML = execution.status === 'Pausado'
                ? '<i class="fas fa-play-circle"></i> Reanudar Trabajo'
                : '<i class="fas fa-save"></i> Guardar Borrador';
        }
        if (finishBtn) finishBtn.classList.remove('d-none');
    }

    const taskGroups = execution.taskGroups || [];
    if (taskGroups.length === 0) {
        container.innerHTML = '<div class="col-12"><p class="text-muted text-center">Este plan no tiene tareas definidas.</p></div>';
        return;
    }

    taskGroups.forEach((group, groupIndex) => {
        const isTable = group.layout === 'table';
        const groupCol = document.createElement('div');
        groupCol.className = 'col-12 col-xl-6';

        let html = `
            <div class="execution-section-header">
                <div class="execution-section-icon">
                    <i class="fas ${isTable ? 'fa-list-check' : 'fa-th-large'}"></i>
                </div>
                <h4 class="mb-0 fw-bold">${group.name}</h4>
            </div>
        `;

        if (isTable) {
            html += `
                <div class="execution-table-card">
                    <div class="table-responsive">
                        <table class="execution-table">
                            <thead>
                                <tr>
                                    <th>Tarea de Inspecci칩n</th>
                                    <th style="width: 160px; text-align: center;">Estado</th>
                                    <th>Medici칩n / Detalle</th>
                                </tr>
                            </thead>
                            <tbody id="group-body-${groupIndex}"></tbody>
                        </table>
                    </div>
                </div>
            `;
        } else {
            html += `<div id="group-body-${groupIndex}" class="row g-3"></div>`;
        }

        groupCol.innerHTML = html;
        container.appendChild(groupCol);

        const groupBody = document.getElementById(`group-body-${groupIndex}`);

        group.tasks.forEach((task, taskIndex) => {
            if (isTable) {
                renderTableTaskRow(groupBody, task, groupIndex, taskIndex, execution);
            } else {
                renderCardTaskItem(groupBody, task, groupIndex, taskIndex, execution);
            }
        });
    });
}

function renderTableTaskRow(container, task, groupIndex, taskIndex, execution) {
    const row = document.createElement('tr');
    row.className = 'execution-row';
    if (task.status && task.status !== 'Pendiente') {
        row.classList.add(`status-${task.status}`);
    }

    row.innerHTML = `
        <td>
            <div class="fw-bold text-dark">${task.description}</div>
            <div class="x-small text-muted">${task.helperText || ''}</div>
        </td>
        <td>
            <div class="status-btn-group">
                <button class="btn-status ok ${task.status === 'Aprob칩' ? 'active' : ''}" data-status="Aprob칩">OK</button>
                <button class="btn-status fallo ${task.status === 'Fallo' ? 'active' : ''}" data-status="Fallo">FALLO</button>
                ${task.allowAlerta !== false ? `<button class="btn-status alerta ${task.status === 'Alerta' ? 'active' : ''}" data-status="Alerta">ALERTA</button>` : ''}
            </div>
        </td>
        <td>
            ${renderTaskField(task, groupIndex, taskIndex, execution)}
        </td>
    `;

    // Status button events
    row.querySelectorAll('.btn-status').forEach(btn => {
        btn.addEventListener('click', () => {
            if (execution.isReadOnly) return;
            const status = btn.dataset.status;
            execution.taskGroups[groupIndex].tasks[taskIndex].status = status;

            row.querySelectorAll('.btn-status').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            // Update row highlighting
            row.classList.remove('status-Aprob칩', 'status-Fallo', 'status-Alerta');
            row.classList.add(`status-${status}`);

            // Re-render task field to show/hide observations if needed (optional, handled by CSS mostly)
            // But we might need to update mandatory status or something similar
        });
    });

    container.appendChild(row);
}

function renderCardTaskItem(container, task, groupIndex, taskIndex, execution) {
    const col = document.createElement('div');
    col.className = 'col-12';

    const card = document.createElement('div');
    card.className = 'execution-card-item execution-card';
    if (task.status && task.status !== 'Pendiente') {
        card.classList.add(`status-${task.status}`);
    }

    card.innerHTML = `
        <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
                <h5 class="fw-bold text-dark mb-1">${task.description}</h5>
                <div class="small text-muted">${task.helperText || ''}</div>
            </div>
            <div class="status-btn-group" style="width: 200px;">
                <button class="btn-status ok ${task.status === 'Aprob칩' ? 'active' : ''}" data-status="Aprob칩">OK</button>
                <button class="btn-status fallo ${task.status === 'Fallo' ? 'active' : ''}" data-status="Fallo">FALLO</button>
                ${task.allowAlerta !== false ? `<button class="btn-status alerta ${task.status === 'Alerta' ? 'active' : ''}" data-status="Alerta">ALERTA</button>` : ''}
            </div>
        </div>
        ${renderTaskField(task, groupIndex, taskIndex, execution, true)}
    `;

    card.querySelectorAll('.btn-status').forEach(btn => {
        btn.addEventListener('click', () => {
            if (execution.isReadOnly) return;
            const status = btn.dataset.status;
            execution.taskGroups[groupIndex].tasks[taskIndex].status = status;

            card.querySelectorAll('.btn-status').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            // Update card highlighting
            card.classList.remove('status-Aprob칩', 'status-Fallo', 'status-Alerta');
            card.classList.add(`status-${status}`);
        });
    });

    col.appendChild(card);
    container.appendChild(col);
}

function renderTaskField(task, groupIndex, taskIndex, execution, isCard = false) {
    let html = '';
    const readOnly = execution.isReadOnly ? 'disabled' : '';

    if (task.type === 'numeric') {
        html = `
            <div class="measurement-input-wrapper">
                <input type="number" class="form-control form-control-sm task-value-input"
                    placeholder="0.0" value="${task.value || ''}" ${readOnly}
                    oninput="window.updateTaskValue(${groupIndex}, ${taskIndex}, this.value)">
                <span class="measurement-unit-label">${task.unit || ''}</span>
            </div>
        `;
    } else if (task.type === 'multi_numeric') {
        html = `<div class="row g-2">`;
        (task.fields || []).forEach((field, fIdx) => {
            const val = task.multiValues ? task.multiValues[fIdx] : '';
            html += `
                <div class="col-6">
                    <label class="x-small fw-bold text-muted text-uppercase mb-1">${field}</label>
                    <div class="measurement-input-wrapper">
                        <input type="number" class="form-control form-control-sm task-multi-value-input"
                            data-index="${fIdx}" placeholder="0.0" value="${val || ''}" ${readOnly}
                            oninput="window.updateTaskMultiValue(${groupIndex}, ${taskIndex}, ${fIdx}, this.value)">
                        <span class="measurement-unit-label">${task.unit || ''}</span>
                    </div>
                </div>
            `;
        });
        html += `</div>`;
    } else if (task.type === 'status_detail' || task.status === 'Fallo') {
        html = `
            <textarea class="form-control form-control-sm mb-2 task-detail-input"
                placeholder="Observaciones o detalle del fallo" rows="2" ${readOnly}
                oninput="window.updateTaskDetail(${groupIndex}, ${taskIndex}, this.value)">${task.detail || ''}</textarea>
        `;
    } else if (task.type === 'text') {
        html = `
            <textarea class="form-control form-control-sm task-detail-input"
                placeholder="Ingrese sus observaciones" rows="2" ${readOnly}
                oninput="window.updateTaskDetail(${groupIndex}, ${taskIndex}, this.value)">${task.detail || ''}</textarea>
        `;
    }

    // Add Photo Evidence Section if required or if it's a card
    if (task.requirePhoto || isCard) {
        const photoId = `photo-${groupIndex}-${taskIndex}`;
        html += `
            <div class="mt-2">
                ${!isCard ? `<div class="d-flex align-items-center gap-2 text-muted x-small mb-1 fw-bold text-uppercase"><i class="fas fa-camera"></i> Evidencia</div>` : ''}
                <div class="photo-evidence-container" id="${photoId}-container">
                    ${(task.photos || []).map((url, pIdx) => `
                        <div class="photo-preview-item">
                            <img src="${url}" onclick="window.open('${url}', '_blank')">
                            ${!execution.isReadOnly ? `<button class="photo-remove-btn" onclick="removeExecutionPhoto(${groupIndex}, ${taskIndex}, ${pIdx})"><i class="fas fa-times"></i></button>` : ''}
                        </div>
                    `).join('')}
                    ${!execution.isReadOnly ? `
                        <div class="photo-upload-btn" onclick="document.getElementById('${photoId}-input').click()">
                            <i class="fas fa-plus"></i>
                            <input type="file" id="${photoId}-input" class="d-none" accept="image/*" onchange="handleExecutionPhotoUpload(this, ${groupIndex}, ${taskIndex})">
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    }

    return html;
}

window.handleExecutionPhotoUpload = async (input, groupIdx, taskIdx) => {
    const file = input.files[0];
    if (!file) return;

    showLoading(true);
    try {
        const executionId = state.currentExecution.execution.fb_id || 'temp_' + Date.now();
        const url = await uploadExecutionFile(executionId, file);
        if (url) {
            const task = state.currentExecution.execution.taskGroups[groupIdx].tasks[taskIdx];
            if (!task.photos) task.photos = [];
            task.photos.push(url);
            renderWorkPlanExecution(state.currentExecution.execution, state.currentExecution.plan);
            showToast('Foto cargada correctamente', 'success');
        }
    } catch (error) {
        console.error("Error uploading photo:", error);
        showToast('Error al cargar la foto', 'error');
    } finally {
        showLoading(false);
    }
};

window.removeExecutionPhoto = (groupIdx, taskIdx, photoIdx) => {
    const task = state.currentExecution.execution.taskGroups[groupIdx].tasks[taskIdx];
    task.photos.splice(photoIdx, 1);
    renderWorkPlanExecution(state.currentExecution.execution, state.currentExecution.plan);
};

function handleClosePlanExecution() {
    document.getElementById('plan-execution-view').classList.add('d-none');
    document.getElementById('app-wrapper').classList.remove('d-none');
    state.currentExecution = null;

    // Ensure any overlays or modals are hidden to prevent the app from "getting stuck"
    if (state.modals.confirm) state.modals.confirm.hide();
    showLoading(false);
}

async function handlePausePlanExecution() {
    const { execution, plan } = state.currentExecution || {};
    if (!execution || !plan) return;

    showLoading(true);
    try {
        if (execution.isLocal) {
            // First time saving: Create Work Order and Execution
            const newWorkOrderData = {
                id: generateNextId('MA'),
                machineId: plan.machineId,
                description: `Mantenimiento Preventivo Basado en Plan: ${plan.name}`,
                observaciones: `Ejecuci칩n de plan: ${plan.name}. Las tareas se gestionan en el checklist interactivo.`,
                status: 'En Proceso', // Creation status is 'En Proceso' even if plan is paused, to keep OT timer independent
                type: 'Preventivo',
                date: new Date().toISOString().split('T')[0],
                startTime: execution.executedAt,
                fechaInicioReal: execution.executedAt,
                workIntervals: [{ start: execution.executedAt, end: null }],
                requester: 'Sistema (Plan de Mantenimiento)',
                leadTechnician: plan.responsibleTechnician,
                technicians: [plan.responsibleTechnician],
                sourcePlanId: plan.fb_id,
                executionId: '',
                createdAt: new Date().toISOString()
            };
            const workOrderDocRef = await addDoc(state.collections.workOrders, newWorkOrderData);

            const executionData = {
                planId: plan.fb_id,
                workOrderFbId: workOrderDocRef.id,
                executedAt: execution.executedAt,
                executedBy: state.currentUser.username,
                taskGroups: execution.taskGroups,
                status: 'Pausado',
                workIntervals: [{ start: execution.executedAt, end: new Date().toISOString() }]
            };
            const executionDocRef = await addDoc(state.collections.workPlanExecutions, executionData);

            await updateDoc(workOrderDocRef, { executionId: executionDocRef.id });

            // Update local state
            execution.fb_id = executionDocRef.id;
            execution.workOrderFbId = workOrderDocRef.id;
            delete execution.isLocal;
            execution.status = 'Pausado';
            execution.workIntervals = executionData.workIntervals;
        } else {
            // Already in Firestore, just update status and taskGroups
            const executionDocRef = doc(state.collections.workPlanExecutions, execution.fb_id);

            const intervals = execution.workIntervals || [];
            if (intervals.length > 0 && !intervals[intervals.length - 1].end) {
                intervals[intervals.length - 1].end = new Date().toISOString();
            }

            await updateDoc(executionDocRef, {
                status: 'Pausado',
                taskGroups: execution.taskGroups,
                workIntervals: intervals
            });

            execution.status = 'Pausado';
            execution.workIntervals = intervals;

            // Note: Per user request, pausing the checklist does NOT automatically pause the Work Order.
            // The technician must pause the OT manually if they want the global timer to stop.
        }

        showToast('Trabajo pausado y guardado.', 'success');
        renderWorkPlanExecution(execution, plan);

    } catch (error) {
        console.error("Error pausing plan execution:", error);
        showToast('Error al pausar el trabajo.', 'error');
    } finally {
        showLoading(false);
    }
}

async function handleResumePlanExecution() {
    const { execution, plan } = state.currentExecution || {};
    if (!execution || !plan || !execution.fb_id) return;

    showLoading(true);
    try {
        const executionDocRef = doc(state.collections.workPlanExecutions, execution.fb_id);

        const intervals = execution.workIntervals || [];
        intervals.push({ start: new Date().toISOString() });

        await updateDoc(executionDocRef, {
            status: 'En Proceso',
            workIntervals: intervals
        });

        // Note: Per user request, resuming the checklist does NOT automatically resume the Work Order.
        /*
        if (execution.workOrderFbId) {
            const woRef = doc(state.collections.workOrders, execution.workOrderFbId);
            await updateDoc(woRef, { status: 'En Proceso' });
        }
        */

        execution.status = 'En Proceso';
        execution.workIntervals = intervals;

        showToast('Trabajo reanudado.', 'success');
        renderWorkPlanExecution(execution, plan);

    } catch (error) {
        console.error("Error resuming plan execution:", error);
        showToast('Error al reanudar el trabajo.', 'error');
    } finally {
        showLoading(false);
    }
}

async function reschedulePlan(planId, completedAtISO) {
    const plan = state.workPlans.find(p => p.fb_id === planId);
    if (!plan) return;

    const planDocRef = doc(state.collections.workPlans, planId);

    // Calculate next due date from completion date
    const currentCompletionDate = new Date(completedAtISO);
    let nextDueDate = new Date(currentCompletionDate);
    const value = plan.frequencyValue || 1;
    switch(plan.frequencyUnit) {
        case 'h':
            // Horas de operaci칩n: El rastreo detallado ser치 en un panel futuro.
            // Por ahora, se reprograma proporcionalmente al valor para evitar quedar en el pasado.
            // Asumimos 1 hora de operaci칩n ~ 1 d칤a calendario para este placeholder.
            nextDueDate.setDate(currentCompletionDate.getDate() + value);
            break;
        case 'd': nextDueDate.setDate(currentCompletionDate.getDate() + value); break;
        case 'w': nextDueDate.setDate(currentCompletionDate.getDate() + (value * 7)); break;
        case 'm': nextDueDate.setMonth(currentCompletionDate.getMonth() + value); break;
        case 'y': nextDueDate.setFullYear(currentCompletionDate.getFullYear() + value); break;
        default: nextDueDate.setMonth(currentCompletionDate.getMonth() + 1);
    }

    const nextYear = nextDueDate.getFullYear();
    const nextMonth = String(nextDueDate.getMonth() + 1).padStart(2, '0');
    const nextDay = String(nextDueDate.getDate()).padStart(2, '0');
    const nextDueDateStr = `${nextYear}-${nextMonth}-${nextDay}`;

    await updateDoc(planDocRef, {
        lastExecutedAt: completedAtISO,
        nextDueDate: nextDueDateStr
    });

    return nextDueDateStr;
}

async function autoCreateNextWorkOrder(planId, lastWorkOrderFbId, nextDueDateOverride = null, leadTechnicianOverride = null) {
    const plan = state.workPlans.find(p => p.fb_id === planId);
    if (!plan) return;

    const lastWO = lastWorkOrderFbId ? state.workOrders.find(o => o.fb_id === lastWorkOrderFbId) : null;
    const partsToCopy = lastWO ? (lastWO.partsUsed || []) : [];

    // Prefer lead technician from last execution, then override, then plan default
    const leadTechnician = leadTechnicianOverride || (lastWO ? lastWO.leadTechnician : plan.responsibleTechnician);

    const now = new Date().toISOString();
    const newWO = {
        id: generateNextId('MA'),
        machineId: plan.machineId,
        description: `Mantenimiento Preventivo Basado en Plan: ${plan.name}`,
        observaciones: `Orden generada autom치ticamente por frecuencia del plan.`,
        status: 'Pendiente',
        type: 'Preventivo',
        date: nextDueDateOverride || plan.nextDueDate,
        requester: 'Sistema (Plan de Mantenimiento)',
        leadTechnician: leadTechnician,
        technicians: [leadTechnician],
        sourcePlanId: plan.fb_id,
        partsUsed: partsToCopy.map(p => ({ ...p, delivered: false })), // Copy parts but mark as not delivered yet
        createdAt: now
    };

    try {
        const docRef = await addDoc(state.collections.workOrders, newWO);
        await recordAuditLog('workOrders', docRef.id, 'CREATE', null, newWO, 'Creaci칩n autom치tica por plan');
        console.log(`[Auto-Plan] Nueva OT creada: ${newWO.id} para la fecha ${plan.nextDueDate}`);
    } catch (error) {
        console.error("Error auto-creating next Work Order:", error);
    }
}

async function completeLinkedPlanExecution(workOrderFbId, nowISO, status = 'Completado', validatedBy = null) {
    // Search locally to avoid Firestore composite index requirement
    const execution = state.workPlanExecutions.find(e =>
        e.workOrderFbId === workOrderFbId && e.status !== 'Completado'
    );

    if (execution) {
        const intervals = execution.workIntervals || [];
        if (intervals.length > 0 && !intervals[intervals.length - 1].end) {
            intervals[intervals.length - 1].end = nowISO;
        }

        const updates = {
            status: status,
            completedAt: nowISO,
            workIntervals: intervals
        };

        if (validatedBy) {
            updates.validatedBy = validatedBy;
        }

        const oldExecution = JSON.parse(JSON.stringify(execution));
        await updateDoc(doc(state.collections.workPlanExecutions, execution.fb_id), updates);
        await recordAuditLog('workPlanExecutions', execution.fb_id, 'UPDATE', oldExecution, { ...execution, ...updates });

        // If it wasn't finished by handleFinishPlanExecution (e.g., direct WO completion from Kanban),
        // we should reschedule and auto-create here if the execution was in a state that didn't do it yet.
        if (execution.status === 'En Proceso' || execution.status === 'Pausado') {
             const plan = state.workPlans.find(p => p.fb_id === execution.planId);
             if (plan) {
                const nextDate = await reschedulePlan(plan.fb_id, execution.executedAt || nowISO);
                await autoCreateNextWorkOrder(plan.fb_id, execution.workOrderFbId, nextDate);
             }
        }
    }
}

async function handleFinishPlanExecution() {
    const { execution, plan } = state.currentExecution || {};
    if (!execution || !plan) return;

    // Validation: Check for mandatory photos and missing data
    const missingPhotos = [];
    const pendingTasks = [];
    const missingFalloDetails = [];

    execution.taskGroups.forEach(group => {
        group.tasks.forEach(task => {
            if (task.status === 'Pendiente') {
                pendingTasks.push(task.description);
            }
            if (task.status === 'Fallo' && (!task.detail || task.detail.trim().length < 5)) {
                missingFalloDetails.push(task.description);
            }
            if (task.requirePhoto && (!task.photos || task.photos.length === 0)) {
                missingPhotos.push(task.description);
            }
        });
    });

    if (pendingTasks.length > 0) {
        showToast(`Hay ${pendingTasks.length} tareas pendientes de calificar.`, 'warning');
        return;
    }

    if (missingFalloDetails.length > 0) {
        showToast('Debe ingresar el detalle del fallo para: ' + missingFalloDetails[0], 'warning');
        return;
    }

    if (missingPhotos.length > 0) {
        showToast('Falta evidencia fotogr치fica obligatoria para: ' + missingPhotos[0], 'warning');
        return;
    }

    showConfirmation('Finalizar Plan', '쮼st치 seguro? Esto completar치 la ejecuci칩n y enviar치 la orden a evaluaci칩n t칠cnica.', async () => {
        showLoading(true);
        try {
            const now = new Date().toISOString();

            if (execution.isLocal) {
                // Create documents if it was never paused
                const workIntervals = [{ start: execution.executedAt, end: now }];
                const totalMs = new Date(now) - new Date(execution.executedAt);

                const newWorkOrderData = {
                    id: generateNextId('MA'),
                    machineId: plan.machineId,
                    description: `Mantenimiento Preventivo Basado en Plan: ${plan.name}`,
                    observaciones: `Ejecuci칩n de plan: ${plan.name}. Las tareas se gestionan en el checklist interactivo.`,
                    status: 'Pendiente de Aprobaci칩n',
                    type: 'Preventivo',
                    date: new Date().toISOString().split('T')[0],
                    startTime: execution.executedAt,
                    fechaInicioReal: execution.executedAt,
                    fechaFinalizacionReal: now,
                    workIntervals: workIntervals,
                    totalWorkDurationMs: totalMs,
                    requester: 'Sistema (Plan de Mantenimiento)',
                    leadTechnician: plan.responsibleTechnician,
                    technicians: [plan.responsibleTechnician],
                    sourcePlanId: plan.fb_id,
                    executionId: '',
                    createdAt: now
                };
                const workOrderDocRef = await addDoc(state.collections.workOrders, newWorkOrderData);

                const executionData = {
                    planId: plan.fb_id,
                    workOrderFbId: workOrderDocRef.id,
                    executedAt: execution.executedAt,
                    completedAt: now,
                    executedBy: state.currentUser.username,
                    taskGroups: execution.taskGroups,
                    status: 'Pendiente de Aprobaci칩n',
                    workIntervals: workIntervals
                };
                const executionDocRef = await addDoc(state.collections.workPlanExecutions, executionData);
                await updateDoc(workOrderDocRef, { executionId: executionDocRef.id });
            } else {
                const executionDocRef = doc(state.collections.workPlanExecutions, execution.fb_id);

                const intervals = execution.workIntervals || [];
                if (intervals.length > 0 && !intervals[intervals.length - 1].end) {
                    intervals[intervals.length - 1].end = now;
                }

                await updateDoc(executionDocRef, {
                    status: 'Pendiente de Aprobaci칩n',
                    taskGroups: execution.taskGroups,
                    completedAt: now,
                    workIntervals: intervals
                });

                if (execution.workOrderFbId) {
                    const woRef = doc(state.collections.workOrders, execution.workOrderFbId);
                    const existingWO = state.workOrders.find(o => o.fb_id === execution.workOrderFbId);

                    if (existingWO) {
                        let woIntervals = existingWO.workIntervals ? JSON.parse(JSON.stringify(existingWO.workIntervals)) : [];
                        // Close open interval if exists in the Work Order
                        const lastInterval = woIntervals[woIntervals.length - 1];
                        if (lastInterval && !lastInterval.end) {
                            lastInterval.end = now;
                        }

                        const totalMs = getTotalWorkDurationMs({ workIntervals: woIntervals });

                        const woUpdates = {
                            status: 'Pendiente de Aprobaci칩n',
                            fechaFinalizacionReal: now,
                            workIntervals: woIntervals,
                            totalWorkDurationMs: totalMs
                        };

                        if (!existingWO.fechaInicioReal) {
                            woUpdates.fechaInicioReal = execution.executedAt;
                        }

                        await updateDoc(woRef, woUpdates);
                    }
                }
            }

            // User requested that rescheduling be based on the start time (executedAt)
            // of the plan to accurately project the next maintenance date.
            const nextDate = await reschedulePlan(plan.fb_id, execution.executedAt || now);

            // Auto-create next Work Order with updated date and last technician
            await autoCreateNextWorkOrder(plan.fb_id, execution.workOrderFbId, nextDate, state.currentUser.username);

            showToast('Plan finalizado, enviado a aprobaci칩n y reprogramado con 칠xito.', 'success');
            handleClosePlanExecution();

        } catch (error) {
            console.error("Error finalizing plan execution:", error);
            showToast('Error al finalizar la ejecuci칩n del plan.', 'error');
        } finally {
            showLoading(false);
        }
    });
}


// --- Work Order & Kanban Functions ---
function clearActiveTimers() {
    for (const orderId in state.activeTimers) {
        clearInterval(state.activeTimers[orderId]);
    }
    state.activeTimers = {};
}

function renderActiveWorkView() {
    clearActiveTimers();
    const requestsContainer = document.getElementById('pending-requests');
    const plannedContainer = document.getElementById('planned-tasks');
    const inProgressContainer = document.getElementById('in-progress-tasks');
    const pausedContainer = document.getElementById('paused-tasks');
    const evaluationContainer = document.getElementById('evaluation-tasks');
    const completedContainer = document.getElementById('completed-tasks');
    const cancelledContainer = document.getElementById('cancelled-tasks');

    requestsContainer.innerHTML = '';
    plannedContainer.innerHTML = '';
    inProgressContainer.innerHTML = '';
    pausedContainer.innerHTML = '';
    if (evaluationContainer) evaluationContainer.innerHTML = '';
    if (completedContainer) completedContainer.innerHTML = '';
    if (cancelledContainer) cancelledContainer.innerHTML = '';

    let workOrdersToDisplay = state.workOrders;
    let solicitudesToDisplay = state.solicitudes;
    const userRole = state.currentUser?.role;
    const managedMachineIds = state.currentUser?.managedMachineIds;
    const equipoAsignado = state.currentUser?.equipoAsignado;

    if ((userRole === 'Jefe de Area' && Array.isArray(managedMachineIds)) || (userRole === 'T칠cnico' && Array.isArray(equipoAsignado)) || (userRole === 'Operario' && Array.isArray(equipoAsignado))) {
        const relevantMachineIds = new Set(userRole === 'Jefe de Area' ? managedMachineIds : equipoAsignado);
        workOrdersToDisplay = state.workOrders.filter(wo => relevantMachineIds.has(wo.machineId));
        solicitudesToDisplay = state.solicitudes.filter(s => relevantMachineIds.has(s.machineId));
    }

    const monthFilter = document.getElementById('kanban-month-filter');
    const selectedMonth = monthFilter ? monthFilter.value : null;

    if (selectedMonth) {
        const [year, month] = selectedMonth.split('-').map(Number);
        const monthName = new Date(year, month - 1, 1)
            .toLocaleDateString('es-ES', { month: 'long', year: 'numeric' })
            .replace(/^\w/, c => c.toUpperCase());
        document.getElementById('page-title').textContent = `Trabajo Activo - ${monthName}`;

        const currentMonthObj = new Date(year, month - 1, 1);

        solicitudesToDisplay = solicitudesToDisplay.filter(s => {
            if (!s.createdAt) return false;

            let localMonthStr = "";
            let d;
            if (/^\d{4}-\d{2}-\d{2}$/.test(s.createdAt)) {
                localMonthStr = s.createdAt.substring(0, 7);
                d = new Date(s.createdAt + 'T12:00:00');
            } else {
                d = new Date(s.createdAt);
                if (isNaN(d.getTime())) return false;
                localMonthStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
            }

            // Si es Pendiente y de un mes anterior, lo consideramos "No Ejecutada"
            if (s.status === 'Pendiente') {
                const sDate = new Date(d.getFullYear(), d.getMonth(), 1);
                if (sDate < currentMonthObj) return true;
            }

            return localMonthStr === selectedMonth;
        });

        workOrdersToDisplay = workOrdersToDisplay.filter(wo => {
            const dateStr = wo.fechaFinalizacionReal || wo.date || wo.createdAt;
            if (!dateStr) return false;

            let localMonthStr = "";
            let d;
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
                localMonthStr = dateStr.substring(0, 7);
                d = new Date(dateStr + 'T12:00:00');
            } else {
                d = new Date(dateStr);
                if (isNaN(d.getTime())) return false;
                localMonthStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
            }

            // Si no est치 terminada y es de un mes anterior, lo consideramos "No Ejecutada"
            if (wo.status !== 'Completado' && wo.status !== 'Cancelado' && wo.status !== 'Rechazado') {
                const woDate = new Date(d.getFullYear(), d.getMonth(), 1);
                if (woDate < currentMonthObj) return true;
            }

            return localMonthStr === selectedMonth;
        });
    }

    const pendingRequests = solicitudesToDisplay.filter(s => {
        if (s.status !== 'Pendiente') return false;
        if (selectedMonth) {
            const [year, month] = selectedMonth.split('-').map(Number);
            const currentMonthObj = new Date(year, month - 1, 1);
            const d = new Date(s.createdAt);
            const sDate = new Date(d.getFullYear(), d.getMonth(), 1);
            if (sDate < currentMonthObj) return false; // Overdue go to cancelled
        }
        return true;
    });

    const cancelledSolicitudes = solicitudesToDisplay.filter(s => {
        if (s.status === 'Cancelado' || s.status === 'Rechazado') return true;
        if (s.status === 'Pendiente' && selectedMonth) {
            const [year, month] = selectedMonth.split('-').map(Number);
            const currentMonthObj = new Date(year, month - 1, 1);
            const d = new Date(s.createdAt);
            const sDate = new Date(d.getFullYear(), d.getMonth(), 1);
            return sDate < currentMonthObj;
        }
        return false;
    });

    if (pendingRequests.length === 0) {
         requestsContainer.innerHTML = '<p class="text-center text-muted">No hay solicitudes pendientes.</p>';
    } else {
        pendingRequests.forEach(req => requestsContainer.appendChild(createSolicitudCard(req)));
    }

    workOrdersToDisplay.forEach(wo => {
        const card = createWorkOrderCard(wo);

        if (wo.status === 'Cancelado' || wo.status === 'Rechazado') {
            if (cancelledContainer) cancelledContainer.appendChild(card);
        } else if (wo.status === 'Pendiente' || wo.status === 'Planificada') {
            plannedContainer.appendChild(card);
        } else if (wo.status === 'En Proceso') {
            inProgressContainer.appendChild(card);
            if (wo.workIntervals) {
                const lastInterval = wo.workIntervals[wo.workIntervals.length - 1];
                if (lastInterval && lastInterval.start && !lastInterval.end) {
                   updateTimerDisplay(wo.id, wo);
                }
            }
        } else if (wo.status === 'Pausado') {
            pausedContainer.appendChild(card);
        } else if (wo.status === 'Pendiente de Evaluaci칩n' || wo.status === 'Pendiente de Aprobaci칩n') {
            if (evaluationContainer) evaluationContainer.appendChild(card);
        } else if (wo.status === 'Completado') {
            if (completedContainer) completedContainer.appendChild(card);
        }
    });

    if (cancelledSolicitudes.length > 0) {
        cancelledSolicitudes.forEach(s => cancelledContainer.appendChild(createSolicitudCard(s)));
    }

    if (plannedContainer.innerHTML === '') plannedContainer.innerHTML = '<p class="text-center text-muted">No hay tareas planificadas.</p>';
    if (inProgressContainer.innerHTML === '') inProgressContainer.innerHTML = '<p class="text-center text-muted">No hay tareas en ejecuci칩n.</p>';
    if (pausedContainer.innerHTML === '') pausedContainer.innerHTML = '<p class="text-center text-muted">No hay tareas pausadas.</p>';
    if (evaluationContainer && evaluationContainer.innerHTML === '') {
        evaluationContainer.innerHTML = '<p class="text-center text-muted">No hay tareas para evaluar.</p>';
    }
    if (completedContainer && completedContainer.innerHTML === '') {
        completedContainer.innerHTML = '<p class="text-center text-muted">No hay tareas evaluadas.</p>';
    }
    if (cancelledContainer && cancelledContainer.innerHTML === '') {
        cancelledContainer.innerHTML = '<p class="text-center text-muted">No hay tareas canceladas o no ejecutadas.</p>';
    }
}

function createSolicitudCard(solicitud) {
    const card = document.createElement('div');
    card.className = 'kanban-card';
    const machine = state.machines.find(m => m.id === solicitud.machineId) || { name: 'Desconocido' };
    const userRole = state.currentUser?.role;
    const isReadOnly = userRole !== 'Admin' && userRole !== 'Planificador' && userRole !== 'T칠cnico';

    let linkedWorkOrder = null;
    if (solicitud.workOrderFbId) {
        linkedWorkOrder = state.workOrders.find(wo => wo.fb_id === solicitud.workOrderFbId);
    } else if (solicitud.workOrderId) {
        linkedWorkOrder = state.workOrders.find(wo => wo.id === solicitud.workOrderId);
    }

    card.innerHTML = `
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <h6 class="card-title mb-0">${machine.name}</h6>
                <div class="d-flex flex-column">
                    <small class="text-muted">Solicitante: ${solicitud.requester}</small>
                    ${linkedWorkOrder ? `<small class="text-primary fw-bold">OT: ${linkedWorkOrder.id}</small>` : ''}
                </div>
            </div>
             <span class="badge bg-secondary">${new Date(solicitud.createdAt).toLocaleDateString('es-ES')}</span>
        </div>
        <p class="card-text my-2">${solicitud.description}</p>
        <div class="card-footer bg-transparent p-0 pt-2 border-top">
             ${isReadOnly 
                ? `<p class="text-muted text-center mb-0 small">Solo visualizaci칩n</p>`
                : `<button class="btn btn-sm btn-success convert-solicitud-btn w-100"><i class="fas fa-check me-2"></i>Crear OT</button>`
             }
        </div>
    `;
    if (!isReadOnly) {
        card.querySelector('.convert-solicitud-btn').addEventListener('click', () => {
            showWorkOrderModal(null, 'Correctivo', solicitud);
        });
    }
    return card;
}

function createWorkOrderCard(order) {
    const card = document.createElement('div');
    card.className = 'kanban-card';
    if (order.status === 'Pendiente de Aprobaci칩n') {
        card.classList.add('status-pending-approval');
    }
    card.dataset.id = order.id;
    const machine = state.machines.find(m => m.id === order.machineId) || { name: 'Desconocido' };
    const isLeadTechnician = state.currentUser?.username === order.leadTechnician;
    const canAction = state.currentUser?.role === 'Admin' || isLeadTechnician;
    const isPlanOrder = order.type === 'Preventivo' || order.linkedPlanId;
    
    let footerContent = '';
    
    const originalSolicitud = (order.solicitudId || order.sourceSolicitudId) ? state.solicitudes.find(s => s.id === (order.solicitudId || order.sourceSolicitudId) || s.fb_id === (order.solicitudId || order.sourceSolicitudId)) : null;

    // Nueva l칩gica de doble evaluaci칩n
    const evs = state.technicianEvaluations.filter(ev => ev.workOrderFbId === order.fb_id);
    const hasOp = evs.some(e => e.evaluatorRole === 'Operario');
    const hasJf = evs.some(e => e.evaluatorRole === 'Jefe de Area');

    let canEvaluate = false;
    const userRole = state.currentUser?.role;
    const isRequester = originalSolicitud && originalSolicitud.requester === state.currentUser?.username;
    const isAssignedOperario = userRole === 'Operario' && Array.isArray(state.currentUser?.equipoAsignado) && state.currentUser.equipoAsignado.includes(order.machineId);

    const canEvalAsJefe = (userRole === 'Admin' || (userRole === 'Planificador' && order.type === 'Preventivo') || (userRole === 'Jefe de Area' && Array.isArray(state.currentUser?.managedMachineIds) && state.currentUser.managedMachineIds.includes(order.machineId)));
    const canEvalAsOp = (userRole === 'Admin' || (userRole === 'Operario' && Array.isArray(state.currentUser?.equipoAsignado) && state.currentUser.equipoAsignado.includes(order.machineId)) || isRequester);

    if ((canEvalAsJefe && !hasJf) || (canEvalAsOp && !hasOp)) {
        canEvaluate = true;
    }

    if (order.isExpired) {
        footerContent = `<p class="text-muted text-center mb-0 small"><i class="fas fa-lock me-1"></i>Expirada - Solo Lectura</p>`;
    } else if (order.status === 'Pendiente de Evaluaci칩n') {
        if (canEvaluate) {
            const label = (hasOp || hasJf) ? 'Completar Evaluaci칩n' : 'Evaluar';
            const badge = (hasOp || hasJf) ? '<div class="text-center mb-1"><span class="badge bg-info text-dark" style="font-size: 0.7rem;">Evaluaci칩n Parcial</span></div>' : '';
            footerContent = `${badge}<button class="btn btn-sm btn-info evaluate-task-btn w-100"><i class="fas fa-star-half-alt me-2"></i>${label}</button>`;
        } else {
            const missing = !hasOp ? 'Operario' : 'Jefe de 츼rea';
            footerContent = `<p class="text-muted text-center mb-0 small"><i class="fas fa-clock me-1"></i>Esperando a ${missing}</p>`;
        }
    } else if (order.status === 'Completado') {
        footerContent = `<button class="btn btn-sm btn-outline-primary view-evaluation-btn w-100"><i class="fas fa-eye me-2"></i>Ver Evaluaci칩n</button>`;
    } else if (!canAction) {
        footerContent = `<p class="text-muted text-center mb-0 small">Solo visualizaci칩n</p>`;
    } else {
        switch(order.status) {
            case 'Pendiente':
                footerContent = `<button class="btn btn-sm btn-primary start-task-btn w-100"><i class="fas fa-play me-2"></i>Iniciar</button>`;
                break;
            case 'En Proceso':
                const completeLabel = isPlanOrder ? 'Finalizar' : 'Completar';
                footerContent = `
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="timer" id="timer-${order.id}">00:00:00</span>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-warning pause-task-btn" title="Pausar"><i class="fas fa-pause"></i></button>
                            <button class="btn btn-sm btn-success complete-task-btn" title="${completeLabel}"><i class="fas fa-check"></i></button>
                        </div>
                    </div>`;
                break;
            case 'Pausado':
                footerContent = `<button class="btn btn-sm btn-info resume-task-btn w-100"><i class="fas fa-play me-2"></i>Reanudar</button>`;
                break;
            case 'Cancelado':
            case 'Rechazado':
                footerContent = `<p class="text-danger text-center mb-0 small"><i class="fas fa-ban me-1"></i>${order.status}</p>`;
                break;
            default:
                footerContent = `<p class="text-muted text-center mb-0 small">${order.status}</p>`;
        }
    }


    const totalScore = evs.reduce((acc, ev) => acc + (ev.score || 0), 0);
    const totalMaxScore = evs.reduce((acc, ev) => acc + (ev.maxScore || 0), 0);
    const avgRating = totalMaxScore > 0 ? (totalScore / totalMaxScore) * 5 : 0;
    const starDisplay = order.status === 'Completado' && avgRating > 0 ? `<span class="text-warning ms-1 fw-bold" style="font-size: 0.8rem;" title="Calificaci칩n: ${avgRating.toFixed(1)}">救${avgRating.toFixed(1)}</span>` : '';

    const cardTitle = order.id ? order.id : `(${machine.id || 'N/A'})`;
    const expiredBadge = order.isExpired ? '<br><span class="badge bg-dark text-white mt-1"><i class="fas fa-hourglass-end me-1"></i>Expirada</span>' : '';
    card.innerHTML = `
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <h6 class="card-title mb-0" style="cursor: pointer;">${cardTitle}${starDisplay}</h6>
                <small class="text-muted">${machine.name}</small>
                ${originalSolicitud ? `<br><small class="text-info fw-bold">Solicitud: ${originalSolicitud.id}</small>` : ''}
            </div>
            <div class="text-end">
                <span class="badge bg-${order.type === 'Preventivo' ? 'primary' : 'danger'}">${order.type}</span>
                ${expiredBadge}
            </div>
        </div>
        <p class="card-text my-2">${order.description}</p>
        <div class="card-footer bg-transparent p-0 pt-2 border-top">
            ${footerContent}
        </div>
    `;
    
    card.querySelector('.card-title').addEventListener('click', () => showWorkOrderModal(order.fb_id));

    // Attach listeners for tech actions
    card.querySelector('.view-evaluation-btn')?.addEventListener('click', (e) => {
        e.stopPropagation();
        showEvaluationDetailsModal(order.fb_id);
    });

    if (canAction) {
        card.querySelector('.start-task-btn')?.addEventListener('click', () => handleKanbanWorkOrderAction(order.fb_id, 'En Proceso'));
        card.querySelector('.pause-task-btn')?.addEventListener('click', () => handleKanbanWorkOrderAction(order.fb_id, 'Pausado'));
        card.querySelector('.resume-task-btn')?.addEventListener('click', () => handleKanbanWorkOrderAction(order.fb_id, 'En Proceso'));
        card.querySelector('.complete-task-btn')?.addEventListener('click', () => {
            const isPlanOrder = order.type === 'Preventivo' || order.linkedPlanId;
            const confirmTitle = isPlanOrder ? 'Finalizar Trabajo' : 'Completar Orden de Trabajo';
            const confirmMsg = isPlanOrder
                ? `쮼st치 seguro que desea finalizar el trabajo en la orden ${order.id || `(${order.machineId})`}? Se notificar치 al planificador.`
                : `쮼st치 seguro que desea completar la orden ${order.id || `(${order.machineId})`}?`;

             showConfirmation(
                confirmTitle,
                confirmMsg,
                () => handleKanbanWorkOrderAction(order.fb_id, 'Pendiente de Evaluaci칩n')
            );
        });
    }

    // Attach listener for evaluation action
    if (order.status === 'Pendiente de Evaluaci칩n') {
        card.querySelector('.evaluate-task-btn')?.addEventListener('click', () => showEvaluationModal(order.id));
    }

    return card;
}

function getTotalWorkDurationMs(order) {
    let totalMs = 0;
    if (order.workIntervals && Array.isArray(order.workIntervals)) {
         order.workIntervals.forEach(interval => {
            if (interval.start && interval.end) {
                const start = new Date(interval.start);
                const end = new Date(interval.end);
                if (!isNaN(start.getTime()) && !isNaN(end.getTime())) {
                    totalMs += end - start;
                }
            }
        });
    }
    return totalMs;
}

function getActiveWorkDurationMs(order) {
    let totalMs = getTotalWorkDurationMs(order);
    if (order.status === 'En Proceso' && order.workIntervals) {
         const lastInterval = order.workIntervals[order.workIntervals.length - 1];
         if (lastInterval && lastInterval.start && !lastInterval.end) {
             totalMs += new Date() - new Date(lastInterval.start);
         }
    }
    return totalMs;
}


function updateTimerDisplay(orderId, order) {
    const timerEl = document.getElementById(`timer-${orderId}`);
    if (!timerEl) return;

    if(state.activeTimers[orderId]) clearInterval(state.activeTimers[orderId]);

    const intervalId = setInterval(() => {
        const totalMs = getActiveWorkDurationMs(order);
        if (totalMs < 0) {
             timerEl.textContent = '00:00:00';
             return;
        }
        const hours = Math.floor(totalMs / (1000 * 60 * 60));
        const minutes = Math.floor((totalMs % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((totalMs % (1000 * 60)) / 1000);
        timerEl.textContent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    }, 1000);

    state.activeTimers[orderId] = intervalId;
}

function addPartMovementToBatch(batch, partId, quantity, type, details = {}) {
    const part = state.parts.find(p => p.id === partId);
    const movementRef = doc(state.collections.partMovements);
    batch.set(movementRef, {
        date: new Date().toISOString(),
        partId: partId,
        partDescription: part ? part.description : 'Desconocido',
        quantity: quantity,
        type: type,
        orderId: details.orderId || null,
        orderHumanId: details.orderHumanId || null,
        user: state.currentUser?.username || 'Sistema',
        ...details
    });
}

async function updateStockForOrder(oldOrder, newOrder) {
    const batch = writeBatch(db);
    const oldPartsMap = new Map((oldOrder.partsUsed || []).map(p => [p.partId, p]));
    const newPartsMap = new Map((newOrder.partsUsed || []).map(p => [p.partId, p]));

    const updatedPartsUsed = [];
    const allPartIds = new Set([...oldPartsMap.keys(), ...newPartsMap.keys()]);

    for (const partId of allPartIds) {
        const oldEntry = oldPartsMap.get(partId);
        const newEntry = newPartsMap.get(partId);

        const oldQtyDelivered = (oldEntry && oldEntry.delivered !== false) ? oldEntry.quantity : 0;
        const newQtyRequested = newEntry ? newEntry.quantity : 0;

        let delta = newQtyRequested - oldQtyDelivered;

        if (delta === 0) {
            if (newEntry) updatedPartsUsed.push(newEntry);
            continue;
        }

        const part = state.parts.find(p => p.id === partId);
        if (part) {
            const currentStock = part.stock || 0;
            const newStock = currentStock - delta;
            const partRef = doc(state.collections.parts, partId);

            if (newStock < 0 && delta > 0) {
                if (newEntry) {
                    if (oldQtyDelivered > 0) {
                        const revertedStock = currentStock + oldQtyDelivered;
                        batch.update(partRef, { stock: revertedStock });
                        addPartMovementToBatch(batch, partId, oldQtyDelivered, 'Reversi칩n por Falta de Stock', {
                            orderId: newOrder.fb_id || 'nuevo',
                            orderHumanId: newOrder.id
                        });
                    }
                    updatedPartsUsed.push({ ...newEntry, delivered: false });
                }
            } else {
                batch.update(partRef, { stock: newStock });
                if (delta !== 0) {
                    addPartMovementToBatch(batch, partId, -delta, delta > 0 ? 'Salida OT' : 'Devoluci칩n OT', {
                        orderId: newOrder.fb_id || 'nuevo',
                        orderHumanId: newOrder.id
                    });
                }
                if (newEntry) {
                    updatedPartsUsed.push({ ...newEntry, delivered: true });
                }
            }
        } else {
            if (newEntry) updatedPartsUsed.push({ ...newEntry, delivered: false });
        }
    }
    await batch.commit();
    newOrder.partsUsed = updatedPartsUsed;

    // Sincronizar stock de repuestos utilizados con Odoo
    if (state.odoo) {
        for (const partId of allPartIds) {
            const part = state.parts.find(p => p.id === partId);
            if (part) {
                const oldEntry = oldPartsMap.get(partId);
                const newEntry = newPartsMap.get(partId);
                const oldQtyDelivered = (oldEntry && oldEntry.delivered !== false) ? oldEntry.quantity : 0;
                const newQtyRequested = (newEntry && newEntry.delivered !== false) ? newEntry.quantity : 0;
                let delta = newQtyRequested - oldQtyDelivered;

                if (delta !== 0) {
                    const newStock = (part.stock || 0) - delta;
                    syncPartStockToOdoo(partId, { ...part, stock: newStock }).catch(err =>
                        console.warn(`[Odoo Stock Sync] Error en ${partId}:`, err)
                    );
                }
            }
        }
    }
}

async function handleKanbanWorkOrderAction(workOrderFbId, newStatus) {
    showLoading(true);
    try {
        const orderRef = doc(state.collections.workOrders, workOrderFbId);
        const orderSnapshot = await getDoc(orderRef);
        if (!orderSnapshot.exists()) {
            throw new Error("Work order not found");
        }

        const orderData = { fb_id: orderSnapshot.id, ...orderSnapshot.data() };

        if (orderData.isExpired) {
            showToast('Esta orden ha expirado y no puede ser modificada.', 'error');
            showLoading(false);
            return;
        }

        let finalStatus = newStatus;
        const oldStatus = orderData.status;

        // 21 CFR Part 11: Re-autenticaci칩n para firma electr칩nica
        const isFinishing = (finalStatus === 'Pendiente de Evaluaci칩n' || finalStatus === 'Completado' || finalStatus === 'Pendiente de Aprobaci칩n');
        if (isFinishing && oldStatus !== finalStatus) {
            const confirmed = await new Promise(resolve => {
                requestSignature(() => resolve(true), () => resolve(false));
            });
            if (!confirmed) {
                showLoading(false);
                return;
            }
            showLoading(true);
        }

        const updates = {};

        // Si es de plan o viene de una solicitud y el t칠cnico intenta completar sin validaci칩n, cambiar a Pendiente de Aprobaci칩n
        const isPlanOrder = orderData.type === 'Preventivo' || orderData.linkedPlanId;
        const hasRequest = orderData.solicitudId || orderData.sourceSolicitudId;
        if (newStatus === 'Pendiente de Evaluaci칩n' && (isPlanOrder || hasRequest) && !orderData.validatedBy) {
            finalStatus = 'Pendiente de Aprobaci칩n';
            updates.technicianFinished = true;
            showToast('Trabajo finalizado. Pendiente de validaci칩n por el Planificador.', 'info');
        }

        updates.status = finalStatus;

        // Solo generar nuevo ID si est치 iniciando por primera vez (cambio de MP a MA o no tiene ID)
        const isPlanned = !orderData.id || orderData.id.startsWith('MP');
        const isFirstStart = newStatus === 'En Proceso' && oldStatus !== 'En Proceso' && isPlanned;

        const now = new Date();
        if (isFirstStart) {
            updates.id = generateNextId('MA');
            updates.fechaInicioReal = now.toISOString();
            // Actualizar la fecha principal de la orden a la fecha local actual para que se mueva en el planificador
            updates.date = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;

            // Filtrar repuestos sin stock al iniciar la orden desde Kanban
            let removedParts = [];
            let adjustedParts = [];
            const processedParts = [];

            for (const item of (orderData.partsUsed || [])) {
                const part = state.parts.find(p => p.id === item.partId);
                const stock = part ? (part.stock || 0) : 0;

                if (stock <= 0) {
                    removedParts.push(part ? part.description : item.partId);
                } else {
                    let finalQty = item.quantity;
                    if (stock < item.quantity) {
                        finalQty = stock;
                        adjustedParts.push(`${part ? part.description : item.partId} (ajustado de ${item.quantity} a ${stock})`);
                    }
                    processedParts.push({ ...item, quantity: finalQty });
                }
            }

            if (removedParts.length > 0 || adjustedParts.length > 0) {
                updates.partsUsed = processedParts;
                let note = "\n\nNota del Sistema (Inicio de OT desde Kanban):";
                if (removedParts.length > 0) {
                    note += `\n- Se eliminaron por falta de stock: ${removedParts.join(', ')}.`;
                }
                if (adjustedParts.length > 0) {
                    note += `\n- Se ajust칩 cantidad por stock insuficiente: ${adjustedParts.join(', ')}.`;
                }
                updates.observaciones = (orderData.observaciones || "") + note;
            }
        }

        let workIntervals = orderData.workIntervals ? JSON.parse(JSON.stringify(orderData.workIntervals)) : [];

        if (finalStatus === 'En Proceso') {
            workIntervals.push({ start: now.toISOString(), end: null });
        } else if (['Pausado', 'Pendiente de Evaluaci칩n', 'Completado', 'Pendiente de Aprobaci칩n'].includes(finalStatus) && oldStatus === 'En Proceso') {
            const lastInterval = workIntervals.find(i => !i.end);
            if (lastInterval) {
                lastInterval.end = now.toISOString();
            }
        }
        updates.workIntervals = workIntervals;

        if (['Pendiente de Evaluaci칩n', 'Completado', 'Pendiente de Aprobaci칩n'].includes(finalStatus)) {
            if (!orderData.fechaFinalizacionReal) {
                updates.fechaFinalizacionReal = now.toISOString();
            }
            const updatedOrderForCalc = { ...orderData, ...updates };
            updates.totalWorkDurationMs = getActiveWorkDurationMs(updatedOrderForCalc);
        }

        if (finalStatus === 'Pendiente de Evaluaci칩n' || finalStatus === 'Completado' || finalStatus === 'Pendiente de Aprobaci칩n') {
            const wasAlreadyProcessed = ['Pendiente de Evaluaci칩n', 'Completado', 'Pendiente de Aprobaci칩n'].includes(oldStatus);
            // Si ya estaba en un estado que descuenta stock, pasamos el objeto original para calcular el delta (que ser치 0 si no cambiaron repuestos)
            // Si no, pasamos un objeto vac칤o para que descuente todo por primera vez
            await updateStockForOrder(wasAlreadyProcessed ? orderData : { partsUsed: [] }, orderData);
        }

        const oldOrder = JSON.parse(JSON.stringify(orderData));
        await updateDoc(orderRef, updates);
        const detailedAction = getWorkOrderDetailedAction(oldOrder, { ...orderData, ...updates }) + (isFinishing ? ' (Firmado)' : '');
        await recordAuditLog('workOrders', orderData.id || workOrderFbId, 'UPDATE', oldOrder, { ...orderData, ...updates }, detailedAction);

        // If finishing the order, also finish any linked plan execution
        if (finalStatus === 'Pendiente de Evaluaci칩n' || finalStatus === 'Completado' || finalStatus === 'Pendiente de Aprobaci칩n') {
            await completeLinkedPlanExecution(workOrderFbId, now.toISOString(), finalStatus);
        }

        // If the work order is linked to a solicitud, ensure the solicitud has the workOrderFbId
        if (orderData.sourceSolicitudId || orderData.solicitudId) {
            const solicitud = state.solicitudes.find(s => s.fb_id === orderData.sourceSolicitudId || s.id === orderData.solicitudId);
            if (solicitud) {
                const solUpdates = {
                    workOrderFbId: workOrderFbId,
                    workOrderId: updates.id || orderData.id
                };
                if (solicitud.status === 'Pendiente') {
                    solUpdates.status = 'Aprobado';
                }
                await updateDoc(doc(state.collections.solicitudes, solicitud.fb_id), solUpdates);
            }
        }

        // Manually trigger a UI update to reflect the change immediately, as onSnapshot can have a slight delay.
        const updatedOrder = { ...orderData, ...updates };
        const orderIndex = state.workOrders.findIndex(wo => wo.fb_id === workOrderFbId);
        if (orderIndex > -1) {
            state.workOrders[orderIndex] = updatedOrder;
        } else {
            state.workOrders.push(updatedOrder);
        }
        renderActiveWorkView(); // Re-render the Kanban view

        showToast(`Orden de trabajo actualizada a: ${newStatus}`, 'success');
    } catch (error) {
        console.error("Error updating work order from Kanban:", error);
        showToast(error.message || 'Error al actualizar la orden de trabajo.', 'error');
    } finally {
        showLoading(false);
    }
}

// --- Assigned Orders Functions (for Technicians) ---
function renderAssignedOrders() {
    const container = document.getElementById('assigned-orders-container');
    if (!container) return;
    container.innerHTML = '';

    if (!state.currentUser || (state.currentUser.role !== 'T칠cnico' && state.currentUser.role !== 'Admin')) {
        container.innerHTML = '<div class="alert alert-warning">No tiene permisos para ver esta secci칩n.</div>';
        return;
    }

    const monthFilter = document.getElementById('assigned-month-filter');
    const selectedMonth = monthFilter ? monthFilter.value : null;

    if (selectedMonth) {
        const [year, month] = selectedMonth.split('-').map(Number);
        const monthName = new Date(year, month - 1, 1)
            .toLocaleDateString('es-ES', { month: 'long', year: 'numeric' })
            .replace(/^\w/, c => c.toUpperCase());
        const titleEl = document.getElementById('assigned-orders-title');
        if (titleEl) titleEl.textContent = `Mis 칍rdenes de Trabajo - ${monthName}`;
    }

    const assignedOrders = state.workOrders.filter(order => {
        const isAssigned = order.technicians && order.technicians.includes(state.currentUser.username);
        const isActiveStatus = ['Pendiente', 'En Proceso', 'Pausado'].includes(order.status);

        if (!isAssigned || !isActiveStatus) return false;

        if (selectedMonth) {
            const orderDateStr = order.date;
            if (!orderDateStr) return false;

            let orderMonthStr = "";
            if (/^\d{4}-\d{2}-\d{2}$/.test(orderDateStr)) {
                orderMonthStr = orderDateStr.substring(0, 7);
            } else {
                const d = new Date(orderDateStr);
                if (isNaN(d.getTime())) return false;
                orderMonthStr = `${d.getFullYear()}-${(d.getMonth() + 1).toString().padStart(2, '0')}`;
            }
            return orderMonthStr === selectedMonth;
        }

        return true;
    });

    if (assignedOrders.length === 0) {
        container.innerHTML = '<p class="text-center text-muted mt-4">No tiene 칩rdenes de trabajo asignadas para este per칤odo.</p>';
        return;
    }

    assignedOrders.sort((a, b) => new Date(a.date) - new Date(b.date));

    assignedOrders.forEach(order => {
        container.appendChild(createAssignedOrderCard(order));
    });
}

function createAssignedOrderCard(order) {
    const card = document.createElement('div');
    card.className = 'card kanban-card mb-3';
    const machine = state.machines.find(m => m.id === order.machineId) || { name: 'Desconocido' };
    const isLead = state.currentUser.username === order.leadTechnician;

    let actionButtonsHTML = '';
    if(isLead) {
        let statusButtons = '';
        switch (order.status) {
            case 'Pendiente':
                statusButtons = `<button class="btn btn-primary start-task-btn"><i class="fas fa-play me-2"></i>Iniciar</button>`;
                break;
            case 'En Proceso':
                statusButtons = `
                    <button class="btn btn-warning pause-task-btn"><i class="fas fa-pause me-2"></i>Pausar</button>
                    <button class="btn btn-success complete-task-btn ms-2"><i class="fas fa-check me-2"></i>Finalizar</button>
                `;
                break;
            case 'Pausado':
                statusButtons = `<button class="btn btn-info resume-task-btn"><i class="fas fa-play me-2"></i>Reanudar</button>`;
                break;
        }
        actionButtonsHTML = `
            <div class="btn-group">
                ${statusButtons}
            </div>
            <div class="btn-group ms-2" role="group">
                <button class="btn btn-outline-secondary edit-details-btn" title="Editar Detalles y Falla"><i class="fas fa-edit"></i></button>
                <button class="btn btn-outline-secondary manage-parts-btn" title="Gestionar Repuestos"><i class="fas fa-box-open"></i></button>
            </div>
        `;
    } else {
         actionButtonsHTML = `<button class="btn btn-outline-secondary view-details-btn"><i class="fas fa-eye me-2"></i>Ver Detalles</button>`;
    }

    const cardTitle = order.id ? order.id : `(${machine.id || 'N/A'})`;
    const fechaLimite = order.date && !isNaN(new Date(order.date))
        ? new Date(order.date).toLocaleDateString('es-ES')
        : 'No especificada';

    const typeBadge = `<span class="badge bg-${order.type === 'Preventivo' ? 'primary' : 'danger'} mb-2">${order.type}</span>`;
    const statusBadge = `<span class="badge bg-${order.status === 'En Proceso' ? 'info text-dark' : (order.status === 'Pausado' ? 'secondary' : 'warning text-dark')}">${order.status}</span>`;

    card.innerHTML = `
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    ${typeBadge}
                    <h5 class="card-title mb-1" style="cursor: pointer;">${cardTitle}</h5>
                    <h6 class="card-subtitle mb-3 text-muted"><i class="fas fa-cogs me-1"></i>${machine.name}</h6>
                </div>
                ${statusBadge}
            </div>

            <div class="row mb-3">
                <div class="col-md-6">
                    <p class="card-text mb-1"><small class="text-muted">Responsable:</small><br><strong>${order.leadTechnician || 'N/A'}</strong></p>
                </div>
                <div class="col-md-6 text-md-end">
                    <p class="card-text mb-1"><small class="text-muted">Fecha L칤mite:</small><br><strong>${fechaLimite}</strong></p>
                </div>
            </div>

            <div class="p-3 bg-light rounded mb-3 border-start border-4 border-${order.type === 'Preventivo' ? 'primary' : 'danger'}">
                <p class="card-text mb-0">${order.description}</p>
            </div>

            <div class="d-flex justify-content-end align-items-center">
                <div>${actionButtonsHTML}</div>
            </div>
        </div>
    `;

    if (isLead) {
        card.querySelector('.start-task-btn')?.addEventListener('click', () => handleKanbanWorkOrderAction(order.fb_id, 'En Proceso'));
        card.querySelector('.pause-task-btn')?.addEventListener('click', () => handleKanbanWorkOrderAction(order.fb_id, 'Pausado'));
        card.querySelector('.resume-task-btn')?.addEventListener('click', () => handleKanbanWorkOrderAction(order.fb_id, 'En Proceso'));
        card.querySelector('.complete-task-btn')?.addEventListener('click', () => {
            showConfirmation(
                'Finalizar Orden de Trabajo',
                `쮼st치 seguro que desea marcar la orden ${order.id || `(${order.machineId})`} como finalizada?`,
                () => handleKanbanWorkOrderAction(order.fb_id, 'Pendiente de Evaluaci칩n')
            );
        });
        card.querySelector('.manage-parts-btn')?.addEventListener('click', () => showManagePartsModal(order.id));
        card.querySelector('.edit-details-btn')?.addEventListener('click', () => showWorkOrderModal(order.fb_id));
    } else {
        card.querySelector('.view-details-btn')?.addEventListener('click', () => showWorkOrderModal(order.fb_id));
    }
    
    card.querySelector('.card-title').addEventListener('click', () => showWorkOrderModal(order.fb_id));

    return card;
}

function showManagePartsModal(orderId) {
    const order = state.workOrders.find(o => o.id === orderId);
    if (!order) {
        showToast('Orden de trabajo no encontrada.', 'error');
        return;
    }

    document.getElementById('manage-parts-modal-title').textContent = `Gestionar Repuestos para OT: ${orderId}`;
    document.getElementById('manage-parts-wo-id').value = orderId;

    const partsListContainer = document.getElementById('current-parts-list');
    partsListContainer.innerHTML = '';
    
    const currentParts = order.partsUsed || [];
    if (currentParts.length > 0) {
        currentParts.forEach(partUsage => {
            renderPartInManageModal(partUsage.partId, partUsage.quantity);
        });
    } else {
        partsListContainer.innerHTML = '<p class="text-muted list-group-item">No hay repuestos asignados a esta orden.</p>';
    }

    const partSelect = document.getElementById('manage-part-select');
    partSelect.innerHTML = '<option value="">Seleccione un repuesto...</option>';
    const relevantParts = state.parts.filter(p => 
        (p.machineIds && p.machineIds.includes(order.machineId)) || 
        (p.machineId === order.machineId)
    );
    relevantParts.forEach(p => {
        partSelect.innerHTML += `<option value="${p.id}">${p.description} (Stock: ${p.stock})</option>`;
    });

    state.modals.manageParts.show();
}

function renderPartInManageModal(partId, quantity) {
    const part = state.parts.find(p => p.id === partId);
    if (!part) return;

    const listContainer = document.getElementById('current-parts-list');
    
    const placeholder = listContainer.querySelector('p');
    if (placeholder) placeholder.remove();

    let partRow = listContainer.querySelector(`[data-part-id="${partId}"]`);
    if(partRow) {
        partRow.dataset.quantity = quantity;
        partRow.querySelector('.part-quantity-badge').textContent = `Cant: ${quantity}`;
    } else {
        partRow = document.createElement('div');
        partRow.className = 'list-group-item d-flex justify-content-between align-items-center';
        partRow.dataset.partId = partId;
        partRow.dataset.quantity = quantity;

        partRow.innerHTML = `
            <span>${part.description}</span>
            <div>
                <span class="badge bg-secondary me-2 part-quantity-badge">Cant: ${quantity}</span>
                <button type="button" class="btn btn-sm btn-outline-danger remove-managed-part-btn"><i class="fas fa-times"></i></button>
            </div>
        `;
        listContainer.appendChild(partRow);
        
        partRow.querySelector('.remove-managed-part-btn').addEventListener('click', () => {
            partRow.remove();
            if (listContainer.children.length === 0) {
                 listContainer.innerHTML = '<p class="text-muted list-group-item">No hay repuestos asignados a esta orden.</p>';
            }
        });
    }
}

function handleAddOrUpdatePartInModal() {
    const partSelect = document.getElementById('manage-part-select');
    const qtyInput = document.getElementById('manage-part-quantity');
    const selectedPartId = partSelect.value;
    const selectedQty = parseInt(qtyInput.value);

    if (!selectedPartId) {
        showToast('Seleccione un repuesto.', 'warning');
        return;
    }
    if (isNaN(selectedQty) || selectedQty < 1) {
        showToast('La cantidad debe ser un n칰mero positivo.', 'warning');
        return;
    }
    renderPartInManageModal(selectedPartId, selectedQty);
    partSelect.value = '';
    qtyInput.value = 1;
}

async function handleSaveManagedParts() {
    const orderId = document.getElementById('manage-parts-wo-id').value;
    if (!orderId) return;

    showLoading(true);

    const originalOrder = state.workOrders.find(o => o.id === orderId);
    if (!originalOrder) {
        showToast('Orden no encontrada.', 'error');
        showLoading(false);
        return;
    }
    
    const originalPartsMap = new Map((originalOrder.partsUsed || []).map(p => [p.partId, p]));
    
    const newPartsList = [];
    const newPartsMap = new Map();
    document.querySelectorAll('#current-parts-list .list-group-item[data-part-id]').forEach(item => {
        const partId = item.dataset.partId;
        const quantity = parseInt(item.dataset.quantity);
        newPartsList.push({ partId, quantity });
        newPartsMap.set(partId, quantity);
    });

    const stockDeltas = new Map();
    newPartsMap.forEach((newQty, partId) => {
        const oldEntry = originalPartsMap.get(partId);
        const oldQty = (oldEntry && oldEntry.delivered !== false) ? oldEntry.quantity : 0;
        const delta = newQty - oldQty;
        if (delta !== 0) {
            stockDeltas.set(partId, (stockDeltas.get(partId) || 0) - delta); // Subtract delta from stock
        }
    });
    
    originalPartsMap.forEach((oldEntry, partId) => {
        if (!newPartsMap.has(partId)) {
            const oldQty = (oldEntry && oldEntry.delivered !== false) ? oldEntry.quantity : 0;
            if (oldQty > 0) {
                stockDeltas.set(partId, (stockDeltas.get(partId) || 0) + oldQty); // Add back to stock
            }
        }
    });

    try {
        const finalizedPartsList = [];
        for (const [partId, delta] of stockDeltas.entries()) {
            const partDocRef = doc(state.collections.parts, partId);
            const partDoc = await getDoc(partDocRef);
            const newEntry = newPartsMap.get(partId);

            if (partDoc.exists()) {
                const currentStock = partDoc.data().stock;
                const newStock = currentStock + delta;

                if (newStock < 0) {
                    // Marcar como no entregado si no hay stock
                    if (newEntry) finalizedPartsList.push({ ...newEntry, delivered: false });
                } else {
                    await updateDoc(partDocRef, { stock: newStock });
                    if (delta !== 0) {
                        await recordPartMovement(partId, delta, delta > 0 ? 'Devoluci칩n OT' : 'Salida OT', {
                            orderId: originalOrder.fb_id,
                            orderHumanId: originalOrder.id
                        });
                    }
                    if (newEntry) finalizedPartsList.push({ ...newEntry, delivered: true });
                }
            } else if (newEntry) {
                 finalizedPartsList.push({ ...newEntry, delivered: false });
            }
        }

        // Add back parts that didn't have stock change but were already in finalized list
        newPartsList.forEach(p => {
            if (!stockDeltas.has(p.partId)) {
                const oldEntry = originalPartsMap.get(p.partId);
                finalizedPartsList.push(oldEntry || p);
            }
        });
        
        const orderDocRef = doc(state.collections.workOrders, originalOrder.fb_id);
        await updateDoc(orderDocRef, { partsUsed: finalizedPartsList });
        
        showToast('Repuestos actualizados correctamente.', 'success');
        state.modals.manageParts.hide();

    } catch (error) {
        console.error("Error saving managed parts:", error);
        showToast(error.message || 'Error al guardar los cambios en los repuestos.', 'error');
    } finally {
        showLoading(false);
    }
}


// --- Planner/Calendar Functions ---
function renderCalendar() {
    const grid = document.getElementById('calendar-grid');
    const monthYearEl = document.getElementById('calendar-month-year');
    grid.innerHTML = '';

    const date = state.calendarDate;
    const year = date.getFullYear();
    const month = date.getMonth();

    monthYearEl.textContent = date.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });

    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();

    let workOrdersToDisplay = state.workOrders;
    const userRole = state.currentUser?.role;
    const managedMachineIds = state.currentUser?.managedMachineIds;
    const equipoAsignado = state.currentUser?.equipoAsignado;

    if ((userRole === 'Jefe de Area' && Array.isArray(managedMachineIds)) || (userRole === 'T칠cnico' && Array.isArray(equipoAsignado)) || (userRole === 'Operario' && Array.isArray(equipoAsignado))) {
        const relevantMachineIds = new Set(userRole === 'Jefe de Area' ? managedMachineIds : equipoAsignado);
        workOrdersToDisplay = state.workOrders.filter(wo => relevantMachineIds.has(wo.machineId));
    }

    const searchTerm = document.getElementById('planner-search-input').value.toLowerCase();
    if (searchTerm) {
        workOrdersToDisplay = workOrdersToDisplay.filter(wo => {
            const machineName = state.machines.find(m => m.id === wo.machineId)?.name || '';
            const leadTechnician = wo.leadTechnician || '';
            return machineName.toLowerCase().includes(searchTerm) ||
                   wo.machineId.toLowerCase().includes(searchTerm) ||
                   leadTechnician.toLowerCase().includes(searchTerm);
        });
    }

    for (let i = 0; i < firstDay; i++) {
        grid.innerHTML += '<div class="calendar-day not-month"></div>';
    }

    for (let day = 1; day <= daysInMonth; day++) {
        const dayEl = document.createElement('div');
        dayEl.className = 'calendar-day';
        dayEl.innerHTML = `<div class="day-number">${day}</div>`;
        
        const currentDateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        
        const tasksForDay = workOrdersToDisplay.filter(wo => wo.date === currentDateStr);
        
        tasksForDay.forEach(task => {
            const taskEl = document.createElement('div');
            taskEl.className = `calendar-task task-${task.type}`;
            if (task.status === 'Pendiente de Aprobaci칩n') {
                taskEl.classList.add('task-pending-approval');
            }
            const isCompleted = task.status === 'Completado' || task.status === 'Pendiente de Evaluaci칩n';
            const displayText = task.id || `(${task.machineId})`;
            taskEl.innerHTML = isCompleted ? `<i class="fas fa-star text-warning"></i> ${displayText}` : displayText;
            taskEl.dataset.fb_id = task.fb_id;
            
            taskEl.setAttribute('data-bs-toggle', 'popover');
            taskEl.setAttribute('data-bs-trigger', 'hover focus');
            taskEl.setAttribute('data-bs-title', `Detalles de OT: ${task.id || 'Pendiente'}`);
            taskEl.setAttribute('data-bs-content', `<b>M치quina:</b> ${task.machineId}<br><b>Tarea:</b> ${task.description}`);
            taskEl.setAttribute('data-bs-html', 'true');

            taskEl.addEventListener('click', (e) => {
                e.stopPropagation();
                showWorkOrderModal(task.fb_id);
            });
            dayEl.appendChild(taskEl);
        });

        grid.appendChild(dayEl);
    }

    const popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
    popoverTriggerList.map(function (popoverTriggerEl) {
        return new bootstrap.Popover(popoverTriggerEl);
    });
}

function changeMonth(offset) {
    state.calendarDate.setMonth(state.calendarDate.getMonth() + offset);
    renderCalendar();
}

// --- Comprehensive Work Order Modal Functions ---
/**
 * Obtiene o crea un ID de equipo en Odoo basado en el ID de la m치quina de la app.
 * @param {string} machineId - ID de la m치quina en la aplicaci칩n (ej: 'M001')
 * @returns {Promise<number|null>} - ID entero de Odoo o null si falla
 */
/**
 * Sincroniza una m치quina con Odoo. Si no existe, la crea. Si existe, la actualiza.
 * Devuelve el ID de Odoo.
 */
async function syncAllMachinesToOdoo() {
    if (!state.odoo) {
        showToast('Odoo no est치 configurado o conectado.', 'error');
        return;
    }

    const confirmSync = confirm(`쮻esea sincronizar las ${state.machines.length} m치quinas con Odoo? Se procesar치n en paralelo para mayor velocidad.`);
    if (!confirmSync) return;

    showLoading(true);
    state.odooSyncError = null;
    let successCount = 0;
    let errorCount = 0;

    const batchSize = 5;
    const machines = state.machines;

    for (let i = 0; i < machines.length; i += batchSize) {
        const batch = machines.slice(i, i + batchSize);
        await Promise.all(batch.map(async (machine) => {
            try {
                await syncMachineToOdoo(machine);
                successCount++;
            } catch (error) {
                console.error(`Error sincronizando m치quina ${machine.id}:`, error);
                errorCount++;
            }
        }));
    }

    showLoading(false);
    if (errorCount === 0) {
        showToast(`Sincronizaci칩n completada: ${successCount} m치quinas procesadas.`, 'success');
    } else {
        showToast(`Sincronizaci칩n terminada con algunos errores: ${successCount} 칠xito, ${errorCount} fallos.`, 'warning');
    }
}

async function syncAllPartsToOdoo() {
    if (!state.odoo) {
        showToast('Odoo no est치 configurado o conectado.', 'error');
        return;
    }

    const confirmSync = confirm(`쮻esea sincronizar los ${state.parts.length} repuestos con Odoo? Se procesar치n en paralelo para mayor velocidad.`);
    if (!confirmSync) return;

    showLoading(true);
    state.odooSyncError = null;
    let successCount = 0;
    let errorCount = 0;

    const batchSize = 8;
    const parts = state.parts;

    for (let i = 0; i < parts.length; i += batchSize) {
        const batch = parts.slice(i, i + batchSize);
        await Promise.all(batch.map(async (part) => {
            try {
                // Sincronizar metadata y stock (syncPartStockToOdoo llama internamente a syncPartToOdoo)
                await syncPartStockToOdoo(part.id, part);
                successCount++;
            } catch (error) {
                console.error(`Error sincronizando repuesto ${part.id}:`, error);
                errorCount++;
            }
        }));
    }

    showLoading(false);
    if (errorCount === 0) {
        showToast(`Sincronizaci칩n completada: ${successCount} repuestos procesados.`, 'success');
    } else {
        showToast(`Sincronizaci칩n terminada con algunos errores: ${successCount} 칠xito, ${errorCount} fallos.`, 'warning');
    }
}

async function syncPartToOdoo(partData) {
    if (!state.odoo || !partData) return null;

    try {
        const isInsumo = partData.classification === 'insumo';
        const isOdoo18Plus = !state.odooVersion || state.odooVersion >= 18;

        const odooProduct = {
            default_code: partData.id,
            name: partData.description,
            standard_price: partData.cost || 0,
            purchase_ok: true,
            sale_ok: false
        };

        if (isOdoo18Plus) {
            // Odoo 18+ (SaaS 19.1+): 'detailed_type' eliminado, 'type' es 'consu' para bienes (Goods)
            // Se usa 'is_storable' para activar el seguimiento de inventario (Track Inventory)
            odooProduct.type = 'consu';
            odooProduct.is_storable = !isInsumo;
        } else {
            // Odoo 17 y anteriores: 'type' limitado, se requiere 'detailed_type'
            odooProduct.type = 'consu';
            odooProduct.detailed_type = isInsumo ? 'consu' : 'product';
        }

        let odooId = partData.odoo_id;

        // Manejo de ID corrupto
        if (odooId && (typeof odooId !== 'number' && String(odooId).includes('[object'))) {
            console.warn(`[Odoo Sync] ID de Odoo corrupto detectado para repuesto ${partData.id}: ${odooId}. Re-sincronizando...`);
            odooId = null;
        }

        if (!odooId) {
            // Buscar si ya existe por c칩digo de referencia (default_code) en product.product
            const results = await state.odoo.searchRead('product.product', [['default_code', '=', partData.id]], ['id', 'default_code', 'name']);

            if (results && results.length > 0) {
                // Verificar coincidencia exacta por c칩digo
                const exactMatch = results.find(r => r.default_code === partData.id);
                if (exactMatch) {
                    odooId = exactMatch.id;
                }
            }

            // Si no se encontr칩 por c칩digo, intentar por nombre
            if (!odooId) {
                const searchName = partData.description.trim();
                const nameResults = await state.odoo.searchRead('product.product', [['name', '=', searchName]], ['id', 'name']);
                if (nameResults && nameResults.length > 0) {
                    const exactMatch = nameResults.find(r => r.name.trim() === searchName);
                    if (exactMatch) odooId = exactMatch.id;
                }
            }
        }

        if (odooId) {
            console.log(`[Odoo Sync] Actualizando repuesto existente en Odoo (ID: ${odooId})`);
            await state.odoo.write('product.product', odooId, odooProduct);
            // Limpiar error previo si la actualizaci칩n fue exitosa
            if (state.odooSyncError) {
                state.odooSyncError = null;
                if (typeof renderParts === 'function') renderParts();
            }
        } else {
            console.log(`[Odoo Sync] Creando nuevo repuesto en Odoo...`);
            // Nota: Al crear product.product, Odoo crea autom치ticamente el product.template asociado.
            // Esto asegura que el ID que obtenemos sea el de product.product (variante) para el stock.
            odooId = await state.odoo.create('product.product', odooProduct);
            console.log(`[Odoo Sync] Nuevo repuesto creado en Odoo con ID: ${odooId}`);
            // Limpiar error previo si la creaci칩n fue exitosa
            if (state.odooSyncError) {
                state.odooSyncError = null;
                if (typeof renderParts === 'function') renderParts();
            }
        }

        // Guardar el odoo_id en Firestore si es nuevo o ha cambiado
        if (odooId && odooId !== partData.odoo_id) {
            console.log(`[Odoo Sync] Guardando Odoo ID ${odooId} en Firestore para el repuesto ${partData.id}`);
            const partDocId = partData.fb_id || partData.id;
            await updateDoc(doc(state.collections.parts, partDocId), { odoo_id: odooId });
            const localPart = state.parts.find(p => p.fb_id === partData.fb_id || p.id === partData.id);
            if (localPart) localPart.odoo_id = odooId;
        }

        return odooId;
    } catch (e) {
        console.error("[Odoo Sync] Error sincronizando repuesto:", e);
        state.odooSyncError = `Error sincronizando repuesto: ${e.message || e}`;
        if (typeof renderParts === 'function') renderParts();
        throw e;
    }
}

async function uploadPartFile(partId, file, type) {
    if (!file) return null;
    const MAX_SIZE = 10 * 1024 * 1024;
    if (file.size > MAX_SIZE) {
        throw new Error(`El archivo ${file.name} excede el l칤mite de 10MB.`);
    }
    const fileName = `${type}_${Date.now()}_${file.name}`;
    const storageRef = ref(state.storage, `repuestos/${partId}/${fileName}`);
    try {
        const snapshot = await uploadBytes(storageRef, file);
        return await getDownloadURL(snapshot.ref);
    } catch (error) {
        console.error(`Error uploading part ${type}:`, error);
        throw error;
    }
}

async function syncMachineToOdoo(machineData) {
    if (!state.odoo || !machineData) return null;

    console.log(`[Odoo Sync] Iniciando sincronizaci칩n para m치quina: ${machineData.id} (${machineData.name})`);

    try {
        let locationId = null;
        if (machineData.location && machineData.location.trim()) {
            const locName = machineData.location.trim();
            try {
                console.log(`[Odoo Sync] Buscando ubicaci칩n en Odoo: "${locName}"`);
                const locations = await state.odoo.searchRead('stock.location', [['name', '=', locName]], ['id']);
                if (locations && locations.length > 0) {
                    locationId = locations[0].id;
                    console.log(`[Odoo Sync] Ubicaci칩n encontrada en Odoo con ID: ${locationId}`);
                } else {
                    console.log(`[Odoo Sync] Ubicaci칩n "${locName}" no encontrada. Cre치ndola...`);
                    // Intentamos crear la ubicaci칩n b치sica.
                    locationId = await state.odoo.create('stock.location', { name: locName });
                    console.log(`[Odoo Sync] Nueva ubicaci칩n creada en Odoo con ID: ${locationId}`);
                }
            } catch (locError) {
                console.warn(`[Odoo Sync] No se pudo obtener/crear la ubicaci칩n "${locName}":`, locError);
                // Seg칰n requerimiento: si falla, se sincroniza sin ubicaci칩n
            }
        }

        const odooMachine = {
            name: machineData.name,
            model: machineData.type || 'maquina',
            serial_no: machineData.id,
            note: `Sincronizado desde App CMMS - ID Local: ${machineData.id}`
        };

        if (locationId) {
            odooMachine.location_id = locationId;
        }

        let odooId = machineData.odoo_id;

        // Si el ID guardado parece corrupto (ej. "[object Object]"), lo ignoramos
        if (odooId && (typeof odooId !== 'number' && String(odooId).includes('[object'))) {
            console.warn(`[Odoo Sync] ID de Odoo corrupto detectado para ${machineData.id}: ${odooId}. Re-sincronizando...`);
            odooId = null;
        }

        // Si no tenemos odoo_id, buscamos por N칰mero de Serie (ID local)
        if (!odooId) {
            const searchSerial = machineData.id.trim();
            console.log(`[Odoo Sync] Buscando equipo en Odoo por N칰mero de Serie: "${searchSerial}"`);

            const results = await state.odoo.searchRead('maintenance.equipment', [['serial_no', '=', searchSerial]], ['id', 'name', 'serial_no']);
            console.log(`[Odoo Sync] Resultados de b칰squeda por serial_no:`, results);

            if (results && results.length > 0) {
                // Verificamos si alguno de los resultados coincide exactamente por serial_no
                const exactMatch = results.find(r => (r.serial_no || '').trim() === searchSerial);

                if (exactMatch) {
                    odooId = exactMatch.id;
                    console.log(`[Odoo Sync] Equipo encontrado en Odoo con ID: ${odooId} (Coincidencia por Serial)`);
                } else {
                    console.log(`[Odoo Sync] Se encontraron equipos (${results.length}) pero ninguno coincide por Serial "${searchSerial}"`);
                    results.forEach((r, idx) => console.log(`  [${idx}] Encontrado en Odoo: "${r.name}" (ID: ${r.id}, Serial: ${r.serial_no})`));
                }
            }
        }

        if (odooId) {
            console.log(`[Odoo Sync] Actualizando equipo existente en Odoo (ID: ${odooId})`);
            await state.odoo.write('maintenance.equipment', odooId, odooMachine);
        } else {
            console.log(`[Odoo Sync] Creando nuevo equipo en Odoo...`);
            const createdId = await state.odoo.create('maintenance.equipment', odooMachine);
            odooId = createdId;
            console.log(`[Odoo Sync] Nuevo equipo creado en Odoo con ID: ${odooId}`);
        }

        // Guardar el odoo_id en Firestore si es nuevo o ha cambiado
        if (odooId && odooId !== machineData.odoo_id) {
            console.log(`[Odoo Sync] Guardando Odoo ID ${odooId} en Firestore para la m치quina ${machineData.id}`);
            await updateDoc(doc(state.collections.machines, machineData.id), { odoo_id: odooId });
            // Actualizar tambi칠n en el estado local para evitar re-sincronizaciones innecesarias
            const localMachine = state.machines.find(m => m.id === machineData.id);
            if (localMachine) localMachine.odoo_id = odooId;
        }

        return odooId;
    } catch (e) {
        console.error("[Odoo Sync] Error sincronizando m치quina:", e);
        throw e; // Lanzamos para que el llamador lo maneje
    }
}

async function getOrCreateOdooEquipmentId(machineId) {
    if (!state.odoo || !machineId) return null;

    let machine = state.machines.find(m => m.id === machineId);

    if (!machine) {
        try {
            const machineDoc = await getDoc(doc(state.collections.machines, machineId));
            if (machineDoc.exists()) {
                machine = { id: machineDoc.id, ...machineDoc.data() };
            }
        } catch (e) {
            console.warn("[Odoo Sync] No se pudo obtener la m치quina de Firestore:", e);
        }
    }

    if (!machine) {
        console.warn(`[Odoo Sync] No se encontr칩 informaci칩n para la m치quina ${machineId}`);
        return null;
    }

    return await syncMachineToOdoo(machine);
}

async function syncTechnicianToOdoo(techData, fbId) {
    if (!state.odoo || !techData) return;
    try {
        const odooUser = {
            name: techData.username,
            login: techData.username + '@corinfar.com' // Odoo requiere un login (email)
        };

        let odooId = null;
        const existingUser = await state.odoo.searchRead('res.users', [['name', '=', techData.username]], ['id']);
        if (existingUser && existingUser.length > 0) {
            odooId = existingUser[0].id;
            console.log(`[Odoo Sync] Usuario encontrado en Odoo (ID: ${odooId}). Actualizando...`);
            await state.odoo.write('res.users', odooId, odooUser);
        } else {
            console.log(`[Odoo Sync] Usuario "${techData.username}" no encontrado en Odoo para sincronizaci칩n.`);
        }

        if (odooId) {
            await updateDoc(doc(state.collections.technicians, fbId), { odoo_id: odooId });
            const localTech = state.technicians.find(t => t.fb_id === fbId);
            if (localTech) localTech.odoo_id = odooId;
        }
    } catch (odooError) {
        console.warn("[Odoo Sync] Fallo sincronizaci칩n de usuario:", odooError);
    }
}

/**
 * Sincroniza el nivel de stock de un repuesto con Odoo (para productos 'storable')
 */
async function syncPartStockToOdoo(partId, partData = null) {
    if (!state.odoo) return;

    // Usar partData proporcionado o buscar en el estado local por ID
    const part = partData || (state.parts && state.parts.find(p => p.id === partId));

    if (!part) {
        console.warn(`[Odoo Sync] No se pudo encontrar datos para el repuesto ${partId} para sincronizar stock.`);
        return;
    }

    try {
        // 1. Asegurarse de que el producto existe en Odoo y sincronizar metadata (Nombre, Precio, Tipo)
        // Esto se hace tanto para Repuestos como para Insumos.
        const odooProductId = await syncPartToOdoo(part);

        // 2. Solo sincronizar stock para repuestos (storable/product), no para insumos (consu)
        if (part.classification === 'insumo') {
            console.log(`[Odoo Sync] El 칤tem ${partId} es un insumo (consumible), solo se sincroniz칩 metadata en Odoo.`);
            return;
        }

        console.log(`[Odoo Sync] Sincronizando stock para repuesto: ${partId} (Cantidad: ${part.stock})`);
        if (!odooProductId) {
            console.warn(`[Odoo Sync] No se pudo obtener o crear el producto en Odoo para el repuesto ${partId}`);
            return;
        }

        // Determinar ubicaci칩n en Odoo
        let odooLocationId = null;
        if (part.location && part.location.trim()) {
            const locName = part.location.trim();
            // Buscar por nombre o por nombre completo (display_name)
            const locations = await state.odoo.searchRead('stock.location', [
                '|', ['name', '=', locName], ['display_name', '=', locName],
                ['usage', '=', 'internal']
            ], ['id']);
            if (locations && locations.length > 0) {
                odooLocationId = locations[0].id;
            }
        }

        // Fallback a ubicaci칩n est치ndar si no se encuentra o no tiene definida
        if (!odooLocationId) {
            // Intentamos buscar una ubicaci칩n llamada 'Stock' que sea interna
            const stockLocs = await state.odoo.searchRead('stock.location', [['name', '=', 'Stock'], ['usage', '=', 'internal']], ['id']);
            if (stockLocs && stockLocs.length > 0) {
                odooLocationId = stockLocs[0].id;
            } else {
                // Si a칰n no hay, buscamos cualquier ubicaci칩n interna
                const anyInternal = await state.odoo.searchRead('stock.location', [['usage', '=', 'internal']], ['id'], { limit: 1 });
                if (anyInternal && anyInternal.length > 0) odooLocationId = anyInternal[0].id;
            }
        }

        if (!odooLocationId) {
            console.warn(`[Odoo Sync] No se encontr칩 una ubicaci칩n interna v치lida en Odoo para sincronizar stock de ${partId}`);
            return;
        }

        const currentStock = Number(part.stock) || 0;

        // En Odoo 17+, se usa stock.quant para ajustar el stock disponible (Quantity on Hand)
        // Buscamos si ya existe un quant para este producto y ubicaci칩n
        const quants = await state.odoo.searchRead('stock.quant', [
            ['product_id', '=', odooProductId],
            ['location_id', '=', odooLocationId]
        ], ['id', 'quantity']);

        if (quants && quants.length > 0) {
            const quantId = quants[0].id;
            console.log(`[Odoo Sync] Actualizando stock en quant existente ID ${quantId} para ${partId}`);
            // Establecemos la cantidad inventariada y aplicamos
            await state.odoo.write('stock.quant', quantId, {
                inventory_quantity: currentStock
            });
            await state.odoo.executeKw('stock.quant', 'action_apply_inventory', [[quantId]]);
        } else {
            console.log(`[Odoo Sync] Creando nuevo quant en Odoo para ${partId} en ubicaci칩n ${odooLocationId}`);
            const newQuantId = await state.odoo.create('stock.quant', {
                product_id: odooProductId,
                location_id: odooLocationId,
                inventory_quantity: currentStock
            });
            await state.odoo.executeKw('stock.quant', 'action_apply_inventory', [[newQuantId]]);
        }

    } catch (error) {
        console.error(`[Odoo Sync] Error sincronizando stock para repuesto ${partId}:`, error);
        state.odooSyncError = `Error stock ${partId}: ${error.message || error}`;
        if (typeof renderParts === 'function') renderParts();
    }
}

async function syncSolicitudToOdoo(solicitudData, fbId, nextId) {
    if (!state.odoo || !solicitudData) return;
    try {
        const machine = state.machines.find(m => m.id === solicitudData.machineId) || { name: solicitudData.machineId };
        const equipmentId = await getOrCreateOdooEquipmentId(solicitudData.machineId);
        const odooData = {
            name: `Fallo en ${machine.name}: ${solicitudData.description.substring(0, 30)}...`,
            description: `${solicitudData.description} (Ref App: ${nextId})`,
            maintenance_type: 'corrective',
            equipment_id: equipmentId
        };

        console.log(`[Odoo Sync] Enviando solicitud a Odoo: ${odooData.name}`);
        const newOdooId = await state.odoo.create('maintenance.request', odooData);
        if (newOdooId) {
            await updateDoc(doc(state.collections.solicitudes, fbId), { odoo_id: newOdooId });
            const localSol = state.solicitudes.find(s => s.fb_id === fbId);
            if (localSol) localSol.odoo_id = newOdooId;
        }
    } catch (odooError) {
        console.warn("[Odoo Sync] Fallo sincronizaci칩n de solicitud:", odooError);
        showToast(`Error sincronizaci칩n Odoo: ${odooError.message}`, 'warning');
    }
}

async function syncWorkOrderToOdoo(orderData, fbId) {
    if (!state.odoo || !orderData) return;

    try {
        const machine = state.machines.find(m => m.id === orderData.machineId) || { name: orderData.machineId };
        const equipmentId = await getOrCreateOdooEquipmentId(orderData.machineId);

        // Buscar ID de Odoo del t칠cnico responsable
        let technicianOdooId = null;
        const leadTech = state.technicians.find(t => t.username === orderData.leadTechnician);
        if (leadTech && leadTech.odoo_id) {
            technicianOdooId = leadTech.odoo_id;
        } else if (orderData.leadTechnician) {
            console.log(`[Odoo Sync] Buscando ID de Odoo para el t칠cnico: ${orderData.leadTechnician}`);
            const techResults = await state.odoo.searchRead('res.users', [['name', '=', orderData.leadTechnician]], ['id']);
            if (techResults && techResults.length > 0) {
                technicianOdooId = techResults[0].id;
                if (leadTech) leadTech.odoo_id = technicianOdooId;
            }
        }

        const odooData = {
            name: `${orderData.id}: ${machine.name}`,
            description: orderData.description,
            maintenance_type: orderData.type.toLowerCase() === 'preventivo' ? 'preventive' : 'corrective',
            priority: orderData.priority === 'Alta' ? '3' : (orderData.priority === 'Media' ? '2' : '1'),
            equipment_id: equipmentId
        };

        if (technicianOdooId) {
            odooData.user_id = technicianOdooId;
        }

        // Si ya tiene un ID de Odoo guardado, lo actualizamos, si no, creamos uno nuevo
        if (orderData.odoo_id) {
            await state.odoo.write('maintenance.request', orderData.odoo_id, odooData);
        } else {
            const newOdooId = await state.odoo.create('maintenance.request', odooData);
            if (newOdooId) {
                await updateDoc(doc(state.collections.workOrders, fbId), { odoo_id: newOdooId });
                // Actualizar en el estado local
                const localWo = state.workOrders.find(wo => wo.fb_id === fbId);
                if (localWo) localWo.odoo_id = newOdooId;
            }
        }
        console.log(`[Odoo Sync] Orden ${orderData.id} sincronizada correctamente.`);
    } catch (odooError) {
        console.warn(`[Odoo Sync] Fallo sincronizaci칩n de OT ${orderData.id}:`, odooError);
        showToast(`Error sincronizaci칩n Odoo (OT ${orderData.id}): ${odooError.message}`, 'warning');
    }
}

async function saveWorkOrder(updates = {}) {
    showLoading(true);
    try {
        const fbId = document.getElementById('wo-fb-id-hidden').value;
        if (fbId) {
            const order = state.workOrders.find(o => o.fb_id === fbId);
            if (order && order.isExpired) {
                showToast('Esta orden ha expirado y no puede ser modificada.', 'error');
                showLoading(false);
                return;
            }
        }
        const isNew = !fbId;
        const orderId = document.getElementById('wo-id').value;

        const partsUsed = [];
        document.querySelectorAll('#wo-parts-list > div').forEach(row => {
            partsUsed.push({
                partId: row.dataset.partId,
                quantity: parseInt(row.dataset.quantity),
                delivered: row.dataset.delivered !== 'false'
            });
        });

        const leadTechnician = document.getElementById('wo-lead-technician-select').value;
        const supportTechnicians = [];
        document.querySelectorAll('#wo-support-technicians-list .assigned-technician-badge').forEach(badge => {
            supportTechnicians.push(badge.dataset.username);
        });

        const sourceSolicitudId = document.getElementById('source-solicitud-id-hidden').value;
        const solicitud = sourceSolicitudId ? state.solicitudes.find(s => s.fb_id === sourceSolicitudId) : null;

        const startDate = document.getElementById('wo-start-date').value;
        const startTime = document.getElementById('wo-start-time').value;
        const endDate = document.getElementById('wo-end-date').value;
        const endTime = document.getElementById('wo-end-time').value;

        let startTimeISO = null;
        if (startDate && startTime) {
            startTimeISO = new Date(`${startDate}T${startTime}`).toISOString();
        } else if (startDate) {
            startTimeISO = new Date(startDate).toISOString();
        }

        let endTimeISO = null;
        if (endDate && endTime) {
            endTimeISO = new Date(`${endDate}T${endTime}`).toISOString();
        } else if (endDate) {
            endTimeISO = new Date(endDate).toISOString();
        }

        if (startTimeISO && endTimeISO && new Date(endTimeISO) <= new Date(startTimeISO)) {
            showToast('La fecha/hora final debe ser posterior a la fecha/hora de inicio.', 'error');
            showLoading(false);
            return;
        }

        const linkedPlanId = document.getElementById('wo-work-plan').value || null;

        // Final validation to prevent duplicate plan assignments in the same month
        if (linkedPlanId && startDate) {
            const targetDate = new Date(startDate + 'T12:00:00Z');
            const targetMonth = targetDate.getUTCMonth();
            const targetYear = targetDate.getUTCFullYear();

            const conflictingOrder = state.workOrders.find(wo => {
                // Exclude the current work order from the check
                if (fbId && wo.fb_id === fbId) return false;

                if (!wo.linkedPlanId || wo.linkedPlanId !== linkedPlanId || !wo.date) return false;

                const woDate = new Date(wo.date + 'T12:00:00Z');
                return woDate.getUTCMonth() === targetMonth && woDate.getUTCFullYear() === targetYear;
            });

            if (conflictingOrder) {
                showToast(`Error: Este plan ya est치 asignado a la orden ${conflictingOrder.id} en este mes.`, 'error');
                showLoading(false);
                return;
            }
        }

        const existingOrder = isNew ? {} : state.workOrders.find(wo => wo.fb_id === fbId) || {};

        const formData = {
            id: isNew ? '' : orderId,
            machineId: document.getElementById('wo-machine').value,
            description: document.getElementById('wo-description').value,
            observaciones: document.getElementById('wo-observaciones').value || "",
            status: document.getElementById('wo-status').value,
            type: document.getElementById('wo-type').value,
            date: startDate, // Main date for calendar
            startTime: startTimeISO,
            endTime: endTimeISO,
            requester: document.getElementById('wo-requester').value,
            leadTechnician: leadTechnician,
            supportTechnicians: supportTechnicians,
            technicians: [...new Set([leadTechnician, ...supportTechnicians].filter(Boolean))],
            partsUsed: partsUsed,
            failureType: document.getElementById('wo-type').value === 'Correctivo' 
                ? document.getElementById('wo-failure-type').value 
                : null,
            maintenanceType: document.getElementById('wo-type').value === 'Preventivo'
                ? document.getElementById('wo-maintenance-type').value
                : null,
            priority: document.getElementById('wo-priority').value || 'Media',
            solicitudId: solicitud ? solicitud.id : (existingOrder.solicitudId || null),
            sourceSolicitudId: solicitud ? solicitud.fb_id : (existingOrder.sourceSolicitudId || null),
            linkedPlanId: linkedPlanId,
        };

        if (formData.type === 'Correctivo' && !formData.failureType) {
            showToast('Para 칩rdenes correctivas, es obligatorio seleccionar un tipo de falla.', 'error');
            showLoading(false);
            return;
        }

        if (formData.type === 'Preventivo' && !formData.maintenanceType) {
            showToast('Para 칩rdenes preventivas, es obligatorio seleccionar un tipo de mantenimiento.', 'error');
            showLoading(false);
            return;
        }

        if (!formData.leadTechnician && formData.status !== 'Cancelado') {
            showToast('Debe asignar un t칠cnico responsable para guardar la orden.', 'error');
            showLoading(false);
            return;
        }
        
        const orderData = { ...existingOrder, ...formData, ...updates };

        // Ensure originalDate is preserved
        if (!orderData.originalDate && orderData.date) {
            orderData.originalDate = orderData.date;
        }

        const oldStatus = existingOrder.status;
        let newStatus = orderData.status;

        // 21 CFR Part 11: Re-autenticaci칩n para firma electr칩nica al completar/evaluar
        const isFinishing = (newStatus === 'Pendiente de Evaluaci칩n' || newStatus === 'Completado' || newStatus === 'Pendiente de Aprobaci칩n');
        if (isFinishing && oldStatus !== newStatus) {
            const confirmed = await new Promise(resolve => {
                requestSignature(() => resolve(true), () => resolve(false));
            });
            if (!confirmed) {
                showLoading(false);
                return;
            }
            showLoading(true);
        }

        // Si es de plan o viene de una solicitud y el t칠cnico intenta completar sin validaci칩n, cambiar a Pendiente de Aprobaci칩n
        const isPlanOrder = orderData.type === 'Preventivo' || orderData.linkedPlanId;
        const hasRequest = orderData.solicitudId || orderData.sourceSolicitudId;
        if (newStatus === 'Pendiente de Evaluaci칩n' && (isPlanOrder || hasRequest) && !orderData.validatedBy) {
            newStatus = 'Pendiente de Aprobaci칩n';
            orderData.status = 'Pendiente de Aprobaci칩n';
            orderData.technicianFinished = true;
            showToast('Trabajo finalizado. Pendiente de validaci칩n por el Planificador.', 'info');
        }

        // Track pause extension if paused in its original month
        if (newStatus === 'Pausado' && oldStatus !== 'Pausado') {
            const scheduledDate = new Date((orderData.originalDate || orderData.date) + 'T12:00:00');
            const now = new Date();
            if (now.getMonth() === scheduledDate.getMonth() && now.getFullYear() === scheduledDate.getFullYear()) {
                orderData.hadPauseExtension = true;
            }
        }

        // Solo generar nuevo ID si est치 iniciando por primera vez (cambio de MP a MA o no tiene ID)
        const isPlanned = !orderData.id || orderData.id.startsWith('MP');
        const isFirstStart = newStatus === 'En Proceso' && oldStatus !== 'En Proceso' && isPlanned;

        if (isFirstStart) {
            orderData.id = generateNextId('MA'); // Assign active ID

            // Filtrar repuestos sin stock al iniciar la orden
            let removedParts = [];
            let adjustedParts = [];
            const processedParts = [];

            for (const item of (orderData.partsUsed || [])) {
                const part = state.parts.find(p => p.id === item.partId);
                const stock = part ? (part.stock || 0) : 0;

                if (stock <= 0) {
                    removedParts.push(part ? part.description : item.partId);
                } else {
                    let finalQty = item.quantity;
                    if (stock < item.quantity) {
                        finalQty = stock;
                        adjustedParts.push(`${part ? part.description : item.partId} (ajustado de ${item.quantity} a ${stock})`);
                    }
                    processedParts.push({ ...item, quantity: finalQty });
                }
            }

            if (removedParts.length > 0 || adjustedParts.length > 0) {
                orderData.partsUsed = processedParts;
                let note = "\n\nNota del Sistema (Inicio de OT):";
                if (removedParts.length > 0) {
                    note += `\n- Se eliminaron por falta de stock: ${removedParts.join(', ')}.`;
                }
                if (adjustedParts.length > 0) {
                    note += `\n- Se ajust칩 cantidad por stock insuficiente: ${adjustedParts.join(', ')}.`;
                }
                orderData.observaciones = (orderData.observaciones || "") + note;
                const obsTextarea = document.getElementById('wo-observaciones');
                if (obsTextarea) obsTextarea.value = orderData.observaciones;
            }
        } else if (isNew) {
            orderData.id = generateNextId('MP'); // Assign planned ID
        }

        if (newStatus && newStatus !== oldStatus) {
            let workIntervals = orderData.workIntervals ? JSON.parse(JSON.stringify(orderData.workIntervals)) : [];
            const now = new Date();

            if (isFirstStart) {
                orderData.fechaInicioReal = now.toISOString();
                // Actualizar la fecha principal de la orden a la fecha local actual para que se mueva en el planificador
                orderData.date = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
            }

            if (newStatus === 'En Proceso') {
                 workIntervals.push({ start: now.toISOString(), end: null });
            } else if (['Pausado', 'Pendiente de Evaluaci칩n', 'Completado', 'Pendiente de Aprobaci칩n'].includes(newStatus) && oldStatus === 'En Proceso') {
                const lastInterval = workIntervals.find(i => !i.end);
                if (lastInterval) {
                    lastInterval.end = now.toISOString();
                }
            }
            orderData.workIntervals = workIntervals;

            if (newStatus === 'Pendiente de Evaluaci칩n' || newStatus === 'Completado' || newStatus === 'Pendiente de Aprobaci칩n') {
                if (!orderData.fechaFinalizacionReal) {
                    orderData.fechaFinalizacionReal = now.toISOString();
                }
                const totalMs = getActiveWorkDurationMs({ ...orderData, status: newStatus }); // Pass new status to calculate correctly
                orderData.totalWorkDurationMs = totalMs;
            }
        }

        // Stock validation only happens when trying to complete the order.
        if (orderData.status === 'Pendiente de Evaluaci칩n' || orderData.status === 'Completado' || orderData.status === 'Pendiente de Aprobaci칩n') {
            if (isNew) {
                // For a new order, all parts are new deductions.
                const newOrderForStock = { ...orderData, partsUsed: orderData.partsUsed || [] };
                await updateStockForOrder({ partsUsed: [] }, newOrderForStock);
            } else {
                // For an existing order, calculate the delta of parts used.
                await updateStockForOrder(existingOrder, orderData);
            }
        }

        let currentFbId = fbId;
        if (isNew) {
            orderData.createdAt = new Date().toISOString();
            const docRef = await addDoc(state.collections.workOrders, orderData);
            document.getElementById('wo-fb-id-hidden').value = docRef.id;
            document.getElementById('wo-id').value = orderData.id;
            currentFbId = docRef.id;
            await recordAuditLog('workOrders', orderData.id, 'CREATE', null, orderData, 'Creaci칩n OT');
        } else {
            const docRef = doc(state.collections.workOrders, fbId);
            await setDoc(docRef, orderData, { merge: true });
            const detailedAction = getWorkOrderDetailedAction(existingOrder, orderData) + (isFinishing ? ' (Firmado)' : '');
            await recordAuditLog('workOrders', orderData.id, 'UPDATE', existingOrder, orderData, detailedAction);
        }

        // --- Sincronizaci칩n con Odoo (Segundo Plano) ---
        if (state.odoo) {
            syncWorkOrderToOdoo(orderData, currentFbId).catch(err => {
                console.warn("[Odoo Background Sync] Error:", err);
            });
        }

        // If finishing the order, also finish any linked plan execution
        if (orderData.status === 'Pendiente de Evaluaci칩n' || orderData.status === 'Completado' || orderData.status === 'Pendiente de Aprobaci칩n') {
            await completeLinkedPlanExecution(currentFbId, new Date().toISOString(), orderData.status);
        }
        
        if (sourceSolicitudId) {
            const solicitud = state.solicitudes.find(s => s.fb_id === sourceSolicitudId);
            if (solicitud) {
                const solUpdates = {
                    workOrderId: orderData.id,
                    workOrderFbId: currentFbId
                };
                // Solo cambiar estado a Aprobado si estaba Pendiente
                if (solicitud.status === 'Pendiente') {
                    solUpdates.status = 'Aprobado';
                }
                await updateDoc(doc(state.collections.solicitudes, sourceSolicitudId), solUpdates);
            }
        }

        showToast('Orden de trabajo guardada.', 'success');
        state.modals.workOrder.hide();

    } catch (error) {
        console.error("Error saving work order:", error);
        showToast(error.message || 'Error al guardar la orden de trabajo.', 'error');
    } finally {
        showLoading(false);
    }
}

function populateWorkPlanSelector(machineId, workOrderDate, currentPlanId = null) {
    const planSelect = document.getElementById('wo-work-plan');
    if (!planSelect) return;

    planSelect.innerHTML = '<option value="">No vincular ning칰n plan</option>';

    if (!machineId || !workOrderDate) {
        return; // No machine or date selected yet
    }

    const plansForMachine = state.workPlans.filter(p => p.machineId === machineId);

    const targetMonthYear = workOrderDate.substring(0, 7); // YYYY-MM format

    const usedPlanIds = new Set(
        state.workOrders
            .filter(wo => {
                // Ensure the work order has a linked plan and a date that starts with the same YYYY-MM string.
                return wo.linkedPlanId && wo.date && wo.date.startsWith(targetMonthYear);
            })
            .map(wo => wo.linkedPlanId)
    );

    plansForMachine.forEach(plan => {
        // The plan is available if it's not used OR if it's the plan currently linked to the order being edited.
        if (!usedPlanIds.has(plan.fb_id) || plan.fb_id === currentPlanId) {
            const option = document.createElement('option');
            option.value = plan.fb_id;
            option.textContent = plan.name;
            planSelect.appendChild(option);
        }
    });
}


async function showWorkOrderModal(identifier = null, type = 'Preventivo', sourceSolicitud = null) {
    const form = document.getElementById('work-order-form');
    form.reset();
    document.getElementById('wo-fb-id-hidden').value = '';
    document.getElementById('wo-parts-list').innerHTML = '';
    document.getElementById('wo-support-technicians-list').innerHTML = '';
    document.getElementById('source-solicitud-id-hidden').value = '';

    // Hide checklist and show observations by default
    document.getElementById('wo-checklist-group').classList.add('d-none');
    document.getElementById('wo-observaciones-group').classList.remove('d-none');

    document.getElementById('wo-start-date').value = '';
    document.getElementById('wo-start-time').value = '';
    document.getElementById('wo-end-date').value = '';
    document.getElementById('wo-end-time').value = '';

    const idInput = document.getElementById('wo-id');
    const saveBtn = document.getElementById('wo-save-btn');
    const addPartBtn = document.getElementById('wo-add-part-btn');
    const addSupportTechBtn = document.getElementById('wo-add-support-technician-btn');
    
    const allFields = document.querySelectorAll('#work-order-form input, #work-order-form select, #work-order-form textarea');
    allFields.forEach(field => field.disabled = false);
    saveBtn.style.display = 'inline-block';
    addPartBtn.disabled = false;
    addSupportTechBtn.disabled = false;
    const startPlanBtnStatic = document.getElementById('wo-start-plan-btn');
    if (startPlanBtnStatic) startPlanBtnStatic.disabled = false;
    
    const leadTechSelect = document.getElementById('wo-lead-technician-select');
    const supportTechSelect = document.getElementById('wo-support-technician-select');
    leadTechSelect.innerHTML = '<option value="">Seleccione responsable...</option>';
    supportTechSelect.innerHTML = '<option value="">Seleccione apoyo...</option>';
    state.technicians.forEach(t => {
        if(t.role === 'T칠cnico') {
            leadTechSelect.innerHTML += `<option value="${t.username}">${t.username}</option>`;
            supportTechSelect.innerHTML += `<option value="${t.username}">${t.username}</option>`;
        }
    });

    const partSelect = document.getElementById('wo-part-select');
    partSelect.innerHTML = '<option value="">Seleccione repuesto...</option>';
    state.parts.forEach(p => partSelect.innerHTML += `<option value="${p.id}">${p.description} (Stock: ${p.stock})</option>`);
    
    const statusSelect = document.getElementById('wo-status');
    statusSelect.innerHTML = ['Pendiente', 'En Proceso', 'Pausado', 'Pendiente de Aprobaci칩n', 'Pendiente de Evaluaci칩n', 'Completado', 'Cancelado'].map(s => `<option>${s}</option>`).join('');
    
    let order = null;
    if (identifier) {
        order = state.workOrders.find(o => o.fb_id === identifier || o.id === identifier);
        const expiredText = order?.isExpired ? ' <span class="badge bg-dark text-white ms-2" style="font-size: 0.8rem;"><i class="fas fa-hourglass-end me-1"></i>EXPIRADA</span>' : '';
        document.getElementById('work-order-modal-title').innerHTML = `Detalles de OT: ${order ? (order.id || 'Pendiente') : 'Nueva'}${expiredText}`;
        idInput.readOnly = true;
        if (order) {
            populateWorkOrderMachineSelector();
            document.getElementById('work-order-id-hidden').value = order.id;
            document.getElementById('wo-fb-id-hidden').value = order.fb_id;
            idInput.value = order.id || 'ID pendiente';
            document.getElementById('wo-machine').value = order.machineId;

            const machine = state.machines.find(m => m.id === order.machineId);
            if (machine) {
                document.getElementById('wo-machine-search').value = machine.name;
            }

            document.getElementById('wo-description').value = order.description;
            document.getElementById('wo-observaciones').value = order.observaciones || "";
            document.getElementById('wo-status').value = order.status;
            document.getElementById('wo-type').value = order.type;
            document.getElementById('wo-priority').value = order.priority || 'Media';
            
            const plannedStartTime = order.startTime ? new Date(order.startTime) : (order.date ? new Date(order.date) : null);
            if (plannedStartTime) {
                document.getElementById('wo-start-date').value = plannedStartTime.toISOString().split('T')[0];
                document.getElementById('wo-start-time').value = plannedStartTime.toTimeString().split(' ')[0].substring(0, 5);
            }

            if (order.endTime) {
                const endDate = new Date(order.endTime);
                document.getElementById('wo-end-date').value = endDate.toISOString().split('T')[0];
                document.getElementById('wo-end-time').value = endDate.toTimeString().split(' ')[0].substring(0, 5);
            }

            // Prioritize real dates for display if they exist
            const realStartTimestamp = order.fechaInicioReal ?? order.start;
            if (realStartTimestamp) {
                const realStartDate = new Date(realStartTimestamp);
                document.getElementById('wo-start-date').value = realStartDate.toISOString().split('T')[0];
                document.getElementById('wo-start-time').value = realStartDate.toTimeString().split(' ')[0].substring(0, 5);
                 document.getElementById('wo-real-start-date').value = realStartDate.toISOString().split('T')[0];
                 document.getElementById('wo-real-start-time').value = realStartDate.toTimeString().split(' ')[0].substring(0, 5);
            }

            const realEndTimestamp = order.fechaFinalizacionReal ?? order.end;
            if (realEndTimestamp) {
                const realEndDate = new Date(realEndTimestamp);
                document.getElementById('wo-end-date').value = realEndDate.toISOString().split('T')[0];
                document.getElementById('wo-end-time').value = realEndDate.toTimeString().split(' ')[0].substring(0, 5);
                 document.getElementById('wo-real-end-date').value = realEndDate.toISOString().split('T')[0];
                 document.getElementById('wo-real-end-time').value = realEndDate.toTimeString().split(' ')[0].substring(0, 5);
            }

            const durationMs = order.totalWorkDurationMs || getActiveWorkDurationMs(order);
            if (durationMs > 0) {
                const hours = Math.floor(durationMs / (1000 * 60 * 60));
                const minutes = Math.floor((durationMs % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((durationMs % (1000 * 60)) / 1000);
                document.getElementById('wo-total-duration').value = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            } else {
                document.getElementById('wo-total-duration').value = '00:00:00';
            }
            
            const solicitudRef = (order.solicitudId || order.sourceSolicitudId) ? state.solicitudes.find(s => s.id === (order.solicitudId || order.sourceSolicitudId) || s.fb_id === (order.solicitudId || order.sourceSolicitudId)) : null;
            const requesterLabel = document.querySelector('label[for="wo-requester"]');
            if (requesterLabel) {
                requesterLabel.innerHTML = solicitudRef ? `Solicitante <small class="text-info fw-bold">(Solicitud: ${solicitudRef.id})</small>` : 'Solicitante';
            }
            if (solicitudRef) {
                document.getElementById('source-solicitud-id-hidden').value = solicitudRef.fb_id;
            }
            document.getElementById('wo-requester').value = order.requester;
            document.getElementById('wo-failure-type').value = order.failureType || '';
            document.getElementById('wo-maintenance-type').value = order.maintenanceType || '';
            
            const lead = order.leadTechnician || (order.technicians && order.technicians[0]) || '';
            const support = order.supportTechnicians || (order.technicians && order.technicians.slice(1)) || [];
            
            leadTechSelect.value = lead;
            support.forEach(techUsername => addSupportTechnicianToWorkOrderUI(techUsername));

            if(order.partsUsed) {
                order.partsUsed.forEach(part => addPartToWorkOrder(part.partId, part.quantity, true, part.delivered));
            }
            renderWoPendingRequests();

            // Populate and set the work plan selector
            const initialDate = document.getElementById('wo-start-date').value;
            populateWorkPlanSelector(order.machineId, initialDate, order.linkedPlanId);
            if (order.linkedPlanId) {
                document.getElementById('wo-work-plan').value = order.linkedPlanId;
            }

            // If the work order is linked to a plan, show the plan info and "Start Plan" button
            if (order.linkedPlanId) {
                const plan = state.workPlans.find(p => p.fb_id === order.linkedPlanId);
                if (plan) {
                    document.getElementById('wo-observaciones-group').classList.add('d-none');
                    const checklistGroup = document.getElementById('wo-checklist-group');
                    checklistGroup.classList.remove('d-none');

                    document.getElementById('wo-plan-name').textContent = plan.name;
                    const startPlanBtn = document.getElementById('wo-start-plan-btn');

                    // Update button text if there is already an execution
                    const existingExecution = state.workPlanExecutions.find(e => e.workOrderFbId === order.fb_id);
                    if (existingExecution) {
                        startPlanBtn.innerHTML = '<i class="fas fa-play me-2"></i>Continuar Plan';
                    } else {
                        startPlanBtn.innerHTML = '<i class="fas fa-play me-2"></i>Iniciar Plan';
                    }

                    // Clone and replace the button to remove any old event listeners
                    const newBtn = startPlanBtn.cloneNode(true);
                    startPlanBtn.parentNode.replaceChild(newBtn, startPlanBtn);

                    // Add the new event listener that calls the execution logic
                    newBtn.addEventListener('click', () => {
                        handleStartLinkedPlan(order, plan);
                    });
                }
            }
        }
    } else {
        populateWorkOrderMachineSelector();
        populateWorkPlanSelector(null, null); // Clear it for new orders
        document.getElementById('work-order-modal-title').textContent = sourceSolicitud ? `Nueva OT desde Solicitud` : `Nueva Orden ${type}`;
        document.getElementById('work-order-id-hidden').value = '';
        idInput.value = 'ID pendiente';
        idInput.readOnly = true;
        document.getElementById('wo-type').value = type;
        document.getElementById('wo-priority').value = 'Media';
        document.getElementById('wo-start-date').value = new Date().toISOString().split('T')[0];
        const requesterLabel = document.querySelector('label[for="wo-requester"]');
        if (requesterLabel) {
            requesterLabel.innerHTML = sourceSolicitud ? `Solicitante <small class="text-info fw-bold">(Solicitud: ${sourceSolicitud.id})</small>` : 'Solicitante';
        }
        document.getElementById('wo-requester').value = sourceSolicitud ? sourceSolicitud.requester : state.currentUser.username;
        document.getElementById('wo-status').value = 'Pendiente';

        if (sourceSolicitud) {
            const isFromMonitoring = typeof sourceSolicitud === 'string';

            if (isFromMonitoring) {
                document.getElementById('wo-machine').value = sourceSolicitud;
                const machine = state.machines.find(m => m.id === sourceSolicitud);
                if (machine) {
                    document.getElementById('wo-machine-search').value = machine.name;
                }
            } else {
                document.getElementById('source-solicitud-id-hidden').value = sourceSolicitud.fb_id;
                document.getElementById('wo-machine').value = sourceSolicitud.machineId;
                document.getElementById('wo-description').value = sourceSolicitud.description;

                const machine = state.machines.find(m => m.id === sourceSolicitud.machineId);
                if (machine) {
                    document.getElementById('wo-machine-search').value = machine.name;
                }
            }

            if (state.currentUser?.role === 'T칠cnico') {
                leadTechSelect.value = state.currentUser.username;
                leadTechSelect.disabled = true;
                addSupportTechBtn.disabled = true;
                document.getElementById('wo-status').value = 'En Proceso';
            }
        }
    }
    
    const userRole = state.currentUser?.role;
    const isLeadTechnician = order ? state.currentUser.username === order.leadTechnician : false;
    const canControl = userRole === 'Admin' || userRole === 'Planificador' || isLeadTechnician || !identifier;
    const canExecute = userRole === 'Admin' || isLeadTechnician;

    // An order is read-only if it's finished, cancelled or expired
    const isFinished = order?.status === 'Completado' || order?.status === 'Cancelado' || order?.status === 'Rechazado' || order?.status === 'Pendiente de Evaluaci칩n' || order?.status === 'Pendiente de Aprobaci칩n' || order?.isExpired;

    if (!canControl || state.currentUser.role === 'Invitado' || isFinished) {
        allFields.forEach(field => field.disabled = true);
        saveBtn.style.display = 'none';
        addPartBtn.disabled = true;
        addSupportTechBtn.disabled = true;
        document.querySelectorAll('#wo-parts-list button, #wo-support-technicians-list button').forEach(btn => btn.disabled = true);
    }

    // Restringir bot칩n de inicio de plan a Admin o T칠cnico L칤der
    const startPlanBtn = document.getElementById('wo-start-plan-btn');
    if (startPlanBtn) {
        startPlanBtn.disabled = !canExecute || isFinished;
    }

    const machineSelector = document.getElementById('wo-machine');
    const dateSelector = document.getElementById('wo-start-date');

    // Remove any existing listeners to prevent duplicates
    const selectedMachineId = machineSelector.value; // Store the current value
    const newMachineSelector = machineSelector.cloneNode(true);
    machineSelector.parentNode.replaceChild(newMachineSelector, machineSelector);
    newMachineSelector.value = selectedMachineId; // Restore the value

    const newDateSelector = dateSelector.cloneNode(true);
    dateSelector.parentNode.replaceChild(newDateSelector, dateSelector);

    const updatePlansListener = () => {
        const machineId = newMachineSelector.value;
        const date = newDateSelector.value;
        const currentPlanId = order ? order.linkedPlanId : null;
        populateWorkPlanSelector(machineId, date, currentPlanId);
    };

    newMachineSelector.addEventListener('change', updatePlansListener);
    newDateSelector.addEventListener('change', updatePlansListener);

    handleWorkOrderTypeChange();
    updateWorkOrderModalButtons(order ? order.status : 'Pendiente');
    state.modals.workOrder.show();
}

function handleWorkOrderTypeChange() {
    const type = document.getElementById('wo-type').value;
    const failureGroup = document.getElementById('wo-failure-type-group');
    const maintenanceGroup = document.getElementById('wo-maintenance-type-group');
    failureGroup.classList.toggle('d-none', type !== 'Correctivo');
    maintenanceGroup.classList.toggle('d-none', type !== 'Preventivo');
}

function generateNextId(prefix) {
    const currentYear = new Date().getFullYear().toString().slice(-2);
    const fullPrefix = `${prefix}-${currentYear}-`;

    const relevantOrders = state.workOrders
        .filter(wo => wo.id && wo.id.startsWith(fullPrefix))
        .map(wo => parseInt(wo.id.split('-')[2]))
        .filter(num => !isNaN(num));

    const maxNumber = relevantOrders.length > 0 ? Math.max(...relevantOrders) : 0;
    const nextNumber = maxNumber + 1;
    const nextSequence = nextNumber.toString().padStart(4, '0');

    return fullPrefix + nextSequence;
}

function addPartToWorkOrder(partId, quantity, isInitialLoad = false, delivered = true) {
    const partSelect = document.getElementById('wo-part-select');
    const qtyInput = document.getElementById('wo-part-quantity');

    const selectedPartId = isInitialLoad ? partId : partSelect.value;
    const selectedQty = isInitialLoad ? quantity : parseInt(qtyInput.value);

    if (!selectedPartId || isNaN(selectedQty) || selectedQty < 1) return;

    const part = state.parts.find(p => p.id === selectedPartId);
    if (!part) return;

    const list = document.getElementById('wo-parts-list');
    
    if (!isInitialLoad) {
        const existingRow = list.querySelector(`[data-part-id="${selectedPartId}"]`);
        if (existingRow) {
            showToast('Este repuesto ya ha sido a침adido.', 'warning');
            return;
        }
    }

    const partRow = document.createElement('div');
    partRow.className = 'd-flex justify-content-between align-items-center border rounded p-2 mb-1';
    partRow.style.backgroundColor = 'var(--content-bg)';
    partRow.dataset.partId = part.id;
    partRow.dataset.quantity = selectedQty;
    partRow.dataset.delivered = (delivered !== false);

    let deliveredBadge = '';
    if (delivered === false) {
        deliveredBadge = '<span class="badge bg-danger me-2"><i class="fas fa-exclamation-triangle me-1"></i>No entregado (Sin stock)</span>';
        partRow.classList.add('border-danger');
        partRow.style.backgroundColor = '#fff5f5';
    }

    partRow.innerHTML = `
        <span>${part.description}</span>
        <div>
            ${deliveredBadge}
            <span class="badge bg-secondary me-2">Cant: ${selectedQty}</span>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="this.parentElement.parentElement.remove()"><i class="fas fa-times"></i></button>
        </div>
    `;
    list.appendChild(partRow);

    if (!isInitialLoad) {
        partSelect.value = '';
        qtyInput.value = 1;
    }
}

function updateWorkOrderModalButtons(status) {
    const fbId = document.getElementById('wo-fb-id-hidden').value;
    const order = state.workOrders.find(wo => wo.fb_id === fbId);

    const startBtn = document.getElementById('wo-start-btn');
    const pauseBtn = document.getElementById('wo-pause-btn');
    const resumeBtn = document.getElementById('wo-resume-btn');
    const completeBtn = document.getElementById('wo-complete-btn');
    const validateBtn = document.getElementById('wo-validate-btn');
    const rejectBtn = document.getElementById('wo-reject-btn');

    startBtn.style.display = 'none';
    pauseBtn.style.display = 'none';
    resumeBtn.style.display = 'none';
    completeBtn.style.display = 'none';
    validateBtn.style.display = 'none';
    rejectBtn.style.display = 'none';

    // If it's a new order (no order object yet), we can only decide based on the passed status.
    // The only relevant status for a new order is 'Pendiente'.
    if (!order) {
        if (status === 'Pendiente') {
            startBtn.style.display = 'inline-block';
        }
        return;
    }

    // For existing orders, check permissions.
    const isLeadTechnician = state.currentUser.username === order.leadTechnician;
    const isPlanificador = state.currentUser.role === 'Planificador' || state.currentUser.role === 'Admin';
    const isPlanOrder = order.type === 'Preventivo' || order.linkedPlanId;
    const canControl = state.currentUser.role === 'Admin' || isLeadTechnician;

    if (canControl) {
        switch (status) {
            case 'Pendiente':
                startBtn.style.display = 'inline-block';
                break;
            case 'En Proceso':
                pauseBtn.style.display = 'inline-block';
                completeBtn.style.display = 'inline-block';
                if (isPlanOrder) {
                    completeBtn.innerHTML = '<i class="fas fa-check me-2"></i>Finalizar Trabajo';
                } else {
                    completeBtn.innerHTML = '<i class="fas fa-check me-2"></i>Completar';
                }
                break;
            case 'Pausado':
                resumeBtn.style.display = 'inline-block';
                completeBtn.style.display = 'inline-block';
                if (isPlanOrder) {
                    completeBtn.innerHTML = '<i class="fas fa-check me-2"></i>Finalizar Trabajo';
                } else {
                    completeBtn.innerHTML = '<i class="fas fa-check me-2"></i>Completar';
                }
                break;
        }
    }

    if (isPlanificador) {
        const hasRequest = order.solicitudId || order.sourceSolicitudId;
        const needsValidation = (isPlanOrder || hasRequest) && !order.validatedBy;

        if (status === 'Pendiente de Aprobaci칩n' || (needsValidation && ['Pendiente de Evaluaci칩n', 'En Proceso', 'Pausado'].includes(status))) {
            validateBtn.style.display = 'inline-block';
            rejectBtn.style.display = 'inline-block';
        }
    }
}

function handleAddSupportTechnicianClick() {
    const techSelect = document.getElementById('wo-support-technician-select');
    const username = techSelect.value;
    if (!username) {
        showToast('Por favor, seleccione un t칠cnico de apoyo.', 'warning');
        return;
    }
    const leadUsername = document.getElementById('wo-lead-technician-select').value;
    if (username === leadUsername) {
        showToast('Este t칠cnico ya es el responsable de la orden.', 'warning');
        return;
    }
    addSupportTechnicianToWorkOrderUI(username);
    techSelect.value = '';
}

function addSupportTechnicianToWorkOrderUI(username) {
    const listContainer = document.getElementById('wo-support-technicians-list');
    const existing = listContainer.querySelector(`[data-username="${username}"]`);
    if (existing) {
        showToast(`El t칠cnico ${username} ya est치 en la lista de apoyo.`, 'warning');
        return;
    }

    const badge = document.createElement('span');
    badge.className = 'assigned-technician-badge';
    badge.dataset.username = username;
    badge.innerHTML = `
        ${username}
        <button type="button" class="btn-remove-tech"><i class="fas fa-times"></i></button>
    `;
    
    badge.querySelector('.btn-remove-tech').addEventListener('click', (e) => {
        e.currentTarget.closest('.assigned-technician-badge').remove();
    });

    listContainer.appendChild(badge);
}

function handleLeadTechnicianChange(e) {
    const leadUsername = e.target.value;
    if (!leadUsername) return;
    
    const supportList = document.getElementById('wo-support-technicians-list');
    const existingSupportBadge = supportList.querySelector(`[data-username="${leadUsername}"]`);
    if (existingSupportBadge) {
        existingSupportBadge.remove();
        showToast(`${leadUsername} ha sido movido a t칠cnico responsable.`, 'info');
    }
}

// --- Reports Functions ---
function generateGeneralReport() {
    showLoading(true);
    setTimeout(() => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        doc.text("Reporte General de Inventario", 14, 20);
        doc.setFontSize(10);
        doc.text(`Fecha de generaci칩n: ${new Date().toLocaleDateString('es-ES')}`, 14, 26);
        
        doc.autoTable({
            startY: 35,
            head: [['ID', 'Nombre', 'Ubicaci칩n', 'Criticidad']],
            body: state.machines.map(m => [m.id, m.name, m.location, m.criticidad || 'Baja']),
            headStyles: { fillColor: [44, 62, 80] },
            didDrawPage: (data) => {
                doc.setFontSize(16);
                doc.text("Listado de M치quinas", 14, 30);
            }
        });

        const finalY = doc.autoTable.previous.finalY;
        doc.setFontSize(16);
        doc.text("Inventario de Repuestos", 14, finalY + 20);

        doc.autoTable({
            startY: finalY + 25,
            head: [['ID', 'Descripci칩n', 'Stock', 'Costo Unitario']],
            body: state.parts.map(p => [p.id, p.description, p.stock, formatCurrency(p.cost)]),
             headStyles: { fillColor: [44, 62, 80] },
        });

        doc.save("Reporte_General_Inventario.pdf");
        showToast('Reporte generado correctamente', 'success');
        showLoading(false);
    }, 1000);
}

function generateWorkOrderReport() {
    showLoading(true);
    setTimeout(() => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        doc.text("Historial de 칍rdenes de Trabajo", 14, 20);
        doc.setFontSize(10);
        doc.text(`Fecha de generaci칩n: ${new Date().toLocaleDateString('es-ES')}`, 14, 26);

        const body = state.workOrders.map(o => {
            const machine = state.machines.find(m => m.id === o.machineId) || { name: 'N/A' };
            return [
                o.id,
                o.type,
                machine.name,
                o.status,
                new Date(o.date).toLocaleDateString('es-ES'),
                o.leadTechnician || 'N/A',
                o.supportTechnicians?.join(', ') || ''
            ];
        });

        doc.autoTable({
            startY: 35,
            head: [['ID', 'Tipo', 'M치quina', 'Estado', 'Fecha', 'Responsable', 'Apoyo']],
            body: body,
            headStyles: { fillColor: [44, 62, 80] },
            columnStyles: {
                2: { cellWidth: 40 }, 
                6: { cellWidth: 'auto'}
            }
        });

        doc.save("Reporte_Ordenes_de_Trabajo.pdf");
        showToast('Reporte generado correctamente', 'success');
        showLoading(false);
    }, 1000);
}

async function generateMachineReport() {
    const machineId = document.getElementById('report-machine-select').value;
    if (!machineId) {
        showToast('Seleccione una m치quina para generar el reporte', 'warning');
        return;
    }
    
    showLoading(true);

    try {
        const machine = state.machines.find(m => m.id === machineId);
        if (!machine) {
            showToast('M치quina no encontrada.', 'error');
            showLoading(false);
            return;
        }
        const machineWorkOrders = state.workOrders.filter(o => o.machineId === machineId);

        // --- KPI Calculations ---
        const correctiveOrdersForKpi = machineWorkOrders
            .filter(o => o.type === 'Correctivo')
            .sort((a, b) => new Date(a.createdAt || a.date) - new Date(b.createdAt || b.date));
        
        let mtbf = 'N/A';
        // MTBF actualizado: (Tiempo total desde creaci칩n hasta hoy) / (Fallas + 1)
        let startDate = machine.createdAt ? new Date(machine.createdAt) : null;
        if (!startDate && machineWorkOrders.length > 0) {
            const sortedAll = [...machineWorkOrders].sort((a, b) => new Date(a.createdAt || a.date) - new Date(b.createdAt || b.date));
            startDate = new Date(sortedAll[0].createdAt || sortedAll[0].date);
        }

        if (startDate) {
            const now = new Date();
            const totalTimeMs = Math.max(0, now - startDate);
            const mtbfMs = totalTimeMs / (correctiveOrdersForKpi.length + 1);
            mtbf = `${parseFloat((mtbfMs / (1000 * 60 * 60 * 24)).toFixed(2))} d칤as`;
        }

        let mttr = 'N/A';
        const repairOrdersForKpi = correctiveOrdersForKpi.filter(o => o.status === 'Completado');
        if (repairOrdersForKpi.length > 0) {
            const totalRepairTimeMs = repairOrdersForKpi.reduce((sum, o) => sum + getTotalWorkDurationMs(o), 0);
            const mttrMs = totalRepairTimeMs / repairOrdersForKpi.length;
            mttr = `${parseFloat((mttrMs / (1000 * 60 * 60)).toFixed(2))} horas`;
        }

        // --- Chart Generation ---
        const chartContainer = document.createElement('div');
        chartContainer.style.position = 'absolute';
        chartContainer.style.left = '-9999px';
        chartContainer.style.width = '1000px';
        chartContainer.style.height = '400px';
        document.body.appendChild(chartContainer);

        const effectivenessCanvas = document.createElement('canvas');
        effectivenessCanvas.width = 300; effectivenessCanvas.height = 300;
        const failureTrendCanvas = document.createElement('canvas');
        failureTrendCanvas.width = 450; failureTrendCanvas.height = 300;
        chartContainer.appendChild(effectivenessCanvas);
        chartContainer.appendChild(failureTrendCanvas);

        const preventiveCount = machineWorkOrders.filter(o => o.type === 'Preventivo').length;
        const correctiveCount = machineWorkOrders.filter(o => o.type === 'Correctivo').length;

        const effectivenessChartPromise = new Promise((resolve) => {
             new Chart(effectivenessCanvas, {
                type: 'doughnut',
                data: {
                    labels: ['Preventivos', 'Correctivos'],
                    datasets: [{
                        data: [preventiveCount, correctiveCount],
                        backgroundColor: ['#3498db', '#e74c3c']
                    }]
                },
                options: {
                    responsive: false,
                    animation: { onComplete: () => resolve(effectivenessCanvas.toDataURL('image/png')) },
                    plugins: {
                        legend: { position: 'right' },
                        title: { display: true, text: 'Efectividad de Mantenimientos', font: { size: 14 } }
                    }
                }
            });
        });

        const failureTypes = ['Mec치nica', 'El칠ctrica', 'Electr칩nica', 'Falla de Operaci칩n'];
        const failureCounts = failureTypes.map(type => 
            correctiveOrdersForKpi.filter(o => o.failureType === type).length
        );
        
        const failureTrendChartPromise = new Promise((resolve) => {
            new Chart(failureTrendCanvas, {
                type: 'bar',
                data: {
                    labels: failureTypes,
                    datasets: [{
                        label: 'Cantidad de Fallas',
                        data: failureCounts,
                        backgroundColor: '#8e44ad',
                    }]
                },
                options: {
                    responsive: false,
                    animation: { onComplete: () => resolve(failureTrendCanvas.toDataURL('image/png')) },
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: 'Tendencia de Fallas Comunes', font: { size: 14 } }
                    },
                     scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                }
            });
        });
        
        const [effectivenessChartImg, failureTrendChartImg] = await Promise.all([effectivenessChartPromise, failureTrendChartPromise]);

        // --- PDF Generation ---
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        doc.setFontSize(18);
        doc.text(`Reporte Hist칩rico de M치quina: ${machine.name}`, 14, 22);
        doc.setFontSize(12);
        doc.text(`ID: ${machine.id} | Ubicaci칩n: ${machine.location} | Criticidad: ${machine.criticidad || 'Baja'}`, 14, 30);
        
        // Add charts side-by-side
        doc.addImage(effectivenessChartImg, 'PNG', 14, 40, 70, 70);
        doc.addImage(failureTrendChartImg, 'PNG', 100, 40, 95, 60);

        const workOrderBody = machineWorkOrders.map(o => [
            o.id, o.type, o.type === 'Correctivo' ? o.failureType || 'N/A' : 'N/A',
            o.status, new Date(o.date).toLocaleDateString('es-ES'), o.description
        ]);
        
        doc.autoTable({
            startY: 115,
            head: [['ID Orden', 'Tipo', 'Tipo Falla', 'Estado', 'Fecha', 'Descripci칩n']],
            body: workOrderBody,
            headStyles: { fillColor: [44, 62, 80] },
            columnStyles: { 5: { cellWidth: 'auto' } }
        });

        let finalY = doc.autoTable.previous.finalY;

        // --- KPIs, Availability, and Costs ---
        doc.addPage();
        doc.setFontSize(16);
        doc.text('An치lisis Detallado', 14, 22);

        // KPI Table
        doc.setFontSize(12);
        doc.text('Indicadores Clave (Mantenimiento Correctivo)', 14, 32);
        doc.autoTable({
            startY: 35,
            body: [
                ['Tiempo Medio Entre Fallos (MTBF):', mtbf],
                ['Tiempo Medio de Reparaci칩n (MTTR):', mttr],
            ],
            theme: 'plain',
            styles: { fontSize: 10 }
        });
        finalY = doc.autoTable.previous.finalY;

        // Availability Table
        const availabilityBody = [];
        const processedDates = new Set();
        const completedCorrectives = machineWorkOrders.filter(o => o.type === 'Correctivo' && o.status === 'Completado' && o.date);
        
        completedCorrectives.forEach(o => {
            if (processedDates.has(o.date)) return;
            
            const dayDate = new Date(o.date + 'T12:00:00Z');
            const startDate = new Date(Date.UTC(dayDate.getUTCFullYear(), dayDate.getUTCMonth(), dayDate.getUTCDate(), 0, 0, 0));
            const endDate = new Date(Date.UTC(dayDate.getUTCFullYear(), dayDate.getUTCMonth(), dayDate.getUTCDate(), 23, 59, 59));
            const scheduledUptimeMs = calculateScheduledUptimeMs([machine], startDate, endDate);
            
            const downtimeOrdersThisDay = completedCorrectives.filter(wo => wo.date === o.date);
            const totalDowntimeMs = downtimeOrdersThisDay.reduce((sum, wo) => sum + getTotalWorkDurationMs(wo), 0);

            let availabilityText = 'N/A';
            if (scheduledUptimeMs > 0) {
                const availability = ((scheduledUptimeMs - totalDowntimeMs) / scheduledUptimeMs) * 100;
                availabilityText = `${Math.max(0, availability).toFixed(2)}%`;
            }
            availabilityBody.push([new Date(o.date + 'T12:00:00Z').toLocaleDateString('es-ES'), availabilityText]);
            processedDates.add(o.date);
        });

        if (availabilityBody.length > 0) {
            doc.text('An치lisis de Disponibilidad por D칤a de Falla Correctiva', 14, finalY + 10);
            doc.autoTable({
                startY: finalY + 13,
                head: [['Fecha de Reparaci칩n', 'Disponibilidad del D칤a']],
                body: availabilityBody,
                headStyles: { fillColor: [44, 62, 80] },
            });
            finalY = doc.autoTable.previous.finalY;
        }

        // Cost Table
        const f = new Intl.NumberFormat('es-HN', { style: 'currency', currency: 'HNL' });
        const completedOrders = machineWorkOrders.filter(o => o.status === 'Completado');
        const costBody = completedOrders.map(order => {
            const { partsCost, laborCost, totalCost } = calculateTotalCost(order, true);
            return [order.id, f.format(partsCost), f.format(laborCost), f.format(totalCost)];
        });

        if (costBody.length > 0) {
             doc.text('An치lisis de Costos por Orden de Trabajo', 14, finalY + 10);
            doc.autoTable({
                startY: finalY + 13,
                head: [['ID Orden', 'Costo Repuestos', 'Costo Mano de Obra', 'Costo Total']],
                body: costBody,
                headStyles: { fillColor: [44, 62, 80] },
            });
            finalY = doc.autoTable.previous.finalY;
        }
        
        const { totalCost: grandTotalCost } = calculateTotalCostForMultiple(completedOrders);
        doc.setFontSize(12);
        doc.setFont(undefined, 'bold');
        doc.text(`Costo Total de Mantenimiento para esta M치quina: ${f.format(grandTotalCost)}`, 14, finalY + 15);

        doc.save(`Reporte_Maquina_${machine.id}.pdf`);
        
        // Cleanup
        document.body.removeChild(chartContainer);
        showToast(`Reporte de ${machine.name} generado`, 'success');

    } catch (error) {
        console.error("Error generating machine report:", error);
        showToast('Error al generar el reporte de m치quina', 'error');
    } finally {
        showLoading(false);
    }
}

function generateMachinePartsReport() {
    const machineId = document.getElementById('report-machine-parts-select').value;
    if (!machineId) {
        showToast('Seleccione una m치quina para generar el reporte', 'warning');
        return;
    }
    showLoading(true);

    setTimeout(() => {
        try {
            const machine = state.machines.find(m => m.id === machineId);
            if (!machine) {
                throw new Error("M치quina no encontrada.");
            }
            const partsForMachine = state.parts.filter(p => (p.machineIds && p.machineIds.includes(machineId)) || p.machineId === machineId);

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.text(`Reporte de Repuestos para: ${machine.name} (${machine.id})`, 14, 20);
            doc.setFontSize(10);
            doc.text(`Fecha de generaci칩n: ${new Date().toLocaleDateString('es-ES')}`, 14, 26);

            const body = partsForMachine.map(p => [
                p.id,
                p.description,
                p.stock,
                p.minStock,
                p.location || 'N/A'
            ]);

            doc.autoTable({
                startY: 35,
                head: [['ID Repuesto', 'Descripci칩n', 'Stock Actual', 'Stock M칤nimo', 'Ubicaci칩n']],
                body: body,
                headStyles: { fillColor: [44, 62, 80] },
            });

            doc.save(`Reporte_Repuestos_${machine.id}.pdf`);
            showToast('Reporte de repuestos generado correctamente', 'success');
        } catch (error) {
            console.error("Error generating parts report:", error);
            showToast('Error al generar el reporte de repuestos.', 'error');
        } finally {
            showLoading(false);
        }
    }, 500);
}

function generateSingleWorkOrderReport() {
    const headerConfig = {
        line1Left: 'Fecha de elaboraci칩n: 27/01/2026',
        line2Left: 'Fecha de revisi칩n: 03/02/2026',
        line3Left: 'Fecha de aprobaci칩n: 05/02/2026',
        line1Center: 'C칩digo: FO-MNDO-001',
        line2Center: 'Versi칩n : 7.0',
        line1Right: 'SISTEMA DE GESTI칍N DE CALIDAD',
        logoBase64: "data:image/png;base64,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"
    };
    const workOrderId = document.getElementById('report-wo-select').value;
    if (!workOrderId) {
        showToast('Seleccione una orden de trabajo para imprimir', 'warning');
        return;
    }
    
    showLoading(true);
    
    const order = state.workOrders.find(o => o.id === workOrderId);
    if (!order) {
        showToast('Orden de trabajo no encontrada.', 'error');
        showLoading(false);
        return;
    }

    const machine = state.machines.find(m => m.id === order.machineId) || { name: 'N/A', id: 'N/A' };

    setTimeout(() => { // Use timeout to allow loading spinner to show
        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'pt', 'letter');

            // --- Helper Functions ---

            const drawFooter = () => {
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setFont(undefined, 'normal');
                    const footerY = doc.internal.pageSize.getHeight() - 20;
                    doc.text('FO-MNDO-001 Orden de trabajo de mantenimiento', margin, footerY);
                    doc.text(`Copia Controlada P치gina  ${i} de ${pageCount}`, pageWidth - margin, footerY, { align: 'right' });
                }
            };

            const drawHeader = () => {
                const pageWidth = doc.internal.pageSize.getWidth();
                const margin = 40;
                const headerY = 30;
                const headerHeight = 60;
                const contentWidth = pageWidth - (margin * 2);
                const colWidth = contentWidth / 3;

                doc.setFontSize(9);
                doc.setFont(undefined, 'normal');

                // Column 1
                doc.text(headerConfig.line1Left, margin, headerY + 15);
                doc.text(headerConfig.line2Left, margin, headerY + 30);
                doc.text(headerConfig.line3Left, margin, headerY + 45);

                // Column 2
                doc.text(headerConfig.line1Center, margin + colWidth, headerY + 15);
                doc.text(headerConfig.line2Center, margin + colWidth, headerY + 30);

                // Column 3
                doc.text(headerConfig.line1Right, margin + colWidth * 2, headerY + 15);

                // Logo
                if (headerConfig.logoBase64) {
                    try {
                        const logoW = 80;
                        const logoH = 25;
                        const textWidth = doc.getTextWidth(headerConfig.line1Right);
                        const logoX = margin + colWidth * 2 + textWidth - logoW;
                        doc.addImage(headerConfig.logoBase64, 'PNG', logoX, headerY + 25, logoW, logoH);
                    } catch (err) {
                        console.error("Error adding logo to PDF:", err);
                    }
                }

                // Main Title
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('Orden de Trabajo de Mantenimiento', pageWidth / 2, headerY + headerHeight + 20, { align: 'center' });

                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
            };

            const drawBoxWithValue = (x, y, w, h, label, value) => {
                doc.setLineWidth(0.5);
                doc.rect(x, y, w, h);
                doc.setFontSize(8);
                doc.text(label, x + 3, y + 10);
                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');
                doc.text(value || 'N/A', x + 3, y + 25);
                doc.setFont(undefined, 'normal');
            };

            // --- Document Body ---
            const pageWidth = doc.internal.pageSize.getWidth();
            const margin = 40;
            const contentWidth = pageWidth - (margin * 2);

            drawHeader();
            
            drawBoxWithValue(margin, 120, contentWidth * 0.4, 30, 'C칩digo M치quina', machine.id);
            drawBoxWithValue(margin + contentWidth * 0.4 + 10, 120, contentWidth * 0.6 - 10, 30, 'M치quina', `${machine.name} - Departamento: ${machine.location || 'N/A'}`);
            
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text(`N칰mero de Orden: ${order.id} - Prioridad ${machine.criticidad || 'N/A'}`, margin, 175);

            drawBoxWithValue(margin, 190, contentWidth / 2 - 5, 30, 'Clase de Mantenimiento', order.type);
            drawBoxWithValue(margin + contentWidth / 2 + 5, 190, contentWidth / 2 - 5, 30, 'Tipo de Falla', order.failureType || 'N/A');

            const requestDate = order.createdAt ? new Date(order.createdAt).toLocaleDateString('es-ES') : 'N/A';
            const solicitudRef = (order.solicitudId || order.sourceSolicitudId) ? state.solicitudes.find(s => s.id === (order.solicitudId || order.sourceSolicitudId) || s.fb_id === (order.solicitudId || order.sourceSolicitudId)) : null;
            const humanSolicitudId = solicitudRef ? solicitudRef.id : order.solicitudId;
            const requesterDisplay = humanSolicitudId ? `${order.requester || 'N/A'} (Solicitud: ${humanSolicitudId})` : (order.requester || 'N/A');
            drawBoxWithValue(margin, 230, contentWidth / 2 - 5, 30, 'Solicitado por:', requesterDisplay);
            drawBoxWithValue(margin + contentWidth / 2 + 5, 230, contentWidth / 2 - 5, 30, 'Fecha de Solicitud:', requestDate);

            // Dynamic Description Box
            const descText = order.description || 'N/A';
            const descLines = doc.splitTextToSize(descText, contentWidth - 10);
            const descBoxHeight = Math.max(40, (descLines.length * 12) + 25);
            doc.rect(margin, 270, contentWidth, descBoxHeight);
            doc.setFontSize(8);
            doc.text('Descripci칩n de la actividad solicitada:', margin + 3, 280);
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(descLines, margin + 5, 295);
            
            let currentY = 270 + descBoxHeight + 10;

            const startTimestamp = order.fechaInicioReal || order.startTime;
            const startDate = startTimestamp ? new Date(startTimestamp).toLocaleDateString('es-ES') : (order.date || 'N/A');
            const startTime = startTimestamp ? new Date(startTimestamp).toLocaleTimeString('es-ES', {hour: '2-digit', minute:'2-digit'}) : 'N/A';
            drawBoxWithValue(margin, currentY, contentWidth / 2 - 5, 30, 'Asignado a:', order.leadTechnician || 'N/A');
            drawBoxWithValue(margin + contentWidth / 2 + 5, currentY, contentWidth / 2 - 5, 30, 'Fecha de Inicio:', startDate);
            
            currentY += 40;
            const collaborators = order.supportTechnicians ? order.supportTechnicians.join(', ') : 'N/A';
            drawBoxWithValue(margin, currentY, contentWidth / 2 - 5, 30, 'Colaboradores:', collaborators);
            drawBoxWithValue(margin + contentWidth / 2 + 5, currentY, contentWidth / 2 - 5, 30, 'Hora de Inicio:', startTime);

            currentY += 40;
            const endTimestamp = order.fechaFinalizacionReal || order.endTime;
            const endDate = endTimestamp ? new Date(endTimestamp).toLocaleDateString('es-ES') : 'N/A';
            const endTime = endTimestamp ? new Date(endTimestamp).toLocaleTimeString('es-ES', {hour: '2-digit', minute:'2-digit'}) : 'N/A';
            const totalHours = (getTotalWorkDurationMs(order) / (1000 * 60 * 60)).toFixed(2);

            const row4W = (contentWidth - 15) / 4;
            drawBoxWithValue(margin, currentY, row4W, 45, 'Estado de la orden:', order.status);
            drawBoxWithValue(margin + row4W + 5, currentY, row4W, 45, 'Fecha Final:', endDate);
            drawBoxWithValue(margin + 2 * (row4W + 5), currentY, row4W, 45, 'Hora Final:', endTime);
            drawBoxWithValue(margin + 3 * (row4W + 5), currentY, row4W, 45, 'Horas empleadas:', `${totalHours} hrs`);

            currentY += 65;
            
            const partsBody = (order.partsUsed || []).map(pInfo => {
                const part = state.parts.find(p => p.id === pInfo.partId);
                return [
                    pInfo.partId,
                    part ? part.description : 'N/A',
                    pInfo.quantity,
                    formatCurrency(part.cost),
                    formatCurrency(part.cost * pInfo.quantity)
                ];
            });
            
            let finalY = currentY;
            if (partsBody.length > 0) {
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('Repuestos / Materiales Utilizados', margin, currentY);

                 doc.autoTable({
                    startY: currentY + 10,
                    head: [['ID', 'Descripci칩n', 'Cantidad', 'Costo Unit.', 'Costo Total']],
                    body: partsBody,
                    headStyles: { fillColor: [44, 62, 80] },
                    margin: { left: margin, right: margin, top: 100 },
                    didDrawPage: function(data) {
                        // Draw header on new pages if table spans multiple pages
                        if (data.pageNumber > 1) {
                            drawHeader();
                        }
                    }
                });
                finalY = doc.autoTable.previous.finalY;
                finalY += 20;
            }

            // Dynamic Observaciones Box
            const obsText = order.observaciones || (order.workPerformed || 'N/A');
            const obsLines = doc.splitTextToSize(obsText, contentWidth - 10);
            const obsBoxHeight = Math.max(40, (obsLines.length * 12) + 25);

            // Check if observaciones box fits on current page
            if (finalY + obsBoxHeight + 40 > doc.internal.pageSize.getHeight()) {
                doc.addPage();
                drawHeader();
                finalY = 120;
            }

            doc.rect(margin, finalY, contentWidth, obsBoxHeight);
            doc.setFontSize(8);
            doc.text('Observaciones / Trabajo Realizado:', margin + 3, finalY + 10);
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(obsLines, margin + 5, finalY + 25);

            finalY += obsBoxHeight;
            
            // Check if signatures fit on current page
            if (finalY + 120 > doc.internal.pageSize.getHeight()) {
                doc.addPage();
                drawHeader();
                finalY = 120;
            } else {
                finalY += 40;
            }

            const evals = state.technicianEvaluations.filter(ev => ev.workOrderFbId === order.fb_id);
            const opEval = evals.find(ev => ev.evaluatorRole === 'Operario');
            const jefeEval = evals.find(ev => ev.evaluatorRole === 'Jefe de Area');

                        const sigWidth = (contentWidth - 60) / 4;
            const sigH = 30;
            const sigW = sigWidth - 5;

            const getSignatureByUsername = (username) => {
                if (!username || username === 'Sistema (Plan de Mantenimiento)') return null;
                const tech = state.technicians.find(t => t.username === username);
                return tech ? tech.signature : null;
            };

            // Signature 1: Ejecutado por
            const sigExec = getSignatureByUsername(order.leadTechnician);
            if (sigExec) {
                try { doc.addImage(sigExec, 'PNG', margin + 2.5, finalY + 10, sigW, sigH); } catch(err){}
            }
            doc.line(margin, finalY + 45, margin + sigWidth, finalY + 45);
            doc.setFontSize(7);
            doc.text(`Ejecutado por:`, margin + sigWidth / 2, finalY + 55, { align: 'center' });
            doc.text(`${order.leadTechnician || ''}`, margin + sigWidth / 2, finalY + 65, { align: 'center' });

            // Signature 2: Recibido por
            const sigLabel = 'Operario';
            const hasRequest = order.solicitudId || order.sourceSolicitudId;
            let receiverName = hasRequest ? (order.requester || '') : (opEval ? opEval.evaluatorId : '');
            if (receiverName === 'Sistema (Plan de Mantenimiento)') receiverName = '';
            const sigRec = getSignatureByUsername(receiverName);
            if (sigRec) {
                try { doc.addImage(sigRec, 'PNG', margin + sigWidth + 20 + 2.5, finalY + 10, sigW, sigH); } catch(err){}
            }
            doc.line(margin + sigWidth + 20, finalY + 45, margin + 2 * sigWidth + 20, finalY + 45);
            doc.text(`${sigLabel}:`, margin + sigWidth + 20 + sigWidth / 2, finalY + 55, { align: 'center' });
            doc.text(`${receiverName}`, margin + sigWidth + 20 + sigWidth / 2, finalY + 65, { align: 'center' });

            // Signature 3: Jefe de Mantenimiento (Planner/Admin, WITH name)
            const validatorName = order.validatedBy || '';
            const sigVal = getSignatureByUsername(validatorName);
            if (sigVal) {
                try { doc.addImage(sigVal, 'PNG', margin + 2 * (sigWidth + 20) + 2.5, finalY + 10, sigW, sigH); } catch(err){}
            }
            doc.line(margin + 2 * (sigWidth + 20), finalY + 45, margin + 3 * sigWidth + 40, finalY + 45);
            doc.text(`Jefe de Mantenimiento:`, margin + 2 * (sigWidth + 20) + sigWidth / 2, finalY + 55, { align: 'center' });
            doc.text(`${validatorName}`, margin + 2 * (sigWidth + 20) + sigWidth / 2, finalY + 65, { align: 'center' });

            // Signature 4: Jefe de 치rea (Area Head evaluator, WITH name)
            const jefeName = jefeEval ? jefeEval.evaluatorId : '';
            const sigJefe = getSignatureByUsername(jefeName);
            if (sigJefe) {
                try { doc.addImage(sigJefe, 'PNG', margin + 3 * (sigWidth + 20) + 2.5, finalY + 10, sigW, sigH); } catch(err){}
            }
            doc.line(margin + 3 * (sigWidth + 20), finalY + 45, pageWidth - margin, finalY + 45);
            doc.text(`Jefe de 치rea:`, margin + 3 * (sigWidth + 20) + sigWidth / 2, finalY + 55, { align: 'center' });
            doc.text(`${jefeName}`, margin + 3 * (sigWidth + 20) + sigWidth / 2, finalY + 65, { align: 'center' });
            
            drawFooter();
            doc.save(`OT_${workOrderId}.pdf`);
            
        } catch (e) {
            console.error("Error generating single WO report:", e);
            showToast('Ocurri칩 un error al generar el PDF.', 'error');
        } finally {
            showLoading(false);
        }
    }, 500);
}

function generateGlobalReport() {
    const month = parseInt(document.getElementById('report-global-month').value);
    const year = parseInt(document.getElementById('report-global-year').value);

    if (isNaN(month) || isNaN(year)) {
        showToast('Por favor, seleccione un mes y a침o v치lidos.', 'error');
        return;
    }

    showLoading(true);

    setTimeout(() => {
        try {
            // 1. Filter Work Orders for the selected period
            const startDate = new Date(year, month, 1);
            const endDate = new Date(year, month + 1, 0, 23, 59, 59);

            const ordersInPeriod = state.workOrders.filter(o => {
                if (!o.date) return false;
                const orderDate = new Date(o.date + 'T12:00:00Z');
                return orderDate >= startDate && orderDate <= endDate;
            });

            if (ordersInPeriod.length === 0) {
                showToast('No hay datos de 칩rdenes de trabajo para el per칤odo seleccionado.', 'warning');
                showLoading(false);
                return;
            }

            // 2. Calculate KPIs
            // 2.1. % de trabajo no planificado
            const totalCorrective = ordersInPeriod.filter(o => o.type === 'Correctivo').length;
            const unplannedWorkPercentage = (totalCorrective / ordersInPeriod.length) * 100;

            // 2.2. Disponibilidad operacional
            const machinesInPeriod = [...new Set(ordersInPeriod.map(o => o.machineId))];
            const machineObjects = state.machines.filter(m => machinesInPeriod.includes(m.id));
            const scheduledUptimeMs = calculateScheduledUptimeMs(machineObjects, startDate, endDate);

            const completedCorrectives = ordersInPeriod.filter(o => o.type === 'Correctivo' && o.status === 'Completado');
            const totalDowntimeMs = completedCorrectives.reduce((sum, o) => sum + getTotalWorkDurationMs(o), 0);

            let operationalAvailability = 'N/A';
            if (scheduledUptimeMs > 0) {
                const availability = ((scheduledUptimeMs - totalDowntimeMs) / scheduledUptimeMs) * 100;
                operationalAvailability = Math.max(0, availability);
            }

            // 2.3. Top 5 equipos problem치ticos
            const correctiveCountsByMachine = ordersInPeriod
                .filter(o => o.type === 'Correctivo')
                .reduce((acc, order) => {
                    acc[order.machineId] = (acc[order.machineId] || 0) + 1;
                    return acc;
                }, {});

            const top5ProblematicMachines = Object.entries(correctiveCountsByMachine)
                .sort(([, a], [, b]) => b - a)
                .slice(0, 5)
                .map(([machineId, count]) => ({
                    machineId,
                    name: state.machines.find(m => m.id === machineId)?.name || 'Desconocido',
                    failures: count
                }));

            // 2.4. 칈ndice de confiabilidad
            const leastReliableMachine = top5ProblematicMachines.length > 0 ? top5ProblematicMachines[0] : null;

            // 3. Generate PDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const monthName = document.getElementById('report-global-month').options[month].text;

            // Header
            doc.setFontSize(18);
            doc.text('Informe de Indicadores Globales', 14, 22);
            doc.setFontSize(12);
            doc.text(`Per칤odo: ${monthName} ${year}`, 14, 30);

            // Summary Table
            doc.setFontSize(14);
            doc.text('Resumen de Indicadores', 14, 45);
            doc.autoTable({
                startY: 50,
                theme: 'grid',
                headStyles: { fillColor: [44, 62, 80] },
                head: [['Indicador', 'Valor']],
                body: [
                    ['% de Trabajo No Planificado', `${unplannedWorkPercentage.toFixed(2)}%`],
                    ['Disponibilidad Operacional', `${typeof operationalAvailability === 'number' ? operationalAvailability.toFixed(2) : operationalAvailability}%`],
                    ['M치quina Menos Confiable', leastReliableMachine ? `${leastReliableMachine.name} (${leastReliableMachine.failures} fallos)` : 'N/A'],
                ]
            });

            let finalY = doc.autoTable.previous.finalY;

            // Top 5 Problematic Machines Details
            doc.setFontSize(14);
            doc.text('Top 5 Equipos Problem치ticos', 14, finalY + 15);

            top5ProblematicMachines.forEach((machine, index) => {
                finalY = doc.autoTable.previous.finalY;
                if (finalY > 250) { // Add new page if content gets too long
                    doc.addPage();
                    finalY = 20;
                }

                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text(`${index + 1}. ${machine.name} (${machine.failures} fallos)`, 14, finalY + 10);

                const machineOrders = ordersInPeriod.filter(o => o.machineId === machine.machineId && o.type === 'Correctivo');
                const body = machineOrders.map(o => {
                    const durationMs = getTotalWorkDurationMs(o);
                    const hours = (durationMs / (1000 * 60 * 60)).toFixed(2);
                    return [
                        o.id,
                        o.description,
                        new Date(o.date + 'T12:00:00Z').toLocaleDateString('es-ES'),
                        `${hours} hrs`
                    ];
                });

                doc.autoTable({
                    startY: finalY + 15,
                    head: [['ID Orden', 'Falla Reportada', 'Fecha', 'Tiempo Reparaci칩n']],
                    body: body,
                    theme: 'striped',
                    headStyles: { fillColor: [108, 117, 125] },
                    margin: { left: 14 }
                });
            });

            doc.save(`Informe_Indicadores_Globales_${monthName}_${year}.pdf`);
            showToast('Reporte global generado correctamente', 'success');

        } catch (error) {
            console.error("Error generating global report:", error);
            showToast('Ocurri칩 un error al generar el reporte.', 'error');
        } finally {
            showLoading(false);
        }
    }, 1000);
}

async function generateExecutionReportPDF() {
    const executionId = document.getElementById('report-execution-select').value;
    if (!executionId) {
        showToast('Por favor, seleccione una ejecuci칩n para generar el reporte.', 'warning');
        return;
    }

    const imageUrlToBase64 = async (url) => {
        if (!url) return null;

        const attemptLoad = (src) => {
            return new Promise((resolve) => {
                const img = new Image();
                img.crossOrigin = 'Anonymous';
                let timeout = setTimeout(() => {
                    img.src = "";
                    resolve(null);
                }, 8000);

                img.onload = () => {
                    clearTimeout(timeout);
                    try {
                        const canvas = document.createElement("canvas");
                        canvas.width = img.width;
                        canvas.height = img.height;
                        const ctx = canvas.getContext("2d");
                        ctx.drawImage(img, 0, 0);
                        resolve({
                            data: canvas.toDataURL("image/jpeg", 0.8),
                            width: img.width,
                            height: img.height
                        });
                    } catch (e) {
                        console.error("Canvas error:", e);
                        resolve(null);
                    }
                };
                img.onerror = () => {
                    clearTimeout(timeout);
                    resolve(null);
                };
                img.src = src;
            });
        };

        // Strategy 1: Direct Load (Often works if CORS is configured or session is active)
        let result = await attemptLoad(url);
        if (result) return result;

        // Strategy 2: Google Proxy (Legacy but often works for simple public files)
        const googleProxy = "https://images1-focus-opensocial.googleusercontent.com/gadgets/proxy?container=focus&refresh=2592000&url=" + encodeURIComponent(url);
        result = await attemptLoad(googleProxy);
        if (result) return result;

        // Strategy 3: Wsrv.nl Proxy (Modern, fast, and handles CORS very well)
        const wsrvProxy = `https://wsrv.nl/?url=${encodeURIComponent(url)}&output=jpg&q=80`;
        result = await attemptLoad(wsrvProxy);

        return result;
    };

    showLoading(true);

    try {
        const execution = state.workPlanExecutions.find(e => e.fb_id === executionId);
        if (!execution) {
            throw new Error('No se encontr칩 la ejecuci칩n del plan.');
        }

        const plan = state.workPlans.find(p => p.fb_id === execution.planId);
        if (!plan) {
            throw new Error('No se encontr칩 el plan de mantenimiento asociado.');
        }

        const workOrder = state.workOrders.find(wo =>
            (execution.workOrderFbId && wo.fb_id === execution.workOrderFbId) || // New way
            (!execution.workOrderFbId && wo.id === execution.workOrderId)      // Old way for backward compatibility
        );
        if (!workOrder) {
            throw new Error('No se encontr칩 la orden de trabajo asociada.');
        }

        const machine = state.machines.find(m => m.id === plan.machineId);
        if (!machine) {
            throw new Error('No se encontr칩 la m치quina asociada.');
        }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'pt', 'letter');
        const pageWidth = doc.internal.pageSize.getWidth();
        const margin = 40;
        let finalY = 0;

        // --- Helper Functions ---
        const headerConfig = {
            line1Left: 'Fecha de elaboraci칩n: 27/01/2026',
            line2Left: 'Fecha de revisi칩n: 03/02/2026',
            line3Left: 'Fecha de aprobaci칩n: 05/02/2026',
            line1Center: 'C칩digo: FO-MNDO-005',
            line2Center: 'Versi칩n : 2.0',
            line1Right: 'SISTEMA DE GESTI칍N DE CALIDAD',
            logoBase64: "data:image/png;base64,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"
        };

        const drawHeader = () => {
            const headerY = 30;
            const headerHeight = 60;
            const contentWidth = pageWidth - (margin * 2);
            const colWidth = contentWidth / 3;

            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');

            // Column 1
            doc.text(headerConfig.line1Left, margin, headerY + 15);
            doc.text(headerConfig.line2Left, margin, headerY + 30);
            doc.text(headerConfig.line3Left, margin, headerY + 45);

            // Column 2
            doc.text(headerConfig.line1Center, margin + colWidth, headerY + 15);
            doc.text(headerConfig.line2Center, margin + colWidth, headerY + 30);

            // Column 3
            doc.text(headerConfig.line1Right, margin + colWidth * 2, headerY + 15);

            // Logo
            if (headerConfig.logoBase64) {
                try {
                    const logoW = 80;
                    const logoH = 25;
                    const textWidth = doc.getTextWidth(headerConfig.line1Right);
                    const logoX = margin + colWidth * 2 + textWidth - logoW;
                    doc.addImage(headerConfig.logoBase64, 'PNG', logoX, headerY + 25, logoW, logoH);
                } catch (err) {
                    console.error("Error adding logo to PDF:", err);
                }
            }

            // Main Title
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Reporte de trabajo de mantenimiento preventivo de equipo', pageWidth / 2, headerY + headerHeight + 25, { align: 'center' });

            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
        };

        drawHeader();

        const FONT_SIZE = 10;
        const LINE_HEIGHT = FONT_SIZE * 1.2;
        let currentY = 150;

        const headerInfo = [
            { label: 'M치quina:', value: machine.name },
            { label: 'C칩digo M치quina:', value: machine.id },
            { label: 'Plan de Mantenimiento:', value: plan.name },
            { label: 'Frecuencia:', value: `Cada ${plan.frequencyValue || 1} ${ {'d': 'D칤a(s)', 'w': 'Semana(s)', 'm': 'Mes(es)', 'y': 'A침o(s)'}[plan.frequencyUnit] || 'Mes(es)'}`},
            { label: 'Ejecutado por:', value: execution.executedBy },
            { label: 'ID Orden de Trabajo:', value: workOrder.id || 'Pendiente' },
            { label: 'Fecha de Inicio:', value: execution.executedAt ? new Date(execution.executedAt).toLocaleString('es-ES') : 'N/A' },
            { label: 'Fecha de Finalizaci칩n:', value: execution.completedAt ? new Date(execution.completedAt).toLocaleString('es-ES') : 'N/A' }
        ];

        doc.autoTable({
            startY: currentY,
            head: [['Campo', 'Valor']],
            body: headerInfo.map(info => [info.label, info.value]),
            theme: 'grid',
            headStyles: { fillColor: [44, 62, 80] },
            columnStyles: { 0: { fontStyle: 'bold' } },
            margin: { top: 150, left: margin, right: margin },
            didDrawPage: (data) => {
                if (data.pageNumber > 1) {
                    drawHeader();
                }
            }
        });

        finalY = doc.autoTable.previous.finalY;

        // --- PDF Task List ---
        doc.setFontSize(12);
        doc.setFont(undefined, 'bold');
        doc.text('Detalle de Tareas Realizadas', margin, finalY + 30);

        let taskY = finalY + 50;

        (execution.taskGroups || []).forEach(group => {
            // Add space and title for the group
            if (taskY > doc.internal.pageSize.getHeight() - 150) {
                doc.addPage();
                drawHeader();
                taskY = 150;
            }

            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text(group.name, margin, taskY);
            taskY += 15;

            const body = group.tasks.map(task => {
                let measurement = '';
                if (task.type === 'numeric') {
                    measurement = `${task.value || ''} ${task.unit || ''}`;
                } else if (task.type === 'multi_numeric') {
                    measurement = (task.fields || []).map((f, i) => {
                        const val = task.multiValues ? task.multiValues[i] || '' : '';
                        return f ? `${f}: ${val}` : val;
                    }).join(', ') + ` ${task.unit || ''}`;
                }

                return [
                    { content: task.description + (task.detail ? `\nObs: ${task.detail}` : ''), hasDetail: !!task.detail },
                    measurement,
                    task.status || 'Pendiente'
                ];
            });

            doc.autoTable({
                startY: taskY,
                head: [['Tarea', 'Medici칩n', 'Resultado']],
                body: body,
                theme: 'striped',
                headStyles: { fillColor: [108, 117, 125] },
                didDrawCell: (data) => {
                    if (data.column.index === 2 && data.cell.section === 'body') {
                        const status = data.cell.text[0];
                        if (status === 'Aprob칩') {
                            doc.setTextColor(39, 174, 96); // Green
                        } else if (status === 'Fallo') {
                            doc.setTextColor(192, 57, 43); // Red
                        } else if (status === 'Alerta') {
                            doc.setTextColor(243, 156, 18); // Orange/Yellow
                        }
                    }
                },
                willDrawCell: (data) => {
                    if (data.column.index === 2 && data.cell.section === 'body') {
                        data.cell.styles.halign = 'left';
                        data.cell.styles.fontStyle = 'bold';
                        data.cell.styles.fontSize = 10;
                    }
                    if (data.column.index === 0 && data.cell.section === 'body' && data.cell.raw && data.cell.raw.hasDetail) {
                        data.cell.styles.fontSize = 8;
                    }
                },
                margin: { top: 150, left: margin, right: margin },
                didDrawPage: (data) => {
                    if (data.pageNumber > 1) {
                        drawHeader();
                    }
                }
            });
            taskY = doc.autoTable.previous.finalY + 25;
        });

        // Check if there's enough space for signatures on the last page
        if (taskY > doc.internal.pageSize.getHeight() - 150) {
            doc.addPage();
            drawHeader();
        }


        // --- PDF Footer (Signature lines) ---
        const signatureY = doc.internal.pageSize.getHeight() - 100;
        const contentWidth = pageWidth - (margin * 2);
        const sigWidth = (contentWidth - 40) / 3;
        const sigH = 35;
        const sigW = sigWidth - 10;

        const getSignatureByUsername = (username) => {
            if (!username) return null;
            const tech = state.technicians.find(t => t.username === username);
            return tech ? tech.signature : null;
        };

        const jefeEval = state.technicianEvaluations.find(ev => ev.workOrderFbId === execution.workOrderFbId && ev.evaluatorRole === 'Jefe de Area');
        const evaluatorName = jefeEval ? jefeEval.evaluatorId : '';

        doc.setFontSize(8);

        // Signature 1: Ejecutado por
        const sigExec = getSignatureByUsername(execution.executedBy);
        if (sigExec) {
            try { doc.addImage(sigExec, 'PNG', margin + 5, signatureY - 40, sigW, sigH); } catch(err){}
        }
        doc.line(margin, signatureY, margin + sigWidth, signatureY);
        doc.text(`Ejecutado por: ${execution.executedBy || ''}`, margin, signatureY + 15);

        // Signature 2: Jefe de Mantenimiento (WITH name)
        const sigRec = getSignatureByUsername(execution.validatedBy);
        if (sigRec) {
            try { doc.addImage(sigRec, 'PNG', margin + sigWidth + 25, signatureY - 40, sigW, sigH); } catch(err){}
        }
        doc.line(margin + sigWidth + 20, signatureY, margin + 2 * sigWidth + 20, signatureY);
        doc.text(`Jefe de Mantenimiento:`, margin + sigWidth + 20, signatureY + 15);
        doc.text(`${execution.validatedBy || ''}`, margin + sigWidth + 20, signatureY + 25);

        // Signature 3: Jefe de 치rea
        const sigJefe = getSignatureByUsername(evaluatorName);
        if (sigJefe) {
            try { doc.addImage(sigJefe, 'PNG', margin + 2 * sigWidth + 45, signatureY - 40, sigW, sigH); } catch(err){}
        }
        doc.line(margin + 2 * sigWidth + 40, signatureY, pageWidth - margin, signatureY);
        doc.text(`Jefe de 치rea: ${evaluatorName}`, margin + 2 * sigWidth + 40, signatureY + 15);

        // --- PDF Annexes (Photos) ---
        const photosToInclude = [];
        (execution.taskGroups || []).forEach(group => {
            group.tasks.forEach(task => {
                if (task.photos && task.photos.length > 0) {
                    task.photos.forEach(photoUrl => {
                        photosToInclude.push({
                            url: photoUrl,
                            description: task.description,
                            detail: task.detail
                        });
                    });
                }
            });
        });

        if (photosToInclude.length > 0) {
            doc.addPage();
            drawHeader();
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Anexos - Evidencia Fotogr치fica', margin, 150);

            let annexY = 170;
            const maxWidth = pageWidth - (margin * 2);

            for (const item of photosToInclude) {
                // Approximate space needed: description (wrap) + detail (wrap) + image (90) + margins
                // We'll calculate more accurately inside
                if (annexY > doc.internal.pageSize.getHeight() - 200) {
                    doc.addPage();
                    drawHeader();
                    annexY = 150;
                }

                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');
                const descLines = doc.splitTextToSize(`Tarea: ${item.description}`, maxWidth);
                doc.text(descLines, margin, annexY);
                annexY += (descLines.length * 12);

                if (item.detail) {
                    doc.setFontSize(9);
                    doc.setFont(undefined, 'italic');
                    const detailLines = doc.splitTextToSize(`Obs: ${item.detail}`, maxWidth);
                    doc.text(detailLines, margin, annexY);
                    annexY += (detailLines.length * 11);
                }
                annexY += 5;

                try {
                    const imgResult = await imageUrlToBase64(item.url);
                    if (imgResult) {
                        const maxW = 130;
                        const maxH = 90;

                        let finalW = imgResult.width;
                        let finalH = imgResult.height;
                        const ratio = Math.min(maxW / finalW, maxH / finalH);

                        finalW = finalW * ratio;
                        finalH = finalH * ratio;

                        // Center the image relative to content area if desired,
                        // but sticking to left margin is usually cleaner in reports
                        doc.addImage(imgResult.data, 'JPEG', margin, annexY, finalW, finalH);
                        annexY += finalH + 10;
                    } else {
                        doc.setTextColor(180, 180, 180);
                        doc.setFontSize(8);
                        doc.text("[La imagen no se pudo cargar en el reporte. Verifique la imagen en el sistema.]", margin, annexY);
                        doc.setTextColor(0, 0, 0);
                        annexY += 12;
                    }
                } catch (err) {
                    console.error("Error adding image to PDF:", err);
                    doc.text("[Error al procesar imagen]", margin, annexY);
                    annexY += 15;
                }
                annexY += 20;
            }
        }

        // --- Save the PDF ---
        const drawFooter = () => {
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setFont(undefined, 'normal');
                const footerY = doc.internal.pageSize.getHeight() - 20;
                doc.text('FO-MNDO-005 Reporte de trabajo de mantenimiento preventivo de equipo', margin, footerY);
                doc.text(`Copia Controlada P치gina  ${i} de ${pageCount}`, pageWidth - margin, footerY, { align: 'right' });
            }
        };
        drawFooter();
        doc.save(`Reporte_Ejecucion_${plan.name.replace(/\s/g, '_')}_${new Date(execution.executedAt).toLocaleDateString('es-ES').replace(/\//g, '-')}.pdf`);
        showToast('Reporte PDF generado correctamente.', 'success');


    } catch (error) {
        console.error("Error al generar el reporte de ejecuci칩n:", error);
        showToast(error.message, 'error');
    } finally {
        showLoading(false);
    }
}

function handlePeriodChange() {
    const period = document.getElementById('dashboard-period-select').value;
    const dateSelect = document.getElementById('dashboardDate');
    const weekSelect = document.getElementById('dashboardWeek');
    const monthSelect = document.getElementById('dashboardMonth');
    const yearSelect = document.getElementById('dashboardYear');

    dateSelect.style.display = 'none';
    weekSelect.style.display = 'none';
    monthSelect.style.display = 'none';
    yearSelect.style.display = 'none';

    if (period === 'day') {
        dateSelect.style.display = 'inline-block';
    } else if (period === 'week') {
        populateWeekSelector();
        weekSelect.style.display = 'inline-block';
        monthSelect.style.display = 'inline-block';
        yearSelect.style.display = 'inline-block';
    } else if (period === 'month') {
        monthSelect.style.display = 'inline-block';
        yearSelect.style.display = 'inline-block';
    } else if (period === 'year') {
        yearSelect.style.display = 'inline-block';
    }
    updateDashboardData();
}

function getDashboardPeriod() {
    const period = document.getElementById('dashboard-period-select').value;
    let startDate, endDate, periodLabel;

    const dateSelect = document.getElementById('dashboardDate');
    const weekSelect = document.getElementById('dashboardWeek');
    const monthSelect = document.getElementById('dashboardMonth');
    const yearSelect = document.getElementById('dashboardYear');

    switch (period) {
        case 'day':
            const selectedDateVal = dateSelect.value;
            if (!selectedDateVal) {
                const now = new Date();
                startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            } else {
                const selectedDate = new Date(selectedDateVal + 'T00:00:00');
                startDate = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), selectedDate.getDate());
            }
            endDate = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate(), 23, 59, 59);
            periodLabel = startDate.toLocaleDateString('es-ES', { day: 'numeric', month: 'long' });
            break;
        case 'week':
             if (weekSelect.value) {
                const [weekStartStr, weekEndStr] = weekSelect.value.split('|');
                startDate = new Date(weekStartStr + 'T00:00:00');
                endDate = new Date(weekEndStr + 'T23:59:59');
                periodLabel = `Semana del ${startDate.toLocaleDateString('es-ES')}`;
            } else { // Fallback
                const now = new Date();
                const firstDayOfWeek = now.getDate() - now.getDay();
                startDate = new Date(now.getFullYear(), now.getMonth(), firstDayOfWeek);
                endDate = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate() + 6, 23, 59, 59);
                periodLabel = 'Esta Semana';
            }
            break;
        case 'year':
            const yearForYear = parseInt(yearSelect.value);
            startDate = new Date(yearForYear, 0, 1);
            endDate = new Date(yearForYear, 11, 31, 23, 59, 59);
            periodLabel = `A침o ${yearForYear}`;
            break;
        case 'month':
        default:
            const month = parseInt(monthSelect.value);
            const yearForMonth = parseInt(yearSelect.value);
            startDate = new Date(yearForMonth, month, 1);
            endDate = new Date(yearForMonth, month + 1, 0, 23, 59, 59);
            const monthName = monthSelect.options[monthSelect.selectedIndex].text;
            periodLabel = `${monthName} ${yearForMonth}`;
            break;
    }
    return { startDate, endDate, periodLabel };
}

function updateDashboardData() {
    const { startDate, endDate, periodLabel } = getDashboardPeriod();

    document.querySelectorAll('.period-label').forEach(el => {
        el.textContent = `(${periodLabel})`;
    });

    let ordersForDashboard = state.workOrders;
    const userRole = state.currentUser?.role;
    const managedMachineIds = state.currentUser?.managedMachineIds;
    const equipoAsignado = state.currentUser?.equipoAsignado;

    if ((userRole === 'Jefe de Area' && Array.isArray(managedMachineIds)) || (userRole === 'T칠cnico' && Array.isArray(equipoAsignado))) {
        const relevantMachineIds = new Set(userRole === 'Jefe de Area' ? managedMachineIds : equipoAsignado);
        ordersForDashboard = state.workOrders.filter(wo => relevantMachineIds.has(wo.machineId));
    }

    const ordersThisPeriod = ordersForDashboard.filter(o => {
        if (!o.date) return false;
        const orderDate = new Date(o.date + 'T12:00:00Z');
        return orderDate >= startDate && orderDate <= endDate;
    });

    updateStats(ordersThisPeriod);
    updateKpis(ordersThisPeriod, startDate, endDate);
    updateCharts(ordersThisPeriod);
    updatePlanNotifications();
}

function updatePlanNotifications() {
    if (!state.currentUser) return;

    const userRole = state.currentUser.role;
    const username = state.currentUser.username;
    const notificationsList = document.getElementById('notifications-list');
    const notificationsCount = document.getElementById('notifications-count');

    if (!notificationsList || !notificationsCount) return;

    const now = new Date();
    now.setHours(0, 0, 0, 0);

    const alerts = [];

    state.workPlans.forEach(plan => {
        if (!plan.isActive || !plan.nextDueDate) return;

        // Permission check: Admin, Planificador or the assigned technician
        const isAuthorized = userRole === 'Admin' || userRole === 'Planificador' || plan.responsibleTechnician === username;
        if (!isAuthorized) return;

        const dueDate = new Date(plan.nextDueDate + 'T00:00:00');
        const diffTime = dueDate.getTime() - now.getTime();
        const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24));

        let type = '';
        let message = '';
        let icon = '';
        let badgeClass = '';

        if (diffDays < 0) {
            type = 'Vencido';
            message = `El plan "${plan.name}" est치 vencido desde el ${new Date(dueDate).toLocaleDateString()}.`;
            icon = 'fa-exclamation-triangle';
            badgeClass = 'bg-danger';
        } else if (diffDays === 0) {
            type = 'Hoy';
            message = `El plan "${plan.name}" debe ejecutarse hoy.`;
            icon = 'fa-clock';
            badgeClass = 'bg-warning text-dark';
        } else if (diffDays <= 3) {
            type = 'Pr칩ximo';
            message = `El plan "${plan.name}" vence en ${diffDays} ${diffDays === 1 ? 'd칤a' : 'd칤as'} (${new Date(dueDate).toLocaleDateString()}).`;
            icon = 'fa-info-circle';
            badgeClass = 'bg-info text-dark';
        }

        if (type) {
            alerts.push({
                planId: plan.fb_id,
                name: plan.name,
                type,
                message,
                icon,
                badgeClass,
                dueDate: plan.nextDueDate
            });
        }
    });

    // Sort alerts: Vencido first, then Hoy, then Pr칩ximo
    alerts.sort((a, b) => {
        const priority = { 'Vencido': 1, 'Hoy': 2, 'Pr칩ximo': 3 };
        return priority[a.type] - priority[b.type] || new Date(a.dueDate) - new Date(b.dueDate);
    });

    notificationsCount.textContent = alerts.length;
    notificationsCount.classList.toggle('d-none', alerts.length === 0);

    if (alerts.length === 0) {
        notificationsList.innerHTML = '<li class="p-3 text-center text-muted">No hay notificaciones</li>';
    } else {
        notificationsList.innerHTML = '';
        alerts.forEach(alert => {
            const li = document.createElement('li');
            li.className = 'notification-item p-2 border-bottom';
            li.style.cursor = 'pointer';
            li.onclick = () => window.scrollToPlan(alert.planId);

            const content = `
                <div class="d-flex align-items-start">
                    <div class="rounded-circle ${alert.badgeClass} p-2 me-2 d-flex align-items-center justify-content-center" style="width: 32px; height: 32px; flex-shrink: 0;">
                        <i class="fas ${alert.icon} fa-sm"></i>
                    </div>
                    <div class="flex-grow-1 overflow-hidden">
                        <div class="fw-bold small d-flex justify-content-between align-items-center">
                            <span>${alert.type}</span>
                            <span class="text-muted" style="font-size: 0.7rem;">${alert.dueDate}</span>
                        </div>
                        <p class="mb-0 small text-truncate-2" id="notif-msg-${alert.planId}"></p>
                    </div>
                </div>
            `;
            li.innerHTML = content;
            li.querySelector(`#notif-msg-${alert.planId}`).textContent = alert.message;
            notificationsList.appendChild(li);
        });
    }
}

function scrollToPlan(planId) {
    switchTab('planes-trabajo');

    // Small delay to allow rendering
    setTimeout(() => {
        const planEl = document.querySelector(`[data-plan-id="${planId}"]`);
        if (planEl) {
            planEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
            planEl.classList.add('highlight-plan');
            setTimeout(() => planEl.classList.remove('highlight-plan'), 3000);
        }
    }, 100);
}

window.scrollToPlan = scrollToPlan;


// --- Dashboard & Charts ---
function calculateScheduledUptimeMs(machines, startDate, endDate) {
    let totalScheduledMs = 0;

    // Normalize dates to avoid time-of-day issues
    const start = new Date(startDate);
    start.setHours(0, 0, 0, 0);
    const end = new Date(endDate);
    end.setHours(0, 0, 0, 0);

    const diffDays = Math.round((end - start) / (24 * 60 * 60 * 1000)) + 1;
    if (diffDays <= 0) return 0;

    // Pre-calculate day counts for the range to avoid redundant loops
    const dayCounts = new Array(7).fill(0);
    const fullWeeks = Math.floor(diffDays / 7);
    for (let i = 0; i < 7; i++) dayCounts[i] = fullWeeks;

    const remainingDays = diffDays % 7;
    let tempDay = start.getDay();
    for (let i = 0; i < remainingDays; i++) {
        dayCounts[tempDay]++;
        tempDay = (tempDay + 1) % 7;
    }

    const getUptimeFromSchedule = (sched) => {
        if (!sched || !sched.startTime || !sched.endTime) return 0;
        const [startH, startM] = sched.startTime.split(':').map(Number);
        const [endH, endM] = sched.endTime.split(':').map(Number);
        return Math.max(0, ((endH * 60 + endM) - (startH * 60 + startM)) * 60 * 1000);
    };

    for (const machine of machines) {
        if (machine.scheduleDisabled) continue;

        if (!machine.schedule) {
            totalScheduledMs += diffDays * 10 * 60 * 60 * 1000; // Default 10h if no schedule
            continue;
        }

        // Mon-Fri
        const weekdayUptime = getUptimeFromSchedule(machine.schedule.weekday);
        if (weekdayUptime > 0 && machine.schedule.weekday?.activeDays) {
            machine.schedule.weekday.activeDays.forEach(dayStr => {
                const dayIdx = parseInt(dayStr);
                if (dayIdx >= 1 && dayIdx <= 5) {
                    totalScheduledMs += dayCounts[dayIdx] * weekdayUptime;
                }
            });
        }

        // Saturday
        if (machine.schedule.saturday?.active) {
            totalScheduledMs += dayCounts[6] * getUptimeFromSchedule(machine.schedule.saturday);
        }

        // Sunday
        if (machine.schedule.sunday?.active) {
            totalScheduledMs += dayCounts[0] * getUptimeFromSchedule(machine.schedule.sunday);
        }
    }
    return totalScheduledMs;
}

function calculateTotalCost(order, returnParts = false) {
    let partsCost = 0;
    if (order.partsUsed && order.partsUsed.length > 0) {
        partsCost = order.partsUsed.reduce((sum, partUsage) => {
            if (partUsage.delivered === false) return sum;
            const part = state.parts.find(p => p.id === partUsage.partId);
            return sum + (part ? part.cost * partUsage.quantity : 0);
        }, 0);
    }

    const totalWorkMs = getTotalWorkDurationMs(order);
    const hoursWorked = totalWorkMs / (1000 * 60 * 60);
    
    let laborCost = 0;
    const techniciansOnOrder = order.technicians || [];
    if (techniciansOnOrder.length > 0 && hoursWorked > 0) {
        laborCost = techniciansOnOrder.reduce((sum, techUsername) => {
            const technician = state.technicians.find(t => t.username === techUsername);
            if (technician && technician.salario) {
                const hourlyRate = technician.salario / 160;
                return sum + (hoursWorked * hourlyRate);
            }
            return sum;
        }, 0);
    }

    const totalCost = partsCost + laborCost + (order.additionalCost || 0);
    return returnParts ? { partsCost, laborCost, totalCost } : totalCost;
}

function calculateTotalCostForMultiple(orders) {
    // Optimization: Pre-calculate maps for faster lookups
    const partsMap = new Map(state.parts.map(p => [p.id, p]));
    const techMap = new Map(state.technicians.map(t => [t.username, t]));

    return orders.reduce((totals, order) => {
        // Inline partially calculateTotalCost logic with pre-calculated maps
        let partsCost = 0;
        if (order.partsUsed && order.partsUsed.length > 0) {
            partsCost = order.partsUsed.reduce((sum, partUsage) => {
                if (partUsage.delivered === false) return sum;
                const part = partsMap.get(partUsage.partId);
                return sum + (part ? (part.cost || 0) * partUsage.quantity : 0);
            }, 0);
        }

        const totalWorkMs = getTotalWorkDurationMs(order);
        const hoursWorked = totalWorkMs / (1000 * 60 * 60);

        let laborCost = 0;
        const techniciansOnOrder = order.technicians || [];
        if (techniciansOnOrder.length > 0 && hoursWorked > 0) {
            laborCost = techniciansOnOrder.reduce((sum, techUsername) => {
                const technician = techMap.get(techUsername);
                if (technician && technician.salario) {
                    const hourlyRate = technician.salario / 160;
                    return sum + (hoursWorked * hourlyRate);
                }
                return sum;
            }, 0);
        }

        const totalCost = partsCost + laborCost + (order.additionalCost || 0);

        totals.partsCost += partsCost;
        totals.laborCost += laborCost;
        totals.totalCost += totalCost;
        return totals;
    }, { partsCost: 0, laborCost: 0, totalCost: 0 });
}


function updateMachineCriticidadChart() {
    if (!state.charts.machineCriticidad) return;

    let machinesToCount = state.machines;
    if (state.currentUser?.role === 'Jefe de Area' && Array.isArray(state.currentUser.managedMachineIds)) {
        const managedIds = new Set(state.currentUser.managedMachineIds);
        machinesToCount = state.machines.filter(m => managedIds.has(m.id));
    }

    const counts = { 'Baja': 0, 'Media': 0, 'Alta': 0 };
    machinesToCount.forEach(m => {
        const crit = m.criticidad || 'Baja';
        if (counts.hasOwnProperty(crit)) {
            counts[crit]++;
        } else {
            counts['Baja']++;
        }
    });

    state.charts.machineCriticidad.data.datasets[0].data = [counts['Baja'], counts['Media'], counts['Alta']];
    state.charts.machineCriticidad.update();

    const legendContainer = document.getElementById('machine-criticidad-legend');
    if (legendContainer) {
        legendContainer.innerHTML = `
            <div class="legend-item"><div class="legend-color" style="background-color: #2ecc71;"></div>Baja: ${counts['Baja']}</div>
            <div class="legend-item"><div class="legend-color" style="background-color: #f39c12;"></div>Media: ${counts['Media']}</div>
            <div class="legend-item"><div class="legend-color" style="background-color: #e74c3c;"></div>Alta: ${counts['Alta']}</div>
        `;
    }

    const statMaquinas = document.getElementById('stat-maquinas');
    if (statMaquinas) statMaquinas.textContent = machinesToCount.length;
}

function updateStats(ordersThisPeriod) {
    updateMachineCriticidadChart();
    document.getElementById('stat-solicitudes').textContent = state.solicitudes.filter(s => s.status === 'Pendiente').length;
    
    document.getElementById('stat-preventivos').textContent = ordersThisPeriod.filter(o => o.type === 'Preventivo').length;
    document.getElementById('stat-correctivos').textContent = ordersThisPeriod.filter(o => o.type === 'Correctivo').length;
    
    const f = new Intl.NumberFormat('es-HN', { style: 'currency', currency: 'HNL' });

    // Gasto Ejecutado (Completed orders in period)
    const completedOrders = ordersThisPeriod.filter(o => o.status === 'Completado');
    const { totalCost: executedCost } = calculateTotalCostForMultiple(completedOrders);
    document.getElementById('stat-gasto-ejecutado').textContent = f.format(executedCost);
    
    // Gasto Planificado (All orders in period, including cancelled/expired)
    const { totalCost: plannedCost } = calculateTotalCostForMultiple(ordersThisPeriod);
    document.getElementById('stat-gasto-planificado').textContent = f.format(plannedCost);
}

function calculateKpisForPeriod(ordersInPeriod, startDate, endDate, machineId = 'all') {
    const periodOrders = machineId === 'all'
        ? ordersInPeriod
        : ordersInPeriod.filter(wo => wo.machineId === machineId);

    const kpis = {
        mtbf: null,
        mttr: null,
        availability: null,
        pmp: null,
        avgCost: null,
        otsCompleted: null,
        otsPlanned: null
    };

    // MTBF & MTTR
    const correctiveOrdersForPeriod = periodOrders.filter(o => o.type === 'Correctivo');

    // MTBF actualizado: (Tiempo transcurrido en el periodo hasta hoy) / (Fallas + 1)
    const now = new Date();
    const effectiveEndDate = endDate > now ? now : endDate;
    const timeElapsedMs = Math.max(0, effectiveEndDate - startDate);

    if (timeElapsedMs > 0) {
        const mtbfMs = timeElapsedMs / (correctiveOrdersForPeriod.length + 1);
        kpis.mtbf = mtbfMs / (1000 * 60 * 60 * 24);
    }

    const repairOrdersForPeriod = correctiveOrdersForPeriod.filter(o => o.status === 'Completado');
    if (repairOrdersForPeriod.length > 0) {
        const totalRepairTime = repairOrdersForPeriod.reduce((sum, o) => sum + getTotalWorkDurationMs(o), 0);
        const mttrMs = totalRepairTime / repairOrdersForPeriod.length;
        kpis.mttr = mttrMs / (1000 * 60 * 60);
    }

    // Availability
    let machinesForKpi = machineId === 'all' ? state.machines : [state.machines.find(m => m.id === machineId)].filter(Boolean);
    if (state.currentUser?.role === 'Jefe de Area' && Array.isArray(state.currentUser.managedMachineIds)) {
        const managedIds = new Set(state.currentUser.managedMachineIds);
        machinesForKpi = machinesForKpi.filter(m => managedIds.has(m.id));
    }

    if (machinesForKpi.length > 0) {
        const scheduledUptimeMs = calculateScheduledUptimeMs(machinesForKpi, startDate, endDate);
        const totalDowntimeMs = repairOrdersForPeriod.reduce((sum, o) => sum + getTotalWorkDurationMs(o), 0);
        if (scheduledUptimeMs > 0) {
            const actualUptimeMs = Math.max(0, scheduledUptimeMs - totalDowntimeMs);
            kpis.availability = (actualUptimeMs / scheduledUptimeMs) * 100;
        }
    }

    // PMP, Cost & OTs
    const completedOrdersInPeriod = periodOrders.filter(o => o.status === 'Completado');
    const plannedOrdersInPeriod = periodOrders; // Include all

    kpis.otsPlanned = plannedOrdersInPeriod.length;
    kpis.otsCompleted = completedOrdersInPeriod.length;

    const preventivePlanned = periodOrders.filter(o => o.type === 'Preventivo').length;
    if (preventivePlanned > 0) {
        const preventiveCompleted = completedOrdersInPeriod.filter(o => o.type === 'Preventivo').length;
        kpis.pmp = (preventiveCompleted / preventivePlanned) * 100;
    }

    if (completedOrdersInPeriod.length > 0) {
        const { totalCost } = calculateTotalCostForMultiple(completedOrdersInPeriod);
        kpis.avgCost = totalCost / completedOrdersInPeriod.length;
    }

    return kpis;
}

function getPreviousPeriod(startDate, endDate) {
    const diff = endDate.getTime() - startDate.getTime();
    const prevEndDate = new Date(startDate.getTime() - 1);
    const prevStartDate = new Date(prevEndDate.getTime() - diff);
    return { prevStartDate, prevEndDate };
}

function updateKpis(ordersInPeriod, startDate, endDate) {
    const machineId = document.getElementById('kpi-machine-select').value;

    const currentKpis = calculateKpisForPeriod(ordersInPeriod, startDate, endDate, machineId);

    // Get previous period data
    const { prevStartDate, prevEndDate } = getPreviousPeriod(startDate, endDate);
    const prevPeriodOrders = state.workOrders.filter(o => {
        if (!o.date) return false;
        const orderDate = new Date(o.date + 'T12:00:00Z');
        return orderDate >= prevStartDate && orderDate <= prevEndDate;
    });
    const prevKpis = calculateKpisForPeriod(prevPeriodOrders, prevStartDate, prevEndDate, machineId);

    // Update UI
    document.getElementById('kpi-mtbf').textContent = currentKpis.mtbf ? currentKpis.mtbf.toFixed(2) : 'N/A';
    document.getElementById('kpi-mttr').textContent = currentKpis.mttr ? currentKpis.mttr.toFixed(2) : 'N/A';
    document.getElementById('kpi-availability').textContent = currentKpis.availability ? `${currentKpis.availability.toFixed(2)}%` : 'N/A';
    document.getElementById('kpi-pmp').textContent = currentKpis.pmp ? `${currentKpis.pmp.toFixed(2)}%` : 'N/A';
    document.getElementById('kpi-cost').textContent = currentKpis.avgCost ? new Intl.NumberFormat('es-HN', { style: 'currency', currency: 'HNL' }).format(currentKpis.avgCost) : 'N/A';

    // Update comparison texts
    updateComparison('mtbf', currentKpis.mtbf, prevKpis.mtbf, true); // Higher is better
    updateComparison('mttr', currentKpis.mttr, prevKpis.mttr, false); // Lower is better
    updateComparison('availability', currentKpis.availability, prevKpis.availability, true); // Higher is better

    updateComparison('pmp', currentKpis.pmp, prevKpis.pmp, true); // Higher is better

    updateComparison('cost', currentKpis.avgCost, prevKpis.avgCost, false); // Lower is better
}

function updateComparison(kpiName, current, previous, higherIsBetter) {
    const element = document.getElementById(`kpi-${kpiName}-comparison`);
    if (!element) return;

    if (current === null || previous === null || previous === 0) {
        element.innerHTML = '';
        return;
    }

    const diff = current - previous;
    const percentageChange = (diff / previous) * 100;

    let className = 'neutral';
    let icon = '<i class="fas fa-minus icon"></i>';

    if (percentageChange > 0) {
        className = higherIsBetter ? 'positive' : 'negative';
        icon = higherIsBetter ? '<i class="fas fa-arrow-up icon"></i>' : '<i class="fas fa-arrow-down icon"></i>';
    } else if (percentageChange < 0) {
        className = higherIsBetter ? 'negative' : 'positive';
        icon = higherIsBetter ? '<i class="fas fa-arrow-down icon"></i>' : '<i class="fas fa-arrow-up icon"></i>';
    }

    const periodLabel = document.getElementById('dashboard-period-select').selectedOptions[0].text.toLowerCase();

    element.className = `kpi-comparison ${className}`;
    element.innerHTML = `${icon} ${percentageChange.toFixed(1)}% vs ${periodLabel} anterior`;
}

function updateCharts(ordersForPeriod) {
    if (!state.charts.maintenance) return;

    const preventiveCount = ordersForPeriod.filter(o => o.type === 'Preventivo').length;
    const correctiveCount = ordersForPeriod.filter(o => o.type === 'Correctivo').length;
    state.charts.maintenance.data.datasets[0].data = [preventiveCount, correctiveCount];
    state.charts.maintenance.update();

    const correctiveOrdersForPeriod = ordersForPeriod.filter(o => o.type === 'Correctivo');
    const failureCounts = {
        'Mec치nica': correctiveOrdersForPeriod.filter(o => o.failureType === 'Mec치nica').length,
        'El칠ctrica': correctiveOrdersForPeriod.filter(o => o.failureType === 'El칠ctrica').length,
        'Electr칩nica': correctiveOrdersForPeriod.filter(o => o.failureType === 'Electr칩nica').length,
        'Falla de Operaci칩n': correctiveOrdersForPeriod.filter(o => o.failureType === 'Falla de Operaci칩n').length,
    };
    state.charts.failureType.data.datasets[0].data = Object.values(failureCounts);
    state.charts.failureType.update();

    state.charts.taskStatus.data.datasets[0].data = [
        ordersForPeriod.filter(o => o.status === 'Pendiente').length,
        ordersForPeriod.filter(o => o.status === 'En Proceso').length,
        ordersForPeriod.filter(o => o.status === 'Pausado').length,
        ordersForPeriod.filter(o => o.status === 'Pendiente de Evaluaci칩n' || o.status === 'Pendiente de Aprobaci칩n').length,
        ordersForPeriod.filter(o => o.status === 'Completado').length,
        ordersForPeriod.filter(o => o.status === 'Cancelado').length
    ];
    state.charts.taskStatus.update();

    const trendLabels = [];
    const preventiveCounts = [];
    const correctiveCounts = [];
    
    const { startDate } = getDashboardPeriod();
    const baseDate = startDate;
    
    // Optimization: Group all work orders by YYYY-MM once
    const ordersByMonthAndType = {};
    state.workOrders.forEach(o => {
        if (!o.date || !o.type) return;
        const monthKey = o.date.substring(0, 7); // YYYY-MM
        if (!ordersByMonthAndType[monthKey]) {
            ordersByMonthAndType[monthKey] = { 'Preventivo': 0, 'Correctivo': 0 };
        }
        if (ordersByMonthAndType[monthKey][o.type] !== undefined) {
            ordersByMonthAndType[monthKey][o.type]++;
        }
    });

    for (let i = 11; i >= 0; i--) {
        const d = new Date(baseDate.getFullYear(), baseDate.getMonth() - i, 1);
        trendLabels.push(d.toLocaleDateString('es-ES', { month: 'short', year: '2-digit' }));

        const monthKey = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
        const stats = ordersByMonthAndType[monthKey] || { 'Preventivo': 0, 'Correctivo': 0 };

        preventiveCounts.push(stats['Preventivo']);
        correctiveCounts.push(stats['Correctivo']);
    }
    state.charts.correctiveTrends.data.labels = trendLabels;
    state.charts.correctiveTrends.data.datasets[0].data = preventiveCounts;
    state.charts.correctiveTrends.data.datasets[1].data = correctiveCounts;
    state.charts.correctiveTrends.update();
}

function populateWorkOrderSelectors(searchTerm = '') {
    const selector = document.getElementById('report-wo-select');
    if (selector) {
        const currentVal = selector.value || selector.dataset.lastValue || "";
        const lowerSearch = searchTerm.toLowerCase();
        selector.innerHTML = '<option value="">Seleccione una Orden de Trabajo...</option>';
        
        let workOrdersToPopulate = state.workOrders;

        // If current user is a technician, only show work orders they are responsible for
        if (state.currentUser?.role === 'T칠cnico') {
            workOrdersToPopulate = workOrdersToPopulate.filter(wo => wo.leadTechnician === state.currentUser.username);
        }

        if (lowerSearch) {
            workOrdersToPopulate = workOrdersToPopulate.filter(wo =>
                wo.id.toLowerCase().includes(lowerSearch) ||
                wo.description.toLowerCase().includes(lowerSearch)
            );
        }

        const sortedWOs = [...workOrdersToPopulate].sort((a, b) => b.id.localeCompare(a.id));

        sortedWOs.forEach(wo => {
            selector.innerHTML += `<option value="${wo.id}">${wo.id} - ${wo.description.substring(0, 30)}...</option>`;
        });
        if (currentVal) {
            const exists = Array.from(selector.options).some(opt => opt.value === currentVal);
            if (exists) {
                selector.value = currentVal;
            }
            selector.dataset.lastValue = currentVal;
        }
    }
}

function populateExecutionReportSelector(searchTerm = '') {
    const selector = document.getElementById('report-execution-select');
    if (!selector) return;

    const currentVal = selector.value || selector.dataset.lastValue || "";
    const lowerSearch = searchTerm.toLowerCase();
    selector.innerHTML = '<option value="">Seleccione una Ejecuci칩n de Plan...</option>';

    // Sort executions by date, newest first, filtering only for those finished or pending evaluation
    let filteredExecutions = state.workPlanExecutions
        .filter(e => e.status === 'Pendiente de Evaluaci칩n' || e.status === 'Completado');

    // If current user is a technician, only show plan executions they performed
    if (state.currentUser?.role === 'T칠cnico') {
        filteredExecutions = filteredExecutions.filter(e => e.executedBy === state.currentUser.username);
    }

    const sortedExecutions = filteredExecutions.sort((a, b) => {
        return new Date(b.executedAt) - new Date(a.executedAt);
    });

    const finalExecutions = [];
    sortedExecutions.forEach(execution => {
        const plan = state.workPlans.find(p => p.fb_id === execution.planId);
        if (plan) {
            const executionDate = new Date(execution.executedAt).toLocaleDateString('es-ES');
            const optionText = `${plan.name} - ${executionDate}`;

            if (lowerSearch && !plan.name.toLowerCase().includes(lowerSearch)) {
                return;
            }

            selector.innerHTML += `<option value="${execution.fb_id}">${optionText}</option>`;
            finalExecutions.push(execution);
        }
    });

    // Check if the previously selected value still exists in the new list
    if (currentVal) {
        const exists = finalExecutions.some(e => e.fb_id === currentVal);
        if (exists) {
            selector.value = currentVal;
        }
        selector.dataset.lastValue = currentVal;
    }
}


function populateSupplierSelectors() {
    const selectors = [
        document.getElementById('part-supplier'),
    ];
    selectors.forEach(selector => {
        if (selector) {
            const currentVal = selector.value;
            selector.innerHTML = '<option value="">Seleccione un proveedor...</option>';
            state.proveedores.forEach(p => {
                selector.innerHTML += `<option value="${p.id}">${p.nombre}</option>`;
            });
            selector.value = currentVal;
        }
    });
}

function populateWorkOrderMachineSelector(searchTerm = '') {
    const selector = document.getElementById('wo-machine');
    const noResultsDiv = document.getElementById('wo-machine-no-results');
    if (!selector) return;

    const currentVal = selector.value;

    // Default state: selector visible, message hidden.
    noResultsDiv.classList.add('d-none');
    selector.classList.remove('d-none');
    selector.innerHTML = '<option value="">Seleccione una m치quina...</option>';

    let machinesToPopulate = state.machines;
    if (state.currentUser?.role === 'Jefe de Area' && Array.isArray(state.currentUser.managedMachineIds)) {
        const managedIds = new Set(state.currentUser.managedMachineIds);
        machinesToPopulate = state.machines.filter(m => managedIds.has(m.id));
    }

    const lowerCaseSearchTerm = searchTerm.toLowerCase();
    const filteredMachines = machinesToPopulate.filter(machine =>
        machine.name.toLowerCase().includes(lowerCaseSearchTerm) ||
        machine.id.toLowerCase().includes(lowerCaseSearchTerm)
    );

    if (filteredMachines.length === 0) {
        // If there are no results...
        if (searchTerm !== '') {
            // ... and we are searching, show the message.
            noResultsDiv.classList.remove('d-none');
            selector.classList.add('d-none');
        }
        // ... and we are NOT searching (initial state), do nothing. The selector remains empty but visible.
    } else {
        // If there are results, populate the selector.
        filteredMachines.forEach(machine => {
            selector.innerHTML += `<option value="${machine.id}">${machine.id} - ${machine.name}</option>`;
        });
    }

    if (filteredMachines.some(m => m.id === currentVal)) {
        selector.value = currentVal;
    }
}

async function handleExpiredWorkOrders() {
    if (state.workOrders.length === 0) return;

    const now = new Date();
    // Use local components for comparison as per project standard
    const currentYear = now.getFullYear();
    const currentMonth = now.getMonth();

    const ordersToProcess = state.workOrders.filter(wo =>
        wo.status !== 'Completado' && wo.status !== 'Cancelado' && wo.status !== 'Rechazado' && !wo.isExpired
    );

    for (const order of ordersToProcess) {
        let shouldUpdate = false;
        let nextStatus = '';
        let isExpired = false;
        let note = '';

        if (order.status === 'Pendiente de Evaluaci칩n' || order.status === 'Pendiente de Aprobaci칩n') {
            const finishDate = order.fechaFinalizacionReal ? new Date(order.fechaFinalizacionReal) : null;
            if (!finishDate) continue;

            const fYear = finishDate.getFullYear();
            const fMonth = finishDate.getMonth();
            const fDay = finishDate.getDate();

            const lastDayOfFMonth = new Date(fYear, fMonth + 1, 0).getDate();
            const isLastDay = fDay === lastDayOfFMonth;

            // Deadline logic for evaluations
            let deadline;
            if (isLastDay) {
                // 2 days grace period: expires at the start of the 3rd day of the next month
                deadline = new Date(fYear, fMonth + 1, 3, 0, 0, 0);
            } else {
                // Expires at the start of the 1st day of the next month
                deadline = new Date(fYear, fMonth + 1, 1, 0, 0, 0);
            }

            if (now >= deadline) {
                shouldUpdate = true;
                nextStatus = 'Completado';
                note = isLastDay
                    ? 'Finalizada autom치ticamente tras 2 d칤as de gracia (fin de mes).'
                    : 'Finalizada autom치ticamente al t칠rmino del mes de ejecuci칩n.';
            }
        } else {
            // Pending/Planned/In Progress/Paused orders
            const scheduledDateStr = order.originalDate || order.date;
            if (!scheduledDateStr) continue;

            const sDate = new Date(scheduledDateStr + 'T12:00:00');
            const sYear = sDate.getFullYear();
            const sMonth = sDate.getMonth();

            let deadline;
            if (order.hadPauseExtension) {
                // Allowed until the end of the next month
                deadline = new Date(sYear, sMonth + 2, 1, 0, 0, 0);
            } else {
                // Allowed until the end of the scheduled month
                deadline = new Date(sYear, sMonth + 1, 1, 0, 0, 0);
            }

            if (now >= deadline) {
                shouldUpdate = true;
                nextStatus = order.status;
                isExpired = true;
                note = 'Marcada como expirada autom치ticamente por exceder el tiempo m치ximo de ejecuci칩n permitido. La orden ahora es de solo lectura.';
            }
        }

        if (shouldUpdate) {
            try {
                const updateData = {
                    status: nextStatus,
                    observaciones: `${order.observaciones || ''}\n\nNota del Sistema: ${note}`.trim()
                };
                if (isExpired) updateData.isExpired = true;

                const oldOrder = JSON.parse(JSON.stringify(order));
                await updateDoc(doc(state.collections.workOrders, order.fb_id), updateData);
                await recordAuditLog('workOrders', order.id, 'UPDATE_AUTO', oldOrder, { ...order, ...updateData }, 'Expiraci칩n Autom치tica');
                console.log(`Orden ${order.id} procesada por expiraci칩n: ${nextStatus}${isExpired ? ' (Expirada)' : ''}`);
            } catch (error) {
                console.error(`Error procesando expiraci칩n de orden ${order.id}:`, error);
            }
        }
    }
}

function drawSingleStar(doc, cx, cy, outerRadius = 3, innerRadius = 1.2, part = 'full') {
    const spikes = 5;
    let rot = Math.PI / 2 * 3;
    let step = Math.PI / spikes;
    let allPoints = [];

    for (let i = 0; i < spikes; i++) {
        let x = cx + Math.cos(rot) * outerRadius;
        let y = cy + Math.sin(rot) * outerRadius;
        allPoints.push([x, y]);
        rot += step;

        x = cx + Math.cos(rot) * innerRadius;
        y = cy + Math.sin(rot) * innerRadius;
        allPoints.push([x, y]);
        rot += step;
    }

    let points = [];
    if (part === 'left') {
        // Puntos 5 (abajo centro), 6, 7, 8, 9 y 0 (arriba centro)
        points = [allPoints[5], allPoints[6], allPoints[7], allPoints[8], allPoints[9], allPoints[0]];
    } else if (part === 'right') {
        // Puntos 0 (arriba centro), 1, 2, 3, 4 y 5 (abajo centro)
        points = [allPoints[0], allPoints[1], allPoints[2], allPoints[3], allPoints[4], allPoints[5]];
    } else {
        points = allPoints;
    }

    // Usar el m칠todo general de dibujo si existe, o caer en polygon
    if (typeof doc.polygon === 'function') {
        doc.polygon(points, 'FD');
    } else {
        // Alternativa con lines (puntos relativos)
        let relativePoints = [];
        let lastX = points[0][0];
        let lastY = points[0][1];
        for (let i = 1; i < points.length; i++) {
            relativePoints.push([points[i][0] - lastX, points[i][1] - lastY]);
            lastX = points[i][0];
            lastY = points[i][1];
        }
        doc.lines(relativePoints, points[0][0], points[0][1], [1, 1], 'FD', true);
    }
}

/**
 * Dibuja estrellas de calificaci칩n con soporte para 50/50 (Operario/Jefe)
 * @param {Object} doc Instancia de jsPDF
 * @param {number} x Posici칩n X
 * @param {number} y Posici칩n Y
 * @param {number|Array} data Porcentaje (0-100) o Array de pares [{op: bool, jefe: bool}]
 * @param {number} starSize Tama침o de la estrella
 */
function drawRatingStars(doc, x, y, data, starSize = 3) {
    const spacing = starSize * 2.5;
    let starResults = [];

    if (Array.isArray(data)) {
        starResults = data;
    } else {
        // Convertir porcentaje a formato de 5 estrellas (retrocompatibilidad)
        const percentage = data;
        let filledCount = 0;
        if (percentage >= 95) filledCount = 5;
        else if (percentage >= 80) filledCount = 4;
        else if (percentage >= 60) filledCount = 3;
        else if (percentage >= 40) filledCount = 2;
        else if (percentage > 0) filledCount = 1;

        for (let i = 0; i < 5; i++) {
            starResults.push({ op: i < filledCount, jefe: i < filledCount });
        }
    }

    starResults.forEach((res, i) => {
        const starX = x + (i * spacing);
        const innerRadius = starSize * 0.4;

        // Dibujar fondo gris (estrella vac칤a)
        doc.setFillColor(220, 220, 220);
        doc.setDrawColor(180, 180, 180);
        drawSingleStar(doc, starX, y, starSize, innerRadius);

        // Dibujar mitad Operario (Izquierda)
        if (res.op) {
            doc.setFillColor(255, 215, 0);
            doc.setDrawColor(218, 165, 32);
            drawSingleStar(doc, starX, y, starSize, innerRadius, 'left');
        }

        // Dibujar mitad Jefe (Derecha)
        if (res.jefe) {
            doc.setFillColor(255, 215, 0);
            doc.setDrawColor(218, 165, 32);
            drawSingleStar(doc, starX, y, starSize, innerRadius, 'right');
        }
    });
}

async function generateTechnicianPerformanceReport(username = null) {
    // Si se llama desde un event listener, el primer argumento es un objeto Event
    const technicianUsername = (username && typeof username === 'string') ? username : document.getElementById('report-technician-select').value;
    const startDateString = document.getElementById('report-technician-start-date').value;
    const endDateString = document.getElementById('report-technician-end-date').value;

    if (!technicianUsername) {
        showToast('Por favor, seleccione un t칠cnico.', 'error');
        return;
    }
    if (!startDateString || !endDateString) {
        showToast('Por favor, seleccione un rango de fechas v치lido.', 'error');
        return;
    }

    showLoading(true);

    try {
        const technician = state.technicians.find(t => t.username === technicianUsername);
        if (!technician) throw new Error('T칠cnico no encontrado.');

        const startDate = new Date(startDateString + 'T00:00:00');
        const endDate = new Date(endDateString + 'T23:59:59');

        const evaluationsInPeriod = state.technicianEvaluations.filter(e =>
            e.technicianId === technicianUsername &&
            new Date(e.evaluationDate) >= startDate &&
            new Date(e.evaluationDate) <= endDate
        );

        // --- PDF Generation (Executive Style) ---
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const periodName = `${startDate.toLocaleDateString('es-ES')} al ${endDate.toLocaleDateString('es-ES')}`;

        // Header
        doc.setFontSize(20);
        doc.setFont(undefined, 'bold');
        doc.text('Informe de Desempe침o Ejecutivo', 105, 20, { align: 'center' });
        doc.setFontSize(12);
        doc.setFont(undefined, 'normal');
        doc.text(`T칠cnico: ${technician.username}`, 14, 40);
        doc.text(`Per칤odo: ${periodName}`, 14, 48);
        doc.line(14, 55, 196, 55); // Horizontal line

        // Summary Cards
        const totalCompleted = state.workOrders.filter(wo =>
            wo.technicians.includes(technicianUsername) &&
            (wo.status === 'Completado' || wo.status === 'Pendiente de Evaluaci칩n') &&
            wo.fechaFinalizacionReal &&
            new Date(wo.fechaFinalizacionReal) >= startDate &&
            new Date(wo.fechaFinalizacionReal) <= endDate
        ).length;

        // Agrupar evaluaciones por OT para consolidar doble evaluaci칩n
        const evaluationsByWO = {};
        evaluationsInPeriod.forEach(e => {
            if (!evaluationsByWO[e.workOrderFbId]) evaluationsByWO[e.workOrderFbId] = [];
            evaluationsByWO[e.workOrderFbId].push(e);
        });

        const totalWOsEvaluated = Object.keys(evaluationsByWO).length;

        // Calcular promedio global basado en pares
        const activePairs = state.evaluationCriteria.filter(c => c.status === 'activo' && c.role === 'Operario' && c.pairId);
        let globalPairTotal = 0;
        let globalPairChecked = 0;

        const tableBody = Object.keys(evaluationsByWO).map(woFbId => {
            const evs = evaluationsByWO[woFbId];
            const workOrder = state.workOrders.find(wo => wo.fb_id === woFbId);
            const opEval = evs.find(e => e.evaluatorRole === 'Operario');
            const jefeEval = evs.find(e => e.evaluatorRole === 'Jefe de Area');

            const starResults = activePairs.map(p => {
                const opOk = opEval ? opEval.results.find(r => r.criteriaId === p.fb_id)?.score === 1 : false;
                const jefeOk = jefeEval ? jefeEval.results.find(r => r.criteriaId === p.pairId)?.score === 1 : false;

                globalPairTotal += 2;
                if (opOk) globalPairChecked++;
                if (jefeOk) globalPairChecked++;

                return { op: opOk, jefe: jefeOk };
            });

            return [
                workOrder ? workOrder.id : 'N/A',
                workOrder ? workOrder.description : 'Descripci칩n no encontrada',
                new Date(evs[0].evaluationDate).toLocaleDateString('es-ES'),
                starResults // Guardamos el array de estrellas para el hook
            ];
        });

        const avgScorePercentage = globalPairTotal > 0 ? (globalPairChecked / globalPairTotal * 100) : 0;

        doc.setFontSize(10);
        doc.setTextColor(100, 100, 100);
        doc.text('Tareas Completadas', 30, 70);
        doc.text('Tareas Evaluadas', 90, 70);
        doc.text('Calificaci칩n Promedio', 150, 70);

        doc.setFontSize(18);
        doc.setTextColor(0, 0, 0);
        doc.text(String(totalCompleted), 30, 80);
        doc.text(String(totalWOsEvaluated), 90, 80);

        // Estrellas en el resumen (usamos porcentaje para el promedio global)
        drawRatingStars(doc, 150, 78, avgScorePercentage, 4);

        // Detailed List of Evaluated Work Orders
        doc.setFontSize(14);
        doc.text('Detalle de 칍rdenes de Trabajo Evaluadas', 14, 100);

        if (tableBody.length > 0) {
            doc.autoTable({
                startY: 105,
                head: [['ID Orden', 'Descripci칩n del Problema', 'Fecha Evaluaci칩n', 'Calificaci칩n']],
                body: tableBody,
                headStyles: { fillColor: [44, 62, 80] },
                columnStyles: {
                    1: { cellWidth: 80 },
                    3: { cellWidth: 40 }
                },
                didParseCell: (data) => {
                    if (data.section === 'body' && data.column.index === 3) {
                        data.cell.text = ['']; // Vaciar el texto para que no se superponga
                    }
                },
                didDrawCell: (data) => {
                    if (data.section === 'body' && data.column.index === 3) {
                        const starResults = data.cell.raw;
                        // Centrar las estrellas en la celda
                        const posX = data.cell.x + 4;
                        const posY = data.cell.y + (data.cell.height / 2);
                        drawRatingStars(doc, posX, posY, starResults, 2.5);
                    }
                }
            });
        } else {
            doc.setFontSize(10);
            doc.text('No se encontraron evaluaciones para este t칠cnico en el per칤odo seleccionado.', 14, 110);
        }

        doc.save(`Informe_Desempeno_${technician.username}_${startDateString}_a_${endDateString}.pdf`);
        showToast('Informe de desempe침o generado.', 'success');

    } catch (error) {
        console.error("Error generating technician performance report:", error);
        showToast('Error al generar el informe: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}


function downloadBackup() {
    showLoading(true);
    try {
        const backupData = {
            version: "1.0",
            backupDate: new Date().toISOString(),
            machines: state.machines,
            parts: state.parts,
            proveedores: state.proveedores,
            technicians: state.technicians,
            workOrders: state.workOrders,
            solicitudes: state.solicitudes,
            workPlans: state.workPlans,
            workPlanExecutions: state.workPlanExecutions,
            evaluationCriteria: state.evaluationCriteria,
            technicianEvaluations: state.technicianEvaluations,
            partMovements: state.partMovements,
            partRequests: state.partRequests
        };

        const jsonString = JSON.stringify(backupData, null, 2);
        const blob = new Blob([jsonString], { type: "application/json" });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        const now = new Date();
        const timestamp = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}`;

        a.href = url;
        a.download = `Respaldo_CORINFAR_${timestamp}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        showToast('Respaldo generado y descargado correctamente.', 'success');
    } catch (error) {
        console.error("Error generating backup:", error);
        showToast('Error al generar el respaldo.', 'error');
    } finally {
        showLoading(false);
    }
}

function populateDynamicSelectors(searchTerm = '', specificId = null) {
    const selectors = [
        document.getElementById('report-technician-select'),
        document.getElementById('report-machine-select'),
        document.getElementById('report-machine-parts-select'),
        document.getElementById('kpi-machine-select'),
        document.getElementById('solicitud-machine')
    ];
    
    selectors.forEach(selector => {
        if (selector) {
            if (specificId && selector.id !== specificId) return;

            const currentVal = selector.value || selector.dataset.lastValue || "";
            const lowerSearch = (specificId === selector.id) ? searchTerm.toLowerCase() : '';

            if (selector.id === 'report-technician-select') {
                selector.innerHTML = '<option value="">Seleccione un t칠cnico...</option>';
                let techniciansToPopulate = state.technicians.filter(t => t.role === 'T칠cnico');

                // If current user is a technician, only show themselves
                if (state.currentUser?.role === 'T칠cnico') {
                    techniciansToPopulate = techniciansToPopulate.filter(t => t.username === state.currentUser.username);
                }

                techniciansToPopulate.forEach(tech => {
                    selector.innerHTML += `<option value="${tech.username}">${tech.username}</option>`;
                });
            } else {
                const isKpiSelector = selector.id === 'kpi-machine-select';
                selector.innerHTML = isKpiSelector ? '<option value="all">Todas las M치quinas</option>' : '<option value="">Seleccione una m치quina...</option>';

                let machinesToPopulate = state.machines;
                if (state.currentUser?.role === 'Jefe de Area' && Array.isArray(state.currentUser.managedMachineIds)) {
                    const managedIds = new Set(state.currentUser.managedMachineIds);
                    machinesToPopulate = state.machines.filter(m => managedIds.has(m.id));
                } else if (state.currentUser?.role === 'T칠cnico' && (selector.id === 'report-machine-select' || selector.id === 'report-machine-parts-select')) {
                    // Filter machines for specific reports if role is T칠cnico
                    const assignedIds = new Set(state.currentUser.equipoAsignado || []);
                    machinesToPopulate = state.machines.filter(m => assignedIds.has(m.id));
                }

                if (lowerSearch) {
                    machinesToPopulate = machinesToPopulate.filter(m =>
                        m.id.toLowerCase().includes(lowerSearch) ||
                        m.name.toLowerCase().includes(lowerSearch)
                    );
                }

                machinesToPopulate.forEach(machine => {
                    selector.innerHTML += `<option value="${machine.id}">${machine.id} - ${machine.name}</option>`;
                });
            }
            if (currentVal) {
                const exists = Array.from(selector.options).some(opt => opt.value === currentVal);
                if (exists) {
                    selector.value = currentVal;
                }
                selector.dataset.lastValue = currentVal;
            }
        }
    });
}

window.state = state;
window.renderCalendar = renderCalendar;
window.renderActiveWorkView = renderActiveWorkView;
window.showWorkOrderModal = showWorkOrderModal;
window.updateDashboardData = updateDashboardData;
window.renderMachines = renderMachines;
window.showPartDetail = showPartDetail;
window.showMachineDetail = showMachineDetail;
window.renderParts = renderParts;
window.renderSolicitudes = renderSolicitudes;
window.renderWorkPlans = renderWorkPlans;
window.toggleTheme = toggleTheme;
window.syncPartToOdoo = syncPartToOdoo;
window.syncPartStockToOdoo = syncPartStockToOdoo;
window.renderAuditLogs = renderAuditLogs;
window.viewAuditDetail = viewAuditDetail;
window.generateFichaMaestra = generateFichaMaestra;
window.requestSignature = requestSignature;
window.handleStartLinkedPlan = handleStartLinkedPlan;
window.handlePausePlanExecution = handlePausePlanExecution;
window.handleResumePlanExecution = handleResumePlanExecution;
window.handleFinishPlanExecution = handleFinishPlanExecution;
async function loadAuditLogs() {
    const list = document.getElementById('audit-log-list');
    if (list) {
        list.innerHTML = '<tr><td colspan="6" class="text-center text-muted"><i class="fas fa-spinner fa-spin"></i> Cargando registros...</td></tr>';
    }

    try {
        const q = query(state.collections.auditLogs, orderBy("timestamp", "desc"), limit(500));
        const snapshot = await getDocs(q);
        state.auditLogs = snapshot.docs.map(doc => ({ fb_id: doc.id, ...doc.data() }));
        renderAuditLogs();
    } catch (error) {
        console.error("Error loading audit logs:", error);
        showToast("Error al cargar registros de auditor칤a", "error");
    }
}

function getAuditCollectionLabel(collectionName) {
    const map = {
        'workOrders': 'OT',
        'solicitudes': 'Solicitud',
        'machines': 'M치quina',
        'parts': 'Repuesto',
        'partMovements': 'Inventario',
        'partRequests': 'Solicitud de Repuesto',
        'technicians': 'Usuario',
        'proveedores': 'Proveedor',
        'workPlans': 'Plan de Mantenimiento',
        'workPlanExecutions': 'Ejecuci칩n de Plan',
        'evaluationCriteria': 'Criterios de Evaluaci칩n',
        'technicianEvaluations': 'Evaluaci칩n de T칠cnico'
    };
    return map[collectionName] || collectionName;
}

function getWorkOrderDetailedAction(oldOrder, newOrder) {
    if (!oldOrder) return 'Creaci칩n OT';

    let actions = [];

    // Cambios de Estado
    if (oldOrder.status !== newOrder.status) {
        if (newOrder.status === 'En Proceso') {
            actions.push(oldOrder.status === 'Pausado' ? 'Reanudaci칩n OT' : 'Inicio OT');
        } else if (newOrder.status === 'Pausado') {
            actions.push('Pausa OT');
        } else if (newOrder.status === 'Cancelado') {
            actions.push('Cancelaci칩n OT');
        } else if (newOrder.status === 'Completado') {
            actions.push('Finalizaci칩n OT');
        } else if (newOrder.status === 'Pendiente de Evaluaci칩n') {
            actions.push('Evaluaci칩n T칠cnica (Enviada)');
        } else if (newOrder.status === 'Pendiente de Aprobaci칩n') {
            actions.push('Trabajo Finalizado (Pendiente Aprobaci칩n)');
        } else {
            actions.push(`Estado: ${newOrder.status}`);
        }
    }

    // Validaci칩n
    if (!oldOrder.validatedBy && newOrder.validatedBy) {
        actions.push('OT Validada');
    }

    // Repuestos
    const oldParts = oldOrder.partsUsed || [];
    const newParts = newOrder.partsUsed || [];
    if (newParts.length > oldParts.length) {
        actions.push('Repuestos agregados');
    } else if (newParts.length < oldParts.length) {
        actions.push('Repuestos eliminados');
    }

    // T칠cnicos
    if (oldOrder.leadTechnician !== newOrder.leadTechnician) {
        actions.push('Cambio de responsable');
    }

    if (actions.length === 0) return 'Modificaci칩n OT';
    return actions.join(', ');
}

function getAuditActionLabel(log) {
    // Si hay una acci칩n detallada espec칤fica y no es gen칠rica, usarla
    const genericActions = ['Modificaci칩n OT', 'Actualizaci칩n OT', 'Modificaci칩n'];
    if (log.detailedAction && !genericActions.includes(log.detailedAction) && !log.detailedAction.startsWith('Cambio estado a')) {
        return log.detailedAction;
    }

    if (log.action === 'CREATE') return 'Creaci칩n';
    if (log.action === 'DELETE') return 'Eliminaci칩n';
    if (log.action === 'UPDATE_AUTO') return 'Actualizaci칩n Autom치tica';

    if (log.action === 'UPDATE' && log.collectionName === 'workOrders' && log.newData && log.oldData) {
        let action = getWorkOrderDetailedAction(log.oldData, log.newData);
        // Si el log original ten칤a informaci칩n de firma, preservarla
        if (log.detailedAction && log.detailedAction.includes('(Firmado)')) {
            action += ' (Firmado)';
        }
        return action;
    }

    if (log.detailedAction) return log.detailedAction;
    return log.action === 'UPDATE' ? 'Modificaci칩n' : log.action;
}

function getAuditDocLabel(log) {
    if (log.docId && log.docId.length < 20 && !/^[a-z0-9]{20,}$/i.test(log.docId)) return log.docId;

    const data = log.newData || log.oldData;
    if (data) {
        return data.id || data.serial_no || data.partId || data.workOrderId || log.docId;
    }
    return log.docId;
}

function renderAuditLogs() {
    const list = document.getElementById('audit-log-list');
    if (!list) return;

    const filterCollection = document.getElementById('audit-filter-collection').value;
    const filterUser = document.getElementById('audit-filter-user').value.toLowerCase();
    const filterStart = document.getElementById('audit-filter-start').value;
    const filterEnd = document.getElementById('audit-filter-end').value;

    let filtered = [...state.auditLogs];

    if (filterCollection !== 'all') {
        filtered = filtered.filter(log => log.collectionName === filterCollection);
    }
    if (filterUser) {
        filtered = filtered.filter(log => log.username.toLowerCase().includes(filterUser));
    }
    if (filterStart) {
        filtered = filtered.filter(log => log.timestamp >= filterStart);
    }
    if (filterEnd) {
        filtered = filtered.filter(log => log.timestamp <= filterEnd + 'T23:59:59');
    }

    filtered.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

    list.innerHTML = filtered.map(log => {
        const actionLabel = getAuditActionLabel(log);
        const collectionLabel = getAuditCollectionLabel(log.collectionName);
        const docLabel = getAuditDocLabel(log);
        const badgeClass = log.action === 'CREATE' ? 'success' : (log.action === 'DELETE' ? 'danger' : 'primary');

        return `
            <tr>
                <td><small>${new Date(log.timestamp).toLocaleString()}</small></td>
                <td>${log.username}</td>
                <td><span class="badge bg-${badgeClass}">${actionLabel}</span></td>
                <td>${collectionLabel}</td>
                <td><small>${docLabel}</small></td>
                <td>
                    <button class="btn btn-sm btn-outline-secondary" onclick="viewAuditDetail('${log.fb_id}')">
                        <i class="fas fa-eye"></i> Ver
                    </button>
                </td>
            </tr>
        `;
    }).join('') || '<tr><td colspan="6" class="text-center text-muted">No se encontraron registros</td></tr>';
}

function generateAuditReport() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('l', 'mm', 'a4');
    const logoBase64 = typeof GLOBAL_LOGO !== 'undefined' ? GLOBAL_LOGO : "";

    doc.setFontSize(18);
    doc.text('REGISTRO DE AUDITOR칈A Y TRAZABILIDAD', 14, 20);

    if (logoBase64) {
        try {
            doc.addImage(logoBase64, 'PNG', 200, 10, 80, 25);
        } catch (e) { console.error("Logo error:", e); }
    }

    doc.setFontSize(10);
    doc.text(`Sistema: CORINFAR CMMS - Cumplimiento 21 CFR Part 11`, 14, 28);
    doc.text(`Fecha de Reporte: ${new Date().toLocaleString()}`, 14, 34);
    doc.text(`Generado por: ${state.currentUser.username}`, 14, 40);

    const logs = [...state.auditLogs].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

    const tableData = logs.map(log => [
        new Date(log.timestamp).toLocaleString(),
        log.username,
        getAuditActionLabel(log),
        getAuditCollectionLabel(log.collectionName),
        getAuditDocLabel(log)
    ]);

    doc.autoTable({
        startY: 45,
        head: [['Fecha/Hora', 'Usuario', 'Acci칩n', 'Colecci칩n', 'ID Documento']],
        body: tableData,
        theme: 'striped',
        headStyles: { fillColor: [44, 62, 80] },
    });

    doc.save(`Audit_Log_${new Date().toISOString().split('T')[0]}.pdf`);
}

function viewAuditDetail(fb_id) {
    const log = state.auditLogs.find(l => l.fb_id === fb_id);
    if (!log) return;

    document.getElementById('audit-old-data').textContent = log.oldData ? JSON.stringify(log.oldData, null, 2) : '--- N/A (CREACI칍N) ---';
    document.getElementById('audit-new-data').textContent = log.newData ? JSON.stringify(log.newData, null, 2) : '--- N/A (ELIMINACI칍N) ---';

    state.modals.auditDetail.show();
}

function requestSignature(onSuccess, onCancel) {
    if (!state.currentUser) {
        if (onCancel) onCancel();
        return;
    }

    // Asegurarse de quitar el overlay de carga para que el usuario pueda interactuar
    showLoading(false);

    document.getElementById('confirm-password-username').textContent = state.currentUser.username;
    const passwordInputEl = document.getElementById('confirm-password-input');
    passwordInputEl.value = '';
    document.getElementById('confirm-password-error').classList.add('d-none');

    let successCalled = false;
    const modalEl = document.getElementById('passwordConfirmModal');

    const onHidden = () => {
        modalEl.removeEventListener('hidden.bs.modal', onHidden);
        if (!successCalled && onCancel) onCancel();
    };
    modalEl.addEventListener('hidden.bs.modal', onHidden);

    const oldBtn = document.getElementById('btn-confirm-password-submit');
    const newBtn = oldBtn.cloneNode(true);
    oldBtn.parentNode.replaceChild(newBtn, oldBtn);

    const handleConfirm = async () => {
        const passwordInput = passwordInputEl.value;
        const hashedPassword = await hashPassword(passwordInput);

        let isValid = false;
        if (state.currentUser.passwordIsHashed) {
            isValid = state.currentUser.password === hashedPassword;
        } else {
            isValid = state.currentUser.password === passwordInput;
        }

        if (isValid) {
            successCalled = true;
            state.modals.passwordConfirm.hide();
            onSuccess();
        } else {
            document.getElementById('confirm-password-error').classList.remove('d-none');
            passwordInputEl.focus();
        }
    };

    newBtn.addEventListener('click', handleConfirm);

    // Soporte para tecla Enter
    const enterListener = (e) => {
        if (e.key === 'Enter') {
            handleConfirm();
        }
    };
    passwordInputEl.addEventListener('keydown', enterListener);

    // Limpiar listener al cerrar
    modalEl.addEventListener('hidden.bs.modal', () => {
        passwordInputEl.removeEventListener('keydown', enterListener);
    }, { once: true });

    state.modals.passwordConfirm.show();

    // Enfocar el input autom치ticamente
    setTimeout(() => passwordInputEl.focus(), 500);
}

// --- Theme Management ---
async function toggleTheme() {
    const isDarkMode = document.body.classList.toggle('dark-mode');
    state.currentTheme = isDarkMode ? 'dark' : 'light';

    // Guardar preferencia si el usuario est치 logueado
    if (state.currentUser && state.currentUser.fb_id) {
        try {
            await updateDoc(doc(state.collections.technicians, state.currentUser.fb_id), {
                theme: state.currentTheme
            });
            state.currentUser.theme = state.currentTheme;
        } catch (error) {
            console.error("Error al guardar preferencia de tema:", error);
        }
    }

    updateChartsTheme();
    showToast(`Modo ${state.currentTheme === 'dark' ? 'oscuro' : 'claro'} activado`, 'info');
}

function updateChartsTheme() {
    const isDark = document.body.classList.contains('dark-mode');
    const textColor = isDark ? '#f1f2f6' : '#666';
    const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';

    // Actualizar defaults de Chart.js
    Chart.defaults.color = textColor;
    if (Chart.defaults.scale && Chart.defaults.scale.grid) {
        Chart.defaults.scale.grid.color = gridColor;
    }

    // Actualizar instancias existentes
    Object.values(state.charts).forEach(chart => {
        if (!chart || !chart.options) return;

        if (chart.options.scales) {
            Object.values(chart.options.scales).forEach(scale => {
                if (scale.grid) scale.grid.color = gridColor;
                if (scale.ticks) scale.ticks.color = textColor;
            });
        }

        if (chart.options.plugins) {
            if (chart.options.plugins.legend && chart.options.plugins.legend.labels) {
                chart.options.plugins.legend.labels.color = textColor;
            }
            if (chart.options.plugins.title) {
                chart.options.plugins.title.color = textColor;
            }
        }

        chart.update();
    });
}

window.updateChartsTheme = updateChartsTheme;
window.applyUserPermissions = applyUserPermissions;

// Export functions to window for verification and external access
window.showPartModal = showPartModal;
window.renderParts = renderParts;
window.showMachineDetail = showMachineDetail;
window.renderMachines = renderMachines;
window.executeWorkPlan = executeWorkPlan;
window.renderWorkPlans = renderWorkPlans;
window.showWorkPlanModal = showWorkPlanModal;
window.renderWorkPlanExecution = renderWorkPlanExecution;
window.updatePlanNotifications = updatePlanNotifications;

// --- Smart Monitoring Functions ---
function renderSmartMonitoring() {
    const container = document.getElementById('smart-monitoring-container');
    if (!container) return;
    container.innerHTML = '';

    const locations = new Set();
    state.machines.forEach(m => { if (m.location) locations.add(m.location); });
    renderSmartMonitoringFilters(Array.from(locations));

    let machinesToRender = [...state.machines];
    if (state.currentUser?.role === 'Jefe de Area' && Array.isArray(state.currentUser.managedMachineIds)) {
        const managedIds = new Set(state.currentUser.managedMachineIds);
        machinesToRender = state.machines.filter(m => managedIds.has(m.id));
    } else if (state.currentUser?.role === 'T칠cnico' && Array.isArray(state.currentUser.equipoAsignado)) {
        const assignedIds = new Set(state.currentUser.equipoAsignado);
        machinesToRender = state.machines.filter(m => assignedIds.has(m.id));
    }

    if (state.monitoringLocationFilter !== 'all') {
        machinesToRender = machinesToRender.filter(m => m.location === state.monitoringLocationFilter);
    }

    // Filter out machines with monitoring disabled
    machinesToRender = machinesToRender.filter(m => m.monitoringEnabled !== false);

    if (machinesToRender.length === 0) {
        container.innerHTML = '<div class="col-12 text-center py-5 text-muted">No se encontraron equipos para monitorear.</div>';
        return;
    }

    machinesToRender.forEach(machine => {
        const cardCol = document.createElement('div');
        cardCol.className = 'col-12 col-md-6 col-xl-4';

        const machinePlans = state.workPlans.filter(p => p.machineId === machine.id);
        const planIds = new Set(machinePlans.map(p => p.fb_id));
        const executions = state.workPlanExecutions
            .filter(e => planIds.has(e.planId) && (e.status === 'Completado' || e.status === 'Pendiente de Evaluaci칩n'))
            .sort((a, b) => new Date(b.executedAt) - new Date(a.executedAt));

        // Get latest measurements
        const measurements = {}; // key: task description, value: { value, unit, status, date, trend, history: [] }

        // Collect history first to determine trend
        const historyMap = {};

        [...executions].reverse().forEach(ex => {
            (ex.taskGroups || []).forEach(group => {
                group.tasks.forEach(task => {
                    if (task.type === 'numeric') {
                        const key = task.description;
                        if (!historyMap[key]) historyMap[key] = [];
                        historyMap[key].push({
                            value: parseFloat(task.value),
                            unit: task.unit,
                            status: task.status,
                            date: ex.executedAt,
                            executedBy: ex.executedBy,
                            workOrderId: ex.workOrderId || 'N/A'
                        });
                    } else if (task.type === 'multi_numeric') {
                        (task.fields || []).forEach((field, fIdx) => {
                            const key = `${task.description} - ${field}`;
                            if (!historyMap[key]) historyMap[key] = [];
                            const val = task.multiValues ? parseFloat(task.multiValues[fIdx]) : NaN;
                            historyMap[key].push({
                                value: val,
                                unit: task.unit,
                                status: task.status,
                                date: ex.executedAt,
                                executedBy: ex.executedBy,
                                workOrderId: ex.workOrderId || 'N/A'
                            });
                        });
                    }
                });
            });
        });

        const latestMeasurements = [];
        Object.keys(historyMap).forEach(key => {
            const history = historyMap[key].filter(h => !isNaN(h.value));
            if (history.length > 0) {
                const latest = history[history.length - 1];
                let trend = 'stable';
                if (history.length > 1) {
                    const prev = history[history.length - 2];
                    if (latest.value > prev.value) trend = 'up';
                    else if (latest.value < prev.value) trend = 'down';
                }
                if (latest.status === 'Alerta' || latest.status === 'Fallo') trend = 'alert';

                // Get config for this variable
                const config = state.monitoringConfigs.find(c => c.machineId === machine.id);
                const varConfig = config?.variables?.find(v => v.name === key);

                // Skip if explicitly disabled in config
                if (varConfig && varConfig.enabled === false) return;

                let currentStatus = latest.status;

                // Apply custom thresholds if available
                if (varConfig && varConfig.thresholds) {
                    const val = latest.value;
                    const t = varConfig.thresholds;

                    const isInRange = (thr) => {
                        if (!thr) return false;
                        const min = thr.min !== "" ? parseFloat(thr.min) : null;
                        const max = thr.max !== "" ? parseFloat(thr.max) : null;

                        if (min !== null && max !== null) return val >= min && val <= max;
                        if (min !== null) return val >= min;
                        if (max !== null) return val <= max;
                        return false;
                    };

                    if (isInRange(t.normal)) {
                        currentStatus = 'Aprob칩';
                    } else if (isInRange(t.warning)) {
                        currentStatus = 'Alerta';
                    } else if (isInRange(t.critical)) {
                        currentStatus = 'Fallo';
                    } else {
                        // Si est치 fuera de todos los rangos definidos, considerarlo fallo
                        currentStatus = 'Fallo';
                    }
                }

                latestMeasurements.push({
                    key: key,
                    ...latest,
                    status: currentStatus,
                    trend: trend,
                    history: history
                });
            }
        });

        // Machine Status logic
        let overallStatus = 'operativo';
        if (latestMeasurements.some(m => m.status === 'Fallo')) overallStatus = 'fallo';
        else if (latestMeasurements.some(m => m.status === 'Alerta')) overallStatus = 'alerta';

        const statusLabel = overallStatus.toUpperCase();

        let measurementsHTML = '';
        latestMeasurements.forEach((m, idx) => {
            const trendIcon = {
                'up': '<i class="fas fa-long-arrow-alt-up trend-up"></i>',
                'down': '<i class="fas fa-long-arrow-alt-down trend-down"></i>',
                'stable': '<i class="fas fa-check trend-stable"></i>',
                'alert': '<i class="fas fa-exclamation-triangle trend-alert"></i>'
            }[m.trend];

            measurementsHTML += `
                <div class="measurement-item" onclick="showMeasurementHistory('${machine.id}', '${m.key.replace(/'/g, "\\'")}')">
                    <div class="measurement-label">${m.key}</div>
                    <div class="measurement-value">${m.value}${m.unit ? ' ' + m.unit : ''}</div>
                    <div class="measurement-trend">${trendIcon}</div>
                </div>
            `;
        });

        if (latestMeasurements.length === 0) {
            measurementsHTML = '<div class="col-12 text-center py-4 text-muted small fst-italic">Sin mediciones registradas</div>';
        }

        cardCol.innerHTML = `
            <div class="monitoring-card">
                <div class="monitoring-card-header">
                    <div class="machine-icon-wrapper">
                        <i class="fas fa-microchip"></i>
                        <div class="status-indicator-top ${overallStatus}"></div>
                    </div>
                    <div class="machine-info-main">
                        <h5>${machine.name}</h5>
                        <div class="sn-text">SN: ${machine.serial || machine.id}</div>
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-link text-muted p-0" data-bs-toggle="dropdown"><i class="fas fa-ellipsis-v"></i></button>
                        <ul class="dropdown-menu shadow border-0">
                            <li><a class="dropdown-item" href="#" onclick="showMachineDetail('${machine.fb_id}')"><i class="fas fa-info-circle me-2"></i>Ver Detalle</a></li>
                            <li><a class="dropdown-item" href="#" onclick="executeWorkPlanForMachine('${machine.id}')"><i class="fas fa-play-circle me-2"></i>Nuevo Plan</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="showMonitoringConfig('${machine.id}')"><i class="fas fa-cog me-2"></i>Configuraci칩n</a></li>
                        </ul>
                    </div>
                </div>

                <div class="measurements-grid">
                    ${measurementsHTML}
                </div>

                <div class="monitoring-card-footer">
                    <div class="footer-status-text status-text-${overallStatus}">
                        ${statusLabel}
                    </div>
                    ${(overallStatus === 'fallo' || overallStatus === 'alerta') ?
                        `<button class="btn-wo-monitoring" onclick="createWorkOrderFromMonitoring('${machine.id}')">Orden de Trabajo</button>` :
                        `<a href="#" class="footer-action-link" onclick="showMachineDetail('${machine.fb_id}')">Ver detalle <i class="fas fa-arrow-right ms-1"></i></a>`
                    }
                </div>
            </div>
        `;
        container.appendChild(cardCol);
    });
}

function renderSmartMonitoringFilters(locations) {
    const container = document.getElementById('monitoring-filters');
    if (!container) return;

    const currentFilter = state.monitoringLocationFilter;
    const activeBtn = document.getElementById('active-location-filter');

    container.innerHTML = `<li><button class="dropdown-item filter-btn ${currentFilter === 'all' ? 'active' : ''}" data-location="all">Todos</button></li>`;

    locations.sort().forEach(loc => {
        const li = document.createElement('li');
        li.innerHTML = `<button class="dropdown-item filter-btn ${currentFilter === loc ? 'active' : ''}" data-location="${loc}">${loc}</button>`;
        container.appendChild(li);
    });

    if (activeBtn) {
        activeBtn.innerHTML = `<i class="fas fa-map-marker-alt me-2"></i> 츼rea: ${currentFilter === 'all' ? 'Todos' : currentFilter}`;
    }

    container.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            state.monitoringLocationFilter = btn.dataset.location;
            renderSmartMonitoring();
        });
    });
}

async function showMonitoringConfig(machineId) {
    const machine = state.machines.find(m => m.id === machineId);
    if (!machine) return;

    showLoading(true);

    // Get current config or create default
    let config = state.monitoringConfigs.find(c => c.machineId === machineId);
    if (!config) {
        config = {
            machineId: machineId,
            variables: []
        };
    }

    // Ensure all variables from plans are present
    const planVars = new Set();
    state.workPlans.filter(p => p.machineId === machineId).forEach(p => {
        (p.taskGroups || []).forEach(g => {
            g.tasks.forEach(t => {
                if (t.type === 'numeric') planVars.add(t.description);
                else if (t.type === 'multi_numeric') {
                    (t.fields || []).forEach(f => planVars.add(`${t.description} - ${f}`));
                }
            });
        });
    });

    planVars.forEach(vName => {
        if (!config.variables.find(v => v.name === vName)) {
            config.variables.push({
                name: vName,
                enabled: true,
                description: '',
                thresholds: {
                    normal: { min: "", max: "" },
                    warning: { min: "", max: "" },
                    critical: { min: "", max: "" }
                }
            });
        }
    });

    state.currentMonitoringConfig = JSON.parse(JSON.stringify(config));
    state.activeMonitoringVar = null;

    document.getElementById('m-config-machine-name').textContent = machine.name;
    document.getElementById('monitoring-config-view').classList.remove('d-none');

    renderMonitoringConfigVariables();
    clearThresholdInputs();

    showLoading(false);
}

function hideMonitoringConfig() {
    document.getElementById('monitoring-config-view').classList.add('d-none');
    state.currentMonitoringConfig = null;
    state.activeMonitoringVar = null;
}

function renderMonitoringConfigVariables() {
    const container = document.getElementById('m-config-variables-container');
    container.innerHTML = '';

    const vars = state.currentMonitoringConfig.variables;

    if (vars.length === 0) {
        container.innerHTML = '<div class="text-center py-5 text-muted">No hay variables configuradas para este equipo.</div>';
        return;
    }

    const varIcons = {
        'temperatura': 'fa-thermometer-half',
        'voltaje': 'fa-bolt',
        'amperios': 'fa-bolt',
        'presi칩n': 'fa-compress-arrows-alt',
        'aceite': 'fa-oil-can',
        'motor': 'fa-clock',
        'horas': 'fa-clock'
    };

    vars.forEach((v, idx) => {
        const card = document.createElement('div');
        card.className = `m-config-var-card ${state.activeMonitoringVar === v.name ? 'active' : ''}`;
        card.onclick = () => selectMonitoringVar(v.name);

        let iconClass = 'fa-chart-line';
        const lowerName = v.name.toLowerCase();
        for (const [key, icon] of Object.entries(varIcons)) {
            if (lowerName.includes(key)) {
                iconClass = icon;
                break;
            }
        }

        card.innerHTML = `
            <div class="m-config-var-icon">
                <i class="fas ${iconClass}"></i>
            </div>
            <div class="m-config-var-info">
                <h6>${v.name}</h6>
                <p>${v.description || 'Variable de monitoreo'}</p>
            </div>
            <label class="m-config-switch" onclick="event.stopPropagation()">
                <input type="checkbox" ${v.enabled !== false ? 'checked' : ''} onchange="toggleMonitoringVar('${v.name.replace(/'/g, "\\'")}', this.checked)">
                <span class="m-config-slider"></span>
            </label>
        `;
        container.appendChild(card);
    });
}

function selectMonitoringVar(varName) {
    state.activeMonitoringVar = varName;
    renderMonitoringConfigVariables();

    const v = state.currentMonitoringConfig.variables.find(v => v.name === varName);
    document.getElementById('m-config-active-var-name').textContent = v.name;

    const t = v.thresholds || {};
    ['normal', 'warning', 'critical'].forEach(type => {
        const tt = t[type] || { min: "", max: "" };
        document.getElementById(`m-threshold-${type}-min`).value = tt.min;
        document.getElementById(`m-threshold-${type}-max`).value = tt.max;
    });
}

function toggleMonitoringVar(varName, enabled) {
    const v = state.currentMonitoringConfig.variables.find(v => v.name === varName);
    if (v) v.enabled = enabled;
}

function clearThresholdInputs() {
    document.getElementById('m-config-active-var-name').textContent = 'Ninguna';
    ['normal', 'warning', 'critical'].forEach(type => {
        document.getElementById(`m-threshold-${type}-min`).value = "";
        document.getElementById(`m-threshold-${type}-max`).value = "";
    });
}

function updateActiveVarThresholds() {
    if (!state.activeMonitoringVar) return;

    const v = state.currentMonitoringConfig.variables.find(v => v.name === state.activeMonitoringVar);
    if (!v) return;

    if (!v.thresholds) v.thresholds = {};

    ['normal', 'warning', 'critical'].forEach(type => {
        v.thresholds[type] = {
            min: document.getElementById(`m-threshold-${type}-min`).value,
            max: document.getElementById(`m-threshold-${type}-max`).value
        };
    });
}

async function handleSaveMonitoringConfig() {
    if (!state.currentMonitoringConfig) return;

    showLoading(true);
    try {
        const config = state.currentMonitoringConfig;
        const existing = state.monitoringConfigs.find(c => c.machineId === config.machineId);

        if (existing) {
            await updateDoc(doc(state.collections.monitoringConfigs, existing.fb_id), config);
        } else {
            await addDoc(state.collections.monitoringConfigs, config);
        }

        showToast('Configuraci칩n guardada correctamente.', 'success');
        hideMonitoringConfig();
    } catch (error) {
        console.error("Error saving monitoring config:", error);
        showToast('Error al guardar la configuraci칩n.', 'error');
    } finally {
        showLoading(false);
    }
}

function handleAddMonitoringVariable() {
    const varName = document.getElementById('new-variable-name').value.trim();
    if (!varName) {
        showToast('Ingrese un nombre para la variable', 'warning');
        return;
    }

    if (state.currentMonitoringConfig.variables.find(v => v.name === varName)) {
        showToast('Esta variable ya existe.', 'warning');
        return;
    }

    state.currentMonitoringConfig.variables.push({
        name: varName,
        enabled: true,
        description: 'Variable personalizada',
        thresholds: {
            normal: { min: "", max: "" },
            warning: { min: "", max: "" },
            critical: { min: "", max: "" }
        }
    });

    state.modals.variableName.hide();
    renderMonitoringConfigVariables();
    selectMonitoringVar(varName);
}

async function showMeasurementHistory(machineId, measurementKey) {
    const machine = state.machines.find(m => m.id === machineId);
    if (!machine) return;

    const machinePlans = state.workPlans.filter(p => p.machineId === machine.id);
    const planIds = new Set(machinePlans.map(p => p.fb_id));
    const executions = state.workPlanExecutions
        .filter(e => planIds.has(e.planId) && (e.status === 'Completado' || e.status === 'Pendiente de Evaluaci칩n'))
        .sort((a, b) => new Date(a.executedAt) - new Date(b.executedAt));

    const history = [];
    executions.forEach(ex => {
        (ex.taskGroups || []).forEach(group => {
            group.tasks.forEach(task => {
                if (task.type === 'numeric' && task.description === measurementKey) {
                    history.push({
                        value: parseFloat(task.value),
                        date: ex.executedAt,
                        executedBy: ex.executedBy,
                        workOrderId: ex.workOrderId || 'N/A'
                    });
                } else if (task.type === 'multi_numeric') {
                    (task.fields || []).forEach((field, fIdx) => {
                        const key = `${task.description} - ${field}`;
                        if (key === measurementKey) {
                            const val = task.multiValues ? parseFloat(task.multiValues[fIdx]) : NaN;
                            if (!isNaN(val)) {
                                history.push({
                                    value: val,
                                    date: ex.executedAt,
                                    executedBy: ex.executedBy,
                                    workOrderId: ex.workOrderId || 'N/A'
                                });
                            }
                        }
                    });
                }
            });
        });
    });

    if (history.length === 0) return;

    const data = history.map(h => h.value);
    const minVal = Math.min(...data);
    const maxVal = Math.max(...data);

    document.getElementById('history-modal-title').innerHTML = `
        Historial: ${measurementKey} (${machine.name})
        <span class="ms-3 badge bg-info x-small">M칤n: ${minVal}</span>
        <span class="badge bg-warning text-dark x-small">M치x: ${maxVal}</span>
    `;

    const tableBody = document.getElementById('measurement-history-table-body');
    tableBody.innerHTML = history.slice().reverse().map(h => `
        <tr>
            <td>${new Date(h.date).toLocaleString()}</td>
            <td class="fw-bold">${h.value}</td>
            <td>${h.executedBy}</td>
            <td>${h.workOrderId}</td>
        </tr>
    `).join('');

    state.modals.measurementHistory.show();

    // Render Chart
    setTimeout(() => {
        const ctx = document.getElementById('measurementHistoryChart').getContext('2d');
        if (state.charts.measurementHistory) {
            state.charts.measurementHistory.destroy();
        }

        const labels = history.map(h => new Date(h.date).toLocaleDateString());
        const padding = (maxVal - minVal) * 0.2 || 1;

        state.charts.measurementHistory = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: measurementKey,
                    data: data,
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    fill: true,
                    tension: 0.3,
                    pointRadius: 5,
                    pointHoverRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: false,
                        suggestedMin: minVal - padding,
                        suggestedMax: maxVal + padding,
                        grid: { color: state.currentTheme === 'dark' ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)' }
                    },
                    x: {
                        grid: { display: false }
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: (context) => `Valor: ${context.parsed.y}`
                        }
                    }
                }
            }
        });
    }, 300);
}

function getMonitoringFailureDescription(machineId) {
    const machine = state.machines.find(m => m.id === machineId);
    if (!machine) return "";

    const machinePlans = state.workPlans.filter(p => p.machineId === machine.id);
    const planIds = new Set(machinePlans.map(p => p.fb_id));
    const executions = state.workPlanExecutions
        .filter(e => planIds.has(e.planId) && (e.status === 'Completado' || e.status === 'Pendiente de Evaluaci칩n'))
        .sort((a, b) => new Date(b.executedAt) - new Date(a.executedAt));

    const historyMap = {};
    [...executions].reverse().forEach(ex => {
        (ex.taskGroups || []).forEach(group => {
            group.tasks.forEach(task => {
                if (task.type === 'numeric') {
                    const key = task.description;
                    if (!historyMap[key]) historyMap[key] = [];
                    historyMap[key].push({ value: parseFloat(task.value), unit: task.unit });
                } else if (task.type === 'multi_numeric') {
                    (task.fields || []).forEach((field, fIdx) => {
                        const key = `${task.description} - ${field}`;
                        if (!historyMap[key]) historyMap[key] = [];
                        const val = task.multiValues ? parseFloat(task.multiValues[fIdx]) : NaN;
                        historyMap[key].push({ value: val, unit: task.unit });
                    });
                }
            });
        });
    });

    const config = state.monitoringConfigs.find(c => c.machineId === machine.id);
    const failures = [];

    Object.keys(historyMap).forEach(key => {
        const history = historyMap[key].filter(h => !isNaN(h.value));
        if (history.length === 0) return;
        const latest = history[history.length - 1];
        const val = latest.value;

        const varConfig = config?.variables?.find(v => v.name === key);
        if (varConfig && varConfig.enabled !== false && varConfig.thresholds) {
            const t = varConfig.thresholds;
            const normal = t.normal;

            const min = normal.min !== "" ? parseFloat(normal.min) : null;
            const max = normal.max !== "" ? parseFloat(normal.max) : null;

            let isOk = true;
            if (min !== null && max !== null) isOk = val >= min && val <= max;
            else if (min !== null) isOk = val >= min;
            else if (max !== null) isOk = val <= max;

            if (!isOk) {
                let label = key;
                let suffix = "fuera de par치metro";

                const lowerKey = key.toLowerCase();
                if (lowerKey.includes("voltaje")) label = "Voltaje";
                else if (lowerKey.includes("amperaje") || lowerKey.includes("amperio")) label = "Amperios";

                if (min !== null && val < min) {
                    suffix = "bajo";
                } else if (max !== null && val > max) {
                    suffix = "alto";
                }

                failures.push(`${label} ${suffix} (${val}${latest.unit || ''})`);
            }
        }
    });

    return failures.length > 0 ? failures.join(", ") : "Par치metros fuera de rango detectados en monitoreo.";
}

async function createWorkOrderFromMonitoring(machineId) {
    const failureDesc = getMonitoringFailureDescription(machineId);
    await showWorkOrderModal(null, 'Correctivo', machineId);
    if (failureDesc) {
        document.getElementById('wo-description').value = failureDesc;
    }
}

function executeWorkPlanForMachine(machineId) {
    const plans = state.workPlans.filter(p => p.machineId === machineId && p.isActive);
    if (plans.length === 0) {
        showToast('No hay planes activos para este equipo.', 'warning');
        return;
    }
    // Si hay m치s de uno, ir a la pesta침a de planes. Si hay uno, ejecutarlo.
    if (plans.length === 1) {
        executeWorkPlan(plans[0].fb_id);
    } else {
        switchTab('planes-trabajo');
    }
}

window.renderSmartMonitoring = renderSmartMonitoring;
window.showMeasurementHistory = showMeasurementHistory;
window.createWorkOrderFromMonitoring = createWorkOrderFromMonitoring;
window.executeWorkPlanForMachine = executeWorkPlanForMachine;
window.switchTab = switchTab;
window.showMonitoringConfig = showMonitoringConfig;
window.hideMonitoringConfig = hideMonitoringConfig;
window.selectMonitoringVar = selectMonitoringVar;
window.toggleMonitoringVar = toggleMonitoringVar;
window.saveWorkOrder = saveWorkOrder;
window.handleKanbanWorkOrderAction = handleKanbanWorkOrderAction;
